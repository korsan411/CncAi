<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CNC Preview</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f0f0f0;
      font-family: Arial, sans-serif;
    }
    .preview-box {
      margin: 10px 0;
      border: 2px solid #333;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 5px;
    }
    #originalImage {
      max-width: 400px;
      max-height: 400px;
    }
    #preview2d {
      width: 400px;
      height: 400px;
      display: block;
    }
    #colorLegend {
      margin-top: 10px;
      width: 400px;
      height: 30px;
      display: block;
      border: 1px solid #333;
    }
    #preview3d {
      width: 100%;
      height: 400px;
    }
    #controls {
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div id="controls">
    <input type="file" id="fileInput" accept="image/*">
  </div>

  <h2>المعاينة الأصلية</h2>
  <div class="preview-box">
    <img id="originalImage" alt="Original Preview">
  </div>

  <h2>معاينة 2D (ألوان حسب الارتفاع)</h2>
  <div class="preview-box">
    <canvas id="preview2d" width="400" height="400"></canvas>
    <canvas id="colorLegend"></canvas>
  </div>

  <h2>معاينة 3D</h2>
  <div class="preview-box">
    <div id="preview3d"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    const fileInput = document.getElementById("fileInput");
    const originalImage = document.getElementById("originalImage");
    const canvas2d = document.getElementById("preview2d");
    const ctx = canvas2d.getContext("2d");
    const legendCanvas = document.getElementById("colorLegend");
    const legendCtx = legendCanvas.getContext("2d");

    // إعداد شريط الألوان (Legend)
    function drawLegend() {
      const grad = legendCtx.createLinearGradient(0, 0, legendCanvas.width, 0);
      grad.addColorStop(0, "hsl(240,100%,50%)"); // أزرق - منخفض
      grad.addColorStop(1, "hsl(0,100%,50%)");   // أحمر - مرتفع
      legendCtx.fillStyle = grad;
      legendCtx.fillRect(0, 0, legendCanvas.width, legendCanvas.height);
      legendCtx.fillStyle = "#000";
      legendCtx.font = "14px Arial";
      legendCtx.fillText("منخفض", 5, 20);
      legendCtx.fillText("مرتفع", legendCanvas.width - 50, 20);
    }
    drawLegend();

    // إعداد 3D
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/400, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth * 0.9, 400);
    document.getElementById("preview3d").appendChild(renderer.domElement);

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(1, 1, 1);
    scene.add(light);

    let mesh;

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // معاينة الصورة الأصلية
      originalImage.src = URL.createObjectURL(file);

      const img = new Image();
      img.onload = () => {
        const offCanvas = document.createElement("canvas");
        offCanvas.width = img.width;
        offCanvas.height = img.height;
        const offCtx = offCanvas.getContext("2d");
        offCtx.drawImage(img, 0, 0);
        const imgData = offCtx.getImageData(0, 0, img.width, img.height);

        // معاينة 2D ملونة
        for (let y = 0; y < img.height; y++) {
          for (let x = 0; x < img.width; x++) {
            const idx = (y * img.width + x) * 4;
            const gray = imgData.data[idx]; 
            ctx.fillStyle = `hsl(${240 - (gray/255)*240}, 100%, 50%)`; 
            ctx.fillRect(x * (canvas2d.width / img.width), y * (canvas2d.height / img.height),
                         canvas2d.width / img.width, canvas2d.height / img.height);
          }
        }

        // معاينة 3D
        if (mesh) scene.remove(mesh);

        const geometry = new THREE.PlaneGeometry(10, 10, img.width - 1, img.height - 1);
        const vertices = geometry.attributes.position.array;

        for (let y = 0; y < img.height; y++) {
          for (let x = 0; x < img.width; x++) {
            const idx = (y * img.width + x) * 4;
            const gray = imgData.data[idx] / 255;
            const vidx = (y * img.width + x) * 3 + 2;
            vertices[vidx] = gray * 3;
          }
        }

        geometry.computeVertexNormals();
        const material = new THREE.MeshLambertMaterial({ color: 0xdddddd, side: THREE.DoubleSide });
        mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        camera.position.set(0, -15, 10);
        camera.lookAt(0, 0, 0);
      };
      img.src = URL.createObjectURL(file);
    });

    function animate() {
      requestAnimationFrame(animate);
      if (mesh) mesh.rotation.z += 0.002;
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
