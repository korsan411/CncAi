<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CNC AI Relief Preview</title>

    <!-- three.js -->
    <script src="https://unpkg.com/three@0.164.1/build/three.min.js"></script>
    <!-- OrbitControls -->
    <script src="https://unpkg.com/three@0.164.1/examples/js/controls/OrbitControls.js"></script>

    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #111;
        color: #fff;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      #uploader {
        background: #222;
        padding: 10px;
        border-bottom: 1px solid #444;
      }
      #buttons {
        background: #222;
        padding: 8px;
        text-align: center;
      }
      #viewer {
        flex: 1;
        position: relative;
      }
      #canvas2d,
      #viewer3d {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
      #viewer3d {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="uploader">
      <input type="file" id="imageInput" accept="image/*" />
    </div>

    <div id="buttons">
      <button id="btn2d">معاينة 2D</button>
      <button id="btn3d">معاينة 3D Relief</button>
    </div>

    <div id="viewer">
      <canvas id="canvas2d"></canvas>
      <div id="viewer3d"></div>
    </div>

    <script>
      const imageInput = document.getElementById("imageInput");
      const canvas2d = document.getElementById("canvas2d");
      const ctx2d = canvas2d.getContext("2d");
      const viewer3d = document.getElementById("viewer3d");
      let uploadedImg = null;

      // رفع الصورة
      imageInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = new Image();
          img.onload = () => {
            uploadedImg = img;
            show2d();
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      });

      // عرض 2D
      function show2d() {
        canvas2d.style.display = "block";
        viewer3d.style.display = "none";
        canvas2d.width = viewer.clientWidth;
        canvas2d.height = viewer.clientHeight;
        ctx2d.drawImage(uploadedImg, 0, 0, canvas2d.width, canvas2d.height);
      }

      // زر 2D
      document.getElementById("btn2d").addEventListener("click", () => {
        if (uploadedImg) show2d();
      });

      // زر 3D Relief
      document.getElementById("btn3d").addEventListener("click", () => {
        if (!uploadedImg) return;

        canvas2d.style.display = "none";
        viewer3d.style.display = "block";
        viewer3d.innerHTML = ""; // تنظيف القديم

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(
          45,
          viewer3d.clientWidth / viewer3d.clientHeight,
          0.1,
          1000
        );
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(viewer3d.clientWidth, viewer3d.clientHeight);
        viewer3d.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // إضاءة
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const light = new THREE.DirectionalLight(0xffffff, 0.8);
        light.position.set(1, 1, 2);
        scene.add(light);

        // تحويل الصورة إلى ارتفاعات
        const tempCanvas = document.createElement("canvas");
        const tempCtx = tempCanvas.getContext("2d");
        const size = 128;
        tempCanvas.width = size;
        tempCanvas.height = size;
        tempCtx.drawImage(uploadedImg, 0, 0, size, size);
        const imgData = tempCtx.getImageData(0, 0, size, size).data;

        const geometry = new THREE.PlaneGeometry(5, 5, size - 1, size - 1);
        for (let i = 0, j = 0; i < imgData.length; i += 4, j++) {
          const gray = imgData[i] * 0.3 + imgData[i + 1] * 0.59 + imgData[i + 2] * 0.11;
          const height = (gray / 255) * 1.5; // مقياس الارتفاع
          geometry.attributes.position.setZ(j, height);
        }
        geometry.computeVertexNormals();

        const material = new THREE.MeshStandardMaterial({
          color: 0xcccccc,
          side: THREE.DoubleSide,
          flatShading: true,
        });

        const relief = new THREE.Mesh(geometry, material);
        scene.add(relief);

        camera.position.set(0, 3, 6);
        controls.update();

        function animate() {
          requestAnimationFrame(animate);
          controls.update();
          renderer.render(scene, camera);
        }
        animate();
      });
    </script>
  </body>
</html>
