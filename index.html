<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>CncAi</title>
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f4f4f4; color:#333; }
    header { background:#222; color:#fff; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:20px; }
    header button { background:#444; color:#fff; border:none; padding:5px 10px; cursor:pointer; border-radius:6px; }
    .tabs { display:flex; background:#ddd; }
    .tabs button { flex:1; padding:10px; border:none; cursor:pointer; font-weight:bold; }
    .tabs button.active { background:#fff; border-bottom:3px solid #222; }
    .tab-content { display:none; padding:15px; }
    .tab-content.active { display:block; }
    canvas { border:1px solid #ccc; max-width:100%; }
    .preview-controls { margin:10px 0; }
    .preview-controls button { margin:2px; padding:5px 8px; border:none; border-radius:6px; cursor:pointer; background:#eee; }
    .form-group { margin:10px 0; }
    textarea { width:100%; height:150px; }
  </style>
</head>
<body>
  <header>
    <h1>CncAi</h1>
    <button onclick="toggleTheme()">🌙/☀️</button>
  </header>

  <!-- تبويبات -->
  <div class="tabs">
    <button class="active" onclick="openTab('preview')">📷 المعاينة</button>
    <button onclick="openTab('gcode')">⚙️ إعدادات G-code</button>
  </div>

  <!-- تبويب المعاينة -->
  <div id="preview" class="tab-content active">
    <input type="file" id="upload" accept="image/*"><br><br>
    <div class="preview-controls">
      <button onclick="setView('original')">الصورة</button>
      <button onclick="setView('heatmap')">Heatmap</button>
      <button onclick="setView('3d')">3D</button>
      <button onclick="changeColormap('jet')">Jet</button>
      <button onclick="changeColormap('hot')">Hot</button>
      <button onclick="changeColormap('cool')">Cool</button>
      <button onclick="changeColormap('gray')">Gray</button>
    </div>
    <canvas id="canvas" width="500" height="500"></canvas>
  </div>

  <!-- تبويب G-code -->
  <div id="gcode" class="tab-content">
    <div class="form-group">
      <label>العرض (مم):</label>
      <input type="number" id="width" value="100">
    </div>
    <div class="form-group">
      <label>الطول (مم):</label>
      <input type="number" id="height" value="100">
    </div>
    <div class="form-group">
      <label>عمق القطع (مم):</label>
      <input type="number" id="depth" value="2">
    </div>
    <div class="form-group">
      <label>سرعة التغذية (مم/دقيقة):</label>
      <input type="number" id="feedrate" value="500">
    </div>
    <button onclick="generateGCode()">توليد G-code</button>
    <button onclick="downloadGCode()">تحميل الملف</button>
    <textarea id="gcodeOutput" readonly></textarea>
    <h3>معاينة 2D للمسار:</h3>
    <canvas id="gcodeCanvas" width="500" height="500"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    let currentTab = 'preview';
    function openTab(tab) {
      document.querySelectorAll('.tab-content').forEach(div=>div.classList.remove('active'));
      document.querySelectorAll('.tabs button').forEach(btn=>btn.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      event.target.classList.add('active');
      currentTab = tab;
    }

    function toggleTheme() {
      document.body.classList.toggle('dark');
    }

    // --- المعاينة (نسخة مستقرة) ---
    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");
    let img = new Image();
    document.getElementById("upload").addEventListener("change", e => {
      let file = e.target.files[0];
      let reader = new FileReader();
      reader.onload = ev => { img.onload = () => ctx.drawImage(img,0,0,500,500); img.src = ev.target.result; };
      reader.readAsDataURL(file);
    });
    function setView(v){ /* placeholder */ }
    function changeColormap(m){ /* placeholder */ }

    // --- G-code ---
    function generateGCode(){
      let w = +document.getElementById("width").value;
      let h = +document.getElementById("height").value;
      let d = +document.getElementById("depth").value;
      let f = +document.getElementById("feedrate").value;
      let gcode = `G21 ; mm\nG90 ; absolute\nG1 Z5 F500\n`;
      for(let y=0;y<=h;y+=10){
        let dir = (y/10)%2==0?1:-1;
        for(let x=0;x<=w;x+=10){
          let X = dir==1?x:w-x;
          gcode += `G1 X${X} Y${y} Z-${d} F${f}\n`;
        }
      }
      gcode += "M30";
      document.getElementById("gcodeOutput").value = gcode;
      drawGcodePath(gcode);
    }

    function downloadGCode(){
      let text = document.getElementById("gcodeOutput").value;
      let blob = new Blob([text],{type:"text/plain"});
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "cnc.nc";
      a.click();
    }

    function drawGcodePath(code){
      let c = document.getElementById("gcodeCanvas");
      let cx = c.getContext("2d");
      cx.clearRect(0,0,c.width,c.height);
      cx.strokeStyle = "blue"; cx.beginPath();
      let x=0,y=0;
      code.split("\n").forEach(line=>{
        if(line.startsWith("G1")){
          let X = /X([\d\.\-]+)/.exec(line);
          let Y = /Y([\d\.\-]+)/.exec(line);
          if(X) x=+X[1]; if(Y) y=+Y[1];
          cx.lineTo(x/2,y/2);
        }
      });
      cx.stroke();
    }
  </script>
</body>
</html>
