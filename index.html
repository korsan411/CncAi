<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNC AI - Raster Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</title>
  <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #0f172a; 
      color: #e2e8f0; 
      margin: 0; 
      padding: 0; 
    }
    header { 
      background: #1e293b; 
      padding: 10px 20px; 
      font-size: 1.2rem; 
      color: #06b6d4; 
      text-align: center;
    }
    .container { 
      display: flex; 
      gap: 16px; 
      padding: 16px; 
      flex-wrap: wrap;
    }
    .panel { 
      background: #1e293b; 
      padding: 12px; 
      border-radius: 8px; 
      flex: 1; 
      min-width: 300px;
    }
    canvas { 
      max-width: 100%; 
      background: #000; 
      border-radius: 6px; 
      display: block; 
      margin: 10px auto; 
      border: 1px solid #334155;
    }
    label { 
      display: block; 
      margin-top: 8px; 
      font-weight: bold;
    }
    input, select { 
      padding: 6px; 
      border-radius: 6px; 
      border: 1px solid #334155; 
      background: #0f172a; 
      color: #e2e8f0; 
      width: 100%; 
      box-sizing: border-box;
      margin-top: 4px;
    }
    button { 
      margin-top: 10px; 
      padding: 10px; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-weight: bold;
    }
    button.primary { 
      background: #06b6d4; 
      color: #021; 
      width: 100%; 
    }
    button.primary:hover {
      background: #0891b2;
    }
    button.primary:disabled {
      background: #64748b;
      cursor: not-allowed;
    }
    #advancedSettings { 
      display: none; 
      margin-top: 10px; 
      padding: 10px; 
      background: #0f172a; 
      border: 1px solid #334155; 
      border-radius: 8px; 
    }
    .toggle-adv { 
      background: #334155; 
      color: #e2e8f0; 
      width: 100%; 
    }
    .toggle-adv:hover {
      background: #475569;
    }
    textarea { 
      width: 100%; 
      height: 200px; 
      margin-top: 10px; 
      border-radius: 6px; 
      background: #0f172a; 
      color: #cbd5e1; 
      border: 1px solid #334155; 
      padding: 8px; 
      box-sizing: border-box;
      font-family: monospace;
      resize: vertical;
    }
    .status {
      padding: 8px;
      border-radius: 4px;
      margin: 10px 0;
      text-align: center;
    }
    .status.loading {
      background: #f59e0b;
      color: #000;
    }
    .status.success {
      background: #10b981;
      color: #fff;
    }
    .status.error {
      background: #ef4444;
      color: #fff;
    }
    .file-input-container {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    .file-input-container input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .file-input-label {
      display: block;
      padding: 10px;
      background: #334155;
      color: #e2e8f0;
      text-align: center;
      border-radius: 6px;
      cursor: pointer;
      border: 1px dashed #64748b;
    }
    .file-input-label:hover {
      background: #475569;
    }
    h3 {
      color: #06b6d4;
      margin-top: 0;
    }
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>ğŸªµ CNC AI - Raster Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</header>
  <div class="container">
    <!-- Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
    <div class="panel">
      <h3>ğŸ–¼ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©</h3>
      <div class="file-input-container">
        <div class="file-input-label">ğŸ“ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„</div>
        <input type="file" id="fileInput" accept="image/*">
      </div>
      <div id="imageStatus" class="status"></div>
      <canvas id="canvasOriginal"></canvas>
    </div>

    <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div class="panel">
      <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
      <label>Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…): <input type="number" id="workWidth" value="30" min="1" step="0.1"></label>
      <label>Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…): <input type="number" id="workHeight" value="20" min="1" step="0.1"></label>
      <label>Ø¹Ù…Ù‚ Ø§Ù„Ø¹Ù…Ù„ (Ù…Ù…): <input type="number" id="workDepth" value="3.0" min="0.1" step="0.1"></label>
      <label>Ø³Ø±Ø¹Ø© Ø§Ù„ØªØºØ°ÙŠØ© (Ù…Ù…/Ø¯Ù‚ÙŠÙ‚Ø©): <input type="number" id="feedRate" value="800" min="1"></label>
      <label>Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø£Ù…Ø§Ù† Z (Ù…Ù…): <input type="number" id="safeZ" value="5" min="0.1" step="0.1"></label>
      <label>Ø®Ø·ÙˆØ© Ø§Ù„Ù…Ø³Ø­ (Ù…Ù…): <input type="number" id="stepOver" value="5" min="0.1" step="0.1"></label>

      <button class="toggle-adv" id="toggleAdvanced">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</button>
      <div id="advancedSettings">
        <label>ğŸª„ Ù†Ø¹ÙˆÙ…Ø© Ø§Ù„Ø³Ø·Ø­ (Smoothing):
          <select id="smoothing">
            <option value="none">Ø¨Ø¯ÙˆÙ†</option>
            <option value="low">Ù…Ù†Ø®ÙØ¶</option>
            <option value="medium">Ù…ØªÙˆØ³Ø·</option>
            <option value="high">Ø¹Ø§Ù„ÙŠ</option>
          </select>
        </label>
        <label>ğŸ“ Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø¹Ù…Ù‚ Z:
          <input type="number" id="zScale" value="1.0" min="0.1" step="0.1">
        </label>
        <label><input type="checkbox" id="invertZ"> Ø¹ÙƒØ³ Ø§Ù„Ø¹Ù…Ù‚ (Invert Z)</label>
        <label>â†”ï¸ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø³Ø­:
          <select id="scanDir">
            <option value="x">Ø£ÙÙ‚ÙŠ (X)</option>
            <option value="y">Ø¹Ù…ÙˆØ¯ÙŠ (Y)</option>
            <option value="diag">Ù‚Ø·Ø±ÙŠ</option>
          </select>
        </label>
        <label><input type="checkbox" id="detailFilter"> ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµØºÙŠØ±Ø©</label>
      </div>

      <button class="primary" id="btnGen" disabled>âš¡ ØªÙˆÙ„ÙŠØ¯ G-code (Raster)</button>
      <button class="primary" id="btnDownload" disabled>ğŸ’¾ ØªØ­Ù…ÙŠÙ„ G-code</button>
      <div id="gcodeStatus" class="status"></div>
      <textarea id="gcodeOut" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± G-code Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯"></textarea>
    </div>
  </div>

  <script>
    let grayMat = null;
    let previewCanvas = document.getElementById("canvasOriginal");
    let ctx = previewCanvas.getContext("2d");
    let currentImageName = "image";
    let openCvReady = false;

    // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ø§Ù‡Ø²ÙŠØ© OpenCV
    function onOpenCvReady() {
      openCvReady = true;
      updateStatus("imageStatus", "OpenCV Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…", "success");
      console.log("OpenCV loaded successfully");
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±
    function updateStatus(elementId, message, type = "") {
      const element = document.getElementById(elementId);
      element.textContent = message;
      element.className = "status " + type;
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    function updateButtons() {
      const hasImage = grayMat !== null;
      document.getElementById("btnGen").disabled = !hasImage || !openCvReady;
      document.getElementById("btnDownload").disabled = document.getElementById("gcodeOut").value === "";
    }

    // Ø²Ø± ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
    document.getElementById("toggleAdvanced").addEventListener("click", () => {
      const adv = document.getElementById("advancedSettings");
      adv.style.display = adv.style.display === "block" ? "none" : "block";
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
    document.getElementById("fileInput").addEventListener("change", e => {
      const f = e.target.files[0];
      if (!f) return;
      
      if (!openCvReady) {
        updateStatus("imageStatus", "OpenCV Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ø¹Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...", "error");
        return;
      }
      
      currentImageName = f.name.replace(/\.[^/.]+$/, "");
      const img = new Image();
      
      img.onload = () => {
        try {
          // ØªØ¹ÙŠÙŠÙ† Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
          const maxWidth = 500;
          const maxHeight = 400;
          let width = img.width;
          let height = img.height;
          
          if (width > maxWidth) {
            height = (maxWidth / width) * height;
            width = maxWidth;
          }
          
          if (height > maxHeight) {
            width = (maxHeight / height) * width;
            height = maxHeight;
          }
          
          previewCanvas.width = width;
          previewCanvas.height = height;
          
          // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³
          ctx.drawImage(img, 0, 0, width, height);
          
          // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ØªØ¯Ø±Ø¬ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OpenCV
          if (grayMat) grayMat.delete();
          
          let src = cv.imread(previewCanvas);
          grayMat = new cv.Mat();
          cv.cvtColor(src, grayMat, cv.COLOR_RGBA2GRAY);
          src.delete();
          
          updateStatus("imageStatus", "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­", "success");
          updateButtons();
        } catch (error) {
          console.error("Error processing image:", error);
          updateStatus("imageStatus", "Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©: " + error.message, "error");
        }
      };
      
      img.onerror = () => {
        updateStatus("imageStatus", "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©", "error");
      };
      
      updateStatus("imageStatus", "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...", "loading");
      img.src = URL.createObjectURL(f);
    });

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    function applySmoothing(mat) {
      let out = new cv.Mat();
      let s = document.getElementById("smoothing").value;
      
      try {
        if (s === "low") {
          cv.GaussianBlur(mat, out, new cv.Size(3, 3), 0);
        } else if (s === "medium") {
          cv.GaussianBlur(mat, out, new cv.Size(5, 5), 0);
        } else if (s === "high") {
          cv.GaussianBlur(mat, out, new cv.Size(9, 9), 0);
        } else {
          mat.copyTo(out);
        }
      } catch (error) {
        console.error("Error applying smoothing:", error);
        mat.copyTo(out);
      }
      
      return out;
    }

    // ØªÙˆÙ„ÙŠØ¯ G-code Raster
    function generateRasterGcode() {
      if (!grayMat) {
        updateStatus("gcodeStatus", "Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯", "error");
        return "";
      }
      
      try {
        updateStatus("gcodeStatus", "Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ G-code...", "loading");
        
        let workWidth = parseFloat(document.getElementById("workWidth").value) * 10; // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù…Ù…
        let workHeight = parseFloat(document.getElementById("workHeight").value) * 10; // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù…Ù…
        let maxDepth = parseFloat(document.getElementById("workDepth").value);
        let feed = parseFloat(document.getElementById("feedRate").value);
        let safeZ = parseFloat(document.getElementById("safeZ").value);
        let stepOver = parseFloat(document.getElementById("stepOver").value);
        let zScale = parseFloat(document.getElementById("zScale").value) || 1.0;
        let invertZ = document.getElementById("invertZ").checked;
        let scanDir = document.getElementById("scanDir").value;
        let detailFilter = document.getElementById("detailFilter").checked;

        let src = applySmoothing(grayMat);
        let w = src.cols, h = src.rows;

        // ÙÙ„ØªØ±Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
        if (detailFilter) {
          let tmp = new cv.Mat();
          cv.resize(src, tmp, new cv.Size(Math.floor(w/2), Math.floor(h/2)), 0, 0, cv.INTER_AREA);
          src.delete();
          src = tmp;
          w = src.cols; 
          h = src.rows;
        }

        let lines = [];
        lines.push("; Raster G-code Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©");
        lines.push("; ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø¨ÙˆØ§Ø³Ø·Ø© CNC AI Raster");
        lines.push(`; Ø§Ù„ØµÙˆØ±Ø©: ${currentImageName}`);
        lines.push(`; Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯: ${workWidth/10} Ø³Ù… Ã— ${workHeight/10} Ø³Ù…`);
        lines.push(`; Ø§Ù„Ø¹Ù…Ù‚ Ø§Ù„Ø£Ù‚ØµÙ‰: ${maxDepth} Ù…Ù…`);
        lines.push("G21 G90 G17 ; Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù„ÙŠÙ…ØªØ±ØŒ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„Ù‚Ø©ØŒ Ù…Ø³ØªÙˆÙ‰ XY");
        lines.push("G0 Z" + safeZ.toFixed(2) + " ; Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø£Ù…Ø§Ù†");

        let scaleX = workWidth / w;
        let scaleY = workHeight / h;

        if (scanDir === "x") {
          for (let y = 0; y < h; y += stepOver) {
            let row = [];
            let firstPoint = true;
            
            for (let x = 0; x < w; x++) {
              let v = src.ucharPtr(y, x)[0];
              let z = ((255 - v) / 255) * maxDepth * zScale;
              if (invertZ) z = maxDepth - z;
              
              if (firstPoint) {
                row.push(`G0 X${(x * scaleX).toFixed(2)} Y${(y * scaleY).toFixed(2)} ; Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©`);
                row.push(`G1 Z${z.toFixed(3)} F${feed/2} ; Ø§Ù„Ù‡Ø¨ÙˆØ· Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Z`);
                firstPoint = false;
              } else {
                row.push(`G1 X${(x * scaleX).toFixed(2)} Y${(y * scaleY).toFixed(2)} Z${z.toFixed(3)} F${feed}`);
              }
            }
            
            if (row.length) {
              lines.push(...row);
              lines.push("G0 Z" + safeZ.toFixed(2) + " ; Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ù…Ø§Ù†");
            }
          }
        } else if (scanDir === "y") {
          for (let x = 0; x < w; x += stepOver) {
            let col = [];
            let firstPoint = true;
            
            for (let y = 0; y < h; y++) {
              let v = src.ucharPtr(y, x)[0];
              let z = ((255 - v) / 255) * maxDepth * zScale;
              if (invertZ) z = maxDepth - z;
              
              if (firstPoint) {
                col.push(`G0 X${(x * scaleX).toFixed(2)} Y${(y * scaleY).toFixed(2)} ; Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©`);
                col.push(`G1 Z${z.toFixed(3)} F${feed/2} ; Ø§Ù„Ù‡Ø¨ÙˆØ· Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Z`);
                firstPoint = false;
              } else {
                col.push(`G1 X${(x * scaleX).toFixed(2)} Y${(y * scaleY).toFixed(2)} Z${z.toFixed(3)} F${feed}`);
              }
            }
            
            if (col.length) {
              lines.push(...col);
              lines.push("G0 Z" + safeZ.toFixed(2) + " ; Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ù…Ø§Ù†");
            }
          }
        } else {
          // Ù…Ø³Ø­ Ù‚Ø·Ø±ÙŠ Ø¨Ø³ÙŠØ·
          let max = Math.max(w, h);
          for (let d = 0; d < max; d += stepOver) {
            let diag = [];
            let firstPoint = true;
            
            for (let x = 0; x <= d; x++) {
              let y = d - x;
              if (x < w && y < h) {
                let v = src.ucharPtr(y, x)[0];
                let z = ((255 - v) / 255) * maxDepth * zScale;
                if (invertZ) z = maxDepth - z;
                
                if (firstPoint) {
                  diag.push(`G0 X${(x * scaleX).toFixed(2)} Y${(y * scaleY).toFixed(2)} ; Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©`);
                  diag.push(`G1 Z${z.toFixed(3)} F${feed/2} ; Ø§Ù„Ù‡Ø¨ÙˆØ· Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Z`);
                  firstPoint = false;
                } else {
                  diag.push(`G1 X${(x * scaleX).toFixed(2)} Y${(y * scaleY).toFixed(2)} Z${z.toFixed(3)} F${feed}`);
                }
              }
            }
            
            if (diag.length) {
              lines.push(...diag);
              lines.push("G0 Z" + safeZ.toFixed(2) + " ; Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¥Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ù…Ø§Ù†");
            }
          }
        }

        lines.push("G0 Z" + safeZ.toFixed(2) + " ; Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø£Ù…Ø§Ù†");
        lines.push("G0 X0 Y0 ; Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„ØµÙØ±");
        lines.push("M30 ; Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬");

        src.delete();
        
        updateStatus("gcodeStatus", "ØªÙ… ØªÙˆÙ„ÙŠØ¯ G-code Ø¨Ù†Ø¬Ø§Ø­", "success");
        return lines.join("\n");
      } catch (error) {
        console.error("Error generating G-code:", error);
        updateStatus("gcodeStatus", "Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ G-code: " + error.message, "error");
        return "";
      }
    }

    // Ø£Ø²Ø±Ø§Ø±
    document.getElementById("btnGen").addEventListener("click", () => {
      const gcode = generateRasterGcode();
      document.getElementById("gcodeOut").value = gcode;
      updateButtons();
    });

    document.getElementById("btnDownload").addEventListener("click", () => {
      let g = document.getElementById("gcodeOut").value;
      if (!g) {
        updateStatus("gcodeStatus", "Ù„Ø§ ÙŠÙˆØ¬Ø¯ G-code Ù„ØªØ­Ù…ÙŠÙ„Ù‡", "error");
        return;
      }
      
      try {
        let a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([g], {type: "text/plain"}));
        a.download = currentImageName + "_raster.gcode";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        updateStatus("gcodeStatus", "ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­", "success");
      } catch (error) {
        console.error("Error downloading file:", error);
        updateStatus("gcodeStatus", "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù", "error");
      }
    });

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.addEventListener("DOMContentLoaded", () => {
      updateButtons();
      updateStatus("imageStatus", "Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„", "");
      updateStatus("gcodeStatus", "", "");
    });
  </script>
</body>
</html>
