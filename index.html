<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CNC AI Preview</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f8f8f8;
      color: #333;
    }
    header {
      background: #4a90e2;
      color: white;
      padding: 12px;
      text-align: center;
    }
    header input {
      margin-top: 8px;
    }
    .preview-section {
      text-align: center;
      padding: 20px;
    }
    canvas, .three-container {
      border: 1px solid #ccc;
      margin: 10px 0;
      background: white;
    }
    .three-container {
      display: inline-block;
    }
    h2 {
      margin-top: 15px;
      font-size: 18px;
      color: #555;
    }
  </style>
</head>
<body>
  <header>
    <h1>CNC AI Preview</h1>
    <input type="file" id="fileInput" accept="image/*">
  </header>

  <!-- Original Image -->
  <div class="preview-section">
    <canvas id="previewOriginal" width="400" height="400"></canvas>
    <h2>الصورة الأصلية</h2>
  </div>

  <!-- Heatmap -->
  <div class="preview-section">
    <canvas id="previewHeatmap" width="400" height="400"></canvas>
    <h2>معاينة Heatmap (ألوان تحدد الارتفاع)</h2>
  </div>

  <!-- 3D Preview -->
  <div class="preview-section">
    <div id="preview3d" class="three-container" style="width:400px; height:400px;"></div>
    <h2>معاينة ثلاثية الأبعاد</h2>
  </div>

  <!-- three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const canvasOriginal = document.getElementById('previewOriginal');
    const ctxOriginal = canvasOriginal.getContext('2d');

    const canvasHeatmap = document.getElementById('previewHeatmap');
    const ctxHeatmap = canvasHeatmap.getContext('2d');

    const preview3d = document.getElementById('preview3d');

    // إعداد مشهد 3D
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(400, 400);
    preview3d.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(0, 1, 1).normalize();
    scene.add(light);
    camera.position.set(0, -150, 150);
    controls.update();

    let mesh;

    // إنشاء خريطة ارتفاعات 3D
    function createHeightMap(image) {
      const w = 100, h = 100;
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = w; tempCanvas.height = h;
      const tctx = tempCanvas.getContext('2d');
      tctx.drawImage(image, 0, 0, w, h);
      const imgData = tctx.getImageData(0, 0, w, h).data;

      const geometry = new THREE.PlaneGeometry(100, 100, w-1, h-1);
      for (let i = 0; i < geometry.attributes.position.count; i++) {
        const stride = i * 3;
        const x = i % w;
        const y = Math.floor(i / w);
        const idx = (y * w + x) * 4;
        const brightness = imgData[idx]; // grayscale
        geometry.attributes.position.array[stride + 2] = brightness / 4;
      }
      geometry.computeVertexNormals();

      const material = new THREE.MeshLambertMaterial({ color: 0xaaaaaa, side: THREE.DoubleSide });
      if (mesh) scene.remove(mesh);
      mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);
    }

    // رسم Heatmap
    function drawHeatmap(image) {
      const w = canvasHeatmap.width;
      const h = canvasHeatmap.height;
      ctxHeatmap.drawImage(image, 0, 0, w, h);
      const imgData = ctxHeatmap.getImageData(0, 0, w, h);
      const data = imgData.data;

      for (let i = 0; i < data.length; i += 4) {
        const brightness = data[i]; // grayscale
        const color = getHeatColor(brightness);
        data[i] = color[0];
        data[i+1] = color[1];
        data[i+2] = color[2];
      }
      ctxHeatmap.putImageData(imgData, 0, 0);
    }

    // ألوان Heatmap متدرجة
    function getHeatColor(value) {
      const ratio = value / 255;
      const r = Math.floor(255 * ratio);
      const g = Math.floor(255 * (1 - Math.abs(ratio - 0.5) * 2));
      const b = Math.floor(255 * (1 - ratio));
      return [r, g, b];
    }

    // أنيميشن 3D
    function animate() {
      requestAnimationFrame(animate);
      if (mesh) mesh.rotation.y += 0.005;
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // رفع صورة
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        // الصورة الأصلية
        canvasOriginal.width = 400;
        canvasOriginal.height = 400;
        ctxOriginal.drawImage(img, 0, 0, 400, 400);

        // Heatmap
        drawHeatmap(img);

        // 3D
        createHeightMap(img);
      };
      img.src = URL.createObjectURL(file);
    });
  </script>
</body>
</html>
