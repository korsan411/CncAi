<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CNC Ai - 3D Preview</title>
  <style>
    body { margin: 0; background: #111; color: white; font-family: Arial, sans-serif; }
    #upload { margin: 20px; }
    #progress-container {
      width: 100%; height: 20px; background: #333; margin: 10px 0;
    }
    #progress-bar {
      height: 100%; width: 0%; background: lime; transition: width 0.2s;
    }
    canvas { display: block; }
  </style>
</head>
<body>
  <input type="file" id="upload" accept="image/*" />
  <div id="progress-container"><div id="progress-bar"></div></div>
  <div id="preview3d"></div>

  <!-- three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>

  <script>
    const upload = document.getElementById("upload");
    const progressBar = document.getElementById("progress-bar");
    const preview3d = document.getElementById("preview3d");

    // إعداد الـ scene
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 4, 4);
    camera.lookAt(0, 0, 0);

    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    preview3d.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // إضاءة
    scene.add(new THREE.AmbientLight(0xffffff, 0.8));
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(5, 5, 5);
    scene.add(dirLight);

    let mesh = null;

    // تحميل صورة ومعالجتها
    upload.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = ev => {
        const img = new Image();
        img.onload = () => {
          // تقليل الحجم للسرعة
          const canvas2d = document.createElement("canvas");
          const ctx = canvas2d.getContext("2d");
          canvas2d.width = 100;
          canvas2d.height = 100;
          ctx.drawImage(img, 0, 0, canvas2d.width, canvas2d.height);

          const imageData = ctx.getImageData(0, 0, canvas2d.width, canvas2d.height).data;
          const width = canvas2d.width;
          const height = canvas2d.height;

          const geometry = new THREE.PlaneGeometry(4, 4, width - 1, height - 1);
          const positions = geometry.attributes.position.array;

          let i = 0;
          const total = width * height;

          function processChunk() {
            let count = 0;
            while (i < total && count < 500) {
              const x = i % width;
              const y = Math.floor(i / width);
              const idx = (y * width + x) * 4;
              const brightness = (imageData[idx] + imageData[idx+1] + imageData[idx+2]) / 3 / 255;

              // التعديل هنا: نكتب مباشرة في المصفوفة
              positions[i * 3 + 2] = brightness * 1.5;

              i++;
              count++;
            }
            geometry.attributes.position.needsUpdate = true;

            const progress = (i / total) * 100;
            progressBar.style.width = progress + "%";

            if (i < total) {
              requestAnimationFrame(processChunk);
            } else {
              geometry.computeVertexNormals();
              const material = new THREE.MeshStandardMaterial({
                color: 0x00ffcc,
                side: THREE.DoubleSide,
                flatShading: true
              });

              if (mesh) scene.remove(mesh);
              mesh = new THREE.Mesh(geometry, material);
              mesh.rotation.x = -Math.PI / 2;
              scene.add(mesh);
            }
          }
          processChunk();
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Render loop
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
