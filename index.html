<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>CNC AI — Multi Machine Raster Engraving</title>

    <!-- مكتبات -->
    <script src="https://docs.opencv.org/4.8.0/opencv.js" async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

    <style>
        /* الأساسيات */
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: Arial, Segoe UI, system-ui;
            background: #041022;
            color: #e6eef6;
            line-height: 1.5;
        }
        
        /* التخطيط الرئيسي */
        .app {
            max-width: 1400px;
            margin: 16px auto;
            padding: 14px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #1e293b;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 480px;
            gap: 16px;
        }
        
        @media (max-width: 1000px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* اللوحات */
        .panel {
            background: #0b1320;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid #1e293b;
        }
        
        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #1e293b;
        }
        
        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        /* التبويبات */
        .tabs {
            display: flex;
            margin-top: 12px;
            border-bottom: 1px solid #1e293b;
        }
        
        .tabs button {
            margin-left: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            background: transparent;
            color: #9bb0c8;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .tabs button:hover {
            background: #1e293b;
        }
        
        .tabs button.active {
            background: #06b6d4;
            color: #021;
        }
        
        .tab-content {
            display: none;
            margin-top: 12px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* العناصر المرئية */
        canvas {
            max-width: 100%;
            border-radius: 6px;
            background: #000;
            display: block;
            margin: 0 auto;
            border: 1px solid #334155;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            background: #021024;
            color: #cfeaf2;
            font-family: monospace;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #1e293b;
            resize: vertical;
        }
        
        #threeContainer {
            width: 100%;
            height: 400px;
            background: #081224;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .simulation-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            display: flex;
            gap: 8px;
        }
        
        .simulation-controls button {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid #06b6d4;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .simulation-controls button:hover {
            background: rgba(6, 182, 212, 0.3);
        }
        
        .simulation-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        /* النماذج */
        label {
            display: block;
            margin-top: 12px;
            color: #cfeaf2;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        input, select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #1e293b;
            background: #0f172a;
            color: #e6eef6;
            margin-top: 6px;
            font-size: 0.9rem;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #06b6d4;
        }
        
        /* الأزرار */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
        }
        
        button {
            background: #1e293b;
            color: #e6eef6;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
        }
        
        button:hover {
            background: #334155;
        }
        
        button.primary {
            background: #06b6d4;
            color: #021;
            font-weight: bold;
        }
        
        button.primary:hover {
            background: #0ea5e9;
        }
        
        /* التنبيهات */
        #toast {
            position: fixed;
            left: 16px;
            bottom: 16px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            display: none;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* النصوص */
        h1 {
            margin: 0;
            color: #06b6d4;
            font-size: 1.5rem;
        }
        
        h3 {
            margin-top: 0;
            color: #9bb0c8;
            font-size: 1.1rem;
            padding-bottom: 8px;
            border-bottom: 1px solid #1e293b;
        }
        
        #cvState {
            color: #9bb0c8;
            font-size: 0.9em;
            padding: 6px 10px;
            background: #0f172a;
            border-radius: 6px;
        }
        
        #estTime {
            margin-top: 12px;
            color: #9bb0c8;
            text-align: center;
            padding: 8px;
            background: #0f172a;
            border-radius: 6px;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-container input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: block;
            padding: 10px;
            background: #1e293b;
            color: #e6eef6;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            border: 2px dashed #334155;
        }
        
        .file-input-label:hover {
            background: #334155;
        }
        
        .info-text {
            font-size: 0.8rem;
            color: #9bb0c8;
            margin-top: 4px;
        }
        
        .settings-row {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        
        .settings-row .input-group {
            flex: 1;
        }
        
        .material-preset {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .material-preset:hover {
            background: #334155;
        }
        
        .material-preset.active {
            background: #06b6d4;
            color: #021;
            border-color: #06b6d4;
        }
        
        .material-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .material-details {
            font-size: 0.8rem;
            color: #9bb0c8;
        }
        
        .active-material .material-details {
            color: #021;
        }
        
        .dimension-info {
            font-size: 0.8rem;
            color: #06b6d4;
            margin-top: 4px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #1e293b;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #06b6d4;
            width: 0%;
            transition: width 0.3s;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #06b6d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .canvas-placeholder {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9bb0c8;
            border: 1px solid #334155;
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <h1>CNC AI — Multi Machine Raster Engraving</h1>
            <div id="cvState">
                <span class="loading"></span>جاري تحميل OpenCV...
            </div>
        </header>

        <div class="grid">
            <!-- لوحة الصورة والمعاينة -->
            <div class="panel">
                <div class="file-input-container">
                    <input id="fileInput" type="file" accept="image/*"/>
                    <label class="file-input-label" for="fileInput">📁 اختر صورة للتحميل</label>
                </div>
                
                <div class="tabs">
                    <button data-tab="original" class="active">🖼️ الصورة الأصلية</button>
                    <button data-tab="heatmap">🔥 خريطة الحرارة</button>
                    <button data-tab="contour">📐 الكشف عن الحواف</button>
                    <button data-tab="simulation">🎬 محاكاة التشغيل</button>
                </div>
                
                <div id="original" class="tab-content active">
                    <div class="canvas-placeholder" id="originalPlaceholder">
                        سيتم عرض الصورة هنا
                    </div>
                    <canvas id="canvasOriginal" style="display: none;"></canvas>
                </div>
                
                <div id="heatmap" class="tab-content">
                    <div class="canvas-placeholder" id="heatmapPlaceholder">
                        خريطة الحرارة ستظهر هنا بعد تحميل الصورة
                    </div>
                    <canvas id="canvasHeatmap" style="display: none;"></canvas>
                </div>
                
                <div id="contour" class="tab-content">
                    <div class="canvas-placeholder" id="contourPlaceholder">
                        كشف الحواف سيظهر هنا بعد تحميل الصورة
                    </div>
                    <canvas id="canvasContour" style="display: none;"></canvas>
                </div>
                
                <div id="simulation" class="tab-content">
                    <div id="threeContainer">
                        <div class="canvas-placeholder" id="simulationPlaceholder">
                            محاكاة التشغيل ستظهر هنا بعد توليد G-code
                        </div>
                    </div>
                </div>
            </div>

            <!-- لوحة التحكم والإعدادات -->
            <div class="panel">
                <!-- إعدادات الماكينة -->
                <div class="panel-section">
                    <h3>⚙️ إعدادات الماكينة</h3>
                    
                    <label for="machineType">
                        نوع الماكينة
                    </label>
                    <select id="machineType">
                        <option value="router">Router CNC</option>
                        <option value="laser">Laser Engraver</option>
                        <option value="plasma">Plasma Cutter</option>
                        <option value="3dprinter">3D Printer</option>
                    </select>
                    
                    <div class="info-text" id="machineDescription">
                        Router CNC - مناسبة للنحت على الخشب والأكريليك والمعادن اللينة
                    </div>
                </div>
                
                <!-- إعدادات حجم العمل -->
                <div class="panel-section">
                    <h3>📏 إعدادات حجم العمل</h3>
                    
                    <div class="input-group">
                        <div>
                            <label for="workWidth">
                                عرض العمل (سم)
                            </label>
                            <input id="workWidth" type="number" value="30" step="0.1" min="1" max="100"/>
                            <div class="dimension-info" id="widthMm">300.0 مم</div>
                        </div>
                        
                        <div>
                            <label for="workHeight">
                                ارتفاع العمل (سم)
                            </label>
                            <input id="workHeight" type="number" value="20" step="0.1" min="1" max="100"/>
                            <div class="dimension-info" id="heightMm">200.0 مم</div>
                        </div>
                    </div>
                    
                    <label for="workDepth">
                        عمق العمل (مم)
                    </label>
                    <input id="workDepth" type="number" value="3.0" step="0.1" min="0.1" max="20"/>
                    
                    <div class="settings-row">
                        <div class="input-group">
                            <div>
                                <label for="originX">
                                    نقطة الأصل X (سم)
                                </label>
                                <input id="originX" type="number" value="0" step="0.1"/>
                            </div>
                            
                            <div>
                                <label for="originY">
                                    نقطة الأصل Y (سم)
                                </label>
                                <input id="originY" type="number" value="0" step="0.1"/>
                            </div>
                        </div>
                        
                        <button id="btnCenterOrigin" class="secondary">🎯 توسيط نقطة الأصل</button>
                    </div>
                </div>
                
                <!-- إعدادات الخامة -->
                <div class="panel-section">
                    <h3>📦 إعدادات الخامة</h3>
                    
                    <label for="materialType">
                        نوع الخامة
                    </label>
                    <select id="materialType">
                        <option value="wood">خشب</option>
                        <option value="acrylic">أكريليك</option>
                        <option value="aluminum">ألومنيوم</option>
                        <option value="steel">صلب</option>
                        <option value="brass">نحاس</option>
                        <option value="plastic">بلاستيك</option>
                        <option value="foam">رغوة</option>
                        <option value="custom">مخصص</option>
                    </select>
                    
                    <div id="materialPresets">
                        <!-- سيتم تعبئتها بالجافاسكريبت -->
                    </div>
                </div>
                
                <!-- إعدادات التشغيل -->
                <div class="panel-section">
                    <h3>🚀 إعدادات التشغيل</h3>
                    
                    <label for="feedRate">
                        سرعة التغذية (مم/دقيقة)
                    </label>
                    <input id="feedRate" type="number" value="800" min="10" max="5000"/>
                    
                    <label for="safeZ">
                        ارتفاع الأمان (مم)
                    </label>
                    <input id="safeZ" type="number" value="5" step="0.1" min="0" max="50"/>
                    
                    <label for="invertZ">
                        عكس المحور Z
                    </label>
                    <select id="invertZ">
                        <option value="no">لا</option>
                        <option value="yes">نعم</option>
                    </select>
                    
                    <label for="scanDir">
                        اتجاه المسارات
                    </label>
                    <select id="scanDir">
                        <option value="x">أفقي (X)</option>
                        <option value="y">رأسي (Y)</option>
                    </select>
                    
                    <label for="stepOver">
                        خطوة المسح (مم)
                    </label>
                    <input id="stepOver" type="number" value="5" step="0.1" min="0.1" max="20"/>
                    
                    <label for="maxDepth">
                        أقصى عمق (مم)
                    </label>
                    <input id="maxDepth" type="number" value="3.0" step="0.1" min="0.1" max="20"/>
                </div>

                <!-- أزرار التحكم -->
                <div class="button-group">
                    <button id="btnGen" class="primary">⚡ توليد G-code</button>
                    <button id="btnQuick" class="secondary">🧪 اختبار سريع</button>
                    <button id="btnDownload" class="secondary">💾 تحميل G-code</button>
                </div>
                
                <div id="estTime"></div>
                
                <label for="gcodeOut" style="margin-top: 16px;">📄 مخرجات G-code</label>
                <textarea id="gcodeOut" readonly placeholder="سيظهر G-code هنا بعد التوليد..."></textarea>
            </div>
        </div>
    </div>
    
    <div id="toast"></div>

    <script>
        // ========== تعريف المتغيرات العامة ==========
        let cvReady = false;
        let grayMat = null;
        let contour = null;
        let previewCanvas = null;
        
        // محاكاة ثلاثية الأبعاد
        let scene, camera, renderer, controls;
        let simulation = {
            isPlaying: false,
            speed: 1,
            currentLine: 0,
            totalLines: 0,
            animationId: null
        };

        // إعدادات الماكينات الافتراضية
        const machineDefaults = {
            router: { 
                feed: 800, 
                safeZ: 5, 
                maxDepth: 3, 
                stepOver: 5,
                description: "Router CNC - مناسبة للنحت على الخشب والأكريليك والمعادن اللينة"
            },
            laser: { 
                feed: 1200, 
                safeZ: 0, 
                maxDepth: 0, 
                stepOver: 0.2,
                description: "Laser Engraver - مناسبة للنقش على الخشب والجلود والأكريليك"
            },
            plasma: { 
                feed: 1500, 
                safeZ: 3, 
                maxDepth: 0, 
                stepOver: 1,
                description: "Plasma Cutter - مناسبة لقطع المعادن بسمك مختلف"
            },
            "3dprinter": { 
                feed: 1000, 
                safeZ: 0.2, 
                maxDepth: 0.2, 
                stepOver: 0.4,
                description: "3D Printer - للطباعة ثلاثية الأبعاد باستخدام تقنية FDM"
            }
        };

        // ========== وظائف المساعدة ==========
        
        /**
         * عرض رسالة تنبيه
         */
        function showToast(msg, ms = 3000) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            clearTimeout(t._t);
            t._t = setTimeout(() => t.style.display = 'none', ms);
        }
        
        /**
         * تحويل السنتيمتر إلى ملليمتر
         */
        function cmToMm(cm) {
            return cm * 10;
        }
        
        /**
         * تحديث عرض الأبعاد بالملليمتر
         */
        function updateDimensionDisplay() {
            const widthCm = parseFloat(document.getElementById('workWidth').value) || 0;
            const heightCm = parseFloat(document.getElementById('workHeight').value) || 0;
            
            document.getElementById('widthMm').textContent = cmToMm(widthCm).toFixed(1) + ' مم';
            document.getElementById('heightMm').textContent = cmToMm(heightCm).toFixed(1) + ' مم';
        }

        /**
         * إظهار العنصر وإخفاء العنصر البديل
         */
        function showElement(elementId, hidePlaceholderId) {
            const element = document.getElementById(elementId);
            const placeholder = document.getElementById(hidePlaceholderId);
            
            if (element && placeholder) {
                element.style.display = 'block';
                placeholder.style.display = 'none';
            }
        }

        // ========== تهيئة OpenCV ==========
        
        /**
         * انتظار تحميل OpenCV
         */
        function waitForCv() {
            if (typeof cv !== 'undefined' && cv.getBuildInformation) {
                cvReady = true;
                document.getElementById('cvState').innerHTML = '✅ OpenCV جاهز';
                showToast('تم تحميل OpenCV بنجاح', 2000);
            } else {
                setTimeout(waitForCv, 100);
            }
        }

        // بدء انتظار OpenCV
        waitForCv();

        // ========== إدارة التبويبات ==========
        
        document.querySelectorAll('.tabs button').forEach(btn => {
            btn.addEventListener('click', () => {
                // إزالة النشاط من جميع الأزرار
                document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                
                // إضافة النشاط للزر المحدد
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // ========== معالجة تحميل الصور ==========
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // التحقق من نوع الملف
            if (!file.type.match('image.*')) {
                showToast('الرجاء اختيار ملف صورة فقط');
                return;
            }
            
            const img = new Image();
            img.onload = function() {
                previewCanvas = document.getElementById('canvasOriginal');
                const ctx = previewCanvas.getContext('2d');
                
                // تحديد أبعاد مناسبة للعرض
                const maxWidth = 600;
                const maxHeight = 400;
                let width = img.width;
                let height = img.height;
                
                if (width > maxWidth) {
                    height = (maxWidth / width) * height;
                    width = maxWidth;
                }
                if (height > maxHeight) {
                    width = (maxHeight / height) * width;
                    height = maxHeight;
                }
                
                previewCanvas.width = width;
                previewCanvas.height = height;
                
                // رسم الصورة على Canvas
                ctx.drawImage(img, 0, 0, width, height);
                
                // إظهار Canvas وإخفاء العنصر النائب
                showElement('canvasOriginal', 'originalPlaceholder');
                
                if (cvReady) {
                    detectContours();
                } else {
                    showToast('جاري انتظار تحميل OpenCV...');
                    // إعادة المحاولة بعد ثانية
                    setTimeout(() => {
                        if (cvReady) detectContours();
                    }, 1000);
                }
            };
            
            img.onerror = function() {
                showToast('خطأ في تحميل الصورة');
            };
            
            img.src = URL.createObjectURL(file);
        });

        // ========== معالجة الصور والرؤية الحاسوبية ==========
        
        /**
         * الكشف عن الحواف في الصورة
         */
        function detectContours() {
            if (!cvReady) {
                showToast('OpenCV غير جاهز بعد');
                return;
            }
            
            try {
                // تحميل الصورة إلى OpenCV
                const src = cv.imread(previewCanvas);
                const gray = new cv.Mat();
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                
                // تطبيق Gaussian Blur
                const blurred = new cv.Mat();
                cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
                
                // كشف الحواف باستخدام Canny
                const edges = new cv.Mat();
                cv.Canny(blurred, edges, 50, 150);
                
                // إيجاد الكنتورات
                const contours = new cv.MatVector();
                const hierarchy = new cv.Mat();
                cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                
                // اختيار أكبر كونتور
                let maxArea = 0;
                let maxContour = null;
                
                for (let i = 0; i < contours.size(); i++) {
                    const cnt = contours.get(i);
                    const area = cv.contourArea(cnt);
                    if (area > maxArea) {
                        maxArea = area;
                        if (maxContour) maxContour.delete();
                        maxContour = cnt;
                    }
                }
                
                if (maxContour) {
                    contour = maxContour;
                    
                    // حفظ الصورة الرمادية للمعالجة اللاحقة
                    if (grayMat) grayMat.delete();
                    grayMat = gray.clone();
                    
                    // عرض خريطة الحرارة
                    renderHeatmap(gray);
                    
                    // عرض الكنتور
                    renderContour(gray, maxContour);
                    
                    showToast('تم كشف الحواف بنجاح');
                }
                
                // تنظيف الذاكرة
                src.delete();
                blurred.delete();
                edges.delete();
                hierarchy.delete();
                contours.delete();
                
            } catch (error) {
                console.error('Error in detectContours:', error);
                showToast('خطأ في معالجة الصورة');
            }
        }

        /**
         * عرض خريطة الحرارة
         */
        function renderHeatmap(gray) {
            const heatCanvas = document.getElementById('canvasHeatmap');
            const ctx = heatCanvas.getContext('2d');
            
            heatCanvas.width = gray.cols;
            heatCanvas.height = gray.rows;
            
            // إنشاء صورة البيانات
            const imgData = ctx.createImageData(heatCanvas.width, heatCanvas.height);
            
            for (let i = 0; i < gray.data.length; i++) {
                const value = gray.data[i];
                const idx = i * 4;
                
                // تدرج ألوان من الأزرق إلى الأحمر
                imgData.data[idx] = value;         // الأحمر
                imgData.data[idx + 1] = 0;         // الأخضر
                imgData.data[idx + 2] = 255 - value; // الأزرق
                imgData.data[idx + 3] = 255;       // الشفافية
            }
            
            ctx.putImageData(imgData, 0, 0);
            showElement('canvasHeatmap', 'heatmapPlaceholder');
        }

        /**
         * عرض الكنتور
         */
        function renderContour(gray, contour) {
            const contourCanvas = document.getElementById('canvasContour');
            const ctx = contourCanvas.getContext('2d');
            
            contourCanvas.width = gray.cols;
            contourCanvas.height = gray.rows;
            
            // رسم خريطة الحرارة كخلفية
            const heatCanvas = document.getElementById('canvasHeatmap');
            ctx.drawImage(heatCanvas, 0, 0);
            
            // رسم الكنتور
            if (contour) {
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                const data = contour.data32S;
                for (let i = 0; i < data.length; i += 2) {
                    const x = data[i];
                    const y = data[i + 1];
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.closePath();
                ctx.stroke();
            }
            
            showElement('canvasContour', 'contourPlaceholder');
        }

        // ========== توليد G-code ==========
        
        /**
         * توليد كود G للمسح النقطي
         */
        function generateRasterGcode(scaleDown = false) {
            if (!grayMat || !contour) {
                showToast("لا توجد صورة جاهزة للمعالجة");
                return "";
            }
            
            try {
                // قراءة الإعدادات
                const dir = document.getElementById('scanDir').value;
                const stepOver = parseFloat(document.getElementById('stepOver').value) || 5;
                const maxDepth = parseFloat(document.getElementById('maxDepth').value) || 3;
                const feed = parseFloat(document.getElementById('feedRate').value) || 800;
                const safeZ = parseFloat(document.getElementById('safeZ').value) || 5;
                const invertZ = document.getElementById('invertZ').value === 'yes';
                
                // قراءة إعدادات حجم العمل
                const workWidth = cmToMm(parseFloat(document.getElementById('workWidth').value) || 30);
                const workHeight = cmToMm(parseFloat(document.getElementById('workHeight').value) || 20);
                const originX = cmToMm(parseFloat(document.getElementById('originX').value) || 0);
                const originY = cmToMm(parseFloat(document.getElementById('originY').value) || 0);

                // بدء كود G
                const lines = [];
                lines.push('G21 G90 G17'); // الوحدات المترية، الإحداثيات المطلقة، مستوى XY
                lines.push('G0 Z' + safeZ.toFixed(2)); // الانتقال لارتفاع الأمان
                
                let totalLen = 0;
                let step = scaleDown ? stepOver * 4 : stepOver;

                // حساب عوامل القياس
                const scaleX = workWidth / previewCanvas.width;
                const scaleY = workHeight / previewCanvas.height;

                // المسح الأفقي
                if (dir === 'x') {
                    for (let y = 0; y < previewCanvas.height; y += step) {
                        let row = [];
                        
                        // جمع النقاط داخل الكنتور
                        for (let x = 0; x < previewCanvas.width; x++) {
                            const point = new cv.Point(x, y);
                            const inside = cv.pointPolygonTest(contour, point, false);
                            
                            if (inside >= 0) {
                                const pv = grayMat.ucharAt(y, x);
                                let z = -((255 - pv) / 255.0) * maxDepth;
                                
                                if (invertZ) {
                                    z = -z;
                                }
                                
                                // تطبيق القياس ونقطة الأصل
                                const scaledX = (x * scaleX) + originX;
                                const scaledY = (y * scaleY) + originY;
                                
                                row.push({ x: scaledX, y: scaledY, z });
                            }
                        }
                        
                        // إذا كان هناك نقاط في الصف
                        if (row.length > 1) {
                            // عكس اتجاه الصفوف الفردية
                            if ((y / step) % 2 !== 0) {
                                row.reverse();
                            }
                            
                            // الانتقال للنقطة الأولى
                            lines.push('G0 X' + row[0].x.toFixed(2) + ' Y' + row[0].y.toFixed(2) + ' Z' + safeZ);
                            lines.push('G1 F' + feed); // تعيين سرعة التغذية
                            
                            // رسم المسار
                            for (let i = 0; i < row.length; i++) {
                                const p = row[i];
                                lines.push('G1 X' + p.x.toFixed(2) + ' Y' + p.y.toFixed(2) + ' Z' + p.z.toFixed(3));
                                
                                // حساب الطول الإجمالي
                                if (i > 0) {
                                    totalLen += Math.hypot(p.x - row[i-1].x, p.y - row[i-1].y);
                                }
                            }
                            
                            // العودة لارتفاع الأمان
                            lines.push('G0 Z' + safeZ);
                        }
                    }
                }
                
                // نهاية البرنامج
                lines.push('M5');  // إيقاف المغزل/الليزر
                lines.push('M30'); // نهاية البرنامج
                
                // حساب الوقت التقريبي
                const timeMin = (totalLen / feed);
                document.getElementById('estTime').textContent = "⏱️ تقدير الوقت: " + timeMin.toFixed(1) + " دقيقة";
                
                return lines.join('\n');
                
            } catch (error) {
                console.error('Error generating G-code:', error);
                showToast('خطأ في توليد G-code');
                return "";
            }
        }

        // ========== إدارة الأحداث ==========
        
        document.getElementById('btnGen').addEventListener('click', () => {
            const gcode = generateRasterGcode(false);
            document.getElementById('gcodeOut').value = gcode;
            if (gcode) {
                showToast("تم توليد G-code بنجاح");
                initSimulation();
            }
        });
        
        document.getElementById('btnQuick').addEventListener('click', () => {
            const gcode = generateRasterGcode(true);
            document.getElementById('gcodeOut').value = gcode;
            if (gcode) {
                showToast("تم توليد G-code سريع بنجاح");
                initSimulation();
            }
        });
        
        document.getElementById('btnDownload').addEventListener('click', () => {
            const text = document.getElementById('gcodeOut').value;
            if (!text) {
                showToast("لا يوجد G-code لتحميله");
                return;
            }
            
            const blob = new Blob([text], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "cnc_output.gcode";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("تم تحميل الملف بنجاح");
        });

        document.getElementById('btnCenterOrigin').addEventListener('click', () => {
            const workWidth = parseFloat(document.getElementById('workWidth').value) || 0;
            const workHeight = parseFloat(document.getElementById('workHeight').value) || 0;
            
            document.getElementById('originX').value = (workWidth / 2).toFixed(1);
            document.getElementById('originY').value = (workHeight / 2).toFixed(1);
            
            showToast("تم توسيط نقطة الأصل");
        });

        document.getElementById('machineType').addEventListener('change', (e) => {
            const type = e.target.value;
            const def = machineDefaults[type];
            
            if (def) {
                document.getElementById('feedRate').value = def.feed;
                document.getElementById('safeZ').value = def.safeZ;
                document.getElementById('maxDepth').value = def.maxDepth;
                document.getElementById('stepOver').value = def.stepOver;
                document.getElementById('machineDescription').textContent = def.description;
                
                showToast(`تم تحميل إعدادات ${type}`);
            }
        });

        // ========== محاكاة ثلاثية الأبعاد ==========
        
        /**
         * تهيئة المحاكاة ثلاثية الأبعاد
         */
        function initSimulation() {
            const container = document.getElementById('threeContainer');
            container.innerHTML = '';
            
            try {
                // إنشاء المشهد
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x081224);
                
                // إنشاء الكاميرا
                camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                camera.position.set(100, 100, 100);
                
                // إنشاء المُصيِّر
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(container.clientWidth, container.clientHeight);
                container.appendChild(renderer.domElement);
                
                // إضافة التحكم
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                
                // إضافة الإضاءة
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(50, 100, 50);
                scene.add(directionalLight);
                
                // إنشاء مادة العمل
                const materialGeometry = new THREE.BoxGeometry(100, 10, 80);
                const materialMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x8B4513,
                    transparent: true,
                    opacity: 0.8
                });
                const material = new THREE.Mesh(materialGeometry, materialMaterial);
                material.position.y = 5;
                scene.add(material);
                
                // إنشاء نموذج مبسط للأداة
                const toolGeometry = new THREE.CylinderGeometry(2, 2, 20, 8);
                const toolMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000 });
                const tool = new THREE.Mesh(toolGeometry, toolMaterial);
                tool.position.set(0, 25, 0);
                scene.add(tool);
                
                // إنشاء مسارات محاكاة (مثال)
                const pathGeometry = new THREE.BufferGeometry();
                const points = [];
                
                for (let i = 0; i < 100; i++) {
                    points.push(new THREE.Vector3(
                        Math.sin(i * 0.1) * 40,
                        15,
                        Math.cos(i * 0.1) * 30
                    ));
                }
                
                pathGeometry.setFromPoints(points);
                const pathMaterial = new THREE.LineBasicMaterial({ color: 0x00ff00 });
                const path = new THREE.Line(pathGeometry, pathMaterial);
                scene.add(path);
                
                // التصيير
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();
                
                showToast('تم تهيئة المحاكاة بنجاح');
                
            } catch (error) {
                console.error('Error initializing simulation:', error);
                showToast('خطأ في تهيئة المحاكاة');
            }
        }

        // ========== التهيئة الأولية ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            // تحديث عرض الأبعاد
            updateDimensionDisplay();
            
            // إضافة مستمعي الأحداث للأبعاد
            document.getElementById('workWidth').addEventListener('input', updateDimensionDisplay);
            document.getElementById('workHeight').addEventListener('input', updateDimensionDisplay);
            
            showToast('تم تحميل التطبيق بنجاح', 2000);
        });
    </script>
</body>
</html>
