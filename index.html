<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNC AI Preview - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©</title>
  <style>
    /* --- Ù†ÙØ³ Ø£Ù†Ù…Ø§Ø· CSS Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ --- */
    :root {
      --primary-color: #4a90e2;
      --secondary-color: #67b0f5;
      --bg-color: #f8f9fa;
      --text-color: #212529;
      --card-bg: #ffffff;
      --border-color: #dee2e6;
      --header-bg: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      --header-text: #ffffff;
      --button-bg: #e9ecef;
      --button-hover: #dee2e6;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --error-color: #dc3545;
      --tab-inactive: #e9ecef;
      --tab-active: var(--primary-color);
      --edge-color: #ff0000;
    }body.dark {
  --bg-color: #121212;
  --text-color: #e0e0e0;
  --card-bg: #1e1e1e;
  --border-color: #444;
  --header-bg: linear-gradient(90deg, #2c2c2c, #444);
  --button-bg: #333;
  --button-hover: #555;
  --tab-inactive: #333;
  --tab-active: #4a90e2;
  --edge-color: #ff4444;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: var(--bg-color);
  color: var(--text-color);
  line-height: 1.6;
  transition: all 0.3s ease;
  padding: 0;
  margin: 0;
}
/* Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø· ÙƒØ§Ù…Ù„Ø© Ù…Ø«Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± */

  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1><span>ğŸ› ï¸</span> CNC AI Preview - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø©</h1>
      <div class="controls">
        <button id="themeToggle">ğŸŒ™</button>
      </div>
    </div>
  </header>  <div class="container">
    <!-- Ø§Ù„ØªØ§Ø¨Ø§Øª -->
    <div class="tabs">
      <div class="tab active" data-tab="preview">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©</div>
      <div class="tab" data-tab="gcode">G-code Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
      <div class="tab" data-tab="simulation">Ù…Ø­Ø§ÙƒØ§Ø© G-code</div>
    </div><!-- ØªØ§Ø¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
<div class="tab-content active" id="preview-tab">
  <section class="upload-section">
    <h2 class="upload-title">ğŸ“¤ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</h2>
    <div class="file-upload">
      <input type="file" id="fileInput" accept="image/*">
      <label for="fileInput"><span>ğŸ“</span> Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
      <div class="file-name" id="fileName">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</div>
    </div>
  </section>

  <div class="previews-container">
    <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© -->
    <div class="preview-block">
      <h3 class="preview-title">ğŸ“· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</h3>
      <div class="preview-content">
        <canvas id="preview2d"></canvas>
      </div>
    </div>

    <!-- Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© 3D -->
    <div class="preview-block">
      <h3 class="preview-title">ğŸŒ€ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</h3>
      <div class="preview-content">
        <div id="preview3d">
          <div class="loading" id="loading3d">
            <div class="loading-spinner"></div>
            <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...</p>
          </div>
        </div>
      </div>
      <div class="options">
        <div class="option-group">
          <label for="rotationSpeed">ğŸ”„ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Ù†</label>
          <input type="range" id="rotationSpeed" min="0" max="0.05" step="0.001" value="0.01">
        </div>
        <div class="option-group">
          <label for="zoomControl">ğŸ” Ø²ÙˆÙ…</label>
          <input type="range" id="zoomControl" min="50" max="500" step="10" value="200">
        </div>
        <div class="option-group">
          <label for="heightIntensity">ğŸ“ Ø´Ø¯Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</label>
          <input type="range" id="heightIntensity" min="20" max="200" step="5" value="80">
        </div>
      </div>
    </div>

    <!-- Heatmap -->
    <div class="preview-block">
      <h3 class="preview-title">ğŸŒˆ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª (Heatmap)</h3>
      <div class="preview-content">
        <canvas id="heatmap"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- ØªØ§Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª G-code -->
<div class="tab-content" id="gcode-tab">
  <div class="settings-panel">
    <div class="action-buttons">
      <button class="btn btn-primary" onclick="generateGcode()">
        <span>âš¡</span> ØªÙˆÙ„ÙŠØ¯ G-code
      </button>
    </div>
    <div class="gcode-output" id="gcodeOutput"></div>
  </div>
</div>

  </div>  <footer>
    <p>ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Three.js - Ù…Ø´Ø±ÙˆØ¹ CncAi Preview Ø§Ù„Ù…ØªØ·ÙˆØ±</p>
  </footer>  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>  <script>
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const canvas2d = document.getElementById('preview2d');
    const ctx2d = canvas2d.getContext('2d');
    const heatmap = document.getElementById('heatmap');
    const ctxHeat = heatmap.getContext('2d');
    const preview3d = document.getElementById('preview3d');

    let mesh, heightMapData, originalImageData;
    let heightFactor = 80;
    let rotationSpeed = 0.01;
    let currentColormap = 'jet';

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);
    const camera = new THREE.PerspectiveCamera(45, preview3d.offsetWidth / preview3d.offsetHeight, 0.1, 1000);
    camera.position.z = 200;
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(preview3d.offsetWidth, preview3d.offsetHeight);
    preview3d.appendChild(renderer.domElement);

    function setupLights(scene) {
      const ambientLight = new THREE.AmbientLight(0x404040, 1);
      scene.add(ambientLight);
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);
    }
    setupLights(scene);

    function createHeightMap(image) {
      const w = Math.min(image.width, 100);
      const h = Math.min(image.height, 100);
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = w;
      tempCanvas.height = h;
      const tctx = tempCanvas.getContext('2d');
      tctx.drawImage(image, 0, 0, w, h);
      const imgData = tctx.getImageData(0, 0, w, h).data;

      // âœ… ØªØµØ­ÙŠØ­ Ù‡Ù†Ø§: Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… new Uint8Array
      heightMapData = {
        data: imgData,
        width: w,
        height: h
      };

      const geometry = new THREE.PlaneGeometry(100, 100, w - 1, h - 1);
      let min = 255, max = 0;
      const colors = [];
      for (let i = 0; i < geometry.attributes.position.count; i++) {
        const x = i % w;
        const y = Math.floor(i / w);
        const idx = (y * w + x) * 4;
        const brightness = 0.34 * imgData[idx] + 0.5 * imgData[idx + 1] + 0.16 * imgData[idx + 2];
        min = Math.min(min, brightness);
        max = Math.max(max, brightness);
        geometry.attributes.position.array[i * 3 + 2] = brightness / heightFactor;
        const norm = (brightness - min) / (max - min || 1);
        colors.push(norm, 0, 1 - norm);
      }
      geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
      geometry.computeVertexNormals();

      const material = new THREE.MeshLambertMaterial({ vertexColors: true, side: THREE.DoubleSide });
      if (mesh) scene.remove(mesh);
      mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);
    }

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      fileName.textContent = file.name;
      const img = new Image();
      img.onload = () => {
        canvas2d.width = img.width;
        canvas2d.height = img.height;
        ctx2d.drawImage(img, 0, 0);
        originalImageData = ctx2d.getImageData(0, 0, canvas2d.width, canvas2d.height);
        createHeightMap(img);
      };
      img.src = URL.createObjectURL(file);
    });

    function animate() {
      requestAnimationFrame(animate);
      if (mesh) mesh.rotation.y += rotationSpeed;
      renderer.render(scene, camera);
    }
    animate();

    function generateGcode() {
      if (!heightMapData) {
        alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }

      let gcode = `; CNC AI Generated G-code\nG21 ; millimeters\nG90 ; absolute positioning\n`;
      const step = 3;
      for (let y = 0; y < heightMapData.height; y += step) {
        for (let x = 0; x < heightMapData.width; x += step) {
          const idx = (y * heightMapData.width + x) * 4;
          const brightness = 0.34 * heightMapData.data[idx] + 0.5 * heightMapData.data[idx + 1] + 0.16 * heightMapData.data[idx + 2];
          const depth = (brightness / 255).toFixed(2);
          gcode += `G1 X${x} Y${y} Z-${depth}\n`;
        }
      }
      gcode += `M30 ; End program`;
      document.getElementById('gcodeOutput').textContent = gcode;
    }
  </script></body>
</html>
