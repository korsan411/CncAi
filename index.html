<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CncAi Preview</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #222;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
      color: #0ff;
    }
    #controls {
      background: #1b1b1b;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    #controls button, #controls select, #controls input {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      background: #333;
      color: #eee;
      cursor: pointer;
    }
    #controls button:hover {
      background: #555;
    }
    #viewer {
      flex: 1;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    canvas {
      max-width: 100%;
      max-height: 100%;
    }
  </style>
</head>
<body>
  <header>
    <h1>CncAi Preview</h1>
  </header>

  <div id="controls">
    <input type="file" id="upload" accept="image/*">
    <button onclick="setView('original')">Original</button>
    <button onclick="setView('heatmap')">Heatmap</button>
    <button onclick="setView('3d')">3D</button>
    <label>Colormap:
      <select id="colormap" onchange="changeColormap(this.value)">
        <option value="jet">Jet</option>
        <option value="hot">Hot</option>
        <option value="gray">Gray</option>
      </select>
    </label>
    <label>Max Height:
      <input type="number" id="maxHeight" value="20" style="width:60px">
    </label>
  </div>

  <div id="viewer">
    <canvas id="originalCanvas"></canvas>
    <canvas id="heatmapCanvas" style="display:none"></canvas>
    <div id="threeContainer" style="width:100%;height:100%;display:none"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
  <script>
    let originalCanvas = document.getElementById('originalCanvas');
    let heatmapCanvas = document.getElementById('heatmapCanvas');
    let ctx = originalCanvas.getContext('2d');
    let heatCtx = heatmapCanvas.getContext('2d');
    let loadedImage = null;
    let currentColormap = 'jet';
    let currentHeights = null;

    // 3D vars
    let scene, camera, renderer, controls, mesh, heatTexture;

    document.getElementById('upload').addEventListener('change', e => {
      let file = e.target.files[0];
      if(!file) return;
      let img = new Image();
      img.onload = () => {
        loadedImage = img;
        originalCanvas.width = img.width;
        originalCanvas.height = img.height;
        ctx.drawImage(img,0,0);

        heatmapCanvas.width = img.width;
        heatmapCanvas.height = img.height;
        createAndApplyHeatmapProtected();
      };
      img.src = URL.createObjectURL(file);
    });

    function setView(mode) {
      originalCanvas.style.display = "none";
      heatmapCanvas.style.display = "none";
      document.getElementById("threeContainer").style.display = "none";

      if(mode==="original") {
        originalCanvas.style.display = "block";
      } else if(mode==="heatmap") {
        heatmapCanvas.style.display = "block";
      } else if(mode==="3d") {
        document.getElementById("threeContainer").style.display = "block";
        initOrUpdate3D();
      }
    }

    function changeColormap(name) {
      currentColormap = name;
      createAndApplyHeatmapProtected(name);
    }

    // تصحيح: حماية وإنشاء Heatmap
    function safeEnsureHeatmapCanvas(img) {
      if(!heatmapCanvas) return false;
      if(!heatmapCanvas.width || !heatmapCanvas.height) {
        heatmapCanvas.width = img.width || 1;
        heatmapCanvas.height = img.height || 1;
      }
      return true;
    }

    function createAndApplyHeatmapProtected(colormap = currentColormap) {
      if(!loadedImage) return;
      if(!safeEnsureHeatmapCanvas(loadedImage)) return;
      try {
        createAndApplyHeatmap(colormap);
      } catch(err) {
        console.error("Heatmap error:", err);
      }
      if(mesh) {
        if(!heatTexture) {
          heatTexture = new THREE.CanvasTexture(heatmapCanvas);
          mesh.material.map = heatTexture;
        } else {
          heatTexture.image = heatmapCanvas;
        }
        heatTexture.needsUpdate = true;
        if(currentHeights) updateMeshFromHeights(currentHeights);
      }
    }

    // إنشاء Heatmap بسيط + حساب الارتفاعات
    function createAndApplyHeatmap(colormap) {
      heatCtx.drawImage(loadedImage,0,0);
      let imgData = heatCtx.getImageData(0,0,heatmapCanvas.width, heatmapCanvas.height);
      let data = imgData.data;
      currentHeights = {w: heatmapCanvas.width, h: heatmapCanvas.height, arr: new Float32Array(heatmapCanvas.width*heatmapCanvas.height)};
      for(let y=0;y<heatmapCanvas.height;y++) {
        for(let x=0;x<heatmapCanvas.width;x++) {
          let i = (y*heatmapCanvas.width+x)*4;
          let gray = (data[i]+data[i+1]+data[i+2])/3/255;
          let color = colormapFn(gray,colormap);
          data[i] = color[0];
          data[i+1] = color[1];
          data[i+2] = color[2];
          currentHeights.arr[y*heatmapCanvas.width+x] = gray;
        }
      }
      heatCtx.putImageData(imgData,0,0);
    }

    function colormapFn(v, map) {
      if(map==="hot") return [255*v, 255*v*0.5, 128*(1-v)];
      if(map==="gray") return [255*v,255*v,255*v];
      // jet-like
      return [255*v, 255*(1-v), 128];
    }

    function initOrUpdate3D() {
      if(!renderer) {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, threeContainer.clientWidth/threeContainer.clientHeight, 0.1, 1000);
        camera.position.set(0, -100, 100);
        renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(threeContainer.clientWidth, threeContainer.clientHeight);
        document.getElementById("threeContainer").appendChild(renderer.domElement);
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        let light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(0,0,1);
        scene.add(light);
      }
      if(!mesh && currentHeights) buildMeshFromHeights(currentHeights, loadedImage);
      animate();
    }

    function buildMeshFromHeights(heightObj, img) {
      let segX = Math.min(80, heightObj.w-1);
      let segY = Math.min(80, heightObj.h-1);
      let geometry = new THREE.PlaneGeometry(img.width, img.height, segX, segY);
      geometry.rotateX(-Math.PI/2);
      let material = new THREE.MeshPhongMaterial({map:new THREE.CanvasTexture(heatmapCanvas), side:THREE.DoubleSide});
      mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);
      heatTexture = mesh.material.map;
      updateMeshFromHeights(heightObj);
    }

    function updateMeshFromHeights(heightObj) {
      if(!mesh) return;
      let geometry = mesh.geometry;
      let pos = geometry.attributes.position;
      let vertsX = geometry.parameters.widthSegments+1;
      let vertsY = geometry.parameters.heightSegments+1;
      for(let y=0;y<vertsY;y++) {
        for(let x=0;x<vertsX;x++) {
          let idx = y*vertsX + x;
          let px = Math.floor(x/vertsX * heightObj.w);
          let py = Math.floor(y/vertsY * heightObj.h);
          let h = heightObj.arr[py*heightObj.w+px] || 0;
          pos.array[idx*3+1] = h * parseFloat(document.getElementById("maxHeight").value||20);
        }
      }
      pos.needsUpdate = true;
      geometry.computeVertexNormals();
      if(heatTexture) heatTexture.needsUpdate = true;
    }

    function animate() {
      requestAnimationFrame(animate);
      if(renderer && scene && camera) renderer.render(scene, camera);
      if(controls) controls.update();
    }
  </script>
</body>
</html>
