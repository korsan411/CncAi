<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNC AI - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
  <style>
    :root {
      --primary-color: #4a90e2;
      --secondary-color: #67b0f5;
      --bg-color: #f8f9fa;
      --text-color: #212529;
      --card-bg: #ffffff;
      --border-color: #dee2e6;
      --header-bg: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      --header-text: #ffffff;
      --button-bg: #e9ecef;
      --button-hover: #dee2e6;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --error-color: #dc3545;
      --ai-color: #9c27b0;
      --wood-color: #8b4513;
      --tab-inactive: #e9ecef;
      --tab-active: var(--primary-color);
      --analysis-color: #17a2b8;
      --roughing-color: #8b4513;
      --finishing-color: #5a2d0c;
      --smoothing-color: #3d2108;
      --drawing-color: #ff5722;
      --refill-color: #795548;
    }

    body.dark {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --card-bg: #1e1e1e;
      --border-color: #444;
      --header-bg: linear-gradient(90deg, #2c2c2c, #444);
      --button-bg: #333;
      --button-hover: #555;
      --ai-color: #ba68c8;
      --wood-color: #a0522d;
      --tab-inactive: #333;
      --tab-active: #4a90e2;
      --analysis-color: #138496;
      --roughing-color: #a0522d;
      --finishing-color: #8b4513;
      --smoothing-color: #5a2d0c;
      --drawing-color: #ff8a65;
      --refill-color: #8d6e63;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      transition: all 0.3s ease;
      padding: 0;
      margin: 0;
    }

    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 1rem;
      text-align: center;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 1400px;
    }

    h1 {
      font-size: 1.8rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    #themeToggle {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--header-text);
      transition: transform 0.3s;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #themeToggle:hover {
      transform: scale(1.1);
      background: rgba(255, 255, 255, 0.2);
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø¨Ø§Øª */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      background: var(--card-bg);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      background: var(--tab-inactive);
      transition: all 0.3s;
      text-align: center;
      flex: 1;
      font-weight: 500;
    }

    .tab.active {
      background: var(--tab-active);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ§Ø¨Ø§Øª */
    .upload-section {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .file-upload {
      margin: 1.5rem 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .file-upload label {
      background: var(--primary-color);
      color: white;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s;
    }

    .file-upload label:hover {
      background: var(--secondary-color);
    }

    .file-name {
      margin-top: 10px;
      font-size: 0.9rem;
      color: var(--text-color);
    }

    .previews-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    @media (min-width: 992px) {
      .previews-container {
        grid-template-columns: 1fr 1fr;
      }
    }

    .preview-block {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid var(--border-color);
    }

    .preview-title {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--primary-color);
    }

    .preview-content {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }

    canvas {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    #preview3d {
      width: 100%;
      height: 300px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative;
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      width: 100%;
      margin-top: 1rem;
    }

    .option-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .option-group label {
      font-size: 0.9rem;
      font-weight: 500;
    }

    input[type="range"] {
      width: 150px;
      accent-color: var(--primary-color);
    }

    .settings-panel {
      background: var(--card-bg);
      border-radius: 10px;
      padding: æé€Ÿ.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .settings-group {
      margin-bottom: 1.5rem;
    }

    .settings-group h3 {
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-group select, 
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 5æé€Ÿ;
      background: var(--bg-color);
      color: var(--text-color);
    }

    .gcode-output {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 15px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre-wrap;
      margin-top: 1rem;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--secondary-color);
    }

    .btn-secondary {
      background: var(--button-bg);
      color: var(--text-color);
    }

    .btn-secondary:hover {
      background: var(--button-hover);
    }

    .btn-ai {
      background: var(--ai-color);
      color: white;
    }

    .btn-ai:hover {
      background: #7b1fa2;
    }

    .btn-analysis {
      background: var(--analysis-color);
      color: white;
    }

    .btn-analysis:hover {
      background: #138496;
    }

    .btn-roughing {
      background: var(--roughing-color);
      color: white;
    }

    .btn-finishing {
      background: var(--finishing-color);
      color: white;
    }

    .btn-smoothing {
      background: var(--smoothing-color);
      color: white;
    }

    .btn-drawing {
      background: var(--drawing-color);
      color: white;
    }

    .btn-refill {
      background: var(--refill-color);
      color: white;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    footer {
      text-align: center;
      margin-top: 3rem;
      padding: 1.5rem;
      color: var(--text-color);
      font-size: 0.9rem;
      border-top: 1px solid var(--border-color);
    }

    .image-enhancement {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .enhancement-btn {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background: var(--button-bg);
      color: var(--text-color);
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }

    .enhancement-btn:hover {
      background: var(--button-hover);
    }

    .loading {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      z-index: 100;
      border-radius: 8px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      background: var(--success-color);
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }

    .notification.error {
      background: var(--error-color);
    }

    .notification.ai {
      background: var(--ai-color);
    }

    .notification.analysis {
      background: var(--analysis-color);
    }

    .ai-options {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .path-optimization {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .optimization-option {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .optimization-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .progress-container {
      width: 100%;
      background-color: var(--border-color);
      border-radius: 5px;
      margin: 15px 0;
      display: none;
    }

    .progress-bar {
      width: 0%;
      height: 20px;
      background-color: var(--primary-color);
      border-radius: 5px;
      transition: width 0.3s ease;
    }

    .edge-detection {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .analysis-panel {
      background: var(--cardæé€Ÿg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      display: none;
    }

    .analysis-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .analysis-item {
      background: var(--bg-color);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .analysis-item h4 {
      margin-bottom: 0.5rem;
      color: var(--analysis-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .analysis-value {
      font-size: 1.2rem;
      font-weight: bold;
    }

    .gcode-preview {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      display: none;
    }

    .gcode-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat-item {
      background: var(--bg-color);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      text-align: center;
    }

    .stat-item h4 {
      margin-bottom: 0.5rem;
      color: var(--primary-color);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .wood-stages {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .wood-stage {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,æé€Ÿ05);
      border: 1px solid var(--border-color);
    }

    .wood-stage h3 {
      margin-bottom: 1rem;
      padding-bottom: 0.5æé€Ÿ;
      border-bottom: 1px solid var(--border-color);
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .advanced-settings {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .path-preview {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .path-preview-content {
      width: 100%;
      height: 300px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--bg-color);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-top: 1rem;
      position: relative;
      overflow: hidden;
    }

    .path-svg {
      width: 100%;
      height: 100%;
    }

    .path-controls {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      justify-content: center;
    }

    .drawing-tools {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 1rem 0;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .drawing-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .drawing-instructions {
      font-size: 0.9rem;
      color: var(--text-color);
      text-align: center;
      margin-top: 0.5rem;
    }

    .drawing-canvas-container {
      position: relative;
      width: 100%;
      height: 300px;
      margin-top: 1rem;
    }

    #drawingCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }

    .manual-selection {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .filename-input {
      margin-top: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filename-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background: var(--bg-color);
      color: var(--text-color);
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.4rem;
      }
      
      .header-content {
        flex-direction: column;
        gap: 15px;
      }
      
      .preview-block {
        padding: 1rem;
      }
      
      .options {
        flex-direction: column;
        align-items: center;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .analysis-results, .gcode-stats {
        grid-template-columns: 1fr;
      }

      .wood-stages {
        grid-template-columns: 1fr;
      }

      .drawing-controls {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1><span>ğŸ› ï¸</span> CNC AI - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©</h1>
      <div class="controls">
        <button id="themeToggle">ğŸŒ™</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Ø§Ù„ØªØ§Ø¨Ø§Øª -->
    <div class="tabs">
      <div class="tab active" data-tab="preview">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©</div>
      <div class="tab" data-tab="gcode">G-code Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
      <div class="tab" data-tab="advanced">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</div>
    </div>

    <!-- ØªØ§Ø¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
    <div class="tab-content active" id="preview-tab">
      <section class="upload-section">
        <h2 class="upload-title">ğŸ“¤ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</h2>
        <div class="file-upload">
          <input type="file" id="fileInput" accept="image/*" style="display: none;">
          <label for="fileInput"><span>ğŸ“</span> Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
          <div class="file-name" id="fileName">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ ØµÙˆØ±Ø© Ø¨Ø¹Ø¯</div>
        </div>

        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="image-enhancement">
          <div class="enhancement-btn" onclick="applyEnhancement('brightness')">ğŸ”† Ø³Ø·ÙˆØ¹</div>
          <div class="enhancement-btn" onclick="applyEnhancement('contrast')">ğŸŒ“ ØªØ¨Ø§ÙŠÙ†</div>
          <div class="enhancement-btn" onclick="applyEnhancement('sharpen')">ğŸ” Ø­Ø¯Ø©</div>
          <div class="enhancement-btn" onclick="applyEnhancement('smooth')">ğŸ”„ Ù†Ø¹ÙˆÙ…Ø©</div>
          <div class="enhancement-btn" onclick="applyEnhancement('grayscale')">âš« ØªØ¯Ø±Ø¬ Ø±Ù…Ø§Ø¯ÙŠ</div>
          <div class="enhancement-btn" onclick="applyEnhancement('reset')">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</div>
        </div>

        <div class="edge-detection">
          <div class="enhancement-btn" onclick="detectEdges('sobel')">ğŸ” ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù (Sobel)</div>
          <div class="enhancement-btn" onclick="detectEdges('canny')">ğŸ” ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù (Canny)</div>
          <div class="enhancement-btn" onclick="detectEdges('laplacian')">ğŸ” ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù (Laplacian)</div>
        </div>
      </section>

      <div class="previews-container">
        <!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© -->
        <div class="preview-block">
          <h3 class="preview-title">ğŸ“· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</h3>
          <div class="preview-content">
            <canvas id="preview2d"></canvas>
          </div>
        </div>

        <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© 3D -->
        <div class="preview-block">
          <h3 class="preview-title">ğŸŒ€ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</h3>
          <div class="preview-content">
            <div id="preview3d">
              <div class="loading" id="loading3d">
                <div class="loading-spinner"></div>
                <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...</p>
              </div>
            </div>
          </div>
          <div class="options">
            <div class="option-group">
              <label for="rotationSpeed">ğŸ”„ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Ù†</label>
              <input type="range" id="rotationSpeed" min="0" max="0.05" step="0.001" value="0.01">
            </div>
            <div class="option-group">
              <label for="zoomControl">ğŸ” Ø²ÙˆÙ…</label>
              <input type="range" id="zoomControl" min="50" max="500" step="10" value="200">
            </div>
            <div class="option-group">
              <label for="heightIntensity">ğŸ“ Ø´Ø¯Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</label>
              <input type="range" id="heightIntensity" min="20" max="200" step="5" value="80">
            </div>
          </div>
        </div>

        <!-- Heatmap -->
        <div class="preview-block">
          <h3 class="preview-title">ğŸŒˆ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª (Heatmap)</h3>
          <div class="preview-content">
            <canvas id="heatmap"></canvas>
          </div>
          <div class="colormap-controls">
            <button class="btn btn-secondary" onclick="setColormap('jet')"><span>ğŸŒˆ</span> Jet</button>
            <button class="btn btn-secondary" onclick="setColormap('hot')"><span>ğŸ”¥</span> Hot</button>
            <button class="btn btn-secondary" onclick="setColormap('cool')"><span>â„ï¸</span> Cool</button>
            <button class="btn btn-secondary" onclick="setColormap('gray')"><span>âšª</span> Gray</button>
          </div>
        </div>

        <!-- Ø­ÙˆØ§Ù Ø§Ù„ØµÙˆØ±Ø© -->
        <div class="preview-block">
          <h3 class="preview-title">ğŸ” Ø­ÙˆØ§Ù Ø§Ù„ØµÙˆØ±Ø©</h3>
          <div class="preview-content">
            <canvas id="edgesCanvas"></canvas>
          </div>
          <div class="options">
            <div class="option-group">
              <label for="edgeThreshold">ğŸ“Š Ø¹ØªØ¨Ø© Ø§Ù„Ø­ÙˆØ§Ù</label>
              <input type="range" id="edgeThreshold" min="1" max="100" step="1" value="50" oninput="updateEdgeDetection()">
            </div>
          </div>
        </div>

        <!-- ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙŠØ¯ÙˆÙŠØ§Ù‹ -->
        <div class="preview-block">
          <h3 class="preview-title">âœï¸ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ ÙŠØ¯ÙˆÙŠØ§Ù‹</h3>
          <div class="preview-content">
            <div class="drawing-canvas-container">
              <canvas id="drawingCanvas"></canvas>
            </div>
          </div>
          <div class="drawing-tools">
            <div class="drawing-controls">
              <button class="btn btn-drawing" id="startDrawing">
                <span>âœï¸</span> Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø³Ù…
              </button>
              <button class="btn btn-secondary" id="clearDrawing">
                <span>ğŸ—‘ï¸</span> Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ù…
              </button>
              <button class="btn btn-primary" id="applyDrawing">
                <span>âœ…</span> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø³Ù…
              </button>
            </div>
            <div class="drawing-instructions">
              <p>Ø§Ø±Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ù‚Ø·Ø¹Ù‡Ø§. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø³Ù…" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø³Ù…ØŒ Ø«Ù… Ø§Ù†Ù‚Ø± ÙˆØ§Ø³Ø­Ø¨ Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©.</p>
            </div>
            <div class="options">
              <div class="option-group">
                <label for="brushSize">ğŸ“ Ø­Ø¬Ù… Ø§Ù„ÙØ±Ø´Ø§Ø©</label>
                <input type="range" id="brushSize" min="1" max="20" step="1" value="5">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ØªØ§Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª G-code -->
    <div class="tab-content" id="gcode-tab">
      <div class="ai-options">
        <h3><span>ğŸ¤–</span> Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
        <div class="path-optimization">
          <div class="optimization-option">
            <input type="checkbox" id="optimizePaths" checked>
            <label for="optimæé€ŸPaths">ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù„ØªÙ‚Ù„ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„Ù‚Ø·Ø¹</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="smoothEdges" checked>
            <label for="smoothEdges">ØªÙ†Ø¹ÙŠÙ… Ø§Ù„Ø­ÙˆØ§Ù Ù„Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø£ÙØ¶Ù„</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="adaptivePrecision">
            <label for="adaptivePrecision">Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„ØªÙƒÙŠÙÙŠØ© (ØªÙ„Ù‚Ø§Ø¦ÙŠØ©)</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useEdges" checked>
            <label for="useEdges">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­ÙˆØ§Ù Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useHeatmap" checked>
            <label for="useHeatmap">Ø§Ø³ØªØ®Ø¯Ø§Ù… Heatmap Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="startFromEdges" checked>
            <label for="startFromEdges">Ø¨Ø¯Ø¡ Ø§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ø§Ù„Ø­ÙˆØ§Ù</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useManualSelection">
            <label for="useManualSelection">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ù„Ù…Ù†Ø§Ø·Ù‚</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useRefillMode">
            <label for="useRefillMode">ÙˆØ¶Ø¹ Ø§Ù„Ù€ Refill (Ù„Ù„Ø®Ø´Ø¨ ÙÙ‚Ø·)</label>
          </div>
        </div>
      </div>

      <div class="settings-panel">
        <div class="settings-group">
          <h3><span>ğŸ­</span> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</h3>
          <div class="form-group">
            <label for="machineType">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
            <select id="machineType">
              <option value="cnc">CNC Router</option>
              <option value="laser">Laser Cutter</option>
              <option value="3dprinter">3D Printer</option>
            </select>
          </div>
        </div>

        <div class="settings-group">
          <h3><span>ğŸ“¦</span> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ù…Ø©</h3>
          <div class="form-group">
            <label for="materialType">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ø©</label>
            <select id="materialType">
              <option value="wood">Ø®Ø´Ø¨</option>
              <option value="acrylic">Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ</option>
              <option value="metal">Ù…Ø¹Ø¯Ù†</option>
              <option value="plastic">Ø¨Ù„Ø§Ø³ØªÙŠÙƒ</option>
            </select>
          </div>
          <div class="form-group">
            <label for="materialThickness">Ø³Ù…Ùƒ Ø§Ù„Ø®Ø§Ù…Ø© (Ù…Ù…)</label>
            <input type="number" id="materialThickness" min="1" max="100" value="10">
          </div>
        </div>

        <div class="settings-group">
          <h3><span>ğŸ”§</span> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø·Ø¹</h3>
          <div class="form-group">
            <label for="toolDiameter">Ù‚Ø·Ø± Ø§Ù„Ø£Ø¯Ø§Ø© (Ù…Ù…)</label>
            <input type="number" id="toolDiameter" min="0.1" max="10" step="0.1" value="3">
          </div>
          <div class="form-group">
            <label for="cutDepth">Ø¹Ù…Ù‚ Ø§Ù„Ù‚Ø·Ø¹ (Ù…Ù…)</label>
            <input type="number" id="cutDepth" min="0.1" max="10" step="0.1" value="2">
          </div>
          <div class="form-group">
            <label for="feedRate">Ø³Ø±Ø¹Ø© Ø§Ù„ØªØºØ°ÙŠØ© (Ù…Ù…/Ø¯Ù‚ÙŠÙ‚Ø©)</label>
            <input type="number" id="feedRate" min="100" max="5000" step="100" value="1000">
          </div>
          <div class="form-group">
            <label for="plungeRate">Ø³Ø±Ø¹Ø© Ø§Ù„Ù†Ø²ÙˆÙ„ (Ù…Ù…/Ø¯Ù‚ÙŠÙ‚Ø©)</label>
            <input type="number" id="plungeRate" min="50" max="1000" step="50" value="300">
          </div>
          <div class="form-group">
            <label for="spindleSpeed">Ø³Ø±Ø¹Ø© Ø§Ù„Ù…ØºØ²Ù„ (RPM)</label>
            <input type="number" id="spindleSpeed" min="1000" max="24000" step="1000" value="12000">
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" onclick="analyzeImage()">
          <span>ğŸ”</span> ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
        </button>
        <button class="btn btn-ai" onclick="generateGcode()">
          <span>ğŸ¤–</span> ØªÙˆÙ„ÙŠØ¯ G-code
        </button>
        <button class="btn btn-secondary" onclick="simulateCutting()">
          <span>ğŸ”„</span> Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù‚Ø·Ø¹
        </button>
        <button class="btn btn-secondary" onclick="saveGcode()">
          <span>ğŸ’¾</span> Ø­ÙØ¸ G-code
        </button>
      </div>

      <div class="analysis-panel" id="analysisPanel">
        <h3><span>ğŸ“Š</span> Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
        <div class="analysis-results">
          <div class="analysis-item">
            <h4><span>ğŸ”¢</span> Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø·</h4>
            <div class="analysis-value" id="pointsCount">0</div>
          </div>
          <div class="analysis-item">
            <h4><span>ğŸ“</span> Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</h4>
            <div class="analysis-value" id="totalDistance">0 Ù…Ù…</div>
          </div>
          <div class="analysis-item">
            <h4><span>â±ï¸</span> ÙˆÙ‚Øª Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</h4>
            <div class="analysis-value" id="cuttingTime">0 Ø¯Ù‚ÙŠÙ‚Ø©</div>
          </div>
          <div class="analysis-item">
            <h4><span>ğŸ“</span> ØªØ¹Ù‚ÙŠØ¯ Ø§Ù„ØªØµÙ…ÙŠÙ…</h4>
            <div class="analysis-value" id="designComplexity">Ù…Ù†Ø®ÙØ¶</div>
          </div>
        </div>
      </div>

      <div class="gcode-preview" id="gcodePreview">
        <h3><span>ğŸ“</span> Ù…Ø¹Ø§ÙŠÙ†Ø© G-code</h3>
        <div class="gcode-output" id="gcodeOutput"></div>
        <div class="gcode-stats">
          <div class="stat-item">
            <h4>Ø¹Ø¯Ø¯ Ø£Ø³Ø·Ø± G-code</h4>
            <div class="stat-value" id="gcodeLines">0</div>
          </div>
          <div class="stat-item">
            <h4>Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù</h4>
            <div class="stat-value" id="fileSize">0 KB</div>
          </div>
        </div>
        <div class="filename-input">
          <label for="gcodeFilename">Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù:</label>
          <input type="text" id="gcodeFilename" value="cnc_design">
          <button class="btn btn-primary" onclick="saveGcode()">
            <span>ğŸ’¾</span> Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
          </button>
        </div>
      </div>
    </div>

    <!-- ØªØ§Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div class="tab-content" id="advanced-tab">
      <div class="advanced-settings">
        <h3><span>âš™ï¸</span> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
        <div class="form-group">
          <label for="resolution">Ø¯Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (1-10)</label>
          <input type="range" id="resolution" min="1" max="10" value="5">
        </div>
        <div class="form-group">
          <label for="stepOver">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¯Ø§Ø®Ù„ (%)</label>
          <input type="range" id="stepOver" min="10" max="90" value="50">
        </div>
        <div class="form-group">
          <label for="tolerance">Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„ØªØ³Ø§Ù…Ø­ (0.01-1)</label>
          <input type="range" id="tolerance" min="1" max="100" value="10">
        </div>
        <div class="form-group">
          <label for="smoothingFactor">Ø¹Ø§Ù…Ù„ Ø§Ù„ØªÙ†Ø¹ÙŠÙ… (0-1)</label>
          <input type="range" id="smoothingFactor" min="0" max="100" value="30">
        </div>
        <div class="form-group">
          <label for="zSafeHeight">Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¢Ù…Ù† (Ù…Ù…)</label>
          <input type="number" id="zSafeHeight" min="1" max="50" value="5">
        </div>
      </div>

      <div class="path-preview">
        <h3><span>ğŸ”„</span> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª</h3>
        <div class="path-preview-content">
          <svg class="path-svg" id="pathSvg"></svg>
        </div>
        <div class="path-controls">
          <button class="btn btn-primary" onclick="updatePathPreview()">
            <span>ğŸ”„</span> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
          </button>
          <button class="btn btn-secondary" onclick="optimizePaths()">
            <span>âš¡</span> ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
          </button>
        </div>
      </div>

      <div class="wood-stages">
        <div class="wood-stage">
          <h3><span>ğŸªµ</span> Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø®Ø´ÙˆÙ†Ø© (Roughing)</h3>
          <div class="form-group">
            <label for="roughingToolDiameter">Ù‚Ø·Ø± Ø£Ø¯Ø§Ø© Ø§Ù„Ø®Ø´ÙˆÙ†Ø© (Ù…Ù…)</label>
            <input type="number" id="roughingToolDiameter" min="1" max="10" step="0.5" value="6">
          </div>
          <div class="form-group">
            <label for="roughingStepDown">Ø¹Ù…Ù‚ Ø§Ù„Ù‚Ø·Ø¹ Ù„Ù„Ø®Ø´ÙˆÙ†Ø© (Ù…Ù…)</label>
            <input type="number" id="roughingStepDown" min="0.5" max="5" step="0.5" value="2">
          </div>
          <div class="form-group">
            <label for="roughingFeedRate">Ø³Ø±Ø¹Ø© Ø§Ù„ØªØºØ°ÙŠØ© Ù„Ù„Ø®Ø´ÙˆÙ†Ø© (Ù…Ù…/Ø¯)</label>
            <input type="number" id="roughingFeedRate" min="500" max="3000" step="100" value="1500">
          </div>
          <button class="btn btn-roughing" onclick="generateRoughingPaths()">
            <span>ğŸªµ</span> ØªÙˆÙ„ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø®Ø´ÙˆÙ†Ø©
          </button>
        </div>

        <div class="wood-stage">
          <h3><span>ğŸ”</span> Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ´Ø·ÙŠØ¨ (Finishing)</h3>
          <div class="form-group">
            <label for="finishingToolDiameter">Ù‚Ø·Ø± Ø£Ø¯Ø§Ø© Ø§Ù„ØªØ´Ø·ÙŠØ¨ (Ù…Ù…)</label>
            <input type="number" id="finishingToolDiameter" min="0.5" max="5" step="0.1" value="3">
          </div>
          <div class="form-group">
            <label for="finishingStepDown">Ø¹Ù…Ù‚ Ø§Ù„Ù‚Ø·Ø¹ Ù„Ù„ØªØ´Ø·ÙŠØ¨ (Ù…Ù…)</label>
            <input type="number" id="finishingStepDown" min="0.1" max="2" step="0.1" value="0.5">
          </div>
          <div class="form-group">
            <label for="finishingFeedRate">Ø³Ø±Ø¹Ø© Ø§Ù„ØªØºØ°ÙŠØ© Ù„Ù„ØªØ´Ø·ÙŠØ¨ (Ù…Ù…/Ø¯)</label>
            <input type="number" id="finishingFeedRate" min="100" max="2000" step="50" value="800">
          </div>
          <button class="btn btn-finishing" onclick="generateFinishingPaths()">
            <span>ğŸ”</span> ØªÙˆÙ„ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªØ´Ø·ÙŠØ¨
          </button>
        </div>

        <div class="wood-stage">
          <h3><span>âœ¨</span> Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙ†Ø¹ÙŠÙ… (Smoothing)</h3>
          <div class="form-group">
            <label for="smoothingToolDiameter">Ù‚Ø·Ø± Ø£Ø¯Ø§Ø© Ø§Ù„ØªÙ†Ø¹ÙŠÙ… (Ù…Ù…)</label>
            <input type="number" id="smoothingToolDiameter" min="0.5" max="5" step="0.1" value="3">
          </div>
          <div class="form-group">
            <label for="smoothingStepDown">Ø¹Ù…Ù‚ Ø§Ù„Ù‚Ø·Ø¹ Ù„Ù„ØªÙ†Ø¹ÙŠÙ… (Ù…Ù…)</label>
            <input type="number" id="smoothingStepDown" min="0.1" max="1" step="0.1" value="0.2">
          </div>
          <div class="form-group">
            <label for="smoothingFeedRate">Ø³Ø±Ø¹Ø© Ø§Ù„ØªØºØ°ÙŠØ© Ù„Ù„ØªÙ†Ø¹ÙŠÙ… (Ù…Ù…/Ø¯)</label>
            <input type="number" id="smoothingFeedRate" min="100" max="1500" step="50" value="500">
          </div>
          <button class="btn btn-smoothing" onclick="generateSmoothingPaths()">
            <span>âœ¨</span> ØªÙˆÙ„ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªÙ†Ø¹ÙŠÙ…
          </button>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" onclick="generateAllPaths()">
          <span>ğŸ”„</span> ØªÙˆÙ„ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
        </button>
        <button class="btn btn-ai" onclick="applyAdaptivePaths()">
          <span>ğŸ¤–</span> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªÙƒÙŠÙÙŠØ©
        </button>
        <button class="btn btn-secondary" onclick="simulateAllStages()">
          <span>ğŸ¬</span> Ù…Ø­Ø§ÙƒØ§Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„
        </button>
      </div>
    </div>
  </div>

  <footer>
    <p>CNC AI - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© Ù…Ø¹ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Â© 2023</p>
    <p>ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø­Ø¯Ø« ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±</p>
  </footer>

  <div class="notification" id="notification"></div>

  <script>
    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    let originalImage = null;
    let processedImage = null;
    let currentImageData = null;
    let heatmapData = null;
    let edgesData = null;
    let isDrawing = false;
    let drawingPoints = [];
    let currentColormap = 'jet';
    let toolPaths = [];
    let analysisResults = {};

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', function() {
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
      document.getElementById('fileInput').addEventListener('change', handleImageUpload);
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ§Ø¨Ø§Øª
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          activateTab(tabId);
        });
      });

      // Ø¥Ø¹Ø¯Ø§Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¸Ù‡Ø±
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù…
      setupDrawingTools();

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      // loadDefaultImage();
    });

    // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø± Ø¨ÙŠÙ† Ø§Ù„ÙØ§ØªØ­ ÙˆØ§Ù„Ø¯Ø§ÙƒÙ†
    function toggleTheme() {
      document.body.classList.toggle('dark');
      const themeToggle = document.getElementById('themeToggle');
      if (document.body.classList.contains('dark')) {
        themeToggle.textContent = 'â˜€ï¸';
      } else {
        themeToggle.textContent = 'ğŸŒ™';
      }
    }

    // ØªÙØ¹ÙŠÙ„ ØªØ§Ø¨ Ù…Ø¹ÙŠÙ†
    function activateTab(tabId) {
      // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ§Ø¨Ø§Øª
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
      document.getElementById(`${tabId}-tab`).classList.add('active');
      document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
    }

    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const fileNameElement = document.getElementById('fileName');
      fileNameElement.textContent = file.name;

      // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';

      const reader = new FileReader();
      
      reader.onprogress = function(e) {
        if (e.lengthComputable) {
          const percentLoaded = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width = `${percentLoaded}%`;
        }
      };

      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
          progressContainer.style.display = 'none';
          
          // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
          originalImage = img;
          processedImage = img;
          
          // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØ¹Ø±Ø¶Ù‡Ø§
          processAndDisplayImage();
          
          // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ù…ÙŠÙ„
          showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        };
        img.src = e.target.result;
      };
      
      reader.onerror = function() {
        progressContainer.style.display = 'none';
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©', 'error');
      };
      
      reader.readAsDataURL(file);
    }

    // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
    function processAndDisplayImage() {
      if (!originalImage) return;

      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ØµØ± canvas
      const previewCanvas = document.getElementById('preview2d');
      const heatmapCanvas = document.getElementById('heatmap');
      const edgesCanvas = document.getElementById('edgesCanvas');
      const drawingCanvas = document.getElementById('drawingCanvas');
      
      // ØªØ¹ÙŠÙŠÙ† Ø£Ø¨Ø¹Ø§Ø¯ canvases
      const maxWidth = 500;
      const maxHeight = 400;
      let width = originalImage.width;
      let height = originalImage.height;
      
      // ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù… Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø©
      if (width > maxWidth) {
        height = (maxWidth / width) * height;
        width = maxWidth;
      }
      if (height > maxHeight) {
        width = (maxHeight / height) * width;
        height = maxHeight;
      }
      
      [previewCanvas, heatmapCanvas, edgesCanvas, drawingCanvas].forEach(canvas => {
        canvas.width = width;
        canvas.height = height;
      });
      
      // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
      const previewCtx = previewCanvas.getContext('2d');
      previewCtx.drawImage(originalImage, 0, 0, width, height);
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø©
      currentImageData = previewCtx.getImageData(0, 0, width, height);
      
      // Ø¥Ù†Ø´Ø§Ø¡ Heatmap
      createHeightMap(previewCtx, width, height);
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© 3D
      create3dPreview();
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù…
      setupDrawingTools();
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª
    function createHeightMap(ctx, width, height) {
      const heatmapCanvas = document.getElementById('heatmap');
      const heatmapCtx = heatmapCanvas.getContext('2d');
      
      // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ heatmap
      heatmapCtx.drawImage(originalImage, 0, 0, width, height);
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙƒØ³Ù„
      const imageData = heatmapCtx.getImageData(0, 0, width, height);
      const data = imageData.data;
      
      // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¯Ø±Ø¬ Ø±Ù…Ø§Ø¯ÙŠ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª
      heatmapData = new Float32Array(width * height);
      
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ© (Ù…ØªÙˆØ³Ø· Ù…Ø±Ø¬Ø­)
        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
        
        // ØªØ®Ø²ÙŠÙ† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ (0-255)
        const idx = Math.floor(i / 4);
        heatmapData[idx] = gray / 255;
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙƒØ³Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        const color = getHeatColor(heatmapData[idx], currentColormap);
        data[i] = color.r;
        data[i + 1] = color.g;
        data[i + 2] = color.b;
      }
      
      // ÙˆØ¶Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù€ canvas
      heatmapCtx.putImageData(imageData, 0, 0);
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù„ÙˆÙ† Heatmap
    function getHeatColor(value, map) {
      let r, g, b;
      
      if (map === 'jet') {
        // Ø®Ø±ÙŠØ·Ø© Ø£Ù„ÙˆØ§Ù† Jet (Ø§Ù„Ø£Ø²Ø±Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ù…Ø±)
        const fourValue = 4 * value;
        r = Math.min(fourValue - 1.5, -fourValue + 4.5) * 255;
        g = Math.min(fourValue - 0.5, -fourValue + 3.5) * 255;
        b = Math.min(fourValue + 0.5, -fourValue + 2.5) * 255;
      } else if (map === 'hot') {
        // Ø®Ø±ÙŠØ·Ø© Ø£Ù„ÙˆØ§Ù† Hot (Ø£Ø³ÙˆØ¯ Ø¥Ù„Ù‰ Ø£Ø¨ÙŠØ¶ Ø¹Ø¨Ø± Ø§Ù„Ø£Ø­Ù…Ø± ÙˆØ§Ù„Ø£ØµÙØ±)
        r = Math.min(3 * value, 1) * 255;
        g = Math.min(3 * value - 1, 1) * 255;
        g = Math.max(g, 0);
        b = Math.min(3 * value - 2, 1) * 255;
        b = Math.max(b, 0);
      } else if (map === 'cool') {
        // Ø®Ø±ÙŠØ·Ø© Ø£Ù„ÙˆØ§Ù† Cool (Ø£Ø±Ø¬ÙˆØ§Ù†ÙŠ Ø¥Ù„Ù‰ Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­)
        r = value * 255;
        g = (1 - value) * 255;
        b = 255;
      } else {
        // ØªØ¯Ø±Ø¬ Ø±Ù…Ø§Ø¯ÙŠ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)
        r = value * 255;
        g = value * 255;
        b = value * 255;
      }
      
      return {
        r: Math.max(0, Math.min(255, Math.round(r))),
        g: Math.max(0, Math.min(255, Math.round(g))),
        b: Math.max(0, Math.min(255, Math.round(b)))
      };
    }

    // ØªØ¹ÙŠÙŠÙ† Ø®Ø±ÙŠØ·Ø© Ø£Ù„ÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯Ø©
    function setColormap(map) {
      currentColormap = map;
      if (originalImage) {
        createHeightMap(null, document.getElementById('heatmap').width, document.getElementById('heatmap').height);
      }
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
    function create3dPreview() {
      // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø³ØªØ³ØªØ®Ø¯Ù… Ù…ÙƒØªØ¨Ø© Ù…Ø«Ù„ Three.js Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© 3D
      // ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø©
      const preview3d = document.getElementById('preview3d');
      preview3d.innerHTML = `
        <div style="padding: 20px; text-align: center; color: var(--text-color);">
          <p>ğŸ” Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ØªØ­Øª Ø§Ù„ØªØ·ÙˆÙŠØ±</p>
          <p>Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© Three.js Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª</p>
        </div>
      `;
    }

    // ØªØ·Ø¨ÙŠÙ‚ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©
    function applyEnhancement(type) {
      if (!currentImageData) return;
      
      const canvas = document.getElementById('preview2d');
      const ctx = canvas.getContext('2d');
      const data = currentImageData.data;
      const width = canvas.width;
      const height = canvas.height;
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯
      switch(type) {
        case 'brightness':
          // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø·ÙˆØ¹
          const brightnessValue = 30;
          for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.min(255, data[i] + brightnessValue);     // R
            data[i + 1] = Math.min(255, data[i + 1] + brightnessValue); // G
            data[i + 2] = Math.min(255, data[i + 2] + brightnessValue); // B
          }
          break;
          
        case 'contrast':
          // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ¨Ø§ÙŠÙ†
          const factor = 1.2;
          for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.min(255, Math.max(0, factor * (data[i] - 128) + 128));     // R
            data[i + 1] = Math.min(255, Math.max(0, factor * (data[i + 1] - 128) + 128)); // G
            data[i + 2] = Math.min(255, Math.max(0, factor * (data[i + 2] - 128) + 128)); // B
          }
          break;
          
        case 'sharpen':
          // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø­Ø¯Ø©
          const tempData = new Uint8ClampedArray(data);
          for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
              for (let c = 0; c < 3; c++) {
                const idx = (y * width + x) * 4 + c;
                const newVal = 
                  5 * tempData[idx] - 
                  tempData[idx - 4] - 
                  tempData[idx + 4] - 
                  tempData[idx - width * 4] - 
                  tempData[idx + width * 4];
                data[idx] = Math.min(255, Math.max(0, newVal));
              }
            }
          }
          break;
          
        case 'smooth':
          // ØªÙ†Ø¹ÙŠÙ… Ø§Ù„ØµÙˆØ±Ø©
          const smoothData = new Uint8ClampedArray(data);
          for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
              for (let c = 0; c < 3; c++) {
                const idx = (y * width + x) * 4 + c;
                let sum = 0;
                for (let ky = -1; ky <= 1; ky++) {
                  for (let kx = -1; kx <= 1; kx++) {
                    const kidx = ((y + ky) * width + (x + kx)) * 4 + c;
                    sum += smoothData[kidx];
                  }
                }
                data[idx] = Math.round(sum / 9);
              }
            }
          }
          break;
          
        case 'grayscale':
          // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¯Ø±Ø¬ Ø±Ù…Ø§Ø¯ÙŠ
          for (let i = 0; i < data.length; i += 4) {
            const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            data[i] = gray;     // R
            data[i + 1] = gray; // G
            data[i + 2] = gray; // B
          }
          break;
          
        case 'reset':
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
          ctx.drawImage(originalImage, 0, 0, width, height);
          currentImageData = ctx.getImageData(0, 0, width, height);
          break;
      }
      
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† resetØŒ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
      if (type !== 'reset') {
        ctx.putImageData(currentImageData, 0, 0);
      }
      
      // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ heatmap ÙˆØ§Ù„Ø­ÙˆØ§Ù
      createHeightMap(ctx, width, height);
      detectEdges();
      
      showNotification(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ${type} Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©`, 'success');
    }

    // ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù
    function detectEdges(algorithm = 'sobel') {
      if (!currentImageData) return;
      
      const canvas = document.getElementById('edgesCanvas');
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      
      // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ canvas Ø§Ù„Ø­ÙˆØ§Ù
      ctx.drawImage(originalImage, 0, 0, width, height);
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;
      
      // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¯Ø±Ø¬ Ø±Ù…Ø§Ø¯ÙŠ Ø£ÙˆÙ„Ø§Ù‹
      const grayData = new Uint8ClampedArray(width * height);
      for (let i = 0; i < data.length; i += 4) {
        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
        grayData[i / 4] = gray;
      }
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù
      edgesData = new Uint8ClampedArray(width * height);
      const threshold = document.getElementById('edgeThreshold').value;
      
      if (algorithm === 'sobel') {
        applySobel(grayData, edgesData, width, height, threshold);
      } else if (algorithm === 'canny') {
        applyCanny(grayData, edgesData, width, height, threshold);
      } else if (algorithm === 'laplacian') {
        applyLaplacian(grayData, edgesData, width, height, threshold);
      }
      
      // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙˆØ§Ù
      for (let i = 0; i < data.length; i += 4) {
        const edgeValue = edgesData[Math.floor(i / 4)];
        data[i] = edgeValue;     // R
        data[i + 1] = edgeValue; // G
        data[i + 2] = edgeValue; // B
        // ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ù‚Ù†Ø§Ø© Ø£Ù„ÙØ§ ÙƒÙ…Ø§ Ù‡ÙŠ
      }
      
      ctx.putImageData(imageData, 0, 0);
      showNotification(`ØªÙ… ØªØ·Ø¨ÙŠÙ‚ ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù (${algorithm})`, 'success');
    }

    // ØªØ·Ø¨ÙŠÙ‚ ÙƒØ´Ù Sobel
    function applySobel(input, output, width, height, threshold) {
      const sobelX = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
      const sobelY = [-1, -2, -1, 0, 0, 0, 1, 2, 1];
      
      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          let gx = 0;
          let gy = 0;
          
          for (let ky = -1; ky <= 1; ky++) {
            for (let kx = -1; kx <= 1; kx++) {
              const pixel = input[(y + ky) * width + (x + kx)];
              const kernelIndex = (ky + 1) * 3 + (kx + 1);
              
              gx += pixel * sobelX[kernelIndex];
              gy += pixel * sobelY[kernelIndex];
            }
          }
          
          const magnitude = Math.sqrt(gx * gx + gy * gy);
          output[y * width + x] = magnitude > threshold ? 255 : 0;
        }
      }
    }

    // ØªØ·Ø¨ÙŠÙ‚ ÙƒØ´Ù Canny
    function applyCanny(input, output, width, height, threshold) {
      // ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¨Ø³Ø· Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Canny
      // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚ Gaussian blur Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… non-maximum suppression
      applySobel(input, output, width, height, threshold);
      
      // Ù‡Ù†Ø§ Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Canny Ø§Ù„ÙƒØ§Ù…Ù„Ø©
      // ÙˆÙ„ÙƒÙ† Ù„Ø£ØºØ±Ø§Ø¶ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ Ù†Ø³ØªØ®Ø¯Ù… Sobel Ù…Ø¹ threshold
    }

    // ØªØ·Ø¨ÙŠÙ‚ ÙƒØ´Ù Laplacian
    function applyLaplacian(input, output, width, height, threshold) {
      const laplacianKernel = [-1, -1, -1, -1, 8, -1, -1, -1, -1];
      
      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          let sum = 0;
          
          for (let ky = -1; ky <= 1; ky++) {
            for (let kx = -1; kx <= 1; kx++) {
              const pixel = input[(y + ky) * width + (x + kx)];
              const kernelIndex = (ky + 1) * 3 + (kx + 1);
              
              sum += pixel * laplacianKernel[kernelIndex];
            }
          }
          
          output[y * width + x] = Math.abs(sum) > threshold ? 255 : 0;
        }
      }
    }

    // ØªØ­Ø¯ÙŠØ« ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¹ØªØ¨Ø©
    function updateEdgeDetection() {
      detectEdges();
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø±Ø³Ù…
    function setupDrawingTools() {
      const canvas = document.getElementById('drawingCanvas');
      const ctx = canvas.getContext('2d');
      const startDrawingBtn = document.getElementById('startDrawing');
      const clearDrawingBtn = document.getElementById('clearDrawing');
      const applyDrawingBtn = document.getElementById('applyDrawing');
      
      // Ù…Ø³Ø­ canvas Ø§Ù„Ø±Ø³Ù…
      function clearDrawing() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawingPoints = [];
      }
      
      // Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø³Ù…
      startDrawingBtn.addEventListener('click', function() {
        isDrawing = true;
        drawingPoints = [];
        showNotification('Ø¨Ø¯Ø¡ Ø§Ù„Ø±Ø³Ù…: Ø§Ù†Ù‚Ø± ÙˆØ§Ø³Ø­Ø¨ Ù„Ø±Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', 'analysis');
      });
      
      // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ù…
      clearDrawingBtn.addEventListener('click', clearDrawing);
      
      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø³Ù…
      applyDrawingBtn.addEventListener('click', function() {
        isDrawing = false;
        if (drawingPoints.length > 0) {
          showNotification('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø³Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©', 'success');
        }
      });
      
      // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙØ£Ø±Ø© Ù„Ù„Ø±Ø³Ù…
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      function startDrawing(e) {
        if (!isDrawing) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        drawingPoints.push({x, y});
        
        ctx.beginPath();
        ctx.moveTo(x, y);
        
        // Ø±Ø³Ù… Ù†Ù‚Ø·Ø© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        const brushSize = document.getElementById('brushSize').value;
        ctx.arc(x, y, brushSize / 2, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
        ctx.fill();
      }
      
      function draw(e) {
        if (!isDrawing) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        drawingPoints.push({x, y});
        
        const brushSize = document.getElementById('brushSize').value;
        
        ctx.lineTo(x, y);
        ctx.lineWidth = brushSize;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
        ctx.stroke();
        
        // Ø±Ø³Ù… Ø¯Ø§Ø¦Ø±Ø© ÙÙŠ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        ctx.beginPath();
        ctx.arc(x, y, brushSize / 2, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
        ctx.fill();
      }
      
      function stopDrawing() {
        if (isDrawing) {
          ctx.beginPath();
        }
      }
    }

    // ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
    function analyzeImage() {
      if (!currentImageData || !heatmapData) {
        showNotification('ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
      }
      
      // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„
      showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...', 'analysis');
      
      setTimeout(() => {
        // ØªØ­Ù„ÙŠÙ„ Ø¨Ø³ÙŠØ· Ù„Ù„ØµÙˆØ±Ø©
        const width = document.getElementById('preview2d').width;
        const height = document.getElementById('preview2d').height;
        
        // Ø­Ø³Ø§Ø¨ Ø¨Ø¹Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
        let sum = 0;
        let min = Infinity;
        let max = -Infinity;
        
        for (let i = 0; i < heatmapData.length; i++) {
          sum += heatmapData[i];
          if (heatmapData[i] < min) min = heatmapData[i];
          if (heatmapData[i] > max) max = heatmapData[i];
        }
        
        const avg = sum / heatmapData.length;
        const range = max - min;
        
        // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­ÙˆØ§Ù
        let edgeCount = 0;
        if (edgesData) {
          for (let i = 0; i < edgesData.length; i++) {
            if (edgesData[i] > 0) edgeCount++;
          }
        }
        
        const edgeDensity = edgeCount / edgesData.length;
        
        // Ø­ÙØ¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„
        analysisResults = {
          points: heatmapData.length,
          avgHeight: avg,
          minHeight: min,
          maxHeight: max,
          heightRange: range,
          edgeCount: edgeCount,
          edgeDensity: edgeDensity,
          complexity: edgeDensity > 0.3 ? 'Ø¹Ø§Ù„ÙŠ' : edgeDensity > 0.1 ? 'Ù…ØªÙˆØ³Ø·' : 'Ù…Ù†Ø®ÙØ¶'
        };
        
        // Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„
        document.getElementById('pointsCount').textContent = analysisResults.points.toLocaleString();
        document.getElementById('totalDistance').textContent = Math.round(analysisResults.points * 0.1) + ' Ù…Ù…';
        document.getElementById('cuttingTime').textContent = Math.round(analysisResults.points * 0.01) + ' Ø¯Ù‚ÙŠÙ‚Ø©';
        document.getElementById('designComplexity').textContent = analysisResults.complexity;
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„
        document.getElementById('analysisPanel').style.display = 'block';
        
        showNotification('ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
      }, 2000);
    }

    // ØªÙˆÙ„ÙŠØ¯ G-code
    function generateGcode() {
      if (!analysisResults.points) {
        showNotification('ÙŠØ±Ø¬Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
      }
      
      showNotification('Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ G-code...', 'analysis');
      
      setTimeout(() => {
        // Ù…Ø­Ø§ÙƒØ§Ø© ØªÙˆÙ„ÙŠØ¯ G-code
        const toolDiameter = parseFloat(document.getElementById('toolDiameter').value);
        const cutDepth = parseFloat(document.getElementById('cutDepth').value);
        const feedRate = parseFloat(document.getElementById('feedRate').value);
        const plungeRate = parseFloat(document.getElementById('plungeRate').value);
        const spindleSpeed = parseFloat(document.getElementById('spindleSpeed').value);
        
        // Ø¥Ù†Ø´Ø§Ø¡ G-code Ø¨Ø³ÙŠØ·
        let gcode = `; G-code generated by CNC AI\n`;
        gcode += `; Tool Diameter: ${toolDiameter} mm\n`;
        gcode += `; Cut Depth: ${cutDepth} mm\n`;
        gcode += `; Feed Rate: ${feedRate} mm/min\n`;
        gcode += `; Plunge Rate: ${plungeRate} mm/min\n`;
        gcode += `; Spindle Speed: ${spindleSpeed} RPM\n\n`;
        
        gcode += `G21 ; Set units to millimeters\n`;
        gcode += `G90 ; Absolute positioning\n`;
        gcode += `G94 ; Units per minute feed rate\n`;
        gcode += `M3 S${spindleSpeed} ; Start spindle clockwise\n\n`;
        
        gcode += `G0 Z5 ; Rapid to safe height\n`;
        gcode += `G0 X0 Y0 ; Rapid to starting position\n\n`;
        
        // Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ø­Ø§ÙƒÙŠØ©
        for (let i = 0; i < 10; i++) {
          const x = i * 10;
          const y = Math.sin(i) * 10;
          gcode += `G1 X${x} Y${y} Z-${cutDepth} F${feedRate}\n`;
        }
        
        gcode += `\nG0 Z5 ; Rapid to safe height\n`;
        gcode += `M5 ; Stop spindle\n`;
        gcode += `M2 ; End program\n`;
        
        // Ø¹Ø±Ø¶ G-code
        document.getElementById('gcodeOutput').textContent = gcode;
        document.getElementById('gcodeLines').textContent = gcode.split('\n').length;
        document.getElementById('fileSize').textContent = Math.round(gcode.length / 1024) + ' KB';
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© G-code
        document.getElementById('gcodePreview').style.display = 'block';
        
        showNotification('ØªÙ… ØªÙˆÙ„ÙŠØ¯ G-code Ø¨Ù†Ø¬Ø§Ø­', 'success');
      }, 3000);
    }

    // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù‚Ø·Ø¹
    function simulateCutting() {
      showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù‚Ø·Ø¹...', 'analysis');
    }

    // Ø­ÙØ¸ G-code
    function saveGcode() {
      const gcode = document.getElementById('gcodeOutput').textContent;
      if (!gcode) {
        showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ G-code Ù„Ø­ÙØ¸Ù‡', 'error');
        return;
      }
      
      const filename = document.getElementById('gcodeFilename').value || 'cnc_design';
      
      const blob = new Blob([gcode], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `${filename}.gcode`;
      document.body.appendChild(a);
      a.click();
      
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      
      showNotification('ØªÙ… Ø­ÙØ¸ Ù…Ù„Ù G-code', 'success');
    }

    // ØªÙˆÙ„ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø®Ø´ÙˆÙ†Ø©
    function generateRoughingPaths() {
      showNotification('Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø®Ø´ÙˆÙ†Ø©...', 'analysis');
    }

    // ØªÙˆÙ„ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªØ´Ø·ÙŠØ¨
    function generateFinishingPaths() {
      showNotification('Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªØ´Ø·ÙŠØ¨...', 'analysis');
    }

    // ØªÙˆÙ„ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªÙ†Ø¹ÙŠÙ…
    function generateSmoothingPaths() {
      showNotification('Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªÙ†Ø¹ÙŠÙ…...', 'analysis');
    }

    // ØªÙˆÙ„ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
    function generateAllPaths() {
      showNotification('Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª...', 'analysis');
    }

    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªÙƒÙŠÙÙŠØ©
    function applyAdaptivePaths() {
      showNotification('Ø¬Ø§Ø±ÙŠ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØªÙƒÙŠÙÙŠØ©...', 'analysis');
    }

    // Ù…Ø­Ø§ÙƒØ§Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„
    function simulateAllStages() {
      showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ù…Ø­Ø§ÙƒØ§Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„...', 'analysis');
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
    function updatePathPreview() {
      showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª...', 'analysis');
    }

    // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
    function optimizePaths() {
      showNotification('Ø¬Ø§Ø±ÙŠ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª...', 'analysis');
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification';
      notification.classList.add(type);
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
