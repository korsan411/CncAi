<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNC AI - النسخة المتطورة مع التحليلات المتقدمة</title>
  <style>
    :root {
      --primary-color: #4a90e2;
      --secondary-color: #67b0f5;
      --bg-color: #f8f9fa;
      --text-color: #212529;
      --card-bg: #ffffff;
      --border-color: #dee2e6;
      --header-bg: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      --header-text: #ffffff;
      --button-bg: #e9ecef;
      --button-hover: #dee2e6;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --error-color: #dc3545;
      --ai-color: #9c27b0;
      --wood-color: #8b4513;
      --tab-inactive: #e9ecef;
      --tab-active: var(--primary-color);
      --analysis-color: #17a2b8;
      --roughing-color: #8b4513;
      --finishing-color: #5a2d0c;
      --smoothing-color: #3d2108;
      --drawing-color: #ff5722;
      --refill-color: #795548;
    }

    body.dark {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --card-bg: #1e1e1e;
      --border-color: #444;
      --header-bg: linear-gradient(90deg, #2c2c2c, #444);
      --button-bg: #333;
      --button-hover: #555;
      --ai-color: #ba68c8;
      --wood-color: #a0522d;
      --tab-inactive: #333;
      --tab-active: #4a90e2;
      --analysis-color: #138496;
      --roughing-color: #a0522d;
      --finishing-color: #8b4513;
      --smoothing-color: #5a2d0c;
      --drawing-color: #ff8a65;
      --refill-color: #8d6e63;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      transition: all 0.3s ease;
      padding: 0;
      margin: 0;
    }

    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 1rem;
      text-align: center;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 1400px;
    }

    h1 {
      font-size: 1.8rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    #themeToggle {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--header-text);
      transition: transform 0.3s;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #themeToggle:hover {
      transform: scale(1.1);
      background: rgba(255, 255, 255, 0.2);
    }

    /* تنسيق التابات */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      background: var(--card-bg);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      background: var(--tab-inactive);
      transition: all 0.3s;
      text-align: center;
      flex: 1;
      font-weight: 500;
    }

    .tab.active {
      background: var(--tab-active);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* محتوى التابات */
    .upload-section {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .file-upload {
      margin: 1.5rem 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .file-upload label {
      background: var(--primary-color);
      color: white;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s;
    }

    .file-upload label:hover {
      background: var(--secondary-color);
    }

    .file-name {
      margin-top: 10px;
      font-size: 0.9rem;
      color: var(--text-color);
    }

    .previews-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    @media (min-width: 992px) {
      .previews-container {
        grid-template-columns: 1fr 1fr;
      }
    }

    .preview-block {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid var(--border-color);
    }

    .preview-title {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--primary-color);
    }

    .preview-content {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }

    canvas {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    #preview3d {
      width: 100%;
      height: 300px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative;
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      width: 100%;
      margin-top: 1rem;
    }

    .option-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .option-group label {
      font-size: 0.9rem;
      font-weight: 500;
    }

    input[type="range"] {
      width: 150px;
      accent-color: var(--primary-color);
    }

    .settings-panel {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 极速.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .settings-group {
      margin-bottom: 1.5rem;
    }

    .settings-group h3 {
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-group select, 
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 5极速;
      background: var(--bg-color);
      color: var(--text-color);
    }

    .gcode-output {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 15px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre-wrap;
      margin-top: 1rem;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--secondary-color);
    }

    .btn-secondary {
      background: var(--button-bg);
      color: var(--text-color);
    }

    .btn-secondary:hover {
      background: var(--button-hover);
    }

    .btn-ai {
      background: var(--ai-color);
      color: white;
    }

    .btn-ai:hover {
      background: #7b1fa2;
    }

    .btn-analysis {
      background: var(--analysis-color);
      color: white;
    }

    .btn-analysis:hover {
      background: #138496;
    }

    .btn-roughing {
      background: var(--roughing-color);
      color: white;
    }

    .btn-finishing {
      background: var(--finishing-color);
      color: white;
    }

    .btn-smoothing {
      background: var(--smoothing-color);
      color: white;
    }

    .btn-drawing {
      background: var(--drawing-color);
      color: white;
    }

    .btn-refill {
      background: var(--refill-color);
      color: white;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    footer {
      text-align: center;
      margin-top: 3rem;
      padding: 1.5rem;
      color: var(--text-color);
      font-size: 0.9rem;
      border-top: 1px solid var(--border-color);
    }

    .image-enhancement {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .enhancement-btn {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background: var(--button-bg);
      color: var(--text-color);
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }

    .enhancement-btn:hover {
      background: var(--button-hover);
    }

    .loading {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      z-index: 100;
      border-radius: 8px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      background: var(--success-color);
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }

    .notification.error {
      background: var(--error-color);
    }

    .notification.ai {
      background: var(--ai-color);
    }

    .notification.analysis {
      background: var(--analysis-color);
    }

    .ai-options {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .path-optimization {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .optimization-option {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .optimization-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .progress-container {
      width: 100%;
      background-color: var(--border-color);
      border-radius: 5px;
      margin: 15px 0;
      display: none;
    }

    .progress-bar {
      width: 0%;
      height: 20px;
      background-color: var(--primary-color);
      border-radius: 5px;
      transition: width 0.3s ease;
    }

    .edge-detection {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .analysis-panel {
      background: var(--card极速g);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      display: none;
    }

    .analysis-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .analysis-item {
      background: var(--bg-color);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .analysis-item h4 {
      margin-bottom: 0.5rem;
      color: var(--analysis-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .analysis-value {
      font-size: 1.2rem;
      font-weight: bold;
    }

    .gcode-preview {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      display: none;
    }

    .gcode-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat-item {
      background: var(--bg-color);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      text-align: center;
    }

    .stat-item h4 {
      margin-bottom: 0.5rem;
      color: var(--primary-color);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .wood-stages {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .wood-stage {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,极速05);
      border: 1px solid var(--border-color);
    }

    .wood-stage h3 {
      margin-bottom: 1rem;
      padding-bottom: 0.5极速;
      border-bottom: 1px solid var(--border-color);
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .advanced-settings {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .path-preview {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .path-preview-content {
      width: 100%;
      height: 300px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--bg-color);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-top: 1rem;
      position: relative;
      overflow: hidden;
    }

    .path-svg {
      width: 100%;
      height: 100%;
    }

    .path-controls {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      justify-content: center;
    }

    .drawing-tools {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 1rem 0;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .drawing-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .drawing-instructions {
      font-size: 0.9rem;
      color: var(--text-color);
      text-align: center;
      margin-top: 0.5rem;
    }

    .drawing-canvas-container {
      position: relative;
      width: 100%;
      height: 300px;
      margin-top: 1rem;
    }

    #drawingCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }

    .manual-selection {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .filename-input {
      margin-top: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filename-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background: var(--bg-color);
      color: var(--text-color);
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.4rem;
      }
      
      .header-content {
        flex-direction: column;
        gap: 15px;
      }
      
      .preview-block {
        padding: 1rem;
      }
      
      .options {
        flex-direction: column;
        align-items: center;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .analysis-results, .gcode-stats {
        grid-template-columns: 1fr;
      }

      .wood-stages {
        grid-template-columns: 1fr;
      }

      .drawing-controls {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1><span>🛠️</span> CNC AI - النسخة المحسنة</h1>
      <div class="controls">
        <button id="themeToggle">🌙</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- التابات -->
    <div class="tabs">
      <div class="tab active" data-tab="preview">معاينة الصورة</div>
      <div class="tab" data-tab="gcode">G-code إعدادات</div>
      <div class="tab" data-tab="advanced">إعدادات متقدمة</div>
    </div>

    <!-- تاب المعاينة -->
    <div class="tab-content active" id="preview-tab">
      <section class="upload-section">
        <h2 class="upload-title">📤 تحميل الصورة</h2>
        <div class="file-upload">
          <input type="file" id="fileInput" accept="image/*" style="display: none;">
          <label for="fileInput"><span>📁</span> اختر صورة</label>
          <div class="file-name" id="fileName">لم يتم اختيار أي صورة بعد</div>
        </div>

        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="image-enhancement">
          <div class="enhancement-btn" onclick="applyEnhancement('brightness')">🔆 سطوع</div>
          <div class="enhancement-btn" onclick="applyEnhancement('contrast')">🌓 تباين</div>
          <div class="enhancement-btn" onclick="applyEnhancement('sharpen')">🔍 حدة</div>
          <div class="enhancement-btn" onclick="applyEnhancement('smooth')">🔄 نعومة</div>
          <div class="enhancement-btn" onclick="applyEnhancement('grayscale')">⚫ تدرج رمادي</div>
          <div class="enhancement-btn" onclick="applyEnhancement('reset')">🔄 إعادة تعيين</div>
        </div>

        <div class="edge-detection">
          <div class="enhancement-btn" onclick="detectEdges('sobel')">🔍 كشف الحواف (Sobel)</div>
          <div class="enhancement-btn" onclick="detectEdges('canny')">🔍 كشف الحواف (Canny)</div>
          <div class="enhancement-btn" onclick="detectEdges('laplacian')">🔍 كشف الحواف (Laplacian)</div>
        </div>
      </section>

      <div class="previews-container">
        <!-- الصورة الأصلية -->
        <div class="preview-block">
          <h3 class="preview-title">📷 الصورة الأصلية</h3>
          <div class="preview-content">
            <canvas id="preview2d"></canvas>
          </div>
        </div>

        <!-- معاينة 3D -->
        <div class="preview-block">
          <h3 class="preview-title">🌀 المعاينة ثلاثية الأبعاد</h3>
          <div class="preview-content">
            <div id="preview3d">
              <div class="loading" id="loading3d">
                <div class="loading-spinner"></div>
                <p>جاري تحميل النموذج...</p>
              </div>
            </div>
          </div>
          <div class="options">
            <div class="option-group">
              <label for="rotationSpeed">🔄 سرعة الدوران</label>
              <input type="range" id="rotationSpeed" min="0" max="0.05" step="0.001" value="0.01">
            </div>
            <div class="option-group">
              <label for="zoomControl">🔍 زوم</label>
              <input type="range" id="zoomControl" min="50" max="500" step="10" value="200">
            </div>
            <div class="option-group">
              <label for="heightIntensity">📏 شدة الارتفاع</label>
              <input type="range" id="heightIntensity" min="20" max="200" step="5" value="80">
            </div>
          </div>
        </div>

        <!-- Heatmap -->
        <div class="preview-block">
          <h3 class="preview-title">🌈 خريطة الارتفاعات (Heatmap)</h3>
          <div class="preview-content">
            <canvas id="heatmap"></canvas>
          </div>
          <div class="colormap-controls">
            <button class="btn btn-secondary" onclick="setColormap('jet')"><span>🌈</span> Jet</button>
            <button class="btn btn-secondary" onclick="setColormap('hot')"><span>🔥</span> Hot</button>
            <button class="btn btn-secondary" onclick="setColormap('cool')"><span>❄️</span> Cool</button>
            <button class="btn btn-secondary" onclick="setColormap('gray')"><span>⚪</span> Gray</button>
          </div>
        </div>

        <!-- حواف الصورة -->
        <div class="preview-block">
          <h3 class="preview-title">🔍 حواف الصورة</h3>
          <div class="preview-content">
            <canvas id="edgesCanvas"></canvas>
          </div>
          <div class="options">
            <div class="option-group">
              <label for="edgeThreshold">📊 عتبة الحواف</label>
              <input type="range" id="edgeThreshold" min="1" max="100" step="1" value="50" oninput="updateEdgeDetection()">
            </div>
          </div>
        </div>

        <!-- تحديد المناطق يدوياً -->
        <div class="preview-block">
          <h3 class="preview-title">✏️ تحديد المناطق يدوياً</h3>
          <div class="preview-content">
            <div class="drawing-canvas-container">
              <canvas id="drawingCanvas"></canvas>
            </div>
          </div>
          <div class="drawing-tools">
            <div class="drawing-controls">
              <button class="btn btn-drawing" id="startDrawing">
                <span>✏️</span> بدء الرسم
              </button>
              <button class="btn btn-secondary" id="clearDrawing">
                <span>🗑️</span> مسح الرسم
              </button>
              <button class="btn btn-primary" id="applyDrawing">
                <span>✅</span> تطبيق الرسم
              </button>
            </div>
            <div class="drawing-instructions">
              <p>ارسم المنطقة التي تريد قطعها. اضغط على "بدء الرسم" لبدء الرسم، ثم انقر واسحب لرسم المنطقة.</p>
            </div>
            <div class="options">
              <div class="option-group">
                <label for="brushSize">📏 حجم الفرشاة</label>
                <input type="range" id="brushSize" min="1" max="20" step="1" value="5">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- تاب إعدادات G-code -->
    <div class="tab-content" id="gcode-tab">
      <div class="ai-options">
        <h3><span>🤖</span> خيارات الذكاء الاصطناعي</h3>
        <div class="path-optimization">
          <div class="optimization-option">
            <input type="checkbox" id="optimizePaths" checked>
            <label for="optim极速Paths">تحسين المسارات لتقليل وقت القطع</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="smoothEdges" checked>
            <label for="smoothEdges">تنعيم الحواف للنتائج الأفضل</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="adaptivePrecision">
            <label for="adaptivePrecision">الدقة التكيفية (تلقائية)</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useEdges" checked>
            <label for="useEdges">استخدام حواف الصورة لتوليد المسارات</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useHeatmap" checked>
            <label for="useHeatmap">استخدام Heatmap لتوليد المسارات</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="startFromEdges" checked>
            <label for="startFromEdges">بدء القطع من الحواف</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useManualSelection">
            <label for="useManualSelection">استخدام التحديد اليدوي للمناطق</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useRefillMode">
            <label for="useRefillMode">وضع الـ Refill (للخشب فقط)</label>
          </div>
        </div>
      </div>

      <div class="settings-panel">
        <div class="settings-group">
          <h3><span>🏭</span> إعدادات الماكينة</h3>
          <div class="form-group">
            <label for="machineType">نوع الماكينة</label>
            <select id="machineType">
              <option value="cnc">CNC Router</option>
              <option value="laser">Laser Cutter</option>
              <option value="3dprinter">3D Printer</option>
            </select>
          </div>
        </div>

        <div class="settings-group">
          <h3><span>📦</span> إعدادات الخامة</h3>
          <div class="form-group">
            <label for="materialType">نوع الخامة</label>
            <select id="materialType">
              <option value="wood">خشب</option>
              <option value="acrylic">أكريليك</option>
              <option value="metal">معدن</option>
              <option value="plastic">بلاستيك</option>
            </select>
          </div>
          <div class="form-group">
            <label for="materialThickness">سمك الخامة (مم)</label>
            <input type="number" id="materialThickness" min="1" max="100" value="10">
          </div>
        </div>

        <div class="settings-group">
          <h3><span>🔧</span> إعدادات القطع</h3>
          <div class="form-group">
            <label for="toolDiameter">قطر الأداة (مم)</label>
            <input type="number" id="toolDiameter" min="0.1" max="10" step="0.1" value="3">
          </div>
          <div class="form-group">
            <label for="cutDepth">عمق القطع (مم)</label>
            <input type="number" id="cutDepth" min="0.1" max="10" step="0.1" value="2">
          </div>
          <div class="form-group">
            <label for="feedRate">سرعة التغذية (مم/دقيقة)</label>
            <input type="number" id="feedRate" min="100" max="5000" step="100" value="1000">
          </div>
          <div class="form-group">
            <label for="plungeRate">سرعة النزول (مم/دقيقة)</label>
            <input type="number" id="plungeRate" min="50" max="1000" step="50" value="300">
          </div>
          <div class="form-group">
            <label for="spindleSpeed">سرعة المغزل (RPM)</label>
            <input type="number" id="spindleSpeed" min="1000" max="24000" step="1000" value="12000">
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" onclick="analyzeImage()">
          <span>🔍</span> تحليل الصورة
        </button>
        <button class="btn btn-ai" onclick="generateGcode()">
          <span>🤖</span> توليد G-code
        </button>
        <button class="btn btn-secondary" onclick="simulateCutting()">
          <span>🔄</span> محاكاة القطع
        </button>
        <button class="btn btn-secondary" onclick="saveGcode()">
          <span>💾</span> حفظ G-code
        </button>
      </div>

      <div class="analysis-panel" id="analysisPanel">
        <h3><span>📊</span> نتائج التحليل</h3>
        <div class="analysis-results">
          <div class="analysis-item">
            <h4><span>🔢</span> عدد النقاط</h4>
            <div class="analysis-value" id="pointsCount">0</div>
          </div>
          <div class="analysis-item">
            <h4><span>📏</span> المسافة الإجمالية</h4>
            <div class="analysis-value" id="totalDistance">0 مم</div>
          </div>
          <div class="analysis-item">
            <h4><span>⏱️</span> وقت القطع المتوقع</h4>
            <div class="analysis-value" id="cuttingTime">0 دقيقة</div>
          </div>
          <div class="analysis-item">
            <h4><span>📐</span> تعقيد التصميم</h4>
            <div class="analysis-value" id="designComplexity">منخفض</div>
          </div>
        </div>
      </div>

      <div class="gcode-preview" id="gcodePreview">
        <h3><span>📝</span> معاينة G-code</h3>
        <div class="gcode-output" id="gcodeOutput"></div>
        <div class="gcode-stats">
          <div class="stat-item">
            <h4>عدد أسطر G-code</h4>
            <div class="stat-value" id="gcodeLines">0</div>
          </div>
          <div class="stat-item">
            <h4>حجم الملف</h4>
            <div class="stat-value" id="fileSize">0 KB</div>
          </div>
        </div>
        <div class="filename-input">
          <label for="gcodeFilename">اسم الملف:</label>
          <input type="text" id="gcodeFilename" value="cnc_design">
          <button class="btn btn-primary" onclick="saveGcode()">
            <span>💾</span> حفظ الملف
          </button>
        </div>
      </div>
    </div>

    <!-- تاب الإعدادات المتقدمة -->
    <div class="tab-content" id="advanced-tab">
      <div class="advanced-settings">
        <h3><span>⚙️</span> إعدادات متقدمة</h3>
        <div class="form-group">
          <label for="resolution">دقة المسارات (1-10)</label>
          <input type="range" id="resolution" min="1" max="10" value="5">
        </div>
        <div class="form-group">
          <label for="stepOver">نسبة التداخل (%)</label>
          <input type="range" id="stepOver" min="10" max="90" value="50">
        </div>
        <div class="form-group">
          <label for="tolerance">مقدار التسامح (0.01-1)</label>
          <input type="range" id="tolerance" min="1" max="100" value="10">
        </div>
        <div class="form-group">
          <label for="smoothingFactor">عامل التنعيم (0-1)</label>
          <input type="range" id="smoothingFactor" min="0" max="100" value="30">
        </div>
        <div class="form-group">
          <label for="zSafeHeight">الارتفاع الآمن (مم)</label>
          <input type="number" id="zSafeHeight" min="1" max="50" value="5">
        </div>
      </div>

      <div class="path-preview">
        <h3><span>🔄</span> معاينة المسارات</h3>
        <div class="path-preview-content">
          <svg class="path-svg" id="pathSvg"></svg>
        </div>
        <div class="path-controls">
          <button class="btn btn-primary" onclick="updatePathPreview()">
            <span>🔄</span> تحديث المعاينة
          </button>
          <button class="btn btn-secondary" onclick="optimizePaths()">
            <span>⚡</span> تحسين المسارات
          </button>
        </div>
      </div>

      <div class="wood-stages">
        <div class="wood-stage">
          <h3><span>🪵</span> مرحلة الخشونة (Roughing)</h3>
          <div class="form-group">
            <label for="roughingToolDiameter">قطر أداة الخشونة (مم)</label>
            <input type="number" id="roughingToolDiameter" min="1" max="10" step="0.5" value="6">
          </div>
          <div class="form-group">
            <label for="roughingStepDown">عمق القطع للخشونة (مم)</label>
            <input type="number" id="roughingStepDown" min="0.5" max="5" step="0.5" value="2">
          </div>
          <div class="form-group">
            <label for="roughingFeedRate">سرعة التغذية للخشونة (مم/د)</label>
            <input type="number" id="roughingFeedRate" min="500" max="3000" step="100" value="1500">
          </div>
          <button class="btn btn-roughing" onclick="generateRoughingPaths()">
            <span>🪵</span> توليد مسارات الخشونة
          </button>
        </div>

        <div class="wood-stage">
          <h3><span>🔍</span> مرحلة التشطيب (Finishing)</h3>
          <div class="form-group">
            <label for="finishingToolDiameter">قطر أداة التشطيب (مم)</label>
            <input type="number" id="finishingToolDiameter" min="0.5" max="5" step="0.1" value="3">
          </div>
          <div class="form-group">
            <label for="finishingStepDown">عمق القطع للتشطيب (مم)</label>
            <input type="number" id="finishingStepDown" min="0.1" max="2" step="0.1" value="0.5">
          </div>
          <div class="form-group">
            <label for="finishingFeedRate">سرعة التغذية للتشطيب (مم/د)</label>
            <input type="number" id="finishingFeedRate" min="100" max="2000" step="50" value="800">
          </div>
          <button class="btn btn-finishing" onclick="generateFinishingPaths()">
            <span>🔍</span> توليد مسارات التشطيب
          </button>
        </div>

        <div class="wood-stage">
          <h3><span>✨</span> مرحلة التنعيم (Smoothing)</h3>
          <div class="form-group">
            <label for="smoothingToolDiameter">قطر أداة التنعيم (مم)</label>
            <input type="number" id="smoothingToolDiameter" min="0.5" max="5" step="0.1" value="3">
          </div>
          <div class="form-group">
            <label for="smoothingStepDown">عمق القطع للتنعيم (مم)</label>
            <input type="number" id="smoothingStepDown" min="0.1" max="1" step="0.1" value="0.2">
          </div>
          <div class="form-group">
            <label for="smoothingFeedRate">سرعة التغذية للتنعيم (مم/د)</label>
            <input type="number" id="smoothingFeedRate" min="100" max="1500" step="50" value="500">
          </div>
          <button class="btn btn-smoothing" onclick="generateSmoothingPaths()">
            <span>✨</span> توليد مسارات التنعيم
          </button>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" onclick="generateAllPaths()">
          <span>🔄</span> توليد جميع المسارات
        </button>
        <button class="btn btn-ai" onclick="applyAdaptivePaths()">
          <span>🤖</span> تطبيق المسارات التكيفية
        </button>
        <button class="btn btn-secondary" onclick="simulateAllStages()">
          <span>🎬</span> محاكاة جميع المراحل
        </button>
      </div>
    </div>
  </div>

  <footer>
    <p>CNC AI - النسخة المتطورة مع التحليلات المتقدمة © 2023</p>
    <p>تم التطوير باستخدام أحدث تقنيات الذكاء الاصطناعي وتحليل الصور</p>
  </footer>

  <div class="notification" id="notification"></div>

  <script>
    // المتغيرات العامة
    let originalImage = null;
    let processedImage = null;
    let currentImageData = null;
    let heatmapData = null;
    let edgesData = null;
    let isDrawing = false;
    let drawingPoints = [];
    let currentColormap = 'jet';
    let toolPaths = [];
    let analysisResults = {};

    // تهيئة الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      // إعداد مستمعات الأحداث
      document.getElementById('fileInput').addEventListener('change', handleImageUpload);
      
      // إعداد التابات
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          activateTab(tabId);
        });
      });

      // إعداد تغيير المظهر
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);

      // إعداد أدوات الرسم
      setupDrawingTools();

      // تحميل الصورة الافتراضية (اختياري)
      // loadDefaultImage();
    });

    // تبديل المظهر بين الفاتح والداكن
    function toggleTheme() {
      document.body.classList.toggle('dark');
      const themeToggle = document.getElementById('themeToggle');
      if (document.body.classList.contains('dark')) {
        themeToggle.textContent = '☀️';
      } else {
        themeToggle.textContent = '🌙';
      }
    }

    // تفعيل تاب معين
    function activateTab(tabId) {
      // إخفاء جميع المحتويات
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // إلغاء تفعيل جميع التابات
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // تفعيل التاب المحدد
      document.getElementById(`${tabId}-tab`).classList.add('active');
      document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
    }

    // التعامل مع رفع الصورة
    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const fileNameElement = document.getElementById('fileName');
      fileNameElement.textContent = file.name;

      // إظهار شريط التقدم
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';

      const reader = new FileReader();
      
      reader.onprogress = function(e) {
        if (e.lengthComputable) {
          const percentLoaded = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width = `${percentLoaded}%`;
        }
      };

      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          // إخفاء شريط التقدم
          progressContainer.style.display = 'none';
          
          // حفظ الصورة الأصلية
          originalImage = img;
          processedImage = img;
          
          // معالجة الصورة وعرضها
          processAndDisplayImage();
          
          // إظهار إشعار بنجاح التحميل
          showNotification('تم تحميل الصورة بنجاح', 'success');
        };
        img.src = e.target.result;
      };
      
      reader.onerror = function() {
        progressContainer.style.display = 'none';
        showNotification('حدث خطأ أثناء تحميل الصورة', 'error');
      };
      
      reader.readAsDataURL(file);
    }

    // معالجة وعرض الصورة
    function processAndDisplayImage() {
      if (!originalImage) return;

      // إنشاء عناصر canvas
      const previewCanvas = document.getElementById('preview2d');
      const heatmapCanvas = document.getElementById('heatmap');
      const edgesCanvas = document.getElementById('edgesCanvas');
      const drawingCanvas = document.getElementById('drawingCanvas');
      
      // تعيين أبعاد canvases
      const maxWidth = 500;
      const maxHeight = 400;
      let width = originalImage.width;
      let height = originalImage.height;
      
      // تغيير الحجم مع الحفاظ على النسبة
      if (width > maxWidth) {
        height = (maxWidth / width) * height;
        width = maxWidth;
      }
      if (height > maxHeight) {
        width = (maxHeight / height) * width;
        height = maxHeight;
      }
      
      [previewCanvas, heatmapCanvas, edgesCanvas, drawingCanvas].forEach(canvas => {
        canvas.width = width;
        canvas.height = height;
      });
      
      // رسم الصورة الأصلية
      const previewCtx = previewCanvas.getContext('2d');
      previewCtx.drawImage(originalImage, 0, 0, width, height);
      
      // الحصول على بيانات الصورة
      currentImageData = previewCtx.getImageData(0, 0, width, height);
      
      // إنشاء Heatmap
      createHeightMap(previewCtx, width, height);
      
      // إنشاء معاينة 3D
      create3dPreview();
      
      // إعداد أدوات الرسم
      setupDrawingTools();
    }

    // إنشاء خريطة الارتفاعات
    function createHeightMap(ctx, width, height) {
      const heatmapCanvas = document.getElementById('heatmap');
      const heatmapCtx = heatmapCanvas.getContext('2d');
      
      // رسم الصورة على heatmap
      heatmapCtx.drawImage(originalImage, 0, 0, width, height);
      
      // الحصول على بيانات البكسل
      const imageData = heatmapCtx.getImageData(0, 0, width, height);
      const data = imageData.data;
      
      // تحويل إلى تدرج رمادي وحساب الارتفاعات
      heatmapData = new Float32Array(width * height);
      
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        // حساب القيمة الرمادية (متوسط مرجح)
        const gray = 0.299 * r + 0.587 * g + 0.114 * b;
        
        // تخزين قيمة الارتفاع (0-255)
        const idx = Math.floor(i / 4);
        heatmapData[idx] = gray / 255;
        
        // تحديث بيانات البكسل بناءً على خريطة الألوان
        const color = getHeatColor(heatmapData[idx], currentColormap);
        data[i] = color.r;
        data[i + 1] = color.g;
        data[i + 2] = color.b;
      }
      
      // وضع البيانات المعالجة على الـ canvas
      heatmapCtx.putImageData(imageData, 0, 0);
    }

    // الحصول على لون Heatmap
    function getHeatColor(value, map) {
      let r, g, b;
      
      if (map === 'jet') {
        // خريطة ألوان Jet (الأزرق إلى الأحمر)
        const fourValue = 4 * value;
        r = Math.min(fourValue - 1.5, -fourValue + 4.5) * 255;
        g = Math.min(fourValue - 0.5, -fourValue + 3.5) * 255;
        b = Math.min(fourValue + 0.5, -fourValue + 2.5) * 255;
      } else if (map === 'hot') {
        // خريطة ألوان Hot (أسود إلى أبيض عبر الأحمر والأصفر)
        r = Math.min(3 * value, 1) * 255;
        g = Math.min(3 * value - 1, 1) * 255;
        g = Math.max(g, 0);
        b = Math.min(3 * value - 2, 1) * 255;
        b = Math.max(b, 0);
      } else if (map === 'cool') {
        // خريطة ألوان Cool (أرجواني إلى أزرق فاتح)
        r = value * 255;
        g = (1 - value) * 255;
        b = 255;
      } else {
        // تدرج رمادي (افتراضي)
        r = value * 255;
        g = value * 255;
        b = value * 255;
      }
      
      return {
        r: Math.max(0, Math.min(255, Math.round(r))),
        g: Math.max(0, Math.min(255, Math.round(g))),
        b: Math.max(0, Math.min(255, Math.round(b)))
      };
    }

    // تعيين خريطة ألوان جديدة
    function setColormap(map) {
      currentColormap = map;
      if (originalImage) {
        createHeightMap(null, document.getElementById('heatmap').width, document.getElementById('heatmap').height);
      }
    }

    // إنشاء معاينة ثلاثية الأبعاد
    function create3dPreview() {
      // هذه الدالة ستستخدم مكتبة مثل Three.js لإنشاء معاينة 3D
      // في هذا المثال، سنقوم بعرض رسالة بسيطة
      const preview3d = document.getElementById('preview3d');
      preview3d.innerHTML = `
        <div style="padding: 20px; text-align: center; color: var(--text-color);">
          <p>🔍 المعاينة ثلاثية الأبعاد تحت التطوير</p>
          <p>سيتم استخدام مكتبة Three.js لإنشاء نموذج ثلاثي الأبعاد بناءً على خريطة الارتفاعات</p>
        </div>
      `;
    }

    // تطبيق تحسينات على الصورة
    function applyEnhancement(type) {
      if (!currentImageData) return;
      
      const canvas = document.getElementById('preview2d');
      const ctx = canvas.getContext('2d');
      const data = currentImageData.data;
      const width = canvas.width;
      const height = canvas.height;
      
      // تطبيق التحسين المحدد
      switch(type) {
        case 'brightness':
          // زيادة السطوع
          const brightnessValue = 30;
          for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.min(255, data[i] + brightnessValue);     // R
            data[i + 1] = Math.min(255, data[i + 1] + brightnessValue); // G
            data[i + 2] = Math.min(255, data[i + 2] + brightnessValue); // B
          }
          break;
          
        case 'contrast':
          // زيادة التباين
          const factor = 1.2;
          for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.min(255, Math.max(0, factor * (data[i] - 128) + 128));     // R
            data[i + 1] = Math.min(255, Math.max(0, factor * (data[i + 1] - 128) + 128)); // G
            data[i + 2] = Math.min(255, Math.max(0, factor * (data[i + 2] - 128) + 128)); // B
          }
          break;
          
        case 'sharpen':
          // زيادة الحدة
          const tempData = new Uint8ClampedArray(data);
          for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
              for (let c = 0; c < 3; c++) {
                const idx = (y * width + x) * 4 + c;
                const newVal = 
                  5 * tempData[idx] - 
                  tempData[idx - 4] - 
                  tempData[idx + 4] - 
                  tempData[idx - width * 4] - 
                  tempData[idx + width * 4];
                data[idx] = Math.min(255, Math.max(0, newVal));
              }
            }
          }
          break;
          
        case 'smooth':
          // تنعيم الصورة
          const smoothData = new Uint8ClampedArray(data);
          for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
              for (let c = 0; c < 3; c++) {
                const idx = (y * width + x) * 4 + c;
                let sum = 0;
                for (let ky = -1; ky <= 1; ky++) {
                  for (let kx = -1; kx <= 1; kx++) {
                    const kidx = ((y + ky) * width + (x + kx)) * 4 + c;
                    sum += smoothData[kidx];
                  }
                }
                data[idx] = Math.round(sum / 9);
              }
            }
          }
          break;
          
        case 'grayscale':
          // تحويل إلى تدرج رمادي
          for (let i = 0; i < data.length; i += 4) {
            const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            data[i] = gray;     // R
            data[i + 1] = gray; // G
            data[i + 2] = gray; // B
          }
          break;
          
        case 'reset':
          // إعادة تعيين إلى الصورة الأصلية
          ctx.drawImage(originalImage, 0, 0, width, height);
          currentImageData = ctx.getImageData(0, 0, width, height);
          break;
      }
      
      // إذا لم يكن reset، تطبيق التغييرات
      if (type !== 'reset') {
        ctx.putImageData(currentImageData, 0, 0);
      }
      
      // إعادة إنشاء heatmap والحواف
      createHeightMap(ctx, width, height);
      detectEdges();
      
      showNotification(`تم تطبيق ${type} على الصورة`, 'success');
    }

    // كشف الحواف
    function detectEdges(algorithm = 'sobel') {
      if (!currentImageData) return;
      
      const canvas = document.getElementById('edgesCanvas');
      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;
      
      // رسم الصورة على canvas الحواف
      ctx.drawImage(originalImage, 0, 0, width, height);
      const imageData = ctx.getImageData(0, 0, width, height);
      const data = imageData.data;
      
      // تحويل إلى تدرج رمادي أولاً
      const grayData = new Uint8ClampedArray(width * height);
      for (let i = 0; i < data.length; i += 4) {
        const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
        grayData[i / 4] = gray;
      }
      
      // تطبيق خوارزمية كشف الحواف
      edgesData = new Uint8ClampedArray(width * height);
      const threshold = document.getElementById('edgeThreshold').value;
      
      if (algorithm === 'sobel') {
        applySobel(grayData, edgesData, width, height, threshold);
      } else if (algorithm === 'canny') {
        applyCanny(grayData, edgesData, width, height, threshold);
      } else if (algorithm === 'laplacian') {
        applyLaplacian(grayData, edgesData, width, height, threshold);
      }
      
      // تحديث بيانات الصورة بناءً على الحواف
      for (let i = 0; i < data.length; i += 4) {
        const edgeValue = edgesData[Math.floor(i / 4)];
        data[i] = edgeValue;     // R
        data[i + 1] = edgeValue; // G
        data[i + 2] = edgeValue; // B
        // تركيب القناة ألفا كما هي
      }
      
      ctx.putImageData(imageData, 0, 0);
      showNotification(`تم تطبيق كشف الحواف (${algorithm})`, 'success');
    }

    // تطبيق كشف Sobel
    function applySobel(input, output, width, height, threshold) {
      const sobelX = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
      const sobelY = [-1, -2, -1, 0, 0, 0, 1, 2, 1];
      
      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          let gx = 0;
          let gy = 0;
          
          for (let ky = -1; ky <= 1; ky++) {
            for (let kx = -1; kx <= 1; kx++) {
              const pixel = input[(y + ky) * width + (x + kx)];
              const kernelIndex = (ky + 1) * 3 + (kx + 1);
              
              gx += pixel * sobelX[kernelIndex];
              gy += pixel * sobelY[kernelIndex];
            }
          }
          
          const magnitude = Math.sqrt(gx * gx + gy * gy);
          output[y * width + x] = magnitude > threshold ? 255 : 0;
        }
      }
    }

    // تطبيق كشف Canny
    function applyCanny(input, output, width, height, threshold) {
      // تطبيق مبسط لخوارزمية Canny
      // في التطبيق الحقيقي، تحتاج إلى تطبيق Gaussian blur أولاً ثم non-maximum suppression
      applySobel(input, output, width, height, threshold);
      
      // هنا سيتم تطبيق الخطوات الإضافية لخوارزمية Canny الكاملة
      // ولكن لأغراض هذا المثال، نستخدم Sobel مع threshold
    }

    // تطبيق كشف Laplacian
    function applyLaplacian(input, output, width, height, threshold) {
      const laplacianKernel = [-1, -1, -1, -1, 8, -1, -1, -1, -1];
      
      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          let sum = 0;
          
          for (let ky = -1; ky <= 1; ky++) {
            for (let kx = -1; kx <= 1; kx++) {
              const pixel = input[(y + ky) * width + (x + kx)];
              const kernelIndex = (ky + 1) * 3 + (kx + 1);
              
              sum += pixel * laplacianKernel[kernelIndex];
            }
          }
          
          output[y * width + x] = Math.abs(sum) > threshold ? 255 : 0;
        }
      }
    }

    // تحديث كشف الحواف عند تغيير العتبة
    function updateEdgeDetection() {
      detectEdges();
    }

    // إعداد أدوات الرسم
    function setupDrawingTools() {
      const canvas = document.getElementById('drawingCanvas');
      const ctx = canvas.getContext('2d');
      const startDrawingBtn = document.getElementById('startDrawing');
      const clearDrawingBtn = document.getElementById('clearDrawing');
      const applyDrawingBtn = document.getElementById('applyDrawing');
      
      // مسح canvas الرسم
      function clearDrawing() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawingPoints = [];
      }
      
      // بدء الرسم
      startDrawingBtn.addEventListener('click', function() {
        isDrawing = true;
        drawingPoints = [];
        showNotification('بدء الرسم: انقر واسحب لرسم المنطقة', 'analysis');
      });
      
      // مسح الرسم
      clearDrawingBtn.addEventListener('click', clearDrawing);
      
      // تطبيق الرسم
      applyDrawingBtn.addEventListener('click', function() {
        isDrawing = false;
        if (drawingPoints.length > 0) {
          showNotification('تم تطبيق الرسم على المنطقة المحددة', 'success');
        }
      });
      
      // أحداث الفأرة للرسم
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      function startDrawing(e) {
        if (!isDrawing) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        drawingPoints.push({x, y});
        
        ctx.beginPath();
        ctx.moveTo(x, y);
        
        // رسم نقطة في البداية
        const brushSize = document.getElementById('brushSize').value;
        ctx.arc(x, y, brushSize / 2, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
        ctx.fill();
      }
      
      function draw(e) {
        if (!isDrawing) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        drawingPoints.push({x, y});
        
        const brushSize = document.getElementById('brushSize').value;
        
        ctx.lineTo(x, y);
        ctx.lineWidth = brushSize;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
        ctx.stroke();
        
        // رسم دائرة في النقطة الحالية
        ctx.beginPath();
        ctx.arc(x, y, brushSize / 2, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
        ctx.fill();
      }
      
      function stopDrawing() {
        if (isDrawing) {
          ctx.beginPath();
        }
      }
    }

    // تحليل الصورة
    function analyzeImage() {
      if (!currentImageData || !heatmapData) {
        showNotification('يرجى تحميل صورة أولاً', 'error');
        return;
      }
      
      // محاكاة عملية التحليل
      showNotification('جاري تحليل الصورة...', 'analysis');
      
      setTimeout(() => {
        // تحليل بسيط للصورة
        const width = document.getElementById('preview2d').width;
        const height = document.getElementById('preview2d').height;
        
        // حساب بعض الإحصائيات البسيطة
        let sum = 0;
        let min = Infinity;
        let max = -Infinity;
        
        for (let i = 0; i < heatmapData.length; i++) {
          sum += heatmapData[i];
          if (heatmapData[i] < min) min = heatmapData[i];
          if (heatmapData[i] > max) max = heatmapData[i];
        }
        
        const avg = sum / heatmapData.length;
        const range = max - min;
        
        // تحليل الحواف
        let edgeCount = 0;
        if (edgesData) {
          for (let i = 0; i < edgesData.length; i++) {
            if (edgesData[i] > 0) edgeCount++;
          }
        }
        
        const edgeDensity = edgeCount / edgesData.length;
        
        // حفظ نتائج التحليل
        analysisResults = {
          points: heatmapData.length,
          avgHeight: avg,
          minHeight: min,
          maxHeight: max,
          heightRange: range,
          edgeCount: edgeCount,
          edgeDensity: edgeDensity,
          complexity: edgeDensity > 0.3 ? 'عالي' : edgeDensity > 0.1 ? 'متوسط' : 'منخفض'
        };
        
        // عرض نتائج التحليل
        document.getElementById('pointsCount').textContent = analysisResults.points.toLocaleString();
        document.getElementById('totalDistance').textContent = Math.round(analysisResults.points * 0.1) + ' مم';
        document.getElementById('cuttingTime').textContent = Math.round(analysisResults.points * 0.01) + ' دقيقة';
        document.getElementById('designComplexity').textContent = analysisResults.complexity;
        
        // إظهار لوحة التحليل
        document.getElementById('analysisPanel').style.display = 'block';
        
        showNotification('تم تحليل الصورة بنجاح', 'success');
      }, 2000);
    }

    // توليد G-code
    function generateGcode() {
      if (!analysisResults.points) {
        showNotification('يرجى تحليل الصورة أولاً', 'error');
        return;
      }
      
      showNotification('جاري توليد G-code...', 'analysis');
      
      setTimeout(() => {
        // محاكاة توليد G-code
        const toolDiameter = parseFloat(document.getElementById('toolDiameter').value);
        const cutDepth = parseFloat(document.getElementById('cutDepth').value);
        const feedRate = parseFloat(document.getElementById('feedRate').value);
        const plungeRate = parseFloat(document.getElementById('plungeRate').value);
        const spindleSpeed = parseFloat(document.getElementById('spindleSpeed').value);
        
        // إنشاء G-code بسيط
        let gcode = `; G-code generated by CNC AI\n`;
        gcode += `; Tool Diameter: ${toolDiameter} mm\n`;
        gcode += `; Cut Depth: ${cutDepth} mm\n`;
        gcode += `; Feed Rate: ${feedRate} mm/min\n`;
        gcode += `; Plunge Rate: ${plungeRate} mm/min\n`;
        gcode += `; Spindle Speed: ${spindleSpeed} RPM\n\n`;
        
        gcode += `G21 ; Set units to millimeters\n`;
        gcode += `G90 ; Absolute positioning\n`;
        gcode += `G94 ; Units per minute feed rate\n`;
        gcode += `M3 S${spindleSpeed} ; Start spindle clockwise\n\n`;
        
        gcode += `G0 Z5 ; Rapid to safe height\n`;
        gcode += `G0 X0 Y0 ; Rapid to starting position\n\n`;
        
        // إضافة بعض الأوامر المحاكية
        for (let i = 0; i < 10; i++) {
          const x = i * 10;
          const y = Math.sin(i) * 10;
          gcode += `G1 X${x} Y${y} Z-${cutDepth} F${feedRate}\n`;
        }
        
        gcode += `\nG0 Z5 ; Rapid to safe height\n`;
        gcode += `M5 ; Stop spindle\n`;
        gcode += `M2 ; End program\n`;
        
        // عرض G-code
        document.getElementById('gcodeOutput').textContent = gcode;
        document.getElementById('gcodeLines').textContent = gcode.split('\n').length;
        document.getElementById('fileSize').textContent = Math.round(gcode.length / 1024) + ' KB';
        
        // إظهار معاينة G-code
        document.getElementById('gcodePreview').style.display = 'block';
        
        showNotification('تم توليد G-code بنجاح', 'success');
      }, 3000);
    }

    // محاكاة القطع
    function simulateCutting() {
      showNotification('جاري تحضير محاكاة القطع...', 'analysis');
    }

    // حفظ G-code
    function saveGcode() {
      const gcode = document.getElementById('gcodeOutput').textContent;
      if (!gcode) {
        showNotification('لا يوجد G-code لحفظه', 'error');
        return;
      }
      
      const filename = document.getElementById('gcodeFilename').value || 'cnc_design';
      
      const blob = new Blob([gcode], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `${filename}.gcode`;
      document.body.appendChild(a);
      a.click();
      
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);
      
      showNotification('تم حفظ ملف G-code', 'success');
    }

    // توليد مسارات الخشونة
    function generateRoughingPaths() {
      showNotification('جاري توليد مسارات الخشونة...', 'analysis');
    }

    // توليد مسارات التشطيب
    function generateFinishingPaths() {
      showNotification('جاري توليد مسارات التشطيب...', 'analysis');
    }

    // توليد مسارات التنعيم
    function generateSmoothingPaths() {
      showNotification('جاري توليد مسارات التنعيم...', 'analysis');
    }

    // توليد جميع المسارات
    function generateAllPaths() {
      showNotification('جاري توليد جميع المسارات...', 'analysis');
    }

    // تطبيق المسارات التكيفية
    function applyAdaptivePaths() {
      showNotification('جاري تطبيق المسارات التكيفية...', 'analysis');
    }

    // محاكاة جميع المراحل
    function simulateAllStages() {
      showNotification('جاري تحضير محاكاة جميع المراحل...', 'analysis');
    }

    // تحديث معاينة المسارات
    function updatePathPreview() {
      showNotification('جاري تحديث معاينة المسارات...', 'analysis');
    }

    // تحسين المسارات
    function optimizePaths() {
      showNotification('جاري تحسين المسارات...', 'analysis');
    }

    // إظهار الإشعارات
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification';
      notification.classList.add(type);
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
