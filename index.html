<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>CNC AI - Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ùˆ G-code</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      direction: rtl;
    }
    header {
      background: #4a90e2;
      color: white;
      padding: 10px 20px;
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: 22px;
    }
    .tabs {
      display: flex;
      justify-content: center;
      background: #eee;
      padding: 10px;
      flex-wrap: wrap;
    }
    .tabs button {
      padding: 10px 20px;
      border: none;
      background: #ddd;
      margin: 3px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .tabs button.active {
      background: #4a90e2;
      color: white;
    }
    .tab-content {
      display: none;
      padding: 15px;
      text-align: center;
    }
    .tab-content.active {
      display: block;
    }
    canvas {
      max-width: 100%;
      border: 1px solid #ccc;
      margin-top: 10px;
    }
    textarea {
      width: 100%;
      height: 200px;
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      resize: vertical;
      font-family: monospace;
    }
    input, button {
      margin: 5px 0;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button.action {
      background: #4a90e2;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    button.action:hover {
      background: #357abd;
    }
    #threeContainer {
      width: 100%;
      height: 400px;
      border: 1px solid #ccc;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ”§ CNC AI - Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ùˆ G-code</h1>
  </header>

  <div class="tabs">
    <button class="active" onclick="openTab(event,'preview')">ğŸ“· Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
    <button onclick="openTab(event,'gcode')">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª G-code</button>
  </div>

  <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
  <div id="preview" class="tab-content active">
    <h2>ğŸ“Š Ù…Ø¹Ø§ÙŠÙ†Ø© 3D</h2>
    <input type="range" id="scaleZ" min="5" max="100" value="30" oninput="updateScaleZ(this.value)">
    <label for="scaleZ">ØªØ­ÙƒÙ… ÙÙŠ Ø§Ø±ØªÙØ§Ø¹ Z</label>
    <div id="threeContainer"></div>
  </div>

  <!-- ØªØ¨ÙˆÙŠØ¨ G-code -->
  <div id="gcode" class="tab-content">
    <h2>ØªÙˆÙ„ÙŠØ¯ G-code</h2>
    <label>ğŸ“ Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ù…):</label>
    <input type="number" id="widthMm" value="100"><br>
    <label>ğŸ“ Ø§Ù„Ø·ÙˆÙ„ (Ù…Ù…):</label>
    <input type="number" id="heightMm" value="100"><br>
    <label>â¬‡ï¸ Ø¹Ù…Ù‚ Ø§Ù„Ù‚Ø·Ø¹ (Z Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠÙ…ØªØ±):</label>
    <input type="number" id="depthMm" value="2"><br>

    <button class="action" onclick="generateGcode()">âš™ï¸ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
    <button class="action" onclick="downloadGcode()">ğŸ’¾ ØªØ­Ù…ÙŠÙ„</button>

    <textarea id="gcodeOutput" readonly placeholder="Ù‡Ù†Ø§ Ø³ÙŠØ¸Ù‡Ø± ÙƒÙˆØ¯ G-code..."></textarea>

    <h3>ğŸ“Š Ù…Ø¹Ø§ÙŠÙ†Ø© 2D Ù„Ù„Ù…Ø³Ø§Ø±</h3>
    <canvas id="gcodeCanvas" width="500" height="500"></canvas>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø© Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    let gcodeText = "";
    let scene, camera, renderer, controls, mesh;
    let scaleZ = 30;

    function openTab(evt, tabId) {
      document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
      document.querySelectorAll(".tabs button").forEach(el => el.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

    // ========== Ù…Ø¹Ø§ÙŠÙ†Ø© 3D ==========
    function init3D() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, window.innerWidth / 400, 0.1, 1000);
      camera.position.set(0, -150, 150);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth * 0.8, 400);
      document.getElementById("threeContainer").appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(0, -1, 1).normalize();
      scene.add(light);

      animate();
    }

    function create3DPlane(width = 50, height = 50) {
      if (mesh) scene.remove(mesh);
      const geometry = new THREE.PlaneGeometry(width, height, 50, 50);
      const material = new THREE.MeshPhongMaterial({ color: 0x4a90e2, wireframe: false, flatShading: true });
      mesh = new THREE.Mesh(geometry, material);

      // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Z
      geometry.attributes.position.array.forEach((val, i) => {
        if ((i + 1) % 3 === 0) {
          geometry.attributes.position.array[i] = (Math.random() - 0.5) * scaleZ;
        }
      });
      geometry.computeVertexNormals();

      scene.add(mesh);
    }

    function updateScaleZ(value) {
      scaleZ = value;
      create3DPlane();
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }

    // ========== G-code ==========
    function generateGcode() {
      const width = parseFloat(document.getElementById("widthMm").value);
      const height = parseFloat(document.getElementById("heightMm").value);
      const depth = parseFloat(document.getElementById("depthMm").value);

      gcodeText = `; G-code Generated by CNC AI\n`;
      gcodeText += `G21 ; Set units to millimeters\n`;
      gcodeText += `G90 ; Absolute positioning\n`;
      gcodeText += `G1 Z5 F500 ; Ø±ÙØ¹ Ø§Ù„Ø£Ø¯Ø§Ø©\n`;
      gcodeText += `G0 X0 Y0 ; Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©\n`;

      const stepX = width / 10;
      const stepY = height / 10;
      let path = [];

      for (let y = 0; y <= height; y += stepY) {
        for (let x = 0; x <= width; x += stepX) {
          gcodeText += `G1 X${x.toFixed(2)} Y${y.toFixed(2)} Z-${depth} F300\n`;
          path.push({x, y});
        }
      }

      gcodeText += `G1 Z5 F500 ; Ø±ÙØ¹ Ø§Ù„Ø£Ø¯Ø§Ø©\n`;
      gcodeText += `M30 ; Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬\n`;

      document.getElementById("gcodeOutput").value = gcodeText;
      drawGcodePath(path, width, height);
    }

    function drawGcodePath(path, width, height) {
      const canvas = document.getElementById("gcodeCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const scaleX = canvas.width / width;
      const scaleY = canvas.height / height;

      ctx.beginPath();
      ctx.moveTo(path[0].x * scaleX, path[0].y * scaleY);
      for (let i = 1; i < path.length; i++) {
        ctx.lineTo(path[i].x * scaleX, path[i].y * scaleY);
      }
      ctx.strokeStyle = "blue";
      ctx.lineWidth = 1.5;
      ctx.stroke();
    }

    function downloadGcode() {
      if (!gcodeText) {
        alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹!");
        return;
      }
      const blob = new Blob([gcodeText], {type: "text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "cnc_output.gcode";
      a.click();
      URL.revokeObjectURL(url);
    }

    window.onload = () => {
      init3D();
      create3DPlane();
    };
  </script>
</body>
</html>
