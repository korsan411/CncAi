<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CNC AI â€” Heatmap Colormaps + Edge Sensitivity + Colored TopView</title>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://docs.opencv.org/4.8.0/opencv.js" async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #041022 0%, #0a1a2e 100%); 
      color:#e6eef6; 
      line-height:1.45;
      overflow-x: hidden;
    }
    
    .app { 
      max-width:1400px; 
      margin:12px auto; 
      padding:14px;
      position: relative;
    }
    
    /* ØªØ£Ø«ÙŠØ± Ø®Ù„ÙÙŠ */
    .bg-effects {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }
    
    .bg-effect {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(6,182,212,0.1) 0%, rgba(6,182,212,0) 70%);
      animation: float 15s infinite linear;
    }
    
    .bg-effect:nth-child(1) {
      width: 300px;
      height: 300px;
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }
    
    .bg-effect:nth-child(2) {
      width: 200px;
      height: 200px;
      top: 60%;
      right: 15%;
      animation-delay: -5s;
    }
    
    .bg-effect:nth-child(3) {
      width: 400px;
      height: 400px;
      bottom: 10%;
      left: 20%;
      animation-delay: -10s;
    }
    
    @keyframes float {
      0% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(30px, -50px) rotate(120deg); }
      66% { transform: translate(-20px, 20px) rotate(240deg); }
      100% { transform: translate(0, 0) rotate(360deg); }
    }
    
    header { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      margin-bottom:20px; 
      padding-bottom:15px; 
      border-bottom:1px solid rgba(30, 41, 59, 0.6);
      background: rgba(11, 19, 32, 0.7);
      padding: 15px 20px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    h1 {
      background: linear-gradient(90deg, #06b6d4, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
    }
    
    .grid { 
      display:grid; 
      grid-template-columns:1fr 520px; 
      gap:20px;
    }
    
    @media (max-width:1100px){ 
      .grid{ grid-template-columns:1fr; } 
    }
    
    .panel { 
      background: rgba(11, 19, 32, 0.7); 
      padding:20px; 
      border-radius:12px; 
      border:1px solid rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .panel:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    }
    
    /* tabs improved */
    .tab-buttons { 
      display:flex; 
      gap:8px; 
      margin-top:15px; 
      background: rgba(14,23,33,0.6); 
      padding:8px; 
      border-radius:10px;
      border: 1px solid rgba(30, 41, 59, 0.3);
    }
    
    .tab-buttons button { 
      flex:1; 
      border:none; 
      padding:10px 12px; 
      border-radius:8px; 
      background:transparent; 
      color:#9bb0c8; 
      cursor:pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .tab-buttons button:hover { 
      background: rgba(6, 182, 212, 0.1);
      color: #e6eef6;
    }
    
    .tab-buttons button.active { 
      background: linear-gradient(135deg, #06b6d4, #0ea5e9); 
      color:#fff; 
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }
    
    .tab-content { 
      display:none; 
      margin-top:15px;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .tab-content.active { 
      display:block; 
    }
    
    canvas { 
      max-width:100%; 
      border-radius:8px; 
      background:#000; 
      display:block; 
      margin:0 auto; 
      border:1px solid rgba(51, 65, 85, 0.5);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    #threeContainer { 
      width:100%; 
      height:420px; 
      background: linear-gradient(135deg, #081224 0%, #0d1b2a 100%); 
      border-radius:10px; 
      overflow:hidden; 
      position:relative;
      border: 1px solid rgba(51, 65, 85, 0.5);
    }
    
    label { 
      display:block; 
      margin-top:15px; 
      color:#cfeaf2; 
      font-weight:600;
      font-size: 0.95rem;
    }
    
    input, select, textarea, button { 
      font-size:0.95rem;
      transition: all 0.3s ease;
    }
    
    input, select { 
      width:100%; 
      padding:10px 12px; 
      border-radius:8px; 
      border:1px solid rgba(30, 41, 59, 0.5); 
      background: rgba(15, 23, 42, 0.7); 
      color:#e6eef6; 
      margin-top:8px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #06b6d4;
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
    }
    
    .button-group { 
      display:flex; 
      flex-direction:column; 
      gap:10px; 
      margin-top:15px; 
    }
    
    .button-row { 
      display:flex; 
      gap:10px; 
    }
    
    button { 
      background: rgba(30, 41, 59, 0.8); 
      color:#e6eef6; 
      border:none; 
      padding:12px 16px; 
      border-radius:10px; 
      cursor:pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    
    button:hover::before {
      left: 100%;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    button.primary { 
      background: linear-gradient(135deg, #06b6d4, #0ea5e9); 
      color:#fff; 
      font-weight:600;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }
    
    button.primary:hover {
      background: linear-gradient(135deg, #0ea5e9, #06b6d4);
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
    }
    
    button.secondary { 
      background: rgba(51, 65, 85, 0.7); 
    }
    
    button.secondary:hover {
      background: rgba(51, 65, 85, 0.9);
    }
    
    #toast { 
      position:fixed; 
      left:16px; 
      bottom:16px; 
      background:rgba(0,0,0,0.85); 
      color:#fff; 
      padding:12px 16px; 
      border-radius:10px; 
      display:none; 
      z-index:10000;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: slideInUp 0.3s ease;
    }
    
    @keyframes slideInUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .canvas-placeholder { 
      width:100%; 
      min-height:260px; 
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); 
      border-radius:8px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      color:#9bb0c8; 
      border:1px solid rgba(51, 65, 85, 0.5);
      flex-direction: column;
      gap: 15px;
    }
    
    .small-meta { 
      font-size:12px; 
      color:#9bb0c8; 
      margin-top:8px;
      line-height: 1.5;
    }
    
    /* Loading Spinners */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(6, 182, 212, 0.2);
      border-top: 4px solid #06b6d4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .loading-spinner.small {
      width: 20px;
      height: 20px;
      border-width: 2px;
    }
    
    .loading-pulse {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #06b6d4;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(0.8); opacity: 0.8; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0.8; }
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #06b6d4, #3b82f6);
      border-radius: 3px;
      width: 0%;
      transition: width 0.5s ease;
    }
    
    /* Card hover effects */
    .feature-card {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      border: 1px solid rgba(30, 41, 59, 0.3);
      transition: all 0.3s ease;
    }
    
    .feature-card:hover {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(6, 182, 212, 0.3);
      transform: translateY(-3px);
    }
    
    /* Simulation controls */
    .sim-controls { 
      position:absolute; 
      top:10px; 
      left:10px; 
      z-index:120; 
      display:flex; 
      gap:8px; 
      align-items:center; 
      background:rgba(0,0,0,0.5); 
      padding:10px;
      border-radius:8px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .sim-controls button { 
      background:rgba(0,0,0,0.6); 
      color:white; 
      border:1px solid #06b6d4; 
      border-radius:6px; 
      padding:8px 12px; 
      cursor:pointer; 
      font-size:0.9rem;
    }
    
    .sim-progress { 
      position:absolute; 
      bottom:10px; 
      left:10px; 
      z-index:120; 
      background:rgba(0,0,0,0.5); 
      padding:8px 12px;
      border-radius:8px; 
      color:#cfeaf2; 
      font-size:12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* Top view + legend */
    #topViewContainer { 
      margin-top:15px; 
      display:flex; 
      flex-direction:column; 
      gap:8px; 
      align-items:center; 
    }
    
    #topView { 
      width:100%; 
      height:200px; 
      background: linear-gradient(135deg, #0d1722 0%, #152232 100%); 
      border-radius:8px; 
      border:1px solid rgba(51, 65, 85, 0.5); 
      display:block;
    }
    
    #topLegend { 
      width:100%; 
      height:20px; 
      border-radius:8px; 
      border:1px solid rgba(43, 56, 68, 0.5); 
      background:linear-gradient(90deg,#ddd,#333); 
    }

    /* colormap buttons under heatmap */
    .colormap-buttons { 
      display:flex; 
      gap:8px; 
      justify-content:center; 
      margin-top:12px; 
    }
    
    .colormap-buttons button { 
      background:rgba(20, 27, 34, 0.7); 
      color:#cfeaf2; 
      border:1px solid rgba(38, 52, 63, 0.5); 
      padding:8px 12px; 
      border-radius:8px; 
      cursor:pointer; 
      font-size:13px;
    }
    
    .colormap-buttons button.active { 
      background:linear-gradient(135deg, #06b6d4, #0ea5e9); 
      color:#fff; 
      border-color:#06b6d4; 
    }

    /* Status indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(30, 41, 59, 0.3);
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9bb0c8;
      animation: pulse 2s infinite;
    }
    
    .status-dot.ready { background: #10b981; }
    .status-dot.loading { background: #f59e0b; }
    .status-dot.error { background: #ef4444; }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .grid { gap: 15px; }
      .panel { padding: 15px; }
      .button-row { flex-direction: column; }
      header { flex-direction: column; gap: 10px; text-align: center; }
      h1 { font-size: 1.5rem; }
    }

    @keyframes spin { 
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); } 
    }
  </style>
</head>
<body>
  <!-- ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© -->
  <div class="bg-effects">
    <div class="bg-effect"></div>
    <div class="bg-effect"></div>
    <div class="bg-effect"></div>
  </div>

  <div class="app">
    <header>
      <h1>CNC AI â€” Heatmap Colormaps + Edge Sensitivity</h1>
      <div class="status-indicator" id="cvState">
        <div class="status-dot loading"></div>
        <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ OpenCV...</span>
        <div class="loading-spinner small"></div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT panel -->
      <div class="panel">
        <div class="feature-card">
          <div style="display:flex;gap:10px;align-items:center;">
            <input id="fileInput" type="file" accept="image/*" style="display:none"/>
            <label class="file-input-label" for="fileInput" style="display:inline-flex;align-items:center;gap:8px;padding:10px 16px;background:rgba(30,41,59,0.7);border-radius:8px;color:#e6eef6;cursor:pointer;border:1px dashed rgba(51,65,85,0.5);transition:all 0.3s ease;">
              <span>ğŸ“</span>
              <span>Ø§Ø®ØªØ± ØµÙˆØ±Ø©</span>
            </label>
            <div style="flex:1"></div>

            <label for="edgeMode" style="font-weight:normal;color:#9bb0c8;white-space:nowrap;">ÙˆØ¶Ø¹ Ø§Ù„Ø­ÙˆØ§Ù:</label>
            <select id="edgeMode" style="width:140px">
              <option value="auto">Canny (Ø¹Ø§Ø¯ÙŠ)</option>
              <option value="sobel">Sobel (Ø¯Ù‚ÙŠÙ‚)</option>
              <option value="laplace">Laplacian (Ù†Ø§Ø¹Ù…)</option>
            </select>
          </div>

          <!-- Edge sensitivity slider -->
          <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
            <label style="margin:0;color:#9bb0c8;white-space:nowrap;">Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ù:</label>
            <input id="edgeSensitivity" type="range" min="0.1" max="1.0" step="0.05" value="0.33" style="flex:1">
            <div id="edgeValue" style="min-width:44px;text-align:center;color:#cfeaf2;font-weight:600;">0.33</div>
          </div>
        </div>

        <div class="tab-buttons" role="tablist">
          <button data-tab="original" class="active">ğŸ–¼ï¸ Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
          <button data-tab="heatmap">ğŸ”¥ Heatmap</button>
          <button data-tab="contour">ğŸ“ Contours</button>
          <button data-tab="topview">ğŸ” Top View</button>
          <button data-tab="simulation">ğŸ¬ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</button>
        </div>

        <div id="original" class="tab-content active">
          <div class="canvas-placeholder" id="originalPlaceholder">
            <div class="loading-spinner"></div>
            <div>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
            <div class="small-meta">Ù‚Ù… Ø¨ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
          </div>
          <canvas id="canvasOriginal" style="display:none;"></canvas>
        </div>

        <div id="heatmap" class="tab-content">
          <div class="canvas-placeholder" id="heatmapPlaceholder">
            <div class="loading-spinner"></div>
            <div>Heatmap Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
            <div class="small-meta">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</div>
          </div>
          <canvas id="canvasHeatmap" style="display:none;"></canvas>

          <!-- colormap buttons under heatmap -->
          <div class="colormap-buttons" id="colormapButtons">
            <button data-map="jet" class="active">Jet</button>
            <button data-map="hot">Hot</button>
            <button data-map="cool">Cool</button>
            <button data-map="gray">Gray</button>
          </div>

          <div class="small-meta">Ø§Ø®ØªÙØ± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù€ colormap. Ø§Ù„ØªØºÙŠÙŠØ± ÙŠØ­Ø¯Ø« Ù„Ø­Ø¸ÙŠØ§Ù‹ ÙˆÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Heatmap ÙˆTop View.</div>
        </div>

        <div id="contour" class="tab-content">
          <div class="canvas-placeholder" id="contourPlaceholder">
            <div class="loading-spinner"></div>
            <div>Contours Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
            <div class="small-meta">Ø³ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø­ÙˆØ§Ù Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</div>
          </div>
          <canvas id="canvasContour" style="display:none;"></canvas>
          <div class="small-meta">ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù Ø£Ùˆ ØªØ­Ø±ÙŠÙƒ Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ù ÙŠØ­Ø¯Ø« Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</div>
        </div>

        <div id="topview" class="tab-content">
          <div id="topViewContainer">
            <div class="canvas-placeholder" id="topViewPlaceholder">
              <div class="loading-spinner"></div>
              <div>Top View Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
              <div class="small-meta">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¨Ø¹Ø¯ ØªÙˆÙ„ÙŠØ¯ G-code</div>
            </div>
            <canvas id="topView" style="display:none;"></canvas>
            <div id="topLegend" title="Ø¹Ù…Ù‚ Ø§Ù„Ù†Ù‚Ø´ â€” Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙ‚Ø·" style="display:none;"></div>
          </div>
          <div class="small-meta">Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø¹Ù…Ù‚ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° G-code (Ø§Ù„Ø£Ù„ÙˆØ§Ù† ØªØªØ¨Ø¹ Ø§Ø®ØªÙŠØ§Ø± Colormap)</div>
        </div>

        <div id="simulation" class="tab-content">
          <div id="threeContainer">
            <div class="canvas-placeholder" id="simulationPlaceholder">
              <div class="loading-spinner"></div>
              <div>Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
              <div class="small-meta">Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø¹Ø¯ ØªÙˆÙ„ÙŠØ¯ G-code</div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT panel -->
      <div class="panel">
        <h3 style="margin-top:0;background:linear-gradient(90deg, #06b6d4, #3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…</h3>

        <div class="feature-card">
          <label for="machineType">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
          <select id="machineType">
            <option value="router">Router CNC</option>
            <option value="laser">Laser Engraver</option>
            <option value="plasma">Plasma Cutter</option>
            <option value="3dprinter">3D Printer</option>
          </select>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:15px">
            <div>
              <label for="workWidth">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
              <input id="workWidth" type="number" value="30" step="0.1" min="1" max="200"/>
              <div class="small-meta" id="widthMm">300.0 Ù…Ù…</div>
            </div>
            <div>
              <label for="workHeight">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
              <input id="workHeight" type="number" value="20" step="0.1" min="1" max="200"/>
              <div class="small-meta" id="heightMm">200.0 Ù…Ù…</div>
            </div>
          </div>

          <label for="workDepth">Ø¹Ù…Ù‚ Ø§Ù„Ø¹Ù…Ù„ (Ù…Ù…)</label>
          <input id="workDepth" type="number" value="3.0" step="0.1" min="0.1" max="50"/>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:15px">
            <div>
              <label for="originX">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ X (Ø³Ù…)</label>
              <input id="originX" type="number" value="0" step="0.1"/>
            </div>
            <div>
              <label for="originY">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ Y (Ø³Ù…)</label>
              <input id="originY" type="number" value="0" step="0.1"/>
            </div>
          </div>
          <div style="margin-top:10px">
            <button id="btnCenterOrigin" class="secondary">ğŸ¯ ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„</button>
          </div>
        </div>

        <div class="feature-card">
          <label for="feedRate">Ø³Ø±Ø¹Ø© Ø§Ù„ØªØºØ°ÙŠØ© (Ù…Ù…/Ø¯Ù‚ÙŠÙ‚Ø©)</label>
          <input id="feedRate" type="number" value="800" min="10" max="5000"/>
          <label for="safeZ">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø£Ù…Ø§Ù† (Ù…Ù…)</label>
          <input id="safeZ" type="number" value="5" step="0.1" min="0" max="100"/>

          <label for="scanDir">Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (Raster)</label>
          <select id="scanDir">
            <option value="x">Ø£ÙÙ‚ÙŠ (X)</option>
            <option value="y">Ø±Ø£Ø³ÙŠ (Y)</option>
          </select>

          <label for="stepOver">Ø®Ø·ÙˆØ© Ø§Ù„Ù…Ø³Ø­ (Ù…Ù…)</label>
          <input id="stepOver" type="number" value="5" step="0.1" min="0.1" max="50"/>
          <label for="maxDepth">Ø£Ù‚ØµÙ‰ Ø¹Ù…Ù‚ (Ù…Ù…)</label>
          <input id="maxDepth" type="number" value="3.0" step="0.1" min="0.1" max="50"/>

          <!-- NEW: Fixed Z + Invert Z -->
          <div style="display:flex;gap:10px;margin-top:12px;align-items:center">
            <label style="font-weight:normal;flex:1;"><input id="fixedZ" type="checkbox" /> Ø§Ø³ØªØ®Ø¯Ø§Ù… Z Ø«Ø§Ø¨Øª</label>
            <input id="fixedZValue" type="number" value="-1.0" step="0.1" style="width:120px" />
          </div>
          <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
            <label style="font-weight:normal;flex:1;"><input id="invertZ" type="checkbox" /> Ø¹ÙƒØ³ Z</label>
            <div style="flex:1"></div>
            <label style="font-weight:normal;color:#9bb0c8">Ù„ÙˆÙ† Ø§Ù„Ø®Ø´Ø¨:</label>
            <select id="woodColor" style="width:140px">
              <option value="#deb887">Ø®Ø´Ø¨ ÙØ§ØªØ­</option>
              <option value="#a0522d" selected>Ø®Ø´Ø¨ Ù…ØªÙˆØ³Ø·</option>
              <option value="#d2b48c">Ø¨ÙŠØ¬</option>
              <option value="#8b5a2b">Ù…Ø§Ù‡ÙˆØ¬Ù†ÙŠ</option>
            </select>
          </div>
        </div>

        <div class="button-group">
          <div class="button-row">
            <button id="btnGen" class="primary">
              <span>âš¡ ØªÙˆÙ„ÙŠØ¯ G-code (Raster)</span>
            </button>
            <button id="btnQuick" class="secondary">
              <span>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹</span>
            </button>
          </div>

          <div style="margin-top:12px">
            <label for="contourMode">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø­ÙˆØ§Ù (Contour)</label>
            <select id="contourMode">
              <option value="outer">Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ÙÙ‚Ø·</option>
              <option value="all">ÙƒÙ„ Ø§Ù„Ø­ÙˆØ§Ù</option>
            </select>
            <div style="height:10px"></div>
            <div class="button-row">
              <button id="btnContour" class="secondary">
                <span>ğŸŒ€ ØªÙˆÙ„ÙŠØ¯ G-code (Contour)</span>
              </button>
              <button id="btnDownload" class="secondary">
                <span>ğŸ’¾ ØªØ­Ù…ÙŠÙ„ G-code</span>
              </button>
            </div>
          </div>
        </div>

        <div id="estTime" style="margin-top:15px;color:#9bb0c8;text-align:center;padding:12px;background:rgba(15,23,42,0.5);border-radius:8px;border:1px solid rgba(30,41,59,0.3);">
          â±ï¸ ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ÙˆÙ‚Øª: Ø³ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯
        </div>

        <label for="gcodeOut" style="margin-top:15px">ğŸ“„ Ù…Ø®Ø±Ø¬Ø§Øª G-code</label>
        <textarea id="gcodeOut" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± G-code Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯..." style="height:180px;background:rgba(2,16,36,0.7);color:#cfeaf2;border-radius:8px;padding:12px;border:1px solid rgba(30,41,59,0.5);resize:vertical;"></textarea>

      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toast"></div>

  <script>
    // ================= Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© =================
    let cvReady = false;
    let grayMat = null;
    let contour = null;
    let previewCanvas = null;
    let additionalContours = [];
    let lastScanDir = 'x';
    let lastGeneratedGcode = '';
    let currentColormap = 'jet';

    // Simulation / Three
    let scene, camera, renderer, controls;
    let simulation = { isPlaying: false, animationFrame: null, tool: null, toolPath: null, pathPoints: [], index: 0, speed: 1 };

    // ================= Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ =================
    function showLoading(elementId, message = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...") {
      const element = document.getElementById(elementId);
      if (element) {
        element.innerHTML = `
          <div class="loading-spinner"></div>
          <div>${message}</div>
          <div class="progress-bar">
            <div class="progress-fill" id="${elementId}-progress"></div>
          </div>
        `;
        element.style.display = 'flex';
        
        // Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„
        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 10;
          const progressBar = document.getElementById(`${elementId}-progress`);
          if (progressBar) {
            progressBar.style.width = Math.min(progress, 90) + '%';
          }
          if (progress >= 90) {
            clearInterval(interval);
          }
        }, 200);
      }
    }

    function hideLoading(elementId, showCanvasId = null) {
      const element = document.getElementById(elementId);
      if (element) {
        element.style.display = 'none';
      }
      if (showCanvasId) {
        const canvas = document.getElementById(showCanvasId);
        if (canvas) {
          canvas.style.display = 'block';
        }
      }
    }

    function updateProgress(elementId, progress) {
      const progressBar = document.getElementById(`${elementId}-progress`);
      if (progressBar) {
        progressBar.style.width = progress + '%';
      }
    }

    // ================= Helper UI funcs =================
    function showToast(msg, ms = 3000) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(t._t);
      t._t = setTimeout(() => {
        t.style.display = 'none';
      }, ms);
      console.log(msg);
    }

    function cmToMm(cm) { return cm * 10; }
    function mmToCm(mm) { return mm / 10; }

    function updateDimensionDisplay() {
      const widthCm = parseFloat(document.getElementById('workWidth').value) || 0;
      const heightCm = parseFloat(document.getElementById('workHeight').value) || 0;
      document.getElementById('widthMm').textContent = cmToMm(widthCm).toFixed(1) + ' Ù…Ù…';
      document.getElementById('heightMm').textContent = cmToMm(heightCm).toFixed(1) + ' Ù…Ù…';
    }

    // ================= OpenCV readiness =================
    function waitForCv() {
      if (typeof cv !== 'undefined' && cv.getBuildInformation) {
        cvReady = true;
        const cvState = document.getElementById('cvState');
        cvState.innerHTML = `
          <div class="status-dot ready"></div>
          <span>âœ… OpenCV Ø¬Ø§Ù‡Ø²</span>
        `;
        showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ OpenCV Ø¨Ù†Ø¬Ø§Ø­', 1400);
      } else {
        setTimeout(waitForCv, 100);
      }
    }
    waitForCv();

    // ================= Tabs behavior =================
    document.querySelectorAll('.tab-buttons button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');

        if (btn.dataset.tab === 'simulation' && document.getElementById('gcodeOut').value) {
          initSimulation();
        }
      });
    });

    // ================= Load image =================
    document.getElementById('fileInput').addEventListener('change', async function (e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.match('image.*')) {
        showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ÙÙ‚Ø·');
        return;
      }
      
      try {
        showLoading('originalPlaceholder', 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...');
        
        const img = new Image();
        img.src = URL.createObjectURL(file);
        
        img.onload = async function() {
          updateProgress('originalPlaceholder', 50);
          
          previewCanvas = document.getElementById('canvasOriginal');
          const ctx = previewCanvas.getContext('2d');

          const maxPixels = 1024 * 1024;
          let w = img.width, h = img.height;
          const currentPixels = w * h;
          if (currentPixels > maxPixels) {
            const ratio = Math.sqrt(maxPixels / currentPixels);
            w = Math.floor(w * ratio);
            h = Math.floor(h * ratio);
            showToast('ØªÙ… ØªØ­Ø³ÙŠÙ† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£ÙØ¶Ù„');
          }

          previewCanvas.width = w;
          previewCanvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);
          
          updateProgress('originalPlaceholder', 100);
          setTimeout(() => {
            hideLoading('originalPlaceholder', 'canvasOriginal');
          }, 500);

          if (cvReady) {
            await detectContours();
          } else {
            showToast('ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± OpenCV...');
            setTimeout(async () => { if (cvReady) await detectContours(); }, 800);
          }
        };
        
        img.onerror = function() {
          showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©');
          hideLoading('originalPlaceholder');
        };
        
      } catch (error) {
        console.error('image load error', error);
        showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©');
        hideLoading('originalPlaceholder');
      }
    });

    // ================= Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ =================
    // [ÙŠØªØ¨Ø¹ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©]
    
    // ÙÙŠ Ø¯Ø§Ù„Ø© detectContours ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ©:
    async function detectContours() {
      if (!cvReady) {
        showToast('OpenCV ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¨Ø¹Ø¯');
        return;
      }
      
      showLoading('heatmapPlaceholder', 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Heatmap...');
      showLoading('contourPlaceholder', 'Ø¬Ø§Ø±ÙŠ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø­ÙˆØ§Ù...');
      
      try {
        // ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
        
        // Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:
        setTimeout(() => {
          hideLoading('heatmapPlaceholder', 'canvasHeatmap');
          hideLoading('contourPlaceholder', 'canvasContour');
        }, 500);
        
      } catch (err) {
        console.error('detectContours error', err);
        showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©');
        hideLoading('heatmapPlaceholder');
        hideLoading('contourPlaceholder');
      }
    }

    // ÙÙŠ Ø¯ÙˆØ§Ù„ ØªÙˆÙ„ÙŠØ¯ G-code ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ©:
    function generateRasterGcode(scaleDown = false) {
      showLoading('simulationPlaceholder', 'Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ G-code...');
      // ... Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ
      
      // Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:
      setTimeout(() => {
        hideLoading('simulationPlaceholder');
      }, 500);
    }

    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ

  </script>
</body>
</html>
