<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNC AI Preview - النسخة المتطورة</title>
  <style>
    /* الأنماط الحالية تبقى كما هي */
    /* ... الأنماط السابقة ... */
    
    /* إضافة أنماط جديدة للتحكم بالذكاء الاصطناعي */
    .ai-controls {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin: 1rem 0;
      border: 1px solid var(--border-color);
    }
    
    .ai-progress {
      margin-top: 1rem;
      width: 100%;
      height: 20px;
      background: var(--button-bg);
      border-radius: 10px;
      overflow: hidden;
    }
    
    .ai-progress-bar {
      height: 100%;
      background: var(--primary-color);
      width: 0%;
      transition: width 0.5s;
    }
    
    .ai-model-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    
    .ai-model {
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }
    
    .ai-model:hover {
      border-color: var(--primary-color);
      background: rgba(74, 144, 226, 0.1);
    }
    
    .ai-model.selected {
      border-color: var(--primary-color);
      background: rgba(74, 144, 226, 0.2);
    }
    
    .ai-model h4 {
      margin-bottom: 0.5rem;
      color: var(--primary-color);
    }
    
    .ai-model p {
      font-size: 0.9rem;
      color: var(--text-color);
    }
    
    .training-section {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }
  </style>
</head>
<body>
  <!-- المحتوى الحالي يبقى كما هو -->
  <!-- ... المحتوى السابق ... -->
  
  <!-- إضافة قسم الذكاء الاصطناعي في تاب المعاينة -->
  <div class="tab-content active" id="preview-tab">
    <!-- المحتوى الحالي -->
    
    <!-- إضافة قسم تحكم الذكاء الاصطناعي -->
    <div class="ai-controls">
      <h3 class="preview-title">🧠 تحكم الذكاء الاصطناعي</h3>
      
      <div class="ai-model-selector">
        <div class="ai-model selected" data-model="cnn">
          <h4>🔄 نموذج CNN الأساسي</h4>
          <p>نموذج شبكة عصبية تلافيفية لاستخراج خريطة الارتفاع</p>
        </div>
        <div class="ai-model" data-model="gan">
          <h4>🎨 نموذج GAN المتقدم</h4>
          <p>نموذج متقدم لإنتاج خرائط ارتفاع عالية الدقة</p>
        </div>
        <div class="ai-model" data-model="custom">
          <h4>⚙️ نموذج مخصص</h4>
          <p>تحميل نموذج مخصص مدرب مسبقًا</p>
        </div>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="analyzeWithAI()">
          <span>🧠</span> تحليل بالذكاء الاصطناعي
        </button>
        <button class="btn btn-secondary" onclick="optimizeToolpath()">
          <span>🔧</span> تحسين المسار تلقائيًا
        </button>
        <button class="btn btn-secondary" onclick="trainCustomModel()">
          <span>🎓</span> تدريب نموذج مخصص
        </button>
      </div>
      
      <div class="ai-progress">
        <div class="ai-progress-bar" id="aiProgressBar"></div>
      </div>
      <div id="aiStatus">جاهز للتحليل</div>
      
      <div class="training-section" id="trainingSection" style="display: none;">
        <h4>تدريب نموذج مخصص</h4>
        <p>قم بتحميل مجموعة من الصور وخرائط الارتفاع المقابلة لها لتدريب نموذج مخصص</p>
        
        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="document.getElementById('trainingData').click()">
            <span>📁</span> تحميل بيانات التدريب
          </button>
          <input type="file" id="trainingData" multiple style="display: none;" onchange="handleTrainingData(this.files)">
          
          <button class="btn btn-primary" onclick="startTraining()">
            <span>🎓</span> بدء التدريب
          </button>
        </div>
        
        <div class="ai-progress">
          <div class="ai-progress-bar" id="trainingProgressBar"></div>
        </div>
        <div id="trainingStatus">لم يتم تحميل بيانات التدريب بعد</div>
      </div>
    </div>
    
    <!-- بقية المحتوى -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
  <script>
    // متغيرات الذكاء الاصطناعي
    let aiModel = null;
    let currentAIModel = 'cnn';
    let isTraining = false;
    let trainingData = [];
    let customModel = null;

    // تهيئة نماذج الذكاء الاصطناعي
    async function initAIModels() {
      updateAIStatus('جاري تحميل نماذج الذكاء الاصطناعي...');
      updateAIProgress(10);
      
      try {
        // تحميل النموذج الأساسي
        await loadBaseModel();
        updateAIProgress(100);
        updateAIStatus('نماذج الذكاء الاصطناعي جاهزة');
        showNotification('تم تحميل نماذج الذكاء الاصطناعي بنجاح');
      } catch (error) {
        console.error('Error loading AI models:', error);
        updateAIStatus('فشل في تحميل النماذج: ' + error.message);
        showNotification('فشل في تحميل نماذج الذكاء الاصطناعي', true);
      }
    }

    // تحميل النموذج الأساسي
    async function loadBaseModel() {
      // في بيئة الإنتاج، سنقوم بتحميل نموذج مدرب مسبقاً
      // هنا نبني نموذجاً بسيطاً للتوضيح
      
      aiModel = tf.sequential();
      
      // طبقات الإدخال والتلافيف
      aiModel.add(tf.layers.conv2d({
        inputShape: [256, 256, 3],
        filters: 32,
        kernelSize: 3,
        activation: 'relu'
      }));
      
      aiModel.add(tf.layers.maxPooling2d({poolSize: 2}));
      
      aiModel.add(tf.layers.conv2d({
        filters: 64,
        kernelSize: 3,
        activation: 'relu'
      }));
      
      aiModel.add(tf.layers.maxPooling2d({poolSize: 2}));
      
      aiModel.add(tf.layers.conv2d({
        filters: 64,
        kernelSize: 3,
        activation: 'relu'
      }));
      
      // تطبيق flatten وإضافة طبقات densely connected
      aiModel.add(tf.layers.flatten());
      
      aiModel.add(tf.layers.dense({units: 128, activation: 'relu'}));
      aiModel.add(tf.layers.dropout({rate: 0.2}));
      
      aiModel.add(tf.layers.dense({units: 64, activation: 'relu'}));
      
      // طبقة الإخراج - خريطة ارتفاع 64x64
      aiModel.add(tf.layers.dense({units: 64 * 64, activation: 'sigmoid'}));
      aiModel.add(tf.layers.reshape({targetShape: [64, 64, 1]}));
      
      // تجميع النموذج
      aiModel.compile({
        optimizer: 'adam',
        loss: 'meanSquaredError',
        metrics: ['accuracy']
      });
      
      console.log('AI Model loaded successfully');
    }

    // تحليل الصورة باستخدام الذكاء الاصطناعي
    async function analyzeWithAI() {
      if (!fileInput.files[0]) {
        showNotification('يجب تحميل صورة أولاً', true);
        return;
      }
      
      if (!aiModel) {
        showNotification('نماذج الذكاء الاصطناعي غير جاهزة بعد', true);
        return;
      }
      
      updateAIStatus('جاري تحليل الصورة...');
      updateAIProgress(10);
      
      try {
        // تحميل الصورة وتحويلها إلى تنسيق مناسب للنموذج
        const img = new Image();
        img.onload = async () => {
          // معالجة الصورة
          updateAIProgress(30);
          
          const tensor = tf.browser.fromPixels(img)
            .resizeNearestNeighbor([256, 256])
            .toFloat()
            .div(tf.scalar(255.0))
            .expandDims();
          
          updateAIProgress(50);
          
          // التنبؤ باستخدام النموذج
          const prediction = aiModel.predict(tensor);
          
          updateAIProgress(80);
          
          // معالجة النتائج
          const heightData = await processPrediction(prediction);
          
          // تحديث المعاينة ثلاثية الأبعاد
          update3DPreviewWithAIData(heightData);
          
          updateAIProgress(100);
          updateAIStatus('تم التحليل بنجاح');
          showNotification('تم تحليل الصورة باستخدام الذكاء الاصطناعي');
          
          // تنظيف الذاكرة
          tensor.dispose();
          prediction.dispose();
        };
        
        img.src = URL.createObjectURL(fileInput.files[0]);
      } catch (error) {
        console.error('AI Analysis error:', error);
        updateAIStatus('فشل في التحليل: ' + error.message);
        showNotification('فشل في تحليل الصورة', true);
      }
    }

    // معالجة تنبؤات النموذج
    async function processPrediction(prediction) {
      const data = await prediction.data();
      const [width, height] = prediction.shape.slice(1, 3);
      
      // تحويل البيانات إلى صورة ارتفاع
      const heightData = new Float32Array(width * height);
      
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const idx = y * width + x;
          heightData[idx] = data[idx] * 255; // تحويل إلى نطاق 0-255
        }
      }
      
      return {
        data: heightData,
        width: width,
        height: height
      };
    }

    // تحديث المعاينة ثلاثية الأبعاد ببيانات الذكاء الاصطناعي
    function update3DPreviewWithAIData(heightData) {
      // حفظ بيانات الارتفاع للاستخدام لاحقاً
      heightMapData = heightData;
      
      // إنشاء شبكة 3D من بيانات الارتفاع
      const geometry = new THREE.PlaneGeometry(100, 100, heightData.width-1, heightData.height-1);
      const colors = [];
      
      for (let i = 0; i < geometry.attributes.position.count; i++) {
        const stride = i * 3;
        const x = i % heightData.width;
        const y = Math.floor(i / heightData.width);
        const idx = y * heightData.width + x;
        
        // تحديث ارتفاع الرأس بناءً على بيانات الذكاء الاصطناعي
        geometry.attributes.position.array[stride + 2] = heightData.data[idx] / heightFactor;
        
        // إضافة الألوان بناءً على الارتفاع
        const norm = heightData.data[idx] / 255;
        const color = getHeatColor(norm, currentColormap);
        colors.push(color.r/255, color.g/255, color.b/255);
      }
      
      geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
      geometry.computeVertexNormals();
      
      const material = new THREE.MeshLambertMaterial({ 
        vertexColors: true, 
        side: THREE.DoubleSide,
        wireframe: false
      });
      
      if (mesh) scene.remove(mesh);
      mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);
      
      // تحديث خريطة الحرارة
      updateHeatmapFromAIData(heightData);
    }

    // تحديث خريطة الحرارة ببيانات الذكاء الاصطناعي
    function updateHeatmapFromAIData(heightData) {
      heatmap.width = heightData.width;
      heatmap.height = heightData.height;
      const heatData = ctxHeat.createImageData(heightData.width, heightData.height);
      
      for (let y = 0; y < heightData.height; y++) {
        for (let x = 0; x < heightData.width; x++) {
          const idx = y * heightData.width + x;
          const pixelIdx = idx * 4;
          const norm = heightData.data[idx] / 255;
          const color = getHeatColor(norm, currentColormap);
          
          heatData.data[pixelIdx] = color.r;
          heatData.data[pixelIdx+1] = color.g;
          heatData.data[pixelIdx+2] = color.b;
          heatData.data[pixelIdx+3] = 255;
        }
      }
      
      ctxHeat.putImageData(heatData, 0, 0);
    }

    // تحسين مسار الأداة تلقائياً
    async function optimizeToolpath() {
      if (!heightMapData) {
        showNotification('يجب إنشاء خريطة ارتفاع أولاً', true);
        return;
      }
      
      updateAIStatus('جاري تحسين مسار الأداة...');
      updateAIProgress(10);
      
      try {
        // محاكاة عملية تحسين المسار
        // في التطبيق الحقيقي، ستستخدم هذه خوارزميات تحسين حقيقية
        
        updateAIProgress(30);
        
        // محاكاة معالجة البيانات
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        updateAIProgress(70);
        
        // محاكاة تحسين المسار
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        updateAIProgress(100);
        updateAIStatus('تم تحسين مسار الأداة');
        showNotification('تم تحسين مسار الأداة باستخدام الذكاء الاصطناعي');
        
        // توليد G-code محسن
        generateOptimizedGcode();
      } catch (error) {
        console.error('Toolpath optimization error:', error);
        updateAIStatus('فشل في تحسين المسار: ' + error.message);
        showNotification('فشل في تحسين مسار الأداة', true);
      }
    }

    // توليد G-code محسن
    function generateOptimizedGcode() {
      // هذا سيكون تنفيذًا متقدمًا في التطبيق الحقيقي
      // هنا نستخدم التوليد الأساسي مع إضافة مؤشر التحسين
      
      generateGcode();
      gcodeOutput.textContent = "; 🧠 مسار محسن باستخدام الذكاء الاصطناعي\n" + gcodeOutput.textContent;
      showNotification('تم توليد G-code محسن');
    }

    // تدريب نموذج مخصص
    function trainCustomModel() {
      document.getElementById('trainingSection').style.display = 'block';
    }

    // معالجة بيانات التدريب
    function handleTrainingData(files) {
      if (files.length === 0) return;
      
      trainingData = [];
      updateTrainingStatus(`تم تحميل ${files.length} ملفًا، جاري المعالجة...`);
      
      // معالجة الملفات (في التطبيق الحقيقي، ستكون هذه عملية معقدة)
      setTimeout(() => {
        updateTrainingStatus(`جاهز للتدريب على ${files.length} عينة`);
        showNotification('تم تحميل بيانات التدريب بنجاح');
      }, 2000);
    }

    // بدء التدريب
    async function startTraining() {
      if (trainingData.length === 0) {
        showNotification('يجب تحميل بيانات التدريب أولاً', true);
        return;
      }
      
      isTraining = true;
      updateTrainingStatus('جاري تدريب النموذج...');
      
      // محاكاة عملية التدريب
      for (let epoch = 0; epoch < 10; epoch++) {
        if (!isTraining) break;
        
        updateTrainingProgress((epoch + 1) * 10);
        updateTrainingStatus(`جاري التدريب (العصر ${epoch + 1}/10)`);
        
        // محاكاة وقت التدريب
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      if (isTraining) {
        updateTrainingStatus('اكتمل التدريب بنجاح');
        showNotification('تم تدريب النموذج المخصص بنجاح');
        isTraining = false;
      }
    }

    // وظائف المساعدة لتحديث الواجهة
    function updateAIStatus(message) {
      document.getElementById('aiStatus').textContent = message;
    }
    
    function updateAIProgress(percent) {
      document.getElementById('aiProgressBar').style.width = percent + '%';
    }
    
    function updateTrainingStatus(message) {
      document.getElementById('trainingStatus').textContent = message;
    }
    
    function updateTrainingProgress(percent) {
      document.getElementById('trainingProgressBar').style.width = percent + '%';
    }

    // تهيئة نماذج الذكاء الاصطناعي عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      initAIModels();
      
      // إعداد مستمعي الأحداث لنماذج الذكاء الاصطناعي
      document.querySelectorAll('.ai-model').forEach(model => {
        model.addEventListener('click', function() {
          document.querySelectorAll('.ai-model').forEach(m => m.classList.remove('selected'));
          this.classList.add('selected');
          currentAIModel = this.getAttribute('data-model');
        });
      });
    });

    // بقية الكود الأصلي يبقى كما هو
    // ...
  </script>
</body>
</html>
