<!doctype html>

<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>CNC AI â€” Multi Machine Raster Engraving (Ù…Ø­Ø³Ù‘Ù†)</title><!-- Ù…ÙƒØªØ¨Ø§Øª -->
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

<style>
    /* Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, Segoe UI, system-ui; background: #041022; color: #e6eef6; line-height: 1.5; }
    .app { max-width: 1400px; margin: 16px auto; padding: 14px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #1e293b; }
    .grid { display: grid; grid-template-columns: 1fr 480px; gap: 16px; }
    @media (max-width: 1000px) { .grid { grid-template-columns: 1fr; } }
    .panel { background: #0b1320; padding: 16px; border-radius: 10px; border: 1px solid #1e293b; }
    .panel-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #1e293b; }
    .panel-section:last-child { border-bottom: none; margin-bottom: 0; }
    .tabs { display: flex; margin-top: 12px; border-bottom: 1px solid #1e293b; flex-wrap: wrap; }
    .tabs button { margin-left: 6px; padding: 8px 14px; border: none; border-radius: 6px 6px 0 0; cursor: pointer; background: transparent; color: #9bb0c8; transition: all 0.2s; font-size: 0.9rem; margin-bottom: 4px; }
    .tabs button:hover { background: #1e293b; }
    .tabs button.active { background: #06b6d4; color: #021; }
    .tabs button:disabled { opacity: 0.5; cursor: not-allowed; }
    .tab-content { display: none; margin-top: 12px; }
    .tab-content.active { display: block; }
    canvas { max-width: 100%; border-radius: 6px; background: #000; display: block; margin: 0 auto; }
    textarea { width: 100%; height: 200px; background: #021024; color: #cfeaf2; font-family: monospace; border-radius: 8px; padding: 10px; border: 1px solid #1e293b; resize: vertical; }
    #threeContainer, #gcodeSimContainer { width: 100%; height: 360px; background: #081224; border-radius: 8px; overflow: hidden; position: relative; }
    label { display: block; margin-top: 12px; color: #cfeaf2; font-weight: bold; font-size: 0.9rem; }
    .input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    input, select { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #1e293b; background: #0f172a; color: #e6eef6; margin-top: 6px; font-size: 0.9rem; }
    input:focus, select:focus { outline: none; border-color: #06b6d4; }
    .button-group { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
    button.primary { background: #06b6d4; color: #021; font-weight: bold; border: none; padding: 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
    button.primary:hover { background: #0ea5e9; }
    button.secondary { background: #1e293b; color: #e6eef6; border: none; padding: 10px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
    button.secondary:hover { background: #334155; }
    #toast { position: fixed; left: 16px; bottom: 16px; background: rgba(0, 0, 0, 0.85); color: #fff; padding: 10px 14px; border-radius: 8px; display: none; z-index: 10000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
    h1 { margin: 0; color: #06b6d4; font-size: 1.5rem; }
    h3 { margin-top: 0; color: #9bb0c8; font-size: 1.1rem; padding-bottom: 8px; border-bottom: 1px solid #1e293b; }
    h4 { margin: 0 0 10px 0; color: #cfeaf2; font-size: 1rem; }
    #cvState { color: #9bb0c8; font-size: 0.9em; padding: 6px 10px; background: #0f172a; border-radius: 6px; }
    #estTime { margin-top: 12px; color: #9bb0c8; text-align: center; padding: 8px; background: #0f172a; border-radius: 6px; }
    .file-input-container { position: relative; overflow: hidden; display: inline-block; width: 100%; }
    .file-input-container input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    .file-input-label { display: block; padding: 10px; background: #1e293b; color: #e6eef6; text-align: center; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
    .file-input-label:hover { background: #334155; }
    .info-text { font-size: 0.8rem; color: #9bb0c8; margin-top: 4px; }
    .settings-row { display: flex; gap: 10px; align-items: end; }
    .settings-row .input-group { flex: 1; }
    .material-preset { background: #1e293b; border: 1px solid #334155; border-radius: 6px; padding: 8px; margin-top: 8px; cursor: pointer; transition: all 0.2s; }
    .material-preset:hover { background: #334155; }
    .material-preset.active { background: #06b6d4; color: #021; border-color: #06b6d4; }
    .material-name { font-weight: bold; margin-bottom: 4px; }
    .material-details { font-size: 0.8rem; color: #9bb0c8; }
    .active-material .material-details { color: #021; }
    .dimension-info { font-size: 0.8rem; color: #06b6d4; margin-top: 4px; }
    .loading { display: flex; justify-content: center; align-items: center; height: 100%; color: #9bb0c8; font-size: 1.1rem; }
    .sim-controls { position: absolute; bottom: 10px; left: 10px; display: flex; gap: 8px; z-index: 10; }
    .sim-controls button { background: rgba(0, 0, 0, 0.7); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    .sim-controls button:hover { background: rgba(0, 0, 0, 0.9); }
    .sim-info { position: absolute; top: 10px; left: 10px; background: rgba(0, 0, 0, 0.7); color: white; padding: 6px 12px; border-radius: 4px; font-size: 0.8rem; z-index: 10; }
    .progress-bar { width: 100%; height: 4px; background: #1e293b; border-radius: 2px; margin-top: 8px; overflow: hidden; }
    .progress-fill { height: 100%; background: #06b6d4; width: 0%; transition: width 0.3s; }
    .three-controls { margin-top: 8px; display:flex; gap:8px; align-items:center; }
</style>

</head>
<body>
    <div class="app">
        <header>
            <h1>CNC AI â€” Multi Machine Raster Engraving</h1>
            <div id="cvState">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ OpenCV...</div>
        </header><div class="grid">
        <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
        <div class="panel">
            <div class="file-input-container">
                <input id="fileInput" type="file" accept="image/*"/>
                <label class="file-input-label" for="fileInput">ğŸ“ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„</label>
            </div>

            <div class="tabs">
                <button data-tab="original" class="active">ğŸ–¼ï¸ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
                <button data-tab="heatmap">ğŸ”¥ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©</button>
                <button data-tab="contour">ğŸ“ Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø­ÙˆØ§Ù</button>
                <button data-tab="threeD">ğŸ“¦ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</button>
                <button data-tab="gcodeSim" id="gcodeSimTab" disabled>ğŸ® Ù…Ø­Ø§ÙƒØ§Ø© G-code</button>
            </div>

            <div id="original" class="tab-content active">
                <canvas id="canvasOriginal"></canvas>
            </div>

            <div id="heatmap" class="tab-content">
                <canvas id="canvasHeatmap"></canvas>
            </div>

            <div id="contour" class="tab-content">
                <canvas id="canvasContour"></canvas>
            </div>

            <div id="threeD" class="tab-content">
                <div id="threeContainer">
                    <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯...</div>
                </div>
                <div class="three-controls">
                    <label for="scaleZSlider">Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Z: <span id="scaleZVal">1.0</span>x</label>
                    <input id="scaleZSlider" type="range" min="0" max="5" step="0.05" value="1" style="flex:1" />
                </div>
            </div>

            <div id="gcodeSim" class="tab-content">
                <div id="gcodeSimContainer">
                    <div class="loading">Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø¹Ø¯ ØªÙˆÙ„ÙŠØ¯ G-code</div>
                </div>
            </div>
        </div>

        <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
        <div class="panel">
            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© -->
            <div class="panel-section">
                <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</h3>

                <label for="machineType">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</label>
                <select id="machineType">
                    <option value="router">Router CNC</option>
                    <option value="laser">Laser Engraver</option>
                    <option value="plasma">Plasma Cutter</option>
                    <option value="3dprinter">3D Printer</option>
                </select>

                <div class="info-text" id="machineDescription">Router CNC - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ø­Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø´Ø¨ ÙˆØ§Ù„Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ù„ÙŠÙ†Ø©</div>
            </div>

            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø¬Ù… Ø§Ù„Ø¹Ù…Ù„ -->
            <div class="panel-section">
                <h3>ğŸ“ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø¬Ù… Ø§Ù„Ø¹Ù…Ù„</h3>

                <div class="input-group">
                    <div>
                        <label for="workWidth">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
                        <input id="workWidth" type="number" value="30" step="0.1" min="1" max="100"/>
                        <div class="dimension-info" id="widthMm">300.0 Ù…Ù…</div>
                    </div>

                    <div>
                        <label for="workHeight">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
                        <input id="workHeight" type="number" value="20" step="0.1" min="1" max="100"/>
                        <div class="dimension-info" id="heightMm">200.0 Ù…Ù…</div>
                    </div>
                </div>

                <label for="workDepth">Ø¹Ù…Ù‚ Ø§Ù„Ø¹Ù…Ù„ (Ù…Ù…)</label>
                <input id="workDepth" type="number" value="3.0" step="0.1" min="0.1" max="20"/>

                <div class="settings-row">
                    <div class="input-group">
                        <div>
                            <label for="originX">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ X (Ø³Ù…)</label>
                            <input id="originX" type="number" value="0" step="0.1"/>
                        </div>

                        <div>
                            <label for="originY">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ Y (Ø³Ù…)</label>
                            <input id="originY" type="number" value="0" step="0.1"/>
                        </div>
                    </div>

                    <button id="btnCenterOrigin" class="secondary" style="height: fit-content;">ğŸ¯ ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„</button>
                </div>
            </div>

            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ù…Ø© -->
            <div class="panel-section">
                <h3>ğŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ù…Ø©</h3>

                <label for="materialType">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ø©</label>
                <select id="materialType">
                    <option value="wood">Ø®Ø´Ø¨</option>
                    <option value="acrylic">Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ</option>
                    <option value="aluminum">Ø£Ù„ÙˆÙ…Ù†ÙŠÙˆÙ…</option>
                    <option value="steel">ØµÙ„Ø¨</option>
                    <option value="brass">Ù†Ø­Ø§Ø³</option>
                    <option value="plastic">Ø¨Ù„Ø§Ø³ØªÙŠÙƒ</option>
                    <option value="foam">Ø±ØºÙˆØ©</option>
                    <option value="custom">Ù…Ø®ØµØµ</option>
                </select>

                <div id="materialPresets"></div>
            </div>

            <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ -->
            <div class="panel-section">
                <h3>ğŸš€ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</h3>

                <label for="feedRate">Ø³Ø±Ø¹Ø© Ø§Ù„ØªØºØ°ÙŠØ© (Ù…Ù…/Ø¯Ù‚ÙŠÙ‚Ø©)</label>
                <input id="feedRate" type="number" value="800" min="10" max="5000"/>

                <label for="safeZ">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø£Ù…Ø§Ù† (Ù…Ù…)</label>
                <input id="safeZ" type="number" value="5" step="0.1" min="0" max="50"/>

                <label for="invertZ">Ø¹ÙƒØ³ Ø§Ù„Ù…Ø­ÙˆØ± Z</label>
                <select id="invertZ"><option value="no">Ù„Ø§</option><option value="yes">Ù†Ø¹Ù…</option></select>

                <label for="scanDir">Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª</label>
                <select id="scanDir"><option value="x">Ø£ÙÙ‚ÙŠ (X)</option><option value="y">Ø±Ø£Ø³ÙŠ (Y)</option></select>

                <label for="stepOver">Ø®Ø·ÙˆØ© Ø§Ù„Ù…Ø³Ø­ (Ù…Ù…)</label>
                <input id="stepOver" type="number" value="5" step="0.1" min="0.1" max="20"/>

                <label for="maxDepth">Ø£Ù‚ØµÙ‰ Ø¹Ù…Ù‚ (Ù…Ù…)</label>
                <input id="maxDepth" type="number" value="3.0" step="0.1" min="0.1" max="20"/>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
            <div class="button-group">
                <button id="btnGen" class="primary">âš¡ ØªÙˆÙ„ÙŠØ¯ G-code</button>
                <button id="btnQuick" class="secondary">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹</button>
                <button id="btnDownload" class="secondary">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ G-code</button>
            </div>

            <div id="estTime"></div>

            <label for="gcodeOut" style="margin-top: 16px;">ğŸ“„ Ù…Ø®Ø±Ø¬Ø§Øª G-code</label>
            <textarea id="gcodeOut" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± G-code Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯..."></textarea>
            <div class="progress-bar"><div class="progress-fill" id="genProgress"></div></div>
        </div>
    </div>
</div>

<div id="toast"></div>

<script>
    // ========== ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ==========
    let cvReady = false;
    let grayMat = null;
    let previewCanvas = null;
    let currentScene = null;
    let gcodeSimScene = null;
    let gcodeSimAnimationId = null;
    let isGcodeGenerated = false;
    let scaleZ = parseFloat(document?.getElementById?.('scaleZSlider')?.value || 1.0);

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
    const machineDefaults = { router:{feed:800,safeZ:5,maxDepth:3,stepOver:5,description:"Router CNC - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ø­Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø´Ø¨ ÙˆØ§Ù„Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ù„ÙŠÙ†Ø©"}, laser:{feed:1200,safeZ:0,maxDepth:0,stepOver:0.2,description:"Laser Engraver - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ù‚Ø´ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø´Ø¨ ÙˆØ§Ù„Ø¬Ù„ÙˆØ¯ ÙˆØ§Ù„Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ"}, plasma:{feed:1500,safeZ:3,maxDepth:0,stepOver:1,description:"Plasma Cutter - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø¨Ø³Ù…Ùƒ Ù…Ø®ØªÙ„Ù"},"3dprinter":{feed:1000,safeZ:0.2,maxDepth:0.2,stepOver:0.4,description:"3D Printer - Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© FDM"} };
    const materialPresets = {
        wood:[{name:"Ø®Ø´Ø¨ Ø±Ù‚Ø§Ø¦Ù‚ÙŠ 3Ù…Ù…",feed:1000,maxDepth:3,stepOver:4},{name:"Ø®Ø´Ø¨ MDF 6Ù…Ù…",feed:800,maxDepth:6,stepOver:5},{name:"Ø®Ø´Ø¨ Ø·Ø¨ÙŠØ¹ÙŠ 10Ù…Ù…",feed:600,maxDepth:10,stepOver:6}],
        acrylic:[{name:"Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ 3Ù…Ù…",feed:800,maxDepth:3,stepOver:3},{name:"Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ 5Ù…Ù…",feed:600,maxDepth:5,stepOver:3},{name:"Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ Ø´ÙØ§Ù 2Ù…Ù…",feed:1000,maxDepth:2,stepOver:2}],
        aluminum:[{name:"Ø£Ù„ÙˆÙ…Ù†ÙŠÙˆÙ… Ø±Ù‚Ø§Ø¦Ù‚ 1Ù…Ù…",feed:500,maxDepth:1,stepOver:2},{name:"Ø£Ù„ÙˆÙ…Ù†ÙŠÙˆÙ… 3Ù…Ù…",feed:400,maxDepth:3,stepOver:2},{name:"Ø£Ù„ÙˆÙ…Ù†ÙŠÙˆÙ… 5Ù…Ù…",feed:300,maxDepth:5,stepOver:1.5}],
        steel:[{name:"ØµÙ„Ø¨ Ø·Ø±ÙŠ 2Ù…Ù…",feed:400,maxDepth:2,stepOver:1.5},{name:"Ø³ØªØ§Ù†Ù„Ø³ Ø³ØªÙŠÙ„ 1Ù…Ù…",feed:350,maxDepth:1,stepOver:1}],
        brass:[{name:"Ù†Ø­Ø§Ø³ Ø£ØµÙØ± 2Ù…Ù…",feed:600,maxDepth:2,stepOver:2.5},{name:"Ù†Ø­Ø§Ø³ Ø£Ø­Ù…Ø± 3Ù…Ù…",feed:500,maxDepth:3,stepOver:2}],
        plastic:[{name:"Ø¨Ù„Ø§Ø³ØªÙŠÙƒ ABS 3Ù…Ù…",feed:800,maxDepth:3,stepOver:4},{name:"Ø¨Ù„Ø§Ø³ØªÙŠÙƒ PVC 2Ù…Ù…",feed:700,maxDepth:2,stepOver:3}],
        foam:[{name:"Ø±ØºÙˆØ© PVC 10Ù…Ù…",feed:1200,maxDepth:10,stepOver:6},{name:"Ø±ØºÙˆØ© Ø¨ÙˆÙ„Ø³ØªØ±ÙŠÙ† 20Ù…Ù…",feed:1500,maxDepth:20,stepOver:8}],
        custom:[{name:"Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¨Ø¯Ø¦ÙŠØ©",feed:800,maxDepth:3,stepOver:5}]
    };

    // ========== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ==========
    function showToast(msg, ms = 2000) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.display = 'block';
        clearTimeout(t._t);
        t._t = setTimeout(() => t.style.display = 'none', ms);
    }
    function cmToMm(cm){return cm*10;}
    function mmToCm(mm){return mm/10;}
    function updateDimensionDisplay(){ const widthCm = parseFloat(document.getElementById('workWidth').value) || 0; const heightCm = parseFloat(document.getElementById('workHeight').value) || 0; document.getElementById('widthMm').textContent = cmToMm(widthCm).toFixed(1) + ' Ù…Ù…'; document.getElementById('heightMm').textContent = cmToMm(heightCm).toFixed(1) + ' Ù…Ù…'; }

    // ========== ØªÙ‡ÙŠØ¦Ø© OpenCV ==========
    function waitForCv(){ if(window.cv && cv.getBuildInformation){ cvReady=true; document.getElementById('cvState').textContent='âœ… OpenCV Ø¬Ø§Ù‡Ø²'; showToast('OpenCV ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­',1500); return; } if(window.cv){ cv['onRuntimeInitialized']=()=>{ cvReady=true; document.getElementById('cvState').textContent='âœ… OpenCV Ø¬Ø§Ù‡Ø²'; showToast('OpenCV ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­',1500); }; } else { setTimeout(waitForCv,200); } }
    waitForCv();

    // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ==========
    document.querySelectorAll('.tabs button').forEach(btn=>{ btn.addEventListener('click',()=>{ document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active')); btn.classList.add('active'); const tabId = btn.dataset.tab; document.getElementById(tabId).classList.add('active'); if(tabId==='threeD' && grayMat){ show3D(); } if(tabId==='gcodeSim' && isGcodeGenerated){ initGcodeSimulation(); } }); });

    // ========== Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± ==========
    document.getElementById('fileInput').addEventListener('change', e=>{ const file = e.target.files[0]; if(!file) return; if(!file.type.match('image.*')){ showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ÙÙ‚Ø·'); return; } const img = new Image(); img.onload = function(){ previewCanvas = document.getElementById('canvasOriginal'); const maxWidth = 800; const maxHeight = 600; let newWidth = img.width; let newHeight = img.height; if(newWidth>maxWidth){ newHeight=(maxWidth/newWidth)*newHeight; newWidth=maxWidth; } if(newHeight>maxHeight){ newWidth=(maxHeight/newHeight)*newWidth; newHeight=maxHeight; } previewCanvas.width=newWidth; previewCanvas.height=newHeight; const ctx = previewCanvas.getContext('2d'); ctx.drawImage(img,0,0,newWidth,newHeight); if(cvReady){ detectContours(); } else { showToast('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ OpenCV...'); } } img.onerror = function(){ showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'); }; img.src = URL.createObjectURL(file); });

    // ========== Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© ÙˆØ§Ù„Ø®Ø§Ù…Ø© ==========
    document.getElementById('machineType').addEventListener('change', e=>{ const type = e.target.value; const def = machineDefaults[type]; if(def){ document.getElementById('feedRate').value = def.feed; document.getElementById('safeZ').value = def.safeZ; document.getElementById('maxDepth').value = def.maxDepth; document.getElementById('stepOver').value = def.stepOver; document.getElementById('machineDescription').textContent = def.description; showToast(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ${type}`); } });
    function updateMaterialPresets(){ const materialType = document.getElementById('materialType').value; const presetsContainer = document.getElementById('materialPresets'); presetsContainer.innerHTML=''; if(materialPresets[materialType]){ materialPresets[materialType].forEach((preset,index)=>{ const presetElement = document.createElement('div'); presetElement.className='material-preset'; presetElement.innerHTML=`<div class="material-name">${preset.name}</div><div class="material-details">Ø³Ø±Ø¹Ø©: ${preset.feed} Ù…Ù…/Ø¯ | Ø¹Ù…Ù‚: ${preset.maxDepth} Ù…Ù… | Ø®Ø·ÙˆØ©: ${preset.stepOver} Ù…Ù…</div>`; presetElement.addEventListener('click',()=>{ document.getElementById('feedRate').value=preset.feed; document.getElementById('maxDepth').value=preset.maxDepth; document.getElementById('stepOver').value=preset.stepOver; document.querySelectorAll('.material-preset').forEach(p=>p.classList.remove('active')); presetElement.classList.add('active'); showToast(`âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ${preset.name}`); }); if(index===0) presetElement.classList.add('active'); presetsContainer.appendChild(presetElement); }); } }
    document.getElementById('materialType').addEventListener('change',updateMaterialPresets); updateMaterialPresets();

    // ========== Ø¥Ø¯Ø§Ø±Ø© Ø­Ø¬Ù… Ø§Ù„Ø¹Ù…Ù„ ==========
    document.getElementById('workWidth').addEventListener('input',updateDimensionDisplay);
    document.getElementById('workHeight').addEventListener('input',updateDimensionDisplay);
    updateDimensionDisplay();
    document.getElementById('btnCenterOrigin').addEventListener('click',()=>{ const workWidth = parseFloat(document.getElementById('workWidth').value) || 0; const workHeight = parseFloat(document.getElementById('workHeight').value) || 0; document.getElementById('originX').value = (workWidth/2).toFixed(1); document.getElementById('originY').value = (workHeight/2).toFixed(1); showToast('âœ… ØªÙ… ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„'); });

    // ========== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ÙŠØ© ==========
    function sampleGrayAt(x,y){ if(!grayMat) return 128; const gw = grayMat.cols; const gh = grayMat.rows; if(x<0||x>=previewCanvas.width||y<0||y>=previewCanvas.height) return 128; const gx_f = (x/previewCanvas.width)*(gw-1); const gy_f = (y/previewCanvas.height)*(gh-1); const x0 = Math.floor(gx_f); const y0 = Math.floor(gy_f); const x1 = Math.min(gw-1,x0+1); const y1 = Math.min(gh-1,y0+1); const sx = gx_f - x0; const sy = gy_f - y0; const v00 = grayMat.ucharPtr(y0,x0)[0]; const v10 = grayMat.ucharPtr(y0,x1)[0]; const v01 = grayMat.ucharPtr(y1,x0)[0]; const v11 = grayMat.ucharPtr(y1,x1)[0]; const v0 = v00*(1-sx)+v10*sx; const v1 = v01*(1-sx)+v11*sx; return v0*(1-sy)+v1*sy; }

    function detectContours(){ if(!cvReady||!previewCanvas) return; try{ const src = cv.imread(previewCanvas); grayMat = new cv.Mat(); cv.cvtColor(src,grayMat,cv.COLOR_RGBA2GRAY); const blurred = new cv.Mat(); cv.GaussianBlur(grayMat,blurred,new cv.Size(5,5),0); const edges = new cv.Mat(); cv.Canny(blurred,edges,50,150); const contours = new cv.MatVector(); const hierarchy = new cv.Mat(); cv.findContours(edges,contours,hierarchy,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE); const contourCanvas = document.getElementById('canvasContour'); contourCanvas.width = previewCanvas.width; contourCanvas.height = previewCanvas.height; const ctx = contourCanvas.getContext('2d'); ctx.drawImage(previewCanvas,0,0); ctx.strokeStyle='#06b6d4'; ctx.lineWidth=2; for(let i=0;i<contours.size();i++){ const cnt = contours.get(i); if(!cnt || !cnt.data32S) continue; ctx.beginPath(); for(let j=0;j<cnt.data32S.length;j+=2){ const x = cnt.data32S[j]; const y = cnt.data32S[j+1]; if(j===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.closePath(); ctx.stroke(); cnt.delete(); } src.delete(); blurred.delete(); edges.delete(); contours.delete(); hierarchy.delete(); createHeatmap(); showToast('âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­'); }catch(e){ console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©:',e); showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©'); } }

    function createHeatmap(){ if(!grayMat||!previewCanvas) return; const heatmapCanvas = document.getElementById('canvasHeatmap'); heatmapCanvas.width = previewCanvas.width; heatmapCanvas.height = previewCanvas.height; const ctx = heatmapCanvas.getContext('2d'); ctx.drawImage(previewCanvas,0,0); const imageData = ctx.getImageData(0,0,heatmapCanvas.width,heatmapCanvas.height); const data = imageData.data; for(let i=0;i<data.length;i+=4){ const x = (i/4)%heatmapCanvas.width; const y = Math.floor((i/4)/heatmapCanvas.width); const grayValue = sampleGrayAt(x,y); let r,g,b; if(grayValue<64){ r=0; g=Math.floor((grayValue/64)*255); b=255; } else if(grayValue<128){ r=Math.floor(((grayValue-64)/64)*255); g=255; b=Math.floor((1-((grayValue-64)/64))*255); } else if(grayValue<192){ r=255; g=Math.floor((1-((grayValue-128)/64))*255); b=0; } else { r=255; g=Math.floor((1-((grayValue-192)/64))*128); b=0; } const alpha=0.6; data[i]=Math.floor(data[i]*(1-alpha)+r*alpha); data[i+1]=Math.floor(data[i+1]*(1-alpha)+g*alpha); data[i+2]=Math.floor(data[i+2]*(1-alpha)+b*alpha); } ctx.putImageData(imageData,0,0); }

    // ========== Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ (Ù…Ø­Ø³Ù†Ø©) ==========
    function disposeCurrentScene(){ if(!currentScene) return; try{ if(currentScene.renderer && currentScene.renderer.domElement && currentScene.renderer.domElement.parentNode){ currentScene.renderer.domElement.parentNode.removeChild(currentScene.renderer.domElement); } if(currentScene.geometry) currentScene.geometry.dispose(); if(currentScene.material) currentScene.material.dispose(); if(currentScene.renderer) { currentScene.renderer.forceContextLoss(); currentScene.renderer.domElement = null; currentScene.renderer = null; } }catch(e){ console.warn('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø´Ù‡Ø¯:',e); } currentScene=null; }

    function show3D(){ if(!grayMat||!previewCanvas){ showToast('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©'); return; } const container = document.getElementById('threeContainer'); container.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯...</div>'; disposeCurrentScene(); setTimeout(()=>{ try{ // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ù…Ù„ Ù„ØªØ­Ø¬ÙŠÙ… Ø§Ù„Ø·Ø§Ø¦Ø±Ø© const workWidth = parseFloat(document.getElementById('workWidth').value) || 30; const workHeight = parseFloat(document.getElementById('workHeight').value) || 20; const workWidthMm = cmToMm(workWidth); const workHeightMm = cmToMm(workHeight); // Ø§Ø®ØªØ± Ù…Ù‚ÙŠØ§Ø³ Ù…Ø´Ù‡Ø¯ Ø«Ø§Ø¨Øª (1 Ù…Ø´Ù‡Ø¯ = 10 Ù…Ù…) const sceneUnitPerMm = 1/10; const planeWidth = workWidthMm * sceneUnitPerMm; const planeHeight = workHeightMm * sceneUnitPerMm; const segX = Math.max(1, previewCanvas.width - 1); const segY = Math.max(1, previewCanvas.height - 1); const scene = new THREE.Scene(); const camera = new THREE.PerspectiveCamera(45, container.clientWidth/container.clientHeight, 0.1, 1000); const renderer = new THREE.WebGLRenderer({antialias:true}); renderer.setSize(container.clientWidth, container.clientHeight); renderer.setClearColor(0x041022); container.innerHTML=''; container.appendChild(renderer.domElement); const controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping=true; controls.dampingFactor=0.05; const ambientLight = new THREE.AmbientLight(0x404040); scene.add(ambientLight); const directionalLight = new THREE.DirectionalLight(0xffffff,0.8); directionalLight.position.set(1,1,1); scene.add(directionalLight); // Plane geometry proportionate Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ù…Ù„ const geometry = new THREE.PlaneGeometry(planeWidth, planeHeight, segX, segY); // material ÙŠØ³ØªØ®Ø¯Ù… Ù„ÙˆÙ† Ø£Ø³Ø§Ø³ÙŠ Ù„ÙƒÙ† Ø³Ù†Ø¶Ø¹ texture Ù„Ø§Ø­Ù‚Ø§Ù‹ const material = new THREE.MeshPhongMaterial({ color:0x06b6d4, wireframe:false, side:THREE.DoubleSide, flatShading:true }); const plane = new THREE.Mesh(geometry, material); // Ù…Ø­Ø§Ø°Ø§Ø© Ø§Ù„Ø·Ø§Ø¦Ø±Ø© Ù„ØªÙƒÙˆÙ† ÙÙŠ Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø´Ù‡Ø¯ plane.rotation.x = -Math.PI/2; // Ù†Ø¬Ø¹Ù„ Ø§Ù„Ø³Ø·Ø­ Ù…Ù‚Ø§Ø¨Ù„ Ù„Ù„Ù…Ø´Ø§Ù‡ÙØ¯ Ø¹Ù†Ø¯ ØªÙƒØ¨ÙŠØ± z scene.add(plane); // ØªØ¹Ø¯ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ // Ù†Ø­Ø³Ø¨ Ù…Ø¹Ø§Ù…Ù„ ØªØ­ÙˆÙŠÙ„ Ù…Ù† pixel index Ø¥Ù„Ù‰ Ù…Ø´Ù‡Ø¯: x_pixel maps to -planeWidth/2 ... +planeWidth/2 const positions = geometry.attributes.position.array; // scaleZ Ù…ØªØºÙŠØ±Ø© Ù…Ù† Ø§Ù„Ù€ slider (scene units per unit depth) scaleZ = parseFloat(document.getElementById('scaleZSlider').value) || 1.0; const maxDepth = parseFloat(document.getElementById('maxDepth').value) || 3.0; // Ø³Ù†Ø­ÙˆÙ„ Ø¹Ù…Ù‚ Ø§Ù„Ø¹Ù…Ù„ Ù…Ù… -> scene units const maxDepthScene = (maxDepth) * sceneUnitPerMm * scaleZ; // Ù†Ø­Ø³Ø¨ Ù‚ÙŠÙ…Ø© Ø§Ø±ØªÙØ§Ø¹ Ù„ÙƒÙ„ Ù†Ù‚Ø·Ø© for(let i=0;i<positions.length;i+=3){ const vx = positions[i]; const vy = positions[i+1]; // positions[i+2] is z (up) // Ù†Ø­Ø³Ø¨ pixel index Ù…Ù† Ø®Ù„Ø§Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„Ù€ geometry: Ù†Ø­ØªØ§Ø¬ Ù„Ø§Ø³ØªÙ†ØªØ§Ø¬ xPixel,yPixel Ù…Ù† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù‚Ù…Ù… const vertexIndex = i/3; const ix = vertexIndex % (segX+1); const iy = Math.floor(vertexIndex/(segX+1)); // ix in [0..segX], iy in [0..segY] // Ù†Ø­ÙˆÙ„ Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¨ÙŠÙƒØ³Ù„ image coords const xPixel = Math.round((ix/(segX))*(previewCanvas.width-1)); const yPixel = Math.round((iy/(segY))*(previewCanvas.height-1)); const grayValue = sampleGrayAt(xPixel,yPixel); // depth fraction (0..1) const depthFraction = (255 - grayValue)/255; const heightScene = depthFraction * maxDepthScene; // Ù†Ø¶Ø¹ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ÙÙŠ Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ù…Ø­Ù„ÙŠ (Ø¨Ø¹Ø¯ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø·Ø§Ø¦Ø±Ø©ØŒ Ù…Ø­ÙˆØ± Z Ù‡Ùˆ positions[i+2]) positions[i+2] = heightScene; }
                geometry.attributes.position.needsUpdate = true; geometry.computeVertexNormals(); // Ø¶Ø¨Ø· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                camera.position.set(0, Math.max(planeWidth,planeHeight), Math.max(planeWidth,planeHeight)*0.8 + 2);
                camera.lookAt(scene.position);
                controls.update();

                function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }

                animate();

                // Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø¬Ø¹
                currentScene = { scene, renderer, controls, camera, geometry, material, plane };

                // ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø¬Ù…
                window.addEventListener('resize', ()=>{ if(!currentScene || !currentScene.camera || !currentScene.renderer) return; currentScene.camera.aspect = container.clientWidth/container.clientHeight; currentScene.camera.updateProjectionMatrix(); currentScene.renderer.setSize(container.clientWidth, container.clientHeight); });

                showToast('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯');
            }catch(error){ console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯:',error); container.innerHTML = '<div class="loading">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</div>'; showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯'); }
        },100);
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ø§Ù„Ù€ 3D Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù€ slider
    document.getElementById('scaleZSlider').addEventListener('input', (e)=>{
        const val = parseFloat(e.target.value);
        document.getElementById('scaleZVal').textContent = val.toFixed(2);
        scaleZ = val;
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø´Ù‡Ø¯ Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§ Ø£Ø¹Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª ÙÙ‚Ø·
        if(currentScene && currentScene.geometry && previewCanvas && grayMat){
            const geometry = currentScene.geometry;
            const positions = geometry.attributes.position.array;
            const segX = Math.max(1, previewCanvas.width-1);
            const segY = Math.max(1, previewCanvas.height-1);
            const workWidth = parseFloat(document.getElementById('workWidth').value) || 30;
            const workHeight = parseFloat(document.getElementById('workHeight').value) || 20;
            const workWidthMm = cmToMm(workWidth);
            const sceneUnitPerMm = 1/10;
            const maxDepth = parseFloat(document.getElementById('maxDepth').value) || 3.0;
            const maxDepthScene = maxDepth * sceneUnitPerMm * scaleZ;
            for(let i=0;i<positions.length;i+=3){ const vertexIndex = i/3; const ix = vertexIndex % (segX+1); const iy = Math.floor(vertexIndex/(segX+1)); const xPixel = Math.round((ix/(segX))*(previewCanvas.width-1)); const yPixel = Math.round((iy/(segY))*(previewCanvas.height-1)); const grayValue = sampleGrayAt(xPixel,yPixel); const depthFraction = (255 - grayValue)/255; positions[i+2] = depthFraction * maxDepthScene; }
            geometry.attributes.position.needsUpdate = true; geometry.computeVertexNormals(); showToast('ğŸ”§ ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ù‚ÙŠØ§Ø³ Z ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©'); }
    });

    // ========== Ù…Ø­Ø§ÙƒØ§Ø© G-code ==========
    function initGcodeSimulation(){ if(!isGcodeGenerated){ showToast('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªÙˆÙ„ÙŠØ¯ G-code Ø£ÙˆÙ„Ø§Ù‹'); return; } const container = document.getElementById('gcodeSimContainer'); container.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©...</div>'; if(gcodeSimScene){ if(gcodeSimScene.renderer && gcodeSimScene.renderer.domElement) container.removeChild(gcodeSimScene.renderer.domElement); if(gcodeSimAnimationId){ cancelAnimationFrame(gcodeSimAnimationId); gcodeSimAnimationId=null; } gcodeSimScene=null; }
        setTimeout(()=>{
            try{
                const scene = new THREE.Scene(); const camera = new THREE.PerspectiveCamera(75, container.clientWidth/container.clientHeight,0.1,1000); const renderer = new THREE.WebGLRenderer({antialias:true}); renderer.setSize(container.clientWidth, container.clientHeight); renderer.setClearColor(0x081224); container.innerHTML=''; container.appendChild(renderer.domElement); const controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping=true; controls.dampingFactor=0.05; const ambientLight = new THREE.AmbientLight(0x404040); scene.add(ambientLight); const directionalLight = new THREE.DirectionalLight(0xffffff,0.8); directionalLight.position.set(1,1,1); scene.add(directionalLight); const gridHelper = new THREE.GridHelper(20,20,0x444444,0x222222); scene.add(gridHelper); const axesHelper = new THREE.AxesHelper(5); scene.add(axesHelper);

                // Ù…Ù†ØµØ© Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¨Ù†ÙŠØ© Ø­Ø³Ø¨ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¹Ù…Ù„ (scene units)
                const workWidth = parseFloat(document.getElementById('workWidth').value) || 30;
                const workHeight = parseFloat(document.getElementById('workHeight').value) || 20;
                const workWidthMm = cmToMm(workWidth);
                const workHeightMm = cmToMm(workHeight);
                const sceneUnitPerMm = 1/10;
                const platformGeometry = new THREE.BoxGeometry(workWidthMm*sceneUnitPerMm, workHeightMm*sceneUnitPerMm, 0.5);
                const platformMaterial = new THREE.MeshPhongMaterial({color:0x333333});
                const platform = new THREE.Mesh(platformGeometry, platformMaterial);
                platform.position.z = -0.25;
                scene.add(platform);

                // Ø±Ø£Ø³ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©
                const toolGeometry = new THREE.CylinderGeometry(0.2,0.2,1,8);
                const toolMaterial = new THREE.MeshPhongMaterial({color:0xff0000});
                const tool = new THREE.Mesh(toolGeometry, toolMaterial);
                tool.position.set(0,0,0.5);
                scene.add(tool);

                const pathPoints = [];
                const pathGeometry = new THREE.BufferGeometry().setFromPoints(pathPoints);
                const pathMaterial = new THREE.LineBasicMaterial({color:0x06b6d4, linewidth:2});
                const path = new THREE.Line(pathGeometry, pathMaterial);
                scene.add(path);

                camera.position.set(10,10,10); camera.lookAt(0,0,0); controls.update();

                gcodeSimScene = { scene, camera, renderer, controls, tool, path, pathPoints };

                const simControls = document.createElement('div'); simControls.className='sim-controls'; simControls.innerHTML = `<button id="simPlay">â–¶ ØªØ´ØºÙŠÙ„</button><button id="simPause">â¸ Ø¥ÙŠÙ‚Ø§Ù</button><button id="simReset">â¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>`; container.appendChild(simControls);
                const simInfo = document.createElement('div'); simInfo.className='sim-info'; simInfo.innerHTML='Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©'; simInfo.id='simInfo'; container.appendChild(simInfo);

                document.getElementById('simPlay').addEventListener('click',()=>{ startGcodeSimulation(); });
                document.getElementById('simPause').addEventListener('click',()=>{ if(gcodeSimAnimationId){ cancelAnimationFrame(gcodeSimAnimationId); gcodeSimAnimationId=null; document.getElementById('simInfo').innerHTML='Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ù…ØªÙˆÙ‚ÙØ©'; } });
                document.getElementById('simReset').addEventListener('click',()=>{ if(gcodeSimAnimationId){ cancelAnimationFrame(gcodeSimAnimationId); gcodeSimAnimationId=null; } gcodeSimScene.tool.position.set(0,0,0.5); gcodeSimScene.pathPoints.length=0; gcodeSimScene.path.geometry.setFromPoints(gcodeSimScene.pathPoints); document.getElementById('simInfo').innerHTML='Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©'; });

                function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }
                animate();

                window.addEventListener('resize',()=>{ camera.aspect = container.clientWidth/container.clientHeight; camera.updateProjectionMatrix(); renderer.setSize(container.clientWidth, container.clientHeight); });
                showToast('âœ… ØªÙ… ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
            }catch(error){ console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©:',error); container.innerHTML = '<div class="loading">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</div>'; showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©'); }
        },100);
    }

    function startGcodeSimulation(){ if(!gcodeSimScene){ showToast('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; } const gcode = document.getElementById('gcodeOut').value; if(!gcode||gcode.trim()===''){ showToast('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ G-code Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©'); return; } const lines = gcode.split('\n'); const tool = gcodeSimScene.tool; const path = gcodeSimScene.path; const pathPoints = gcodeSimScene.pathPoints; pathPoints.length=0; path.geometry.setFromPoints(pathPoints); let currentX=0; let currentY=0; let currentZ=0.5; let lineIndex=0; const simInfo = document.getElementById('simInfo'); function simulateLine(){ if(lineIndex>=lines.length){ gcodeSimAnimationId=null; simInfo.innerHTML='Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©'; return; } const line = lines[lineIndex].trim(); lineIndex++; simInfo.innerHTML = `Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø³Ø·Ø± ${lineIndex} Ù…Ù† ${lines.length}`; if(line.startsWith('G1')||line.startsWith('G0')){ const xMatch = line.match(/X([\d.-]+)/); const yMatch = line.match(/Y([\d.-]+)/); const zMatch = line.match(/Z([\d.-]+)/); if(xMatch) currentX = parseFloat(xMatch[1]) / 10; if(yMatch) currentY = parseFloat(yMatch[1]) / 10; if(zMatch) currentZ = parseFloat(zMatch[1]) / 10 + 0.5; tool.position.set(currentX,currentY,currentZ); pathPoints.push(new THREE.Vector3(currentX,currentY,currentZ)); path.geometry.setFromPoints(pathPoints); }
            // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©: Ù†Ø³ØªØ®Ø¯Ù… requestAnimationFrame Ù„ØªØ¬Ø±Ø¨Ø© Ø£Ù†Ø¹Ù…
            gcodeSimAnimationId = requestAnimationFrame(simulateLine);
        }
        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
        simulateLine();
    }

    // ========== ØªÙˆÙ„ÙŠØ¯ G-code (Ù…ØµØ­Ø­ Ø­Ø³Ø§Ø¨ÙŠØ§Ù‹ ÙˆÙ…Ù†Ø·Ù‚ÙŠØ§Ù‹) ==========
    document.getElementById('btnGen').addEventListener('click',()=>{
        if(!grayMat||!previewCanvas){ showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
        try{
            const workWidth = parseFloat(document.getElementById('workWidth').value) || 30;
            const workHeight = parseFloat(document.getElementById('workHeight').value) || 20;
            const workDepth = parseFloat(document.getElementById('workDepth').value) || 3;
            const originX = parseFloat(document.getElementById('originX').value) || 0;
            const originY = parseFloat(document.getElementById('originY').value) || 0;
            const feedRate = parseFloat(document.getElementById('feedRate').value) || 800;
            const safeZ = parseFloat(document.getElementById('safeZ').value) || 5;
            const invertZ = document.getElementById('invertZ').value === 'yes';
            const scanDir = document.getElementById('scanDir').value;
            const stepOver = parseFloat(document.getElementById('stepOver').value) || 5;
            const maxDepth = parseFloat(document.getElementById('maxDepth').value) || 3;

            const workWidthMm = cmToMm(workWidth);
            const workHeightMm = cmToMm(workHeight);
            const originXMm = cmToMm(originX);
            const originYMm = cmToMm(originY);

            const scaleX = workWidthMm / previewCanvas.width;
            const scaleY = workHeightMm / previewCanvas.height;

            document.getElementById('genProgress').style.width = '0%';

            let gcode = `; G-code generated by CNC AI`+"\n";
            gcode += `; Work area: ${workWidthMm.toFixed(1)} x ${workHeightMm.toFixed(1)} mm\n`;
            gcode += `; Material depth: ${workDepth.toFixed(1)} mm\n`;
            gcode += `; Feed rate: ${feedRate} mm/min\n`;
            gcode += `; Step over: ${stepOver} mm\n\n`;

            gcode += `G21 ; Set units to mm\n`;
            gcode += `G90 ; Absolute positioning\n`;
            gcode += `G17 ; XY plane\n`;
            gcode += `G94 ; Feed per minute\n\n`;

            gcode += `G0 Z${safeZ.toFixed(3)} ; Move to safe Z\n`;
            gcode += `G0 X${originXMm.toFixed(3)} Y${originYMm.toFixed(3)} ; Move to origin\n\n`;

            // Ø­Ø³Ø§Ø¨ Ø®Ø·ÙˆØ© Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„: Ù†Ø³ØªØ®Ø¯Ù… Ø£ÙƒØ¨Ø± Ø¹Ø§Ù…Ù„ Ù…Ù‚ÙŠØ§Ø³ Ù„ØªØ­Ø§Ø´ÙŠ ØªØ´ÙˆÙ‡
            const scalePxPerMm = Math.max(scaleX, scaleY); // mm per pixel
            const stepOverPx = Math.max(1, Math.round(stepOver / scalePxPerMm));

            let totalSteps = 0; if(scanDir==='x') totalSteps = Math.ceil(previewCanvas.height / stepOverPx); else totalSteps = Math.ceil(previewCanvas.width / stepOverPx);
            let currentStep = 0;

            if(scanDir==='x'){
                for(let y=0;y<previewCanvas.height;y+=stepOverPx){ let isCutting=false; for(let x=0;x<previewCanvas.width;x++){ const grayValue = sampleGrayAt(x,y); // Ø¹Ù…Ù‚ ÙØ¹Ù„ÙŠ (Ù…Ù…)
                            const depth = ((255 - grayValue) / 255) * maxDepth; // 0..maxDepth
                            const targetZ = invertZ ? -depth : depth; const targetX = originXMm + x * scaleX; const targetY = originYMm + y * scaleY; if(depth>0 && !isCutting){ // Ù†Ø²ÙˆÙ„ Ù„Ù„Ø£Ø¯Ø§Ø©
                                gcode += `G1 Z${targetZ.toFixed(3)} F${Math.max(1, Math.round(feedRate/2))} ; Start cutting\n`;
                                isCutting=true;
                            } else if(depth<=0 && isCutting){ gcode += `G1 Z${safeZ.toFixed(3)} ; Stop cutting\n`; isCutting=false; }
                            if(isCutting){ gcode += `G1 X${targetX.toFixed(3)} Y${targetY.toFixed(3)} Z${targetZ.toFixed(3)} F${feedRate}\n`; } else { gcode += `G0 X${targetX.toFixed(3)} Y${targetY.toFixed(3)} ; Move without cutting\n`; } } if(isCutting){ gcode += `G1 Z${safeZ.toFixed(3)} ; Lift tool\n`; isCutting=false; } currentStep++; document.getElementById('genProgress').style.width = `${(currentStep/totalSteps)*100}%`; }
            } else {
                for(let x=0;x<previewCanvas.width;x+=stepOverPx){ let isCutting=false; for(let y=0;y<previewCanvas.height;y++){ const grayValue = sampleGrayAt(x,y); const depth = ((255 - grayValue)/255) * maxDepth; const targetZ = invertZ ? -depth : depth; const targetX = originXMm + x * scaleX; const targetY = originYMm + y * scaleY; if(depth>0 && !isCutting){ gcode += `G1 Z${targetZ.toFixed(3)} F${Math.max(1, Math.round(feedRate/2))} ; Start cutting\n`; isCutting=true; } else if(depth<=0 && isCutting){ gcode += `G1 Z${safeZ.toFixed(3)} ; Stop cutting\n`; isCutting=false; } if(isCutting){ gcode += `G1 X${targetX.toFixed(3)} Y${targetY.toFixed(3)} Z${targetZ.toFixed(3)} F${feedRate}\n`; } else { gcode += `G0 X${targetX.toFixed(3)} Y${targetY.toFixed(3)} ; Move without cutting\n`; } } if(isCutting){ gcode += `G1 Z${safeZ.toFixed(3)} ; Lift tool\n`; isCutting=false; } currentStep++; document.getElementById('genProgress').style.width = `${(currentStep/totalSteps)*100}%`; }
            }

            gcode += `\nG0 Z${safeZ.toFixed(3)} ; Lift tool\n`;
            gcode += `G0 X${originXMm.toFixed(3)} Y${originYMm.toFixed(3)} ; Return to origin\n`;
            gcode += `M30 ; End program\n`;

            document.getElementById('gcodeOut').value = gcode;
            document.getElementById('gcodeSimTab').disabled = false; isGcodeGenerated=true;

            const lineCount = gcode.split('\n').length; const estMinutes = Math.round(lineCount * 0.03); document.getElementById('estTime').innerHTML = `â± ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: ${estMinutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            showToast('âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ G-code Ø¨Ù†Ø¬Ø§Ø­');
        }catch(e){ console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ G-code:',e); showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ G-code'); }
    });

    // Ø²Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹
    document.getElementById('btnQuick').addEventListener('click',()=>{ document.getElementById('workWidth').value=15; document.getElementById('workHeight').value=10; document.getElementById('stepOver').value=2; document.getElementById('maxDepth').value=1; updateDimensionDisplay(); showToast('âš¡ ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹'); });

    // Ø²Ø± ØªØ­Ù…ÙŠÙ„ G-code
    document.getElementById('btnDownload').addEventListener('click',()=>{ const gcode = document.getElementById('gcodeOut').value; if(!gcode||gcode.trim()===''){ showToast('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ G-code Ù„ØªØ­Ù…ÙŠÙ„Ù‡'); return; } const blob = new Blob([gcode],{type:'text/plain'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download='cnc_ai_gcode.nc'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast('ğŸ’¾ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù G-code'); });

    // ========== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ==========
    document.addEventListener('DOMContentLoaded',()=>{ updateDimensionDisplay(); setTimeout(()=>{ showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹! ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„',3000); },1000); });
</script>

</body>
</html>
