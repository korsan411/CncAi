<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CNC AI</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #fff; text-align: center; }
    h1 { color: #0f0; }
    canvas, #viewer3d { border: 1px solid #444; margin: 10px; }
    #viewer2d { width: 300px; height: 300px; }
    #viewer3d { width: 500px; height: 400px; display: inline-block; }
    #progress-container { width: 400px; margin: 10px auto; background: #333; height: 20px; border-radius: 5px; overflow: hidden; }
    #progress-bar { width: 0%; height: 100%; background: lime; text-align: center; color: black; font-size: 12px; }
    button { margin: 15px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>CNC Ai</h1>

  <input type="file" id="upload" accept="image/*"><br><br>

  <h2>معاينة 2D</h2>
  <canvas id="viewer2d"></canvas>

  <h2>تقدم المعالجة</h2>
  <div id="progress-container"><div id="progress-bar">0%</div></div>

  <h2>معاينة 3D</h2>
  <div id="viewer3d"></div>

  <button id="download">تنزيل G-code</button>

  <!-- three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>

  <script>
    const upload = document.getElementById("upload");
    const canvas2d = document.getElementById("viewer2d");
    const ctx = canvas2d.getContext("2d");
    const progressBar = document.getElementById("progress-bar");
    const downloadBtn = document.getElementById("download");

    // إعداد 3D
    const container3d = document.getElementById("viewer3d");
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x222222);
    const camera = new THREE.PerspectiveCamera(45, container3d.clientWidth/container3d.clientHeight, 0.1, 1000);
    camera.position.set(0, 5, 5);
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(container3d.clientWidth, container3d.clientHeight);
    container3d.appendChild(renderer.domElement);
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const light = new THREE.DirectionalLight(0xffffff, 0.8);
    light.position.set(5,5,5);
    scene.add(light);

    let mesh = null;
    let gcodeData = "";

    // رفع الصورة
    upload.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        canvas2d.width = 100;
        canvas2d.height = 100;
        ctx.drawImage(img, 0, 0, canvas2d.width, canvas2d.height);
        processImage();
      };
      img.src = URL.createObjectURL(file);
    });

    function processImage() {
      const imgData = ctx.getImageData(0,0,canvas2d.width,canvas2d.height).data;
      const w = canvas2d.width, h = canvas2d.height;

      const geometry = new THREE.PlaneGeometry(4,4,w-1,h-1);
      const pos = geometry.attributes.position;
      let i = 0, total = w*h;
      gcodeData = "G21 ; mm\nG90 ; absolute\nG1 F1000\n";

      function processChunk() {
        let count = 0;
        while (i < total && count < 1000) {
          const x = i % w;
          const y = Math.floor(i/w);
          const idx = (y*w+x)*4;
          const gray = (imgData[idx]+imgData[idx+1]+imgData[idx+2])/3/255;
          pos.setZ(i, gray*1.5);

          // Gcode
          gcodeData += `G1 X${x} Y${y} Z${(gray*2).toFixed(2)}\n`;

          i++; count++;
        }
        pos.needsUpdate = true;
        const progress = Math.round((i/total)*100);
        progressBar.style.width = progress+"%";
        progressBar.textContent = progress+"%";
        if (i<total) {
          requestAnimationFrame(processChunk);
        } else {
          geometry.computeVertexNormals();
          const material = new THREE.MeshStandardMaterial({color:0x00ffcc, side:THREE.DoubleSide, flatShading:true});
          if (mesh) scene.remove(mesh);
          mesh = new THREE.Mesh(geometry, material);
          mesh.rotation.x = -Math.PI/2;
          scene.add(mesh);
        }
      }
      processChunk();
    }

    // تنزيل gcode
    downloadBtn.addEventListener("click", ()=>{
      const blob = new Blob([gcodeData], {type:"text/plain"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "output.gcode";
      a.click();
      URL.revokeObjectURL(url);
    });

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene,camera);
    }
    animate();
  </script>
</body>
</html>
