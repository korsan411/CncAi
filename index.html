<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNC AI Preview - ุงููุณุฎุฉ ุงููุชุทูุฑุฉ</title>
  <style>
    /* ุงูุฃููุงุท ุงูุญุงููุฉ ุชุจูู ููุง ูู */
    /* ... ุงูุฃููุงุท ุงูุณุงุจูุฉ ... */
    
    /* ุฅุถุงูุฉ ุฃููุงุท ุฌุฏูุฏุฉ ููุชุญูู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู */
    .ai-controls {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin: 1rem 0;
      border: 1px solid var(--border-color);
    }
    
    .ai-progress {
      margin-top: 1rem;
      width: 100%;
      height: 20px;
      background: var(--button-bg);
      border-radius: 10px;
      overflow: hidden;
    }
    
    .ai-progress-bar {
      height: 100%;
      background: var(--primary-color);
      width: 0%;
      transition: width 0.5s;
    }
    
    .ai-model-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    
    .ai-model {
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }
    
    .ai-model:hover {
      border-color: var(--primary-color);
      background: rgba(74, 144, 226, 0.1);
    }
    
    .ai-model.selected {
      border-color: var(--primary-color);
      background: rgba(74, 144, 226, 0.2);
    }
    
    .ai-model h4 {
      margin-bottom: 0.5rem;
      color: var(--primary-color);
    }
    
    .ai-model p {
      font-size: 0.9rem;
      color: var(--text-color);
    }
    
    .training-section {
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }
  </style>
</head>
<body>
  <!-- ุงููุญุชูู ุงูุญุงูู ูุจูู ููุง ูู -->
  <!-- ... ุงููุญุชูู ุงูุณุงุจู ... -->
  
  <!-- ุฅุถุงูุฉ ูุณู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูู ุชุงุจ ุงููุนุงููุฉ -->
  <div class="tab-content active" id="preview-tab">
    <!-- ุงููุญุชูู ุงูุญุงูู -->
    
    <!-- ุฅุถุงูุฉ ูุณู ุชุญูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู -->
    <div class="ai-controls">
      <h3 class="preview-title">๐ง ุชุญูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู</h3>
      
      <div class="ai-model-selector">
        <div class="ai-model selected" data-model="cnn">
          <h4>๐ ูููุฐุฌ CNN ุงูุฃุณุงุณู</h4>
          <p>ูููุฐุฌ ุดุจูุฉ ุนุตุจูุฉ ุชูุงููููุฉ ูุงุณุชุฎุฑุงุฌ ุฎุฑูุทุฉ ุงูุงุฑุชูุงุน</p>
        </div>
        <div class="ai-model" data-model="gan">
          <h4>๐จ ูููุฐุฌ GAN ุงููุชูุฏู</h4>
          <p>ูููุฐุฌ ูุชูุฏู ูุฅูุชุงุฌ ุฎุฑุงุฆุท ุงุฑุชูุงุน ุนุงููุฉ ุงูุฏูุฉ</p>
        </div>
        <div class="ai-model" data-model="custom">
          <h4>โ๏ธ ูููุฐุฌ ูุฎุตุต</h4>
          <p>ุชุญููู ูููุฐุฌ ูุฎุตุต ูุฏุฑุจ ูุณุจููุง</p>
        </div>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="analyzeWithAI()">
          <span>๐ง</span> ุชุญููู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู
        </button>
        <button class="btn btn-secondary" onclick="optimizeToolpath()">
          <span>๐ง</span> ุชุญุณูู ุงููุณุงุฑ ุชููุงุฆููุง
        </button>
        <button class="btn btn-secondary" onclick="trainCustomModel()">
          <span>๐</span> ุชุฏุฑูุจ ูููุฐุฌ ูุฎุตุต
        </button>
      </div>
      
      <div class="ai-progress">
        <div class="ai-progress-bar" id="aiProgressBar"></div>
      </div>
      <div id="aiStatus">ุฌุงูุฒ ููุชุญููู</div>
      
      <div class="training-section" id="trainingSection" style="display: none;">
        <h4>ุชุฏุฑูุจ ูููุฐุฌ ูุฎุตุต</h4>
        <p>ูู ุจุชุญููู ูุฌููุนุฉ ูู ุงูุตูุฑ ูุฎุฑุงุฆุท ุงูุงุฑุชูุงุน ุงูููุงุจูุฉ ููุง ูุชุฏุฑูุจ ูููุฐุฌ ูุฎุตุต</p>
        
        <div class="action-buttons">
          <button class="btn btn-secondary" onclick="document.getElementById('trainingData').click()">
            <span>๐</span> ุชุญููู ุจูุงูุงุช ุงูุชุฏุฑูุจ
          </button>
          <input type="file" id="trainingData" multiple style="display: none;" onchange="handleTrainingData(this.files)">
          
          <button class="btn btn-primary" onclick="startTraining()">
            <span>๐</span> ุจุฏุก ุงูุชุฏุฑูุจ
          </button>
        </div>
        
        <div class="ai-progress">
          <div class="ai-progress-bar" id="trainingProgressBar"></div>
        </div>
        <div id="trainingStatus">ูู ูุชู ุชุญููู ุจูุงูุงุช ุงูุชุฏุฑูุจ ุจุนุฏ</div>
      </div>
    </div>
    
    <!-- ุจููุฉ ุงููุญุชูู -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
  <script>
    // ูุชุบูุฑุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู
    let aiModel = null;
    let currentAIModel = 'cnn';
    let isTraining = false;
    let trainingData = [];
    let customModel = null;

    // ุชููุฆุฉ ููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
    async function initAIModels() {
      updateAIStatus('ุฌุงุฑู ุชุญููู ููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู...');
      updateAIProgress(10);
      
      try {
        // ุชุญููู ุงููููุฐุฌ ุงูุฃุณุงุณู
        await loadBaseModel();
        updateAIProgress(100);
        updateAIStatus('ููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุฌุงูุฒุฉ');
        showNotification('ุชู ุชุญููู ููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุจูุฌุงุญ');
      } catch (error) {
        console.error('Error loading AI models:', error);
        updateAIStatus('ูุดู ูู ุชุญููู ุงูููุงุฐุฌ: ' + error.message);
        showNotification('ูุดู ูู ุชุญููู ููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู', true);
      }
    }

    // ุชุญููู ุงููููุฐุฌ ุงูุฃุณุงุณู
    async function loadBaseModel() {
      // ูู ุจูุฆุฉ ุงูุฅูุชุงุฌุ ุณูููู ุจุชุญููู ูููุฐุฌ ูุฏุฑุจ ูุณุจูุงู
      // ููุง ูุจูู ูููุฐุฌุงู ุจุณูุทุงู ููุชูุถูุญ
      
      aiModel = tf.sequential();
      
      // ุทุจูุงุช ุงูุฅุฏุฎุงู ูุงูุชูุงููู
      aiModel.add(tf.layers.conv2d({
        inputShape: [256, 256, 3],
        filters: 32,
        kernelSize: 3,
        activation: 'relu'
      }));
      
      aiModel.add(tf.layers.maxPooling2d({poolSize: 2}));
      
      aiModel.add(tf.layers.conv2d({
        filters: 64,
        kernelSize: 3,
        activation: 'relu'
      }));
      
      aiModel.add(tf.layers.maxPooling2d({poolSize: 2}));
      
      aiModel.add(tf.layers.conv2d({
        filters: 64,
        kernelSize: 3,
        activation: 'relu'
      }));
      
      // ุชุทุจูู flatten ูุฅุถุงูุฉ ุทุจูุงุช densely connected
      aiModel.add(tf.layers.flatten());
      
      aiModel.add(tf.layers.dense({units: 128, activation: 'relu'}));
      aiModel.add(tf.layers.dropout({rate: 0.2}));
      
      aiModel.add(tf.layers.dense({units: 64, activation: 'relu'}));
      
      // ุทุจูุฉ ุงูุฅุฎุฑุงุฌ - ุฎุฑูุทุฉ ุงุฑุชูุงุน 64x64
      aiModel.add(tf.layers.dense({units: 64 * 64, activation: 'sigmoid'}));
      aiModel.add(tf.layers.reshape({targetShape: [64, 64, 1]}));
      
      // ุชุฌููุน ุงููููุฐุฌ
      aiModel.compile({
        optimizer: 'adam',
        loss: 'meanSquaredError',
        metrics: ['accuracy']
      });
      
      console.log('AI Model loaded successfully');
    }

    // ุชุญููู ุงูุตูุฑุฉ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
    async function analyzeWithAI() {
      if (!fileInput.files[0]) {
        showNotification('ูุฌุจ ุชุญููู ุตูุฑุฉ ุฃููุงู', true);
        return;
      }
      
      if (!aiModel) {
        showNotification('ููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุบูุฑ ุฌุงูุฒุฉ ุจุนุฏ', true);
        return;
      }
      
      updateAIStatus('ุฌุงุฑู ุชุญููู ุงูุตูุฑุฉ...');
      updateAIProgress(10);
      
      try {
        // ุชุญููู ุงูุตูุฑุฉ ูุชุญููููุง ุฅูู ุชูุณูู ููุงุณุจ ูููููุฐุฌ
        const img = new Image();
        img.onload = async () => {
          // ูุนุงูุฌุฉ ุงูุตูุฑุฉ
          updateAIProgress(30);
          
          const tensor = tf.browser.fromPixels(img)
            .resizeNearestNeighbor([256, 256])
            .toFloat()
            .div(tf.scalar(255.0))
            .expandDims();
          
          updateAIProgress(50);
          
          // ุงูุชูุจุค ุจุงุณุชุฎุฏุงู ุงููููุฐุฌ
          const prediction = aiModel.predict(tensor);
          
          updateAIProgress(80);
          
          // ูุนุงูุฌุฉ ุงููุชุงุฆุฌ
          const heightData = await processPrediction(prediction);
          
          // ุชุญุฏูุซ ุงููุนุงููุฉ ุซูุงุซูุฉ ุงูุฃุจุนุงุฏ
          update3DPreviewWithAIData(heightData);
          
          updateAIProgress(100);
          updateAIStatus('ุชู ุงูุชุญููู ุจูุฌุงุญ');
          showNotification('ุชู ุชุญููู ุงูุตูุฑุฉ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู');
          
          // ุชูุธูู ุงูุฐุงูุฑุฉ
          tensor.dispose();
          prediction.dispose();
        };
        
        img.src = URL.createObjectURL(fileInput.files[0]);
      } catch (error) {
        console.error('AI Analysis error:', error);
        updateAIStatus('ูุดู ูู ุงูุชุญููู: ' + error.message);
        showNotification('ูุดู ูู ุชุญููู ุงูุตูุฑุฉ', true);
      }
    }

    // ูุนุงูุฌุฉ ุชูุจุคุงุช ุงููููุฐุฌ
    async function processPrediction(prediction) {
      const data = await prediction.data();
      const [width, height] = prediction.shape.slice(1, 3);
      
      // ุชุญููู ุงูุจูุงูุงุช ุฅูู ุตูุฑุฉ ุงุฑุชูุงุน
      const heightData = new Float32Array(width * height);
      
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const idx = y * width + x;
          heightData[idx] = data[idx] * 255; // ุชุญููู ุฅูู ูุทุงู 0-255
        }
      }
      
      return {
        data: heightData,
        width: width,
        height: height
      };
    }

    // ุชุญุฏูุซ ุงููุนุงููุฉ ุซูุงุซูุฉ ุงูุฃุจุนุงุฏ ุจุจูุงูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู
    function update3DPreviewWithAIData(heightData) {
      // ุญูุธ ุจูุงูุงุช ุงูุงุฑุชูุงุน ููุงุณุชุฎุฏุงู ูุงุญูุงู
      heightMapData = heightData;
      
      // ุฅูุดุงุก ุดุจูุฉ 3D ูู ุจูุงูุงุช ุงูุงุฑุชูุงุน
      const geometry = new THREE.PlaneGeometry(100, 100, heightData.width-1, heightData.height-1);
      const colors = [];
      
      for (let i = 0; i < geometry.attributes.position.count; i++) {
        const stride = i * 3;
        const x = i % heightData.width;
        const y = Math.floor(i / heightData.width);
        const idx = y * heightData.width + x;
        
        // ุชุญุฏูุซ ุงุฑุชูุงุน ุงูุฑุฃุณ ุจูุงุกู ุนูู ุจูุงูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู
        geometry.attributes.position.array[stride + 2] = heightData.data[idx] / heightFactor;
        
        // ุฅุถุงูุฉ ุงูุฃููุงู ุจูุงุกู ุนูู ุงูุงุฑุชูุงุน
        const norm = heightData.data[idx] / 255;
        const color = getHeatColor(norm, currentColormap);
        colors.push(color.r/255, color.g/255, color.b/255);
      }
      
      geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
      geometry.computeVertexNormals();
      
      const material = new THREE.MeshLambertMaterial({ 
        vertexColors: true, 
        side: THREE.DoubleSide,
        wireframe: false
      });
      
      if (mesh) scene.remove(mesh);
      mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);
      
      // ุชุญุฏูุซ ุฎุฑูุทุฉ ุงูุญุฑุงุฑุฉ
      updateHeatmapFromAIData(heightData);
    }

    // ุชุญุฏูุซ ุฎุฑูุทุฉ ุงูุญุฑุงุฑุฉ ุจุจูุงูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู
    function updateHeatmapFromAIData(heightData) {
      heatmap.width = heightData.width;
      heatmap.height = heightData.height;
      const heatData = ctxHeat.createImageData(heightData.width, heightData.height);
      
      for (let y = 0; y < heightData.height; y++) {
        for (let x = 0; x < heightData.width; x++) {
          const idx = y * heightData.width + x;
          const pixelIdx = idx * 4;
          const norm = heightData.data[idx] / 255;
          const color = getHeatColor(norm, currentColormap);
          
          heatData.data[pixelIdx] = color.r;
          heatData.data[pixelIdx+1] = color.g;
          heatData.data[pixelIdx+2] = color.b;
          heatData.data[pixelIdx+3] = 255;
        }
      }
      
      ctxHeat.putImageData(heatData, 0, 0);
    }

    // ุชุญุณูู ูุณุงุฑ ุงูุฃุฏุงุฉ ุชููุงุฆูุงู
    async function optimizeToolpath() {
      if (!heightMapData) {
        showNotification('ูุฌุจ ุฅูุดุงุก ุฎุฑูุทุฉ ุงุฑุชูุงุน ุฃููุงู', true);
        return;
      }
      
      updateAIStatus('ุฌุงุฑู ุชุญุณูู ูุณุงุฑ ุงูุฃุฏุงุฉ...');
      updateAIProgress(10);
      
      try {
        // ูุญุงูุงุฉ ุนูููุฉ ุชุญุณูู ุงููุณุงุฑ
        // ูู ุงูุชุทุจูู ุงูุญููููุ ุณุชุณุชุฎุฏู ูุฐู ุฎูุงุฑุฒููุงุช ุชุญุณูู ุญููููุฉ
        
        updateAIProgress(30);
        
        // ูุญุงูุงุฉ ูุนุงูุฌุฉ ุงูุจูุงูุงุช
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        updateAIProgress(70);
        
        // ูุญุงูุงุฉ ุชุญุณูู ุงููุณุงุฑ
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        updateAIProgress(100);
        updateAIStatus('ุชู ุชุญุณูู ูุณุงุฑ ุงูุฃุฏุงุฉ');
        showNotification('ุชู ุชุญุณูู ูุณุงุฑ ุงูุฃุฏุงุฉ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู');
        
        // ุชูููุฏ G-code ูุญุณู
        generateOptimizedGcode();
      } catch (error) {
        console.error('Toolpath optimization error:', error);
        updateAIStatus('ูุดู ูู ุชุญุณูู ุงููุณุงุฑ: ' + error.message);
        showNotification('ูุดู ูู ุชุญุณูู ูุณุงุฑ ุงูุฃุฏุงุฉ', true);
      }
    }

    // ุชูููุฏ G-code ูุญุณู
    function generateOptimizedGcode() {
      // ูุฐุง ุณูููู ุชูููุฐูุง ูุชูุฏููุง ูู ุงูุชุทุจูู ุงูุญูููู
      // ููุง ูุณุชุฎุฏู ุงูุชูููุฏ ุงูุฃุณุงุณู ูุน ุฅุถุงูุฉ ูุคุดุฑ ุงูุชุญุณูู
      
      generateGcode();
      gcodeOutput.textContent = "; ๐ง ูุณุงุฑ ูุญุณู ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู\n" + gcodeOutput.textContent;
      showNotification('ุชู ุชูููุฏ G-code ูุญุณู');
    }

    // ุชุฏุฑูุจ ูููุฐุฌ ูุฎุตุต
    function trainCustomModel() {
      document.getElementById('trainingSection').style.display = 'block';
    }

    // ูุนุงูุฌุฉ ุจูุงูุงุช ุงูุชุฏุฑูุจ
    function handleTrainingData(files) {
      if (files.length === 0) return;
      
      trainingData = [];
      updateTrainingStatus(`ุชู ุชุญููู ${files.length} ููููุงุ ุฌุงุฑู ุงููุนุงูุฌุฉ...`);
      
      // ูุนุงูุฌุฉ ุงููููุงุช (ูู ุงูุชุทุจูู ุงูุญููููุ ุณุชููู ูุฐู ุนูููุฉ ูุนูุฏุฉ)
      setTimeout(() => {
        updateTrainingStatus(`ุฌุงูุฒ ููุชุฏุฑูุจ ุนูู ${files.length} ุนููุฉ`);
        showNotification('ุชู ุชุญููู ุจูุงูุงุช ุงูุชุฏุฑูุจ ุจูุฌุงุญ');
      }, 2000);
    }

    // ุจุฏุก ุงูุชุฏุฑูุจ
    async function startTraining() {
      if (trainingData.length === 0) {
        showNotification('ูุฌุจ ุชุญููู ุจูุงูุงุช ุงูุชุฏุฑูุจ ุฃููุงู', true);
        return;
      }
      
      isTraining = true;
      updateTrainingStatus('ุฌุงุฑู ุชุฏุฑูุจ ุงููููุฐุฌ...');
      
      // ูุญุงูุงุฉ ุนูููุฉ ุงูุชุฏุฑูุจ
      for (let epoch = 0; epoch < 10; epoch++) {
        if (!isTraining) break;
        
        updateTrainingProgress((epoch + 1) * 10);
        updateTrainingStatus(`ุฌุงุฑู ุงูุชุฏุฑูุจ (ุงูุนุตุฑ ${epoch + 1}/10)`);
        
        // ูุญุงูุงุฉ ููุช ุงูุชุฏุฑูุจ
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      if (isTraining) {
        updateTrainingStatus('ุงูุชูู ุงูุชุฏุฑูุจ ุจูุฌุงุญ');
        showNotification('ุชู ุชุฏุฑูุจ ุงููููุฐุฌ ุงููุฎุตุต ุจูุฌุงุญ');
        isTraining = false;
      }
    }

    // ูุธุงุฆู ุงููุณุงุนุฏุฉ ูุชุญุฏูุซ ุงููุงุฌูุฉ
    function updateAIStatus(message) {
      document.getElementById('aiStatus').textContent = message;
    }
    
    function updateAIProgress(percent) {
      document.getElementById('aiProgressBar').style.width = percent + '%';
    }
    
    function updateTrainingStatus(message) {
      document.getElementById('trainingStatus').textContent = message;
    }
    
    function updateTrainingProgress(percent) {
      document.getElementById('trainingProgressBar').style.width = percent + '%';
    }

    // ุชููุฆุฉ ููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    document.addEventListener('DOMContentLoaded', function() {
      initAIModels();
      
      // ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ ูููุงุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู
      document.querySelectorAll('.ai-model').forEach(model => {
        model.addEventListener('click', function() {
          document.querySelectorAll('.ai-model').forEach(m => m.classList.remove('selected'));
          this.classList.add('selected');
          currentAIModel = this.getAttribute('data-model');
        });
      });
    });

    // ุจููุฉ ุงูููุฏ ุงูุฃุตูู ูุจูู ููุง ูู
    // ...
  </script>
</body>
</html>
