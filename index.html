<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNC AI - Ù†Ø³Ø®Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ´ØºÙŠÙ„ (Index)</title>
  <style>
    :root{--primary:#4a90e2;--bg:#f8f9fa;--text:#212529;--card:#fff;--muted:#6b7280}
    body{font-family:Segoe UI,Roboto,"Noto Naskh Arabic",sans-serif;background:var(--bg);color:var(--text);margin:0;padding:0}
    header{background:linear-gradient(90deg,var(--primary),#67b0f5);color:#fff;padding:12px}
    .header-content{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:18px}
    .container{padding:12px;display:grid;grid-template-columns:1fr;gap:12px}
    .tabs{display:flex;gap:8px}
    .tab{padding:8px 12px;background:#fff;border-radius:8px;cursor:pointer;border:1px solid #e6e6e6}
    .tab.active{background:var(--primary);color:#fff}
    .tab-content{display:none;background:#fff;padding:12px;border-radius:8px;border:1px solid #e6e6e6}
    .tab-content.active{display:block}
    .upload-section{display:flex;flex-direction:column;gap:8px}
    .file-upload{display:flex;align-items:center;gap:8px}
    .file-upload input[type=file]{display:none}
    .file-upload label{background:#fff;padding:8px;border-radius:6px;border:1px solid #ddd;cursor:pointer}
    .previews-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .preview-block{background:#fff;border:1px solid #e6e6e6;padding:8px;border-radius:8px}
    .preview-content{height:220px;display:flex;align-items:center;justify-content:center;background:#fafafa;border-radius:6px;overflow:hidden}
    canvas{max-width:100%;max-height:100%}
    #preview3d{width:100%;height:220px}
    .options{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .option-group{display:flex;flex-direction:column;gap:4px}
    .btn{padding:8px 10px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff;border:none}
    footer{padding:12px;text-align:center;color:var(--muted)}
    .notification{position:fixed;right:16px;bottom:16px;background:#222;color:#fff;padding:8px 12px;border-radius:8px;display:none}
    .progress-container{height:8px;background:#eee;border-radius:6px;overflow:hidden}
    .progress-bar{height:100%;width:0;background:linear-gradient(90deg,var(--primary),#67b0f5)}
    pre#gcodeOutput{max-height:240px;overflow:auto;background:#0b1220;color:#d6f8ff;padding:8px;border-radius:6px}
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>ğŸ› ï¸ CNC AI - Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„</h1>
      <div>
        <button id="themeToggle" class="btn">ğŸŒ™</button>
      </div>
    </div>
  </header>  <div class="container">
    <div class="tabs">
      <div class="tab active" data-tab="preview">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©</div>
      <div class="tab" data-tab="gcode">G-code Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
      <div class="tab" data-tab="simulation">Ù…Ø­Ø§ÙƒØ§Ø© G-code</div>
    </div><!-- ØªØ§Ø¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
<div class="tab-content active" id="preview-tab">
  <section class="upload-section">
    <h3>ğŸ“¤ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</h3>
    <div class="file-upload">
      <input type="file" id="fileInput" accept="image/*">
      <label for="fileInput">ğŸ“ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
      <div id="fileName">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ ØµÙˆØ±Ø©</div>
    </div>
    <div class="progress-container" id="progressContainer"><div class="progress-bar" id="progressBar"></div></div>
    <div class="image-enhancement" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
      <button class="btn" onclick="applyEnhancement('grayscale')">âš« ØªØ¯Ø±Ø¬ Ø±Ù…Ø§Ø¯ÙŠ</button>
      <button class="btn" onclick="applyEnhancement('reset')">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø©</button>
    </div>
  </section>

  <div class="previews-container" style="margin-top:12px">
    <div class="preview-block">
      <h4>ğŸ“· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</h4>
      <div class="preview-content"><canvas id="preview2d" width="640" height="360"></canvas></div>
      <div class="options">
        <div class="option-group"><label>ğŸ“ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© X</label><input type="range" id="startPointX" min="0" max="100" value="50"></div>
        <div class="option-group"><label>ğŸ“ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Y</label><input type="range" id="startPointY" min="0" max="100" value="50"></div>
        <button class="btn" onclick="selectStartPoint()">ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</button>
      </div>
    </div>

    <div class="preview-block">
      <h4>ğŸŒˆ Heatmap</h4>
      <div class="preview-content"><canvas id="heatmap" width="640" height="360"></canvas></div>
      <div style="margin-top:8px;display:flex;gap:6px"><button class="btn" onclick="setColormap('jet')">Jet</button><button class="btn" onclick="setColormap('hot')">Hot</button><button class="btn" onclick="setColormap('gray')">Gray</button></div>
    </div>

    <div class="preview-block">
      <h4>ğŸ” Ø­ÙˆØ§Ù Ø§Ù„ØµÙˆØ±Ø©</h4>
      <div class="preview-content"><canvas id="edgesCanvas" width="640" height="360"></canvas></div>
    </div>

    <div class="preview-block">
      <h4>ğŸŒ€ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</h4>
      <div class="preview-content"><div id="preview3d"></div></div>
      <div class="options">
        <div class="option-group"><label>ğŸ”„ Ø³Ø±Ø¹Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Ù†</label><input type="range" id="rotationSpeed" min="0" max="0.05" step="0.001" value="0.01"></div>
        <div class="option-group"><label>ğŸ” Ø²ÙˆÙ…</label><input type="range" id="zoomControl" min="50" max="600" value="200"></div>
        <div class="option-group"><label>ğŸ“ Ø´Ø¯Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</label><input type="range" id="heightIntensity" min="10" max="400" value="80"></div>
      </div>
    </div>
  </div>
</div>

<!-- ØªØ§Ø¨ G-code -->
<div class="tab-content" id="gcode-tab">
  <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª G-code</h3>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    <div>
      <label>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª</label>
      <select id="gcodeType"><option value="heatmap">Heatmap</option><option value="edges">Edges</option><option value="hybrid">Hybrid</option></select>
    </div>
    <div>
      <label>Ø¯Ù‚Ø© Ø§Ù„ØªÙˆÙ„ÙŠØ¯</label>
      <select id="gcodePrecision"><option value="low">Ù…Ù†Ø®ÙØ¶Ø©</option><option value="medium" selected>Ù…ØªÙˆØ³Ø·Ø©</option><option value="high">Ø¹Ø§Ù„ÙŠØ©</option></select>
    </div>
    <div>
      <label>Feed rate (mm/min)</label>
      <input id="feedRate" value="1200">
    </div>
    <div>
      <label>Spindle speed (RPM)</label>
      <input id="spindleSpeed" value="10000">
    </div>
    <div>
      <label>Cut depth (mm)</label>
      <input id="cutDepth" value="2">
    </div>
    <div>
      <label>Pass depth (mm)</label>
      <input id="passDepth" value="0.5">
    </div>
  </div>

  <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
    <button class="btn btn-primary" onclick="onGenerateGcode()">âš¡ ØªÙˆÙ„ÙŠØ¯ G-code</button>
    <button class="btn" onclick="downloadGcode()">ğŸ’¾ Ø­ÙØ¸ G-code</button>
  </div>

  <h4 style="margin-top:8px">Ù†Ø§ØªØ¬ G-code</h4>
  <pre id="gcodeOutput">// Ø§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©...</pre>
</div>

<!-- ØªØ§Ø¨ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© -->
<div class="tab-content" id="simulation-tab">
  <h3>Ù…Ø­Ø§ÙƒØ§Ø© (Ù…Ø¨Ø¯Ø¦ÙŠ)</h3>
  <p>Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§ÙƒØ§Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
</div>

  </div>  <footer>
    <p>ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Three.js - Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ¬Ø±Ø¨Ø©</p>
  </footer>  <div class="notification" id="notification"></div>  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>  <script>
    // ======== Ø¹Ù†Ø§ØµØ± DOM ÙˆØªÙ‡ÙŠØ¦Ø© ========
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const previewCanvas = document.getElementById('preview2d');
    const ctx2d = previewCanvas.getContext('2d');
    const heatmapCanvas = document.getElementById('heatmap');
    const ctxHeat = heatmapCanvas.getContext('2d');
    const edgesCanvas = document.getElementById('edgesCanvas');
    const ctxEdges = edgesCanvas.getContext('2d');
    const progressBar = document.getElementById('progressBar');
    const notification = document.getElementById('notification');
    const gcodeOutput = document.getElementById('gcodeOutput');

    let originalImageData = null; // ImageData of original
    let heightMapData = null; // Float32Array or 2D array of normalized [0..1]
    let edgesImageData = null;
    let startPoint = {x:50,y:50};
    let isSelectingStartPoint = false;
    let currentColormap = 'jet';
    let generatedGcodeText = '';

    // Tabs
    document.querySelectorAll('.tab').forEach(tab=>{
      tab.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab+'-tab').classList.add('active');
      });
    });

    // Theme toggle (simple)
    document.getElementById('themeToggle').addEventListener('click',()=>document.body.classList.toggle('dark'));

    function showNotification(msg, isError=false){
      notification.textContent = msg;notification.style.display='block';notification.style.background = isError ? '#b00020' : '#222';
      setTimeout(()=>notification.style.display='none',3000);
    }

    function updateProgress(p){progressBar.style.width = Math.max(0,Math.min(100,p))+'%';}

    // ======== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§ ========
    fileInput.addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      fileName.textContent = file.name;
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = ()=>{
        // Ø§Ø­ØªÙØ¸ Ø¨Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ø§Ø±ØªÙØ§Ø¹
        const w = img.width; const h = img.height;
        // Ø¶Ø¨Ø· Ø£Ø­Ø¬Ø§Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³Ø§Øª Ø¥Ù„Ù‰ Ù†ÙØ³ Ù†Ø³Ø¨Ø© Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø£Ù‚ØµÙ‰ Ø¹Ø±Ø¶ 640
        const scale = Math.min(640 / w, 360 / h, 1);
        const cw = Math.round(w * scale); const ch = Math.round(h * scale);
        previewCanvas.width = cw; previewCanvas.height = ch;
        heatmapCanvas.width = cw; heatmapCanvas.height = ch;
        edgesCanvas.width = cw; edgesCanvas.height = ch;

        ctx2d.clearRect(0,0,cw,ch);
        ctx2d.drawImage(img,0,0,cw,ch);
        originalImageData = ctx2d.getImageData(0,0,cw,ch);

        // Ø­Ø³Ø§Ø¨ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹Ø§Øª (Ø¨Ø³Ø·: ØªØ¯Ø±Ø¬ Ø±Ù…Ø§Ø¯ÙŠ Ù…Ø¹ ØªØ·Ø¨ÙŠØ¹)
        heightMapData = computeHeightMapFromImage(originalImageData);
        renderHeatmap(heightMapData, cw, ch);

        // Ø­ÙˆØ§Ù Ø¹Ø¨Ø± Sobel
        edgesImageData = computeSobelEdges(originalImageData);
        ctxEdges.putImageData(edgesImageData,0,0);

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© 3D
        build3DFromHeightmap(heightMapData, cw, ch);

        // reset start point to center
        startPoint = {x:50,y:50}; document.getElementById('startPointX').value = 50; document.getElementById('startPointY').value = 50;

        showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§'); updateProgress(100);
        URL.revokeObjectURL(url);
      };
      img.src = url; updateProgress(20);
    });

    // ======== ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø®Ø±ÙŠØ·Ø© Ø§Ø±ØªÙØ§Ø¹Ø§Øª (ØªØ¯Ø±Ø¬ Ø±Ù…Ø§Ø¯ÙŠ) ========
    function computeHeightMapFromImage(imgData){
      const w = imgData.width; const h = imgData.height;
      const out = new Array(h);
      for(let y=0;y<h;y++){ out[y]=new Float32Array(w); }
      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          const i = (y*w + x)*4;
          const r=imgData.data[i], g=imgData.data[i+1], b=imgData.data[i+2];
          const gray = (0.299*r + 0.587*g + 0.114*b)/255; // 0..1
          out[y][x] = gray; // Ø§Ø±ØªÙØ§Ø¹ (1=bright)
        }
      }
      return {data:out,width:w,height:h};
    }

    // ======== Ø±Ø³Ù… Heatmap Ø¨Ø³ÙŠØ· ========
    function renderHeatmap(hmap,w,h){
      const img = ctxHeat.createImageData(w,h);
      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          const v = hmap.data[y][x]; // 0..1
          const rgba = colormap(v, currentColormap);
          const i = (y*w + x)*4;
          img.data[i]=rgba[0]; img.data[i+1]=rgba[1]; img.data[i+2]=rgba[2]; img.data[i+3]=255;
        }
      }
      ctxHeat.putImageData(img,0,0);
    }

    // Ø®Ø±ÙŠØ·Ø© Ø£Ù„ÙˆØ§Ù† Ø¨Ø³ÙŠØ·Ø©
    function colormap(v, name){
      // v: 0..1
      v = Math.max(0,Math.min(1,v));
      if(name==='gray'){
        const k=Math.round(v*255);return [k,k,k,255];
      }
      if(name==='hot'){
        const r=Math.round(Math.min(1,2*v)*255);
        const g=Math.round(Math.min(1,2*(v-0.5))*255);
        const b=0;return [r,Math.max(0,g),b,255];
      }
      // jet-like
      const r = Math.round(255*Math.max(0,Math.min(1,1.5*v)));
      const g = Math.round(255*Math.max(0,Math.min(1,1.5*(1-Math.abs(v-0.5)*2))));
      const b = Math.round(255*Math.max(0,Math.min(1,1.5*(1-v))));
      return [r,g,b,255];
    }

    function setColormap(name){currentColormap = name; if(heightMapData) renderHeatmap(heightMapData,heightMapData.width,heightMapData.height);} 

    // ======== ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù - Sobel (Ø¨Ø³ÙŠØ·) ========
    function computeSobelEdges(imgData){
      const w=imgData.width,h=imgData.height;
      const gray = new Float32Array(w*h);
      for(let y=0;y<h;y++) for(let x=0;x<w;x++){const i=(y*w+x)*4;gray[y*w+x]=(0.299*imgData.data[i]+0.587*imgData.data[i+1]+0.114*imgData.data[i+2]);}
      const out = ctxEdges.createImageData(w,h);
      const gx=[-1,0,1,-2,0,2,-1,0,1]; const gy=[-1,-2,-1,0,0,0,1,2,1];
      for(let y=1;y<h-1;y++){
        for(let x=1;x<w-1;x++){
          let sx=0,sy=0; let k=0;
          for(let yy=-1;yy<=1;yy++) for(let xx=-1;xx<=1;xx++){ const val=gray[(y+yy)*w+(x+xx)]; sx+=val*gx[k]; sy+=val*gy[k]; k++; }
          const mag = Math.min(255,Math.sqrt(sx*sx+sy*sy)); const i=(y*w+x)*4;
          out.data[i]=out.data[i+1]=out.data[i+2]=mag; out.data[i+3]=255;
        }
      }
      return out;
    }

    // ======== Ù…Ø¹Ø§ÙŠÙ†Ø© 3D Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Three.js ========
    let three = {scene:null,cam:null,renderer:null,mesh:null,animId:null};
    function build3DFromHeightmap(hmap,w,h){
      // ØªÙ†Ø¸ÙŠÙ
      if(three.renderer){ cancelAnimationFrame(three.animId); three.renderer.domElement.remove(); three.renderer.dispose(); three = {scene:null,cam:null,renderer:null,mesh:null,animId:null}; }
      const container = document.getElementById('preview3d');
      const renderer = new THREE.WebGLRenderer({antialias:true}); renderer.setSize(container.clientWidth,220); container.appendChild(renderer.domElement);
      const scene = new THREE.Scene(); scene.background = new THREE.Color(0xf6f6f6);
      const cam = new THREE.PerspectiveCamera(45, container.clientWidth/220, 0.1, 1000); cam.position.set(0, -200, 200); cam.up.set(0,0,1);
      const light = new THREE.DirectionalLight(0xffffff,1); light.position.set(0,0,1); scene.add(light); scene.add(new THREE.AmbientLight(0x909090));

      // ØªØ­ÙˆÙŠÙ„ heightmap Ø¥Ù„Ù‰ BufferGeometry (plane)
      const geometry = new THREE.PlaneGeometry(100, 100, w-1, h-1);
      const positions = geometry.attributes.position.array; // x,y,z interleaved
      // Ù†Ù…Ù„Ø£ z Ù…Ù† heightmap
      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          const idx = (y*w + x);
          const vi = idx*3; // vertex index in array
          const val = 1 - hmap.data[y][x]; // darker -> deeper
          positions[vi+2] = (val * (document.getElementById('heightIntensity').value/100));
        }
      }
      geometry.computeVertexNormals();
      const mat = new THREE.MeshStandardMaterial({color:0x8b5a2b, metalness:0.2, roughness:0.8, side:THREE.DoubleSide});
      const mesh = new THREE.Mesh(geometry, mat); mesh.rotateX(-Math.PI/2); scene.add(mesh);

      three.scene=scene; three.cam=cam; three.renderer=renderer; three.mesh=mesh;

      function animate(){
        const rot = parseFloat(document.getElementById('rotationSpeed').value);
        three.mesh.rotation.z += rot;
        const zoom = parseInt(document.getElementById('zoomControl').value);
        three.cam.position.z = Math.max(60, zoom);
        renderer.render(scene, cam);
        three.animId = requestAnimationFrame(animate);
      }
      animate();

      // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
      document.getElementById('heightIntensity').addEventListener('input',()=>{
        const hi = document.getElementById('heightIntensity').value/100;
        for(let y=0;y<h;y++) for(let x=0;x<w;x++){ const idx=(y*w+x); const vi=idx*3; positions[vi+2] = (1 - hmap.data[y][x])*hi; }
        geometry.attributes.position.needsUpdate = true; geometry.computeVertexNormals();
      });
    }

    // ======== ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¯ÙˆÙŠØ§Ù‹ ========
    const previewRect = previewCanvas.getBoundingClientRect();
    previewCanvas.addEventListener('click', function(e){ if(!isSelectingStartPoint) return; const rect = previewCanvas.getBoundingClientRect(); const x = e.clientX-rect.left; const y = e.clientY-rect.top; startPoint={x: (x/previewCanvas.width)*100, y:(y/previewCanvas.height)*100}; document.getElementById('startPointX').value = startPoint.x; document.getElementById('startPointY').value = startPoint.y; drawStartPointMarker(x,y); isSelectingStartPoint=false; previewCanvas.style.cursor='default'; showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'); });
    function selectStartPoint(){ isSelectingStartPoint=true; previewCanvas.style.cursor='crosshair'; showNotification('Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©'); }
    function drawStartPointMarker(x,y){ ctx2d.putImageData(originalImageData,0,0); ctx2d.beginPath(); ctx2d.arc(x,y,8,0,Math.PI*2); ctx2d.strokeStyle='#00ff00'; ctx2d.lineWidth=3; ctx2d.stroke(); }

    // ======== ØªÙˆÙ„ÙŠØ¯ G-code (ØªØºÙ„ÙŠÙ generateRealGcode) ========
    async function onGenerateGcode(){ updateProgress(0); showNotification('Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ G-code...'); const text = await generateRealGcode(); generatedGcodeText = text; gcodeOutput.textContent = text; showNotification('ØªÙ… ØªÙˆÙ„ÙŠØ¯ G-code'); }

    function downloadGcode(){ if(!generatedGcodeText){ showNotification('Ù„Ù… ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ G-code Ø¨Ø¹Ø¯', true); return;} const blob=new Blob([generatedGcodeText],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='cncai_output.gcode'; a.click(); URL.revokeObjectURL(url); }

    // ======== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆG-code (Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© ÙˆÙ…ØªÙ…Ø§Ø´ÙŠØ© Ù…Ø¹ ÙƒÙˆØ¯Ùƒ) ========
    function extractHeatmapPoints(heightData,width,height,cutDepth,resolution){
      const points=[]; for(let y=0;y<height;y+=resolution){ for(let x=0;x<width;x+=resolution){ const pv = heightData[y][x]; const depth = (1 - pv)*cutDepth; points.push({x:(x/width)*100 -50, y:(y/height)*100 -50, z:-depth, value:pv}); }} return points; }

    function extractEdgePoints(edgeData,width,height,cutDepth){
      // edgeData is ImageData
      const points=[]; for(let y=0;y<height;y++) for(let x=0;x<width;x++){
        const i=(y*width+x)*4; const v=edgeData.data[i]; if(v>100){ const depth = cutDepth*0.8; points.push({x:(x/width)*100-50,y:(y/height)*100-50,z:-depth}); }
      } return points;
    }

    function mergeEdgeAndHeatmapPaths(edgePoints, heatmapPoints, mergeFactor){ if(edgePoints.length===0) return heatmapPoints; if(heatmapPoints.length===0) return edgePoints; const merged=[...edgePoints]; for(const hp of heatmapPoints){ let closestDist=Infinity,closest=null; for(const ep of edgePoints){ const d=Math.hypot(hp.x-ep.x,hp.y-ep.y); if(d<closestDist){closestDist=d;closest=ep;} } if(closestDist<5){ merged.push({x:hp.x*mergeFactor+closest.x*(1-mergeFactor), y:hp.y*mergeFactor+closest.y*(1-mergeFactor), z:hp.z*mergeFactor+closest.z*(1-mergeFactor)}); } else merged.push(hp);} return merged; }

    function determineStartPoint(points,strategy){ if(points.length===0) return {x:0,y:0,z:0}; if(strategy==='manual'){ return {x:startPoint.x-50,y:startPoint.y-50,z:0}; } if(strategy==='center'){ return {x:0,y:0,z:0}; } let closest=points[0],minD=Math.hypot(points[0].x,points[0].y); for(let i=1;i<points.length;i++){ const d=Math.hypot(points[i].x,points[i].y); if(d<minD){minD=d;closest=points[i];}} return closest; }

    function optimizeToolpaths(points,startPt){ if(points.length<=1) return points; const optimized=[startPt]; const remaining=points.slice(); // naive
      // ensure startPt exists in set
      // simple nearest neighbor
      while(remaining.length>0){ const last=optimized[optimized.length-1]; let bestIdx=0,bestD=Infinity; for(let i=0;i<remaining.length;i++){ const d=Math.hypot(last.x-remaining[i].x,last.y-remaining[i].y, (last.z-remaining[i].z)*0.2); if(d<bestD){bestD=d;bestIdx=i;} } optimized.push(remaining[bestIdx]); remaining.splice(bestIdx,1); }
      return optimized; }

    async function processImageWithAI(imgData){ // placeholder: return normalized 2D array
      // For now return heightMapData.data
      return heightMapData.data;
    }

    // Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© Ù…Ù† generateRealGcode Ù…ØªÙˆØ§ÙÙ‚Ø© Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    async function generateRealGcode(){ if(!heightMapData || !originalImageData){ showNotification('ÙŠØ¬Ø¨ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', true); return ''; }
      const feedRate = parseInt(document.getElementById('feedRate').value)||1200; const spindleSpeed = parseInt(document.getElementById('spindleSpeed').value)||10000; const cutDepth = parseFloat(document.getElementById('cutDepth').value)||2; const gcodePrecision = document.getElementById('gcodePrecision').value; const gcodeType = document.getElementById('gcodeType').value; const useEdges = (gcodeType==='edges'||gcodeType==='hybrid'); const useHeatmap = (gcodeType==='heatmap'||gcodeType==='hybrid'||gcodeType==='heatmap');
      let resolution = 5; if(gcodePrecision==='medium') resolution=3; if(gcodePrecision==='high') resolution=1; updateProgress(10);
      const w = heightMapData.width, h = heightMapData.height; let edgePoints = [], heatmapPoints = [];
      if(useEdges && edgesCanvas){ edgePoints = extractEdgePoints(ctxEdges.getImageData(0,0,w,h), w, h, cutDepth); updateProgress(30); }
      if(useHeatmap && heightMapData){ heatmapPoints = extractHeatmapPoints(heightMapData.data, w, h, cutDepth, resolution); updateProgress(50); }
      let points = [];
      if(gcodeType==='edges') points = edgePoints; else if(gcodeType==='heatmap') points = heatmapPoints; else if(gcodeType==='hybrid') points = mergeEdgeAndHeatmapPaths(edgePoints, heatmapPoints, 0.6);
      if(points.length===0){ const ai = await processImageWithAI(originalImageData); for(let y=0;y<h;y+=resolution) for(let x=0;x<w;x+=resolution){ const pv = ai[y][x]||0; const depth=(1-pv)*cutDepth; points.push({x:(x/w)*100-50,y:(y/h)*100-50,z:-depth}); } }
      const startStrategy = document.getElementById('startPointStrategy') ? document.getElementById('startPointStrategy').value : 'auto'; const startPt = determineStartPoint(points,startStrategy);
      const toolPaths = optimizeToolpaths(points,startPt); updateProgress(80);
      let gcode = `; G-code generated by CNC AI\n`; gcode+=`; Feed rate: ${feedRate} mm/min\n`; gcode+=`; Spindle: ${spindleSpeed} RPM\n`; gcode+=`; Start: X${startPt.x.toFixed(3)} Y${startPt.y.toFixed(3)}\n`;
      gcode+=`G21\nG90\nG0 Z5\nM3 S${spindleSpeed}\nG4 P1\n\nG0 X${startPt.x.toFixed(3)} Y${startPt.y.toFixed(3)}\nG1 Z0 F${feedRate/2}\n`;
      for(let i=0;i<toolPaths.length;i++){ const p=toolPaths[i]; gcode+=`G1 X${p.x.toFixed(3)} Y${p.y.toFixed(3)} Z${(p.z||0).toFixed(3)} F${feedRate}\n`; }
      gcode+=`\nG0 Z5\nM5\nG0 X0 Y0\nM30\n`;
      updateProgress(100); return gcode;
    }

    // Ø¹Ø±Ø¶ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù€Ù€ sliders
    document.getElementById('startPointX').addEventListener('input',e=>startPoint.x=parseFloat(e.target.value));
    document.getElementById('startPointY').addEventListener('input',e=>startPoint.y=parseFloat(e.target.value));

    // ØªÙ‡ÙŠØ¦Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    window.addEventListener('load',()=>{ startPoint={x:50,y:50}; document.getElementById('startPointX').value=50; document.getElementById('startPointY').value=50; updateProgress(0); });

    // Ø®ÙŠØ§Ø± Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ
    function applyEnhancement(mode){ if(!originalImageData) return; if(mode==='grayscale'){ ctx2d.putImageData(originalImageData,0,0); const id = ctx2d.getImageData(0,0,previewCanvas.width,previewCanvas.height); for(let i=0;i<id.data.length;i+=4){ const g = 0.299*id.data[i]+0.587*id.data[i+1]+0.114*id.data[i+2]; id.data[i]=id.data[i+1]=id.data[i+2]=g; } ctx2d.putImageData(id,0,0); } else if(mode==='reset'){ ctx2d.putImageData(originalImageData,0,0); } }

  </script></body>
</html>
