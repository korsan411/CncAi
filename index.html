<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CNC AI â€” CNC Router & Laser Engraving & 3D Printing</title>

  <!-- Ù…ÙƒØªØ¨Ø§Øª Ù…Ø¹ fallback -->
  <script src="https://docs.opencv.org/4.8.0/opencv.js" 
          onerror="handleOpenCVError()" 
          async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"
          onerror="handleThreeJSError()"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"
          onerror="handleThreeJSError()"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"
          onerror="handleThreeJSError()"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"
          onerror="handleThreeJSError()"></script>

  <style>
    * { box-sizing: border-box; }
    body { 
        margin: 0; 
        font-family: 'Segoe UI', system-ui, sans-serif; 
        background: linear-gradient(135deg, #041022 0%, #0a1a35 100%);
        color: #e6eef6; 
        line-height: 1.5;
        min-height: 100vh;
    }
    
    .app { 
        max-width: 1400px; 
        margin: 16px auto; 
        padding: 16px;
    }
    
    header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 20px; 
        padding: 16px 20px;
        border-bottom: 1px solid rgba(30, 41, 59, 0.6);
        background: rgba(11, 19, 32, 0.8);
        border-radius: 12px;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    header h1 {
        margin: 0;
        font-size: 1.8rem;
        background: linear-gradient(90deg, #06b6d4, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 700;
    }
    
    .grid { 
        display: grid; 
        grid-template-columns: 1fr 520px; 
        gap: 20px;
    }
    
    @media (max-width: 1100px){ 
        .grid{ 
            grid-template-columns: 1fr;
        } 
    }
    
    .panel { 
        background: rgba(11, 19, 32, 0.8); 
        padding: 20px; 
        border-radius: 12px; 
        border: 1px solid rgba(30, 41, 59, 0.5);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(10px);
    }
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
    .tab-buttons { 
        display: flex; 
        gap: 8px; 
        margin-top: 16px; 
        background: rgba(14, 23, 33, 0.8); 
        padding: 8px; 
        border-radius: 10px;
        border: 1px solid rgba(30, 41, 59, 0.3);
    }
    
    .tab-buttons button { 
        flex: 1; 
        border: none; 
        padding: 10px 12px; 
        border-radius: 8px; 
        background: transparent; 
        color: #9bb0c8; 
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .tab-buttons button:hover { 
        background: rgba(30, 41, 59, 0.5);
        transform: translateY(-1px);
    }
    
    .tab-buttons button.active { 
        background: linear-gradient(135deg, #06b6d4, #3b82f6); 
        color: #fff; 
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }
    
    .tab-content { 
        display: none; 
        margin-top: 16px;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .tab-content.active { 
        display: block; 
    }
    
    canvas { 
        max-width: 100%; 
        border-radius: 8px; 
        background: #000; 
        display: block; 
        margin: 0 auto; 
        border: 1px solid rgba(51, 65, 85, 0.5);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    #threeContainer, #threeDContainer { 
        width: 100%; 
        height: 420px; 
        background: rgba(8, 18, 36, 0.7); 
        border-radius: 10px; 
        overflow: hidden; 
        position: relative;
        border: 1px solid rgba(51, 65, 85, 0.5);
    }
    
    label { 
        display: block; 
        margin-top: 16px; 
        color: #cfeaf2; 
        font-weight: 600;
        font-size: 0.95rem;
    }
    
    input, select, textarea, button { 
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }
    
    input, select { 
        width: 100%; 
        padding: 10px 12px; 
        border-radius: 8px; 
        border: 1px solid rgba(30, 41, 59, 0.5); 
        background: rgba(15, 23, 42, 0.7); 
        color: #e6eef6; 
        margin-top: 6px;
    }
    
    input:focus, select:focus {
        outline: none;
        border-color: #06b6d4;
        box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
    }
    
    .button-group { 
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
        margin-top: 16px; 
    }
    
    .button-row { 
        display: flex; 
        gap: 10px; 
    }
    
    button { 
        background: rgba(30, 41, 59, 0.8); 
        color: #e6eef6; 
        border: none; 
        padding: 12px 16px; 
        border-radius: 8px; 
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    button.primary { 
        background: linear-gradient(135deg, #06b6d4, #3b82f6); 
        color: #fff; 
        font-weight: 600;
    }
    
    button.primary:hover {
        background: linear-gradient(135deg, #0ea5e9, #2563eb);
        box-shadow: 0 6px 16px rgba(6, 182, 212, 0.4);
    }
    
    button.secondary { 
        background: rgba(51, 65, 85, 0.8); 
    }
    
    button.secondary:hover {
        background: rgba(71, 85, 105, 0.8);
    }
    
    #toast { 
        position: fixed; 
        right: 20px; 
        bottom: 20px; 
        background: rgba(0, 0, 0, 0.9); 
        color: #fff; 
        padding: 12px 16px; 
        border-radius: 10px; 
        display: none; 
        z-index: 10000;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        border-left: 4px solid #06b6d4;
    }
    
    .canvas-placeholder { 
        width: 100%; 
        min-height: 260px; 
        background: rgba(0, 0, 0, 0.3); 
        border-radius: 8px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        color: #9bb0c8; 
        border: 1px dashed rgba(51, 65, 85, 0.5);
    }
    
    .small-meta { 
        font-size: 0.85rem; 
        color: #9bb0c8; 
        margin-top: 8px;
        line-height: 1.4;
    }

    /* ØªØ­Ø³ÙŠÙ† Ù‚Ø³Ù… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù€ Colormap */
    .colormap-section {
        margin: 20px 0;
        padding: 20px;
        background: rgba(14, 23, 33, 0.6);
        border-radius: 12px;
        border: 1px solid rgba(51, 65, 85, 0.3);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .colormap-title {
        text-align: center;
        margin-bottom: 16px;
        color: #cfeaf2;
        font-weight: 700;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .colormap-buttons { 
        display: flex; 
        gap: 10px; 
        justify-content: center; 
        margin-top: 12px; 
        flex-wrap: wrap; 
    }
    
    .colormap-buttons button {
        background: rgba(20, 27, 34, 0.8); 
        color: #cfeaf2; 
        border: 1px solid rgba(38, 52, 63, 0.5); 
        padding: 12px 18px; 
        border-radius: 10px; 
        cursor: pointer; 
        font-size: 0.95rem; 
        font-weight: 600; 
        transition: all 0.3s ease; 
        min-width: 90px;
    }
    
    .colormap-buttons button:hover { 
        background: rgba(30, 41, 59, 0.8); 
        border-color: #06b6d4; 
        transform: translateY(-3px); 
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }
    
    .colormap-buttons button.active { 
        background: linear-gradient(135deg, #06b6d4, #3b82f6); 
        color: #fff; 
        border-color: #06b6d4; 
        box-shadow: 0 6px 16px rgba(6, 182, 212, 0.4);
    }

    /* ØªØ­Ø³ÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© */
    .machine-settings { 
        transition: all 0.3s ease; 
    }
    
    .laser-specific { 
        border-right: 3px solid #ff4444; 
        padding-right: 12px; 
        margin: 12px 0; 
        background: rgba(255, 0, 0, 0.05);
        border-radius: 8px;
        padding: 12px;
    }
    
    .router-specific { 
        border-right: 3px solid #06b6d4; 
        padding-right: 12px; 
        margin: 12px 0; 
        background: rgba(6, 182, 212, 0.05);
        border-radius: 8px;
        padding: 12px;
    }
    
    .threed-specific { 
        border-right: 3px solid #10b981; 
        padding-right: 12px; 
        margin: 12px 0; 
        background: rgba(16, 185, 129, 0.05);
        border-radius: 8px;
        padding: 12px;
    }
    
    .laser-edge-settings {
        border: 1px solid rgba(255, 68, 68, 0.3);
        border-radius: 8px;
        padding: 12px;
        margin: 12px 0;
        background: rgba(255, 68, 68, 0.05);
    }
    
    .laser-mode-description {
        font-size: 0.85rem;
        color: #9bb0c8;
        margin-top: 6px;
        line-height: 1.4;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    input[type="range"] {
        -webkit-appearance: none;
        height: 6px;
        background: rgba(30, 41, 59, 0.7);
        border-radius: 3px;
        outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #06b6d4;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    
    input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #06b6d4;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    /* ØªØ­Ø³ÙŠÙ† Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†Øµ */
    textarea {
        height: 180px;
        background: rgba(2, 16, 36, 0.7);
        color: #cfeaf2;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid rgba(30, 41, 59, 0.5);
        resize: vertical;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    textarea:focus {
        outline: none;
        border-color: #06b6d4;
        box-shadow: 0 0 0 2px rgba(6, 182, 212, 0.2);
    }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø± */
    #estTime {
        margin-top: 16px;
        color: #9bb0c8;
        text-align: center;
        padding: 12px;
        background: rgba(15, 23, 42, 0.7);
        border-radius: 8px;
        border: 1px solid rgba(30, 41, 59, 0.3);
        font-weight: 500;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù€ Top View */
    #topViewContainer { 
        margin-top: 16px; 
        display: flex; 
        flex-direction: column; 
        gap: 8px; 
        align-items: center; 
    }
    
    #topView { 
        width: 100%; 
        height: 200px; 
        background: rgba(13, 23, 34, 0.7); 
        border-radius: 8px; 
        border: 1px solid rgba(51, 65, 85, 0.5);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    #topLegend { 
        width: 100%; 
        height: 20px; 
        border-radius: 8px; 
        border: 1px solid rgba(43, 56, 68, 0.5); 
        background: linear-gradient(90deg, #ddd, #333);
    }

    /* ØªØ­Ø³ÙŠÙ† Ø­Ø§Ù„Ø© OpenCV */
    #cvState {
        display: flex;
        align-items: center;
        font-weight: 500;
        background: rgba(15, 23, 42, 0.7);
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid rgba(30, 41, 59, 0.3);
    }
    
    .loading {
        display: inline-block;
        width: 18px;
        height: 18px;
        border: 3px solid rgba(243, 243, 243, 0.3);
        border-top: 3px solid #06b6d4;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 8px;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù */
    .file-input-label {
        display: inline-block;
        padding: 10px 14px;
        background: rgba(30, 41, 59, 0.8);
        border-radius: 8px;
        color: #e6eef6;
        cursor: pointer;
        border: 1px dashed rgba(51, 65, 85, 0.5);
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .file-input-label:hover {
        background: rgba(40, 51, 69, 0.8);
        border-color: #06b6d4;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø®Ø·ÙˆØ· Ø§Ù„ÙØµÙ„ */
    hr {
        border: none;
        height: 1px;
        background: rgba(30, 41, 59, 0.5);
        margin: 16px 0;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
    h3 {
        margin-top: 0;
        color: #cfeaf2;
        border-bottom: 1px solid rgba(30, 41, 59, 0.5);
        padding-bottom: 10px;
        font-size: 1.3rem;
    }
    
    h4 {
        margin: 0;
        font-size: 1.1rem;
    }

    /* ØªØ­Ø³ÙŠÙ† Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± */
    input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
    .inner-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ‚Ø¯Ù… */
    .progress-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 30000;
        flex-direction: column;
        gap: 20px;
        backdrop-filter: blur(4px);
    }
    
    .progress-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(243, 243, 243, 0.2);
        border-top: 5px solid #06b6d4;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    .progress-text {
        color: white;
        font-size: 1.1rem;
        font-weight: 500;
    }

    @keyframes spin { 
        0% { transform: rotate(0); } 
        100% { transform: rotate(360deg); } 
    }

    /* Debug overlay */
    #debugOverlay {
        position: fixed;
        left: 16px;
        bottom: 16px;
        width: 420px;
        max-height: 55vh;
        background: rgba(2,6,23,0.9);
        color: #e6eef6;
        border: 1px solid rgba(102, 126, 234, 0.08);
        border-radius: 8px;
        font-size: 13px;
        z-index: 20000;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 8px 40px rgba(0,0,0,0.6);
    }
    #debugOverlay.minimized { height: 36px; width: 160px; cursor: pointer; }
    #debugHeader {
        display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.03);
        background: linear-gradient(90deg, rgba(6,182,212,0.06), rgba(8,145,178,0.02));
    }
    #debugHeader b { color:#aee8f2; }
    #debugControls { display:flex; gap:6px; align-items:center; }
    .dbg-btn { background:transparent; border:1px solid rgba(255,255,255,0.06); color:#cfeaf2; padding:6px 8px; border-radius:6px; cursor:pointer; font-size:12px; }
    #debugList { overflow:auto; padding:8px; display:flex; flex-direction:column; gap:6px; }
    .dbg-item { padding:8px; border-radius:6px; background:rgba(255,255,255,0.02); line-height:1.2; max-height:120px; overflow:auto; font-family:monospace; font-size:12px; }
    .dbg-time { opacity:0.7; font-size:11px; margin-bottom:6px; display:block; }
    .dbg-error { border-left:4px solid #ef4444; }
    .dbg-warn { border-left:4px solid #f59e0b; }
    .dbg-info { border-left:4px solid #06b6d4; color:#cfeaf2; }
    .dbg-meta { opacity:0.75; font-size:11px; margin-top:6px; color:#9bb0c8; }
    #debugFooter { padding:6px 10px; border-top:1px solid rgba(255,255,255,0.02); text-align:right; font-size:12px; color:#9bb0c8; background:rgba(0,0,0,0.03); display:flex; justify-content:space-between; align-items:center; }

    /* Simulation controls */
    .sim-controls { position:absolute; top:10px; right:10px; z-index:120; display:flex; gap:8px; align-items:center; background:rgba(0,0,0,0.35); padding:6px;border-radius:6px }
    .sim-controls button { background:rgba(0,0,0,0.55); color:white; border:1px solid #06b6d4; border-radius:4px; padding:6px 8px; cursor:pointer; font-size:0.9rem }
    .sim-progress { position:absolute; bottom:10px; right:10px; z-index:120; background:rgba(0,0,0,0.35); padding:6px 8px;border-radius:6px; color:#cfeaf2; font-size:12px }

    /* Ù‚Ø³Ù… Ù…Ù„ÙØ§Øª STL Ùˆ SVG Ùˆ DXF */
    .file-format-section {
        margin: 20px 0;
        padding: 16px;
        background: rgba(14, 23, 33, 0.6);
        border-radius: 12px;
        border: 1px solid rgba(51, 65, 85, 0.3);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .file-format-title {
        text-align: center;
        margin-bottom: 16px;
        color: #cfeaf2;
        font-weight: 700;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .file-format-buttons { 
        display: flex; 
        gap: 10px; 
        justify-content: center; 
        margin-top: 12px; 
        flex-wrap: wrap; 
    }
    
    .file-format-buttons button {
        background: rgba(20, 27, 34, 0.8); 
        color: #cfeaf2; 
        border: 1px solid rgba(38, 52, 63, 0.5); 
        padding: 12px 18px; 
        border-radius: 10px; 
        cursor: pointer; 
        font-size: 0.95rem; 
        font-weight: 600; 
        transition: all 0.3s ease; 
        min-width: 90px;
    }
    
    .file-format-buttons button:hover { 
        background: rgba(30, 41, 59, 0.8); 
        border-color: #06b6d4; 
        transform: translateY(-3px); 
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }
    
    .file-format-buttons button.active { 
        background: linear-gradient(135deg, #06b6d4, #3b82f6); 
        color: #fff; 
        border-color: #06b6d4; 
        box-shadow: 0 6px 16px rgba(6, 182, 212, 0.4);
    }

    /* Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª */
    .settings-panel {
        background: rgba(14, 23, 33, 0.6);
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
        border: 1px solid rgba(51, 65, 85, 0.3);
    }
    
    .memory-indicator {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        z-index: 1000;
    }
    
    .performance-warning {
        background: rgba(255, 165, 0, 0.1);
        border: 1px solid rgba(255, 165, 0, 0.3);
        border-radius: 6px;
        padding: 8px;
        margin: 8px 0;
        font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ø°Ø§ÙƒØ±Ø© -->
  <div class="memory-indicator" id="memoryIndicator">Ø°Ø§ÙƒØ±Ø©: 0 Ù…Ø§Øª</div>

  <div class="app">
    <header>
      <h1>CNC AI â€” CNC Router & Laser Engraving & 3D Printing</h1>
      <div id="cvState">
        <span class="loading" style="display:inline-block;width:16px;height:16px;border:3px solid #f3f3f3;border-top:3px solid #06b6d4;border-radius:50%;animation:spin 1s linear infinite;margin-right:8px;"></span>
        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ OpenCV...
      </div>
    </header>

    <div class="grid">
      <!-- LEFT panel -->
      <div class="panel">
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="fileInput" type="file" accept="image/*"/>
          <label class="file-input-label" for="fileInput" style="display:inline-block;padding:8px 12px;background:#1e293b;border-radius:6px;color:#e6eef6;cursor:pointer;border:1px dashed #334155">ğŸ“ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
          <div style="flex:1"></div>

          <label for="edgeMode" style="font-weight:normal;color:#9bb0c8">Edge Mode:</label>
          <select id="edgeMode" style="width:140px">
            <option value="auto">Canny (Ø¹Ø§Ø¯ÙŠ)</option>
            <option value="sobel">Sobel (Ø¯Ù‚ÙŠÙ‚)</option>
            <option value="laplace">Laplacian (Ù†Ø§Ø¹Ù€Ù…)</option>
          </select>
        </div>

        <!-- Edge sensitivity slider -->
        <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
          <label style="margin:0;color:#9bb0c8">Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ù:</label>
          <input id="edgeSensitivity" type="range" min="0.1" max="1.0" step="0.05" value="0.33" style="flex:1">
          <div id="edgeValue" style="min-width:44px;text-align:center;color:#cfeaf2">0.33</div>
        </div>

        <!-- ========== Ù‚Ø³Ù… Ù…Ù„ÙØ§Øª STL Ùˆ SVG Ùˆ DXF ========== -->
        <div class="file-format-section">
          <div class="file-format-title">
            <span>ğŸ“</span>
            ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª STL Ùˆ SVG Ùˆ DXF
            <span>ğŸ“</span>
          </div>
          <div class="file-format-buttons" id="fileFormatButtons">
            <button data-format="stl" title="ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù STL (Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯)">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>STL</div>
                <div style="font-size:0.8rem;color:#9bb0c8">Ù†Ù…ÙˆØ°Ø¬ Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</div>
              </div>
            </button>
            <button data-format="svg" title="ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù SVG (Ø±Ø³ÙˆÙ… Ù…ØªØ¬Ù‡Ø©)">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>SVG</div>
                <div style="font-size:0.8rem;color:#9bb0c8">Ø±Ø³ÙˆÙ… Ù…ØªØ¬Ù‡Ø©</div>
              </div>
            </button>
            <button data-format="dxf" title="ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù DXF (Ø±Ø³Ù… CAD)">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>DXF</div>
                <div style="font-size:0.8rem;color:#9bb0c8">Ø±Ø³Ù… CAD</div>
              </div>
            </button>
          </div>
          <div class="small-meta" style="text-align: center; margin-top: 8px;">
            ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª STL Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ØŒ ÙˆÙ…Ù„ÙØ§Øª SVG/DXF Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ G-code
          </div>
        </div>

        <!-- ========== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù€ Colormap Ø§Ù„Ø«Ø§Ø¨ØªØ© ========== -->
        <div class="colormap-section">
          <div class="colormap-title">
            <span>ğŸ¨</span>
            Ø®ÙŠØ§Ø±Ø§Øª ØªØ¯Ø±Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
            <span>ğŸ¨</span>
          </div>
          <div class="colormap-buttons" id="colormapButtons">
            <button data-map="jet" class="active" title="Jet - Ø§Ù„Ø£Ø²Ø±Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ù…Ø±">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>Jet</div>
                <div style="width:100%;height:4px;background:linear-gradient(90deg,#0000ff,#00ffff,#ffff00,#ff0000);border-radius:2px"></div>
              </div>
            </button>
            <button data-map="hot" title="Hot - Ø§Ù„Ø£Ø³ÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ù…Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø£ØµÙØ±">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>Hot</div>
                <div style="width:100%;height:4px;background:linear-gradient(90deg,#000000,#ff0000,#ffff00,#ffffff);border-radius:2px"></div>
              </div>
            </button>
            <button data-map="cool" title="Cool - Ø§Ù„Ø³Ù…Ø§ÙˆÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¬ÙˆØ§Ù†ÙŠ">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>Cool</div>
                <div style="width:100%;height:4px;background:linear-gradient(90deg,#00ffff,#ff00ff);border-radius:2px"></div>
              </div>
            </button>
            <button data-map="gray" title="Gray - Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>Gray</div>
                <div style="width:100%;height:4px;background:linear-gradient(90deg,#000000,#ffffff);border-radius:2px"></div>
              </div>
            </button>
          </div>
          <div class="small-meta" style="text-align: center; margin-top: 8px;">
            Ø§Ù„ØªØºÙŠÙŠØ± ÙŠØ·Ø¨Ù‚ Ø¹Ù„Ù‰: Heatmap â€¢ Top View â€¢ Contours â€¢ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª
          </div>
        </div>

        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ -->
        <div class="settings-panel">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <label style="margin:0;color:#cfeaf2">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡:</label>
            <button id="btnOptimizePerformance" class="secondary" style="font-size:0.8rem;padding:6px 10px;">ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡</button>
          </div>
          <div style="display:flex;gap:12px;margin-top:8px;">
            <label style="font-size:0.8rem;">
              <input type="checkbox" id="enableMemoryCleanup" checked /> ØªÙ†Ø¸ÙŠÙ Ø°Ø§ÙƒØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠ
            </label>
            <label style="font-size:0.8rem;">
              <input type="checkbox" id="enableSimplifiedSimulation" checked /> Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ø¨Ø³Ø·Ø©
            </label>
          </div>
        </div>

        <div class="tab-buttons" role="tablist">
          <button data-tab="original" class="active">ğŸ–¼ï¸ Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
          <button data-tab="heatmap">ğŸ”¥ Heatmap</button>
          <button data-tab="contour">ğŸ“ Contours</button>
          <button data-tab="topview">ğŸ” Top View</button>
          <button data-tab="threed">ğŸ§Š 3D Models</button>
          <button data-tab="simulation">ğŸ¬ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</button>
        </div>

        <div id="original" class="tab-content active">
          <div class="canvas-placeholder" id="originalPlaceholder">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          <canvas id="canvasOriginal" style="display:none;"></canvas>
        </div>

        <div id="heatmap" class="tab-content">
          <div class="canvas-placeholder" id="heatmapPlaceholder">Heatmap Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          <canvas id="canvasHeatmap" style="display:none;"></canvas>
        </div>

        <div id="contour" class="tab-content">
          <div class="canvas-placeholder" id="contourPlaceholder">Contours Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          <canvas id="canvasContour" style="display:none;"></canvas>
          <div class="small-meta">ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù Ø£Ùˆ ØªØ­Ø±ÙŠÙƒ Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ù ÙŠØ­Ø¯Ø« Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</div>
        </div>

        <div id="topview" class="tab-content">
          <div id="topViewContainer">
            <canvas id="topView"></canvas>
            <div id="topLegend" title="Ø¹Ù…Ù‚ Ø§Ù„Ù†Ù‚Ø´ â€” Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙ‚Ø·"></div>
          </div>
          <div class="small-meta">Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø¹Ù…Ù‚ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° G-code (Ø§Ù„Ø£Ù„ÙˆØ§Ù† ØªØªØ¨Ø¹ Ø§Ø®ØªÙŠØ§Ø± Colormap)</div>
        </div>

        <div id="threed" class="tab-content">
          <div class="canvas-placeholder" id="threedPlaceholder">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          <div id="threeDContainer" style="display:none;">
            <canvas id="canvas3D"></canvas>
          </div>
        </div>

        <div id="simulation" class="tab-content">
          <div id="threeContainer">
            <div class="canvas-placeholder" id="simulationPlaceholder">Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ ØªÙˆÙ„ÙŠØ¯ G-code</div>
          </div>
        </div>
      </div>

      <!-- RIGHT panel -->
      <div class="panel">
        <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</h3>

        <!-- Machine Category Selection -->
        <label for="machineCategory">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
        <select id="machineCategory">
          <option value="router">CNC Router (Ù†Ø­Øª Ø®Ø´Ø¨)</option>
          <option value="laser">Laser Engraver (Ù†Ù‚Ø´ Ù„ÙŠØ²Ø±)</option>
          <option value="threed">3D Printer (Ø·Ø¨Ø§Ø¹Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯)</option>
        </select>

        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­ÙØ¸ -->
        <div class="settings-panel">
          <div style="display:flex;gap:8px;">
            <button id="btnSaveSettings" class="secondary" style="flex:1;font-size:0.8rem;padding:6px 10px;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            <button id="btnLoadSettings" class="secondary" style="flex:1;font-size:0.8rem;padding:6px 10px;">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          </div>
        </div>

        <!-- CNC Router Settings -->
        <div id="routerSettings" class="machine-settings">
          <h4 class="router-specific">ğŸ”„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª CNC Router</h4>
          
          <label for="workWidth">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
          <input id="workWidth" type="number" value="30" step="0.1" min="1" max="200"/>
          <div class="small-meta" id="widthMm">300.0 Ù…Ù…</div>

          <label for="workHeight">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
          <input id="workHeight" type="number" value="20" step="0.1" min="1" max="200"/>
          <div class="small-meta" id="heightMm">200.0 Ù…Ù…</div>

          <label for="workDepth">Ø¹Ù…Ù‚ Ø§Ù„Ø¹Ù…Ù„ (Ù…Ù…)</label>
          <input id="workDepth" type="number" value="3.0" step="0.1" min="0.1" max="50"/>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label for="originX">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ X (Ø³Ù…)</label>
              <input id="originX" type="number" value="0" step="0.1"/>
            </div>
            <div>
              <label for="originY">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ Y (Ø³Ù…)</label>
              <input id="originY" type="number" value="0" step="0.1"/>
            </div>
          </div>
          <div style="margin-top:6px"><button id="btnCenterOrigin" class="secondary">ğŸ¯ ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„</button></div>

          <hr style="border-color:#122433;margin:12px 0"/>

          <label for="feedRate">Ø³Ø±Ø¹Ø© Ø§Ù„ØªØºØ°ÙŠØ© (Ù…Ù…/Ø¯Ù‚ÙŠÙ‚Ø©)</label>
          <input id="feedRate" type="number" value="800" min="10" max="5000"/>
          <label for="safeZ">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø£Ù…Ø§Ù† (Ù…Ù…)</label>
          <input id="safeZ" type="number" value="5" step="0.1" min="0" max="100"/>

          <label for="scanDir">Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (Raster)</label>
          <select id="scanDir">
            <option value="x">Ø£ÙÙ‚ÙŠ (X)</option>
            <option value="y">Ø±Ø£Ø³ÙŠ (Y)</option>
          </select>

          <label for="stepOver">Ø®Ø·ÙˆØ© Ø§Ù„Ù…Ø³Ø­ (Ù…Ù…)</label>
          <input id="stepOver" type="number" value="5" step="0.1" min="0.1" max="50"/>
          <label for="maxDepth">Ø£Ù‚ØµÙ‰ Ø¹Ù…Ù‚ (Ù…Ù…)</label>
          <input id="maxDepth" type="number" value="3.0" step="0.1" min="0.1" max="50"/>

          <!-- Fixed Z + Invert Z -->
          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <label style="font-weight:normal;"><input id="fixedZ" type="checkbox" /> Ø§Ø³ØªØ®Ø¯Ø§Ù… Z Ø«Ø§Ø¨Øª</label>
            <input id="fixedZValue" type="number" value="-1.0" step="0.1" style="width:120px" />
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <label style="font-weight:normal;"><input id="invertZ" type="checkbox" /> Ø¹ÙƒØ³ Z</label>
            <div style="flex:1"></div>
            <label style="font-weight:normal;color:#9bb0c8">Ù„ÙˆÙ† Ø§Ù„Ø®Ø´Ø¨:</label>
            <select id="woodColor" style="width:140px">
              <option value="#deb887">Ø®Ø´Ø¨ ÙØ§ØªØ­</option>
              <option value="#a0522d" selected>Ø®Ø´Ø¨ Ù…ØªÙˆØ³Ø·</option>
              <option value="#d2b48c">Ø¨ÙŠØ¬</option>
              <option value="#8b5a2b">Ù…Ø§Ù‡ÙˆØ¬Ù†ÙŠ</option>
            </select>
          </div>

          <div class="button-group">
            <div class="button-row">
              <button id="btnGen" class="primary">âš¡ ØªÙˆÙ„ÙŠØ¯ G-code (Raster)</button>
              <button id="btnQuick" class="secondary">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹</button>
            </div>

            <div style="margin-top:8px">
              <label for="contourMode">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø­ÙˆØ§Ù (Contour)</label>
              <select id="contourMode">
                <option value="outer">Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ÙÙ‚Ø·</option>
                <option value="all">ÙƒÙ„ Ø§Ù„Ø­ÙˆØ§Ù</option>
              </select>
              <div style="height:8px"></div>
              <div class="button-row">
                <button id="btnContour" class="secondary">ğŸŒ€ ØªÙˆÙ„ÙŠØ¯ G-code (Contour)</button>
                <button id="btnDownload" class="secondary">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ G-code</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Laser Engraver Settings -->
        <div id="laserSettings" class="machine-settings" style="display:none;">
          <h4 class="laser-specific">âš¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Laser Engraver</h4>
          
          <label for="laserWorkWidth">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
          <input id="laserWorkWidth" type="number" value="30" step="0.1" min="1" max="200"/>
          <div class="small-meta" id="laserWidthMm">300.0 Ù…Ù…</div>

          <label for="laserWorkHeight">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
          <input id="laserWorkHeight" type="number" value="20" step="0.1" min="1" max="200"/>
          <div class="small-meta" id="laserHeightMm">200.0 Ù…Ù…</div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label for="laserOriginX">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ X (Ø³Ù…)</label>
              <input id="laserOriginX" type="number" value="0" step="0.1"/>
            </div>
            <div>
              <label for="laserOriginY">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ Y (Ø³Ù…)</label>
              <input id="laserOriginY" type="number" value="0" step="0.1"/>
            </div>
          </div>
          <div style="margin-top:6px"><button id="btnLaserCenterOrigin" class="secondary">ğŸ¯ ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„</button></div>

          <!-- Laser Edge Detection Settings -->
          <div class="laser-edge-settings">
            <label for="laserEdgeMode">Ù†Ù…Ø· ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù Ù„Ù„Ù„ÙŠØ²Ø±</label>
            <select id="laserEdgeMode">
              <option value="canny">Canny (Ø¹Ø§Ø¯ÙŠ)</option>
              <option value="adaptive">Adaptive Threshold (Ù„Ù„Ù†Ù‚Ø´)</option>
              <option value="morphological">Morphological (Ù„Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©)</option>
              <option value="gradient">Gradient-Based (Ù„Ù„ØªØ¯Ø±Ø¬Ø§Øª)</option>
            </select>
            <div class="laser-mode-description" id="laserModeDesc">
              Adaptive Threshold - Ù…Ù…ØªØ§Ø² Ù„Ù„ØµÙˆØ± Ø°Ø§Øª Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© ØºÙŠØ± Ø§Ù„Ù…ØªØ¬Ø§Ù†Ø³Ø©
            </div>

            <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
              <label style="margin:0;color:#9bb0c8">Ø¯Ù‚Ø© Ø§Ù„Ù„ÙŠØ²Ø±:</label>
              <input id="laserDetail" type="range" min="1" max="10" value="5" step="1" style="flex:1">
              <div id="laserDetailValue" style="min-width:44px;text-align:center;color:#ff4444">5</div>
            </div>
          </div>

          <div style="margin-top: 8px;">
            <button id="btnRedetectLaser" class="secondary">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ÙƒØ´Ù Ø­ÙˆØ§Ù Ø§Ù„Ù„ÙŠØ²Ø±</button>
          </div>

          <hr style="border-color:#ff4444;margin:12px 0"/>

          <!-- Laser Power -->
          <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
            <label style="margin:0;color:#9bb0c8">Ù‚ÙˆØ© Ø§Ù„Ù„ÙŠØ²Ø±:</label>
            <input id="laserPower" type="range" min="0" max="100" value="80" step="1" style="flex:1">
            <div id="laserPowerValue" style="min-width:44px;text-align:center;color:#ff4444">80%</div>
          </div>

          <label for="laserMode">ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠØ²Ø±</label>
          <select id="laserMode">
            <option value="engrave">Ù†Ù‚Ø´ (Grayscale)</option>
            <option value="cut">Ù‚Øµ (Contour)</option>
            <option value="combine">Ù†Ù‚Ø´ + Ù‚Øµ</option>
          </select>

          <label for="laserSpeed">Ø³Ø±Ø¹Ø© Ø§Ù„Ù„ÙŠØ²Ø± (Ù…Ù…/Ø¯Ù‚ÙŠÙ‚Ø©)</label>
          <input id="laserSpeed" type="number" value="2000" min="100" max="10000"/>

          <label for="laserPasses">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª</label>
          <input id="laserPasses" type="number" value="1" min="1" max="10"/>

          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <label style="font-weight:normal;">
              <input id="laserDynamic" type="checkbox" checked /> 
              Ù‚ÙˆØ© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© (Ø­Ø³Ø¨ Ø§Ù„Ø¸Ù„Ø§Ù…)
            </label>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <label style="font-weight:normal;">
              <input id="laserAirAssist" type="checkbox" /> 
              Air Assist
            </label>
          </div>

          <!-- Laser Buttons -->
          <div class="button-group">
            <div class="button-row">
              <button id="btnLaserEngrave" class="primary" style="background:#ff4444;">âš¡ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ù„ÙŠØ²Ø± (Ù†Ù‚Ø´)</button>
              <button id="btnLaserQuick" class="secondary">ğŸ§ª Ù†Ù‚Ø´ Ø³Ø±ÙŠØ¹</button>
            </div>
            <div class="button-row">
              <button id="btnLaserCut" class="secondary">âœ‚ï¸ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ù„ÙŠØ²Ø± (Ù‚Øµ)</button>
              <button id="btnLaserDownload" class="secondary">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠØ²Ø±</button>
            </div>
          </div>
        </div>

        <!-- 3D Printer Settings -->
        <div id="threedSettings" class="machine-settings" style="display:none;">
          <h4 class="threed-specific">ğŸ§Š Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</h4>
          
          <label for="threedFileInput">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù 3D (STL, OBJ, etc.)</label>
          <input id="threedFileInput" type="file" accept=".stl,.obj,.3ds,.dae,.ply" style="margin-bottom:12px"/>
          
          <label for="threedWorkWidth">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
          <input id="threedWorkWidth" type="number" value="30" step="0.1" min="1" max="200"/>
          <div class="small-meta" id="threedWidthMm">300.0 Ù…Ù…</div>

          <label for="threedWorkHeight">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
          <input id="threedWorkHeight" type="number" value="20" step="0.1" min="1" max="200"/>
          <div class="small-meta" id="threedHeightMm">200.0 Ù…Ù…</div>

          <label for="threedWorkDepth">Ø¹Ù…Ù‚ Ø§Ù„Ø¹Ù…Ù„ (Ù…Ù…)</label>
          <input id="threedWorkDepth" type="number" value="10" step="0.1" min="0.1" max="100"/>
          <div class="small-meta" id="threedDepthMm">10.0 Ù…Ù…</div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label for="threedOriginX">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ X (Ø³Ù…)</label>
              <input id="threedOriginX" type="number" value="0" step="0.1"/>
            </div>
            <div>
              <label for="threedOriginY">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ Y (Ø³Ù…)</label>
              <input id="threedOriginY" type="number" value="0" step="0.1"/>
            </div>
          </div>
          <div style="margin-top:6px"><button id="btnThreedCenterOrigin" class="secondary">ğŸ¯ ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„</button></div>

          <hr style="border-color:#10b981;margin:12px 0"/>

          <label for="threedLayerHeight">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø·Ø¨Ù‚Ø© (Ù…Ù…)</label>
          <input id="threedLayerHeight" type="number" value="0.2" step="0.05" min="0.05" max="1.0"/>

          <label for="threedFillDensity">ÙƒØ«Ø§ÙØ© Ø§Ù„Ø­Ø´Ùˆ (%)</label>
          <input id="threedFillDensity" type="number" value="20" step="5" min="0" max="100"/>

          <label for="threedPrintSpeed">Ø³Ø±Ø¹Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ù…Ù…/Ø«)</label>
          <input id="threedPrintSpeed" type="number" value="50" step="5" min="10" max="200"/>

          <label for="threedInfillPattern">Ù†Ù…Ø· Ø§Ù„Ø­Ø´Ùˆ</label>
          <select id="threedInfillPattern">
            <option value="rectilinear">Rectilinear</option>
            <option value="grid">Grid</option>
            <option value="triangles">Triangles</option>
            <option value="honeycomb">Honeycomb</option>
          </select>

          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <label style="font-weight:normal;">
              <input id="threedSupport" type="checkbox" /> 
              Ø¯Ø¹Ù… (Support)
            </label>
            <div style="flex:1"></div>
            <label style="font-weight:normal;">
              <input id="threedRaft" type="checkbox" /> 
              Ø±Ø§ÙØ¯Ø© (Raft)
            </label>
          </div>

          <!-- 3D Buttons -->
          <div class="button-group">
            <div class="button-row">
              <button id="btnSliceModel" class="primary" style="background:#10b981;">âš¡ ØªÙˆÙ„ÙŠØ¯ G-code (3D)</button>
              <button id="btnPreviewLayers" class="secondary">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø·Ø¨Ù‚Ø§Øª</button>
            </div>
            <button id="btnDownload3D" class="secondary">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ G-code 3D</button>
          </div>
        </div>

        <div id="estTime" style="margin-top:12px;color:#9bb0c8;text-align:center;padding:8px;background:#0f172a;border-radius:6px"></div>

        <label for="gcodeOut" style="margin-top:12px">ğŸ“„ Ù…Ø®Ø±Ø¬Ø§Øª G-code</label>
        <textarea id="gcodeOut" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± G-code Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯..." style="height:180px;background:#021024;color:#cfeaf2;border-radius:8px;padding:10px;"></textarea>

      </div>
    </div>
  </div>

  <!-- Progress Overlay -->
  <div class="progress-overlay" id="progressOverlay">
    <div class="progress-spinner"></div>
    <div class="progress-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
  </div>

  <!-- Debug Overlay -->
  <div id="debugOverlay" aria-live="polite" role="status">
    <div id="debugHeader">
      <div><b>Debug</b> â€” Console</div>
      <div id="debugControls">
        <button id="dbgToggleSize" class="dbg-btn" title="ØªØµØºÙŠØ±/ØªÙƒØ¨ÙŠØ±">ğŸ”½</button>
        <button id="dbgCopy" class="dbg-btn" title="Ù†Ø³Ø® Ø§Ù„Ø³Ø¬Ù„">ğŸ“‹ Ù†Ø³Ø®</button>
        <button id="dbgClear" class="dbg-btn" title="Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„">ğŸ§¹ Ù…Ø³Ø­</button>
      </div>
    </div>
    <div id="debugList"></div>
    <div id="debugFooter">
      <div id="debugSummary">0 Ø³Ø¬Ù„Ø§Øª</div>
      <div style="flex:1"></div>
      <div style="font-size:12px;color:#9bb0c8">Ø§Ù†Ù‚Ø± Ø§Ù„ØªØµØºÙŠØ± Ù„Ø­ÙØ¸ Ø§Ù„Ø´Ø§Ø´Ø©</div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // ================= Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© =================
    let cvReady = false;
    let grayMat = null;
    let contour = null;
    let previewCanvas = null;
    let additionalContours = []; // {contour, area}
    let lastScanDir = 'x';
    let lastGeneratedGcode = '';
    let isProcessing = false;

    // colormap current
    let currentColormap = 'jet';
    let edgeSensitivityTimer = null;

    // Simulation / Three
    let scene, camera, renderer, controls;
    let simulation = { 
      isPlaying: false, 
      animationFrame: null, 
      tool: null, 
      toolPath: null, 
      pathPoints: [], 
      index: 0, 
      speed: 1,
      elapsedTime: 0
    };

    // ================= Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ =================
    let threeDModel = null;
    let threeDScene = null;
    let threeDRenderer = null;
    let threeDCamera = null;
    let threeDControls = null;

    // ================= Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† =================
    class TaskManager {
      constructor() {
        this.queue = [];
        this.isRunning = false;
        this.currentTask = null;
      }

      async addTask(taskFn, description = 'Ù…Ù‡Ù…Ø©') {
        return new Promise((resolve, reject) => {
          this.queue.push({ taskFn, description, resolve, reject });
          if (!this.isRunning) {
            this.processQueue();
          }
        });
      }

      async processQueue() {
        if (this.queue.length === 0) {
          this.isRunning = false;
          return;
        }

        this.isRunning = true;
        const task = this.queue.shift();
        this.currentTask = task;

        try {
          showProgress(task.description);
          const result = await task.taskFn();
          task.resolve(result);
        } catch (error) {
          console.error(`ÙØ´Ù„ ÙÙŠ ${task.description}:`, error);
          showToast(`ÙØ´Ù„ ÙÙŠ ${task.description}: ${error.message}`, 5000);
          task.reject(error);
        } finally {
          this.currentTask = null;
          hideProgress();
          // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªØ§Ù„ÙŠ Ø¨Ø¹Ø¯ ÙØªØ±Ø© Ø±Ø§Ø­Ø©
          setTimeout(() => this.processQueue(), 50);
        }
      }

      clear() {
        this.queue = [];
        this.isRunning = false;
        this.currentTask = null;
      }

      getQueueLength() {
        return this.queue.length;
      }
    }

    const taskManager = new TaskManager();

    // ================= Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø¯Ù… =================
    function showProgress(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...') {
      try {
        document.getElementById('progressText').textContent = message;
        document.getElementById('progressOverlay').style.display = 'flex';
      } catch (error) {
        console.warn('ÙØ´Ù„ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù…:', error);
      }
    }

    function hideProgress() {
      try {
        document.getElementById('progressOverlay').style.display = 'none';
      } catch (error) {
        console.warn('ÙØ´Ù„ ÙÙŠ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ‚Ø¯Ù…:', error);
      }
    }

    // ================= Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø© Ø§Ù„Ù…Ø­Ø³Ù† =================
    class InputValidator {
      static validateNumberInput(inputId, min, max, defaultValue = min) {
        try {
          const input = document.getElementById(inputId);
          if (!input) {
            throw new Error(`Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ${inputId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
          }
          
          let value = parseFloat(input.value);
          
          if (isNaN(value)) {
            showToast(`Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ ${inputId} ØºÙŠØ± ØµØ§Ù„Ø­Ø©`);
            input.value = defaultValue;
            return defaultValue;
          }
          
          if (value < min) {
            showToast(`Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ ${inputId} Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (${min})`);
            input.value = min;
            return min;
          }
          
          if (value > max) {
            showToast(`Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ ${inputId} Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (${max})`);
            input.value = max;
            return max;
          }
          
          return value;
        } catch (error) {
          console.error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ${inputId}:`, error);
          return defaultValue;
        }
      }

      static validateImageSize(canvas) {
        if (!canvas) return false;
        
        const maxPixels = 2000000; // 2MP Ù„Ù„Ø­Ø¯ Ù…Ù† Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        const currentPixels = canvas.width * canvas.height;
        
        if (currentPixels > maxPixels) {
          const ratio = Math.sqrt(maxPixels / currentPixels);
          const newWidth = Math.floor(canvas.width * ratio);
          const newHeight = Math.floor(canvas.height * ratio);
          
          const tempCanvas = document.createElement('canvas');
          const tempCtx = tempCanvas.getContext('2d');
          tempCanvas.width = newWidth;
          tempCanvas.height = newHeight;
          tempCtx.drawImage(canvas, 0, 0, newWidth, newHeight);
          
          const ctx = canvas.getContext('2d');
          canvas.width = newWidth;
          canvas.height = newHeight;
          ctx.drawImage(tempCanvas, 0, 0);
          
          showToast('ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£ÙØ¶Ù„');
          return true;
        }
        return false;
      }

      static validateLaserSettings() {
        const power = this.validateNumberInput('laserPower', 0, 100, 80);
        const speed = this.validateNumberInput('laserSpeed', 100, 10000, 2000);
        const passes = this.validateNumberInput('laserPasses', 1, 10, 1);
        
        return { power, speed, passes };
      }

      static validateRouterSettings() {
        const feedRate = this.validateNumberInput('feedRate', 10, 5000, 800);
        const safeZ = this.validateNumberInput('safeZ', 0, 100, 5);
        const maxDepth = this.validateNumberInput('maxDepth', 0.1, 50, 3);
        const stepOver = this.validateNumberInput('stepOver', 0.1, 50, 5);
        
        return { feedRate, safeZ, maxDepth, stepOver };
      }

      static validate3DSettings() {
        const layerHeight = this.validateNumberInput('threedLayerHeight', 0.05, 1.0, 0.2);
        const fillDensity = this.validateNumberInput('threedFillDensity', 0, 100, 20);
        const printSpeed = this.validateNumberInput('threedPrintSpeed', 10, 200, 50);
        const workDepth = this.validateNumberInput('threedWorkDepth', 0.1, 100, 10);
        
        return { layerHeight, fillDensity, printSpeed, workDepth };
      }

      static validateAllInputs() {
        const errors = [];
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        const requiredInputs = [
          { id: 'workWidth', min: 1, max: 200 },
          { id: 'workHeight', min: 1, max: 200 },
          { id: 'laserWorkWidth', min: 1, max: 200 },
          { id: 'laserWorkHeight', min: 1, max: 200 },
          { id: 'threedWorkWidth', min: 1, max: 200 },
          { id: 'threedWorkHeight', min: 1, max: 200 }
        ];
        
        requiredInputs.forEach(input => {
          try {
            this.validateNumberInput(input.id, input.min, input.max);
          } catch (error) {
            errors.push(`Ø®Ø·Ø£ ÙÙŠ ${input.id}: ${error.message}`);
          }
        });
        
        return errors;
      }
    }

    // ================= Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ø³Ù† =================
    class MemoryManager {
      constructor() {
        this.mats = new Set();
        this.maxMats = 15;
        this.cleanupInterval = null;
        this.startAutoCleanup();
      }

      track(mat) {
        try {
          if (mat && !this.isMatDeleted(mat)) {
            this.mats.add(mat);
            if (this.mats.size > this.maxMats) {
              this.cleanupOldest();
            }
            this.updateMemoryIndicator();
          }
        } catch (error) {
          console.warn('ÙØ´Ù„ ÙÙŠ ØªØªØ¨Ø¹ Ø§Ù„Ù…ØµÙÙˆÙØ©:', error);
        }
      }

      isMatDeleted(mat) {
        try {
          return !mat || typeof mat.delete !== 'function';
        } catch {
          return true;
        }
      }

      cleanupOldest() {
        try {
          if (this.mats.size > 0) {
            const oldest = this.mats.values().next().value;
            this.safeDelete(oldest);
            this.mats.delete(oldest);
            this.updateMemoryIndicator();
          }
        } catch (error) {
          console.warn('ÙØ´Ù„ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø£Ù‚Ø¯Ù… Ù…ØµÙÙˆÙØ©:', error);
        }
      }

      safeDelete(mat) {
        try {
          if (!this.isMatDeleted(mat) && typeof mat.delete === 'function') {
            mat.delete();
          }
        } catch (error) {
          console.warn('ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¨Ø£Ù…Ø§Ù†:', error);
        }
      }

      cleanupAll() {
        try {
          this.mats.forEach(mat => this.safeDelete(mat));
          this.mats.clear();
          this.updateMemoryIndicator();
        } catch (error) {
          console.warn('ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ù…Ù„:', error);
        }
      }

      cleanupMats() {
        try {
          if (grayMat && !this.isMatDeleted(grayMat)) { 
            this.safeDelete(grayMat);
            grayMat = null; 
          }
        } catch (error) { 
          console.warn('ÙØ´Ù„ ÙÙŠ ØªÙ†Ø¸ÙŠÙ grayMat:', error); 
        }
        
        try {
          if (contour && !this.isMatDeleted(contour) && typeof contour.delete === 'function') {
            this.safeDelete(contour);
            contour = null;
          }
        } catch (error) { 
          console.warn('ÙØ´Ù„ ÙÙŠ ØªÙ†Ø¸ÙŠÙ contour:', error); 
        }
        
        try {
          additionalContours.forEach(item => {
            if (item && item.contour && !this.isMatDeleted(item.contour)) {
              this.safeDelete(item.contour);
            }
          });
          additionalContours = [];
        } catch (error) { 
          console.warn('ÙØ´Ù„ ÙÙŠ ØªÙ†Ø¸ÙŠÙ additionalContours:', error); 
        }
        
        this.updateMemoryIndicator();
      }

      getMemoryUsage() {
        return this.mats.size;
      }

      updateMemoryIndicator() {
        try {
          const indicator = document.getElementById('memoryIndicator');
          if (indicator) {
            indicator.textContent = `Ø°Ø§ÙƒØ±Ø©: ${this.mats.size} Ù…Ø§Øª`;
            
            // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            if (this.mats.size > 10) {
              indicator.style.background = 'rgba(255, 165, 0, 0.7)';
            } else if (this.mats.size > 5) {
              indicator.style.background = 'rgba(255, 255, 0, 0.7)';
            } else {
              indicator.style.background = 'rgba(0, 0, 0, 0.7)';
            }
          }
        } catch (error) {
          console.warn('ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ø°Ø§ÙƒØ±Ø©:', error);
        }
      }

      startAutoCleanup() {
        if (this.cleanupInterval) {
          clearInterval(this.cleanupInterval);
        }
        
        this.cleanupInterval = setInterval(() => {
          const enableCleanup = document.getElementById('enableMemoryCleanup');
          if (enableCleanup && enableCleanup.checked && this.mats.size > 8) {
            this.cleanupOldest();
            console.log('Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø°Ø§ÙƒØ±Ø© ØªÙ… ØªÙ†ÙÙŠØ°Ù‡');
          }
        }, 30000); // ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
      }

      stopAutoCleanup() {
        if (this.cleanupInterval) {
          clearInterval(this.cleanupInterval);
          this.cleanupInterval = null;
        }
      }
    }

    const memoryManager = new MemoryManager();

    // ================= Ù†Ø¸Ø§Ù… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =================
    class SettingsManager {
      constructor() {
        this.storageKey = 'cnc_ai_settings';
      }

      saveSettings() {
        try {
          const settings = {
            machineCategory: document.getElementById('machineCategory').value,
            router: {
              workWidth: document.getElementById('workWidth').value,
              workHeight: document.getElementById('workHeight').value,
              workDepth: document.getElementById('workDepth').value,
              originX: document.getElementById('originX').value,
              originY: document.getElementById('originY').value,
              feedRate: document.getElementById('feedRate').value,
              safeZ: document.getElementById('safeZ').value,
              scanDir: document.getElementById('scanDir').value,
              stepOver: document.getElementById('stepOver').value,
              maxDepth: document.getElementById('maxDepth').value,
              fixedZ: document.getElementById('fixedZ').checked,
              fixedZValue: document.getElementById('fixedZValue').value,
              invertZ: document.getElementById('invertZ').checked,
              woodColor: document.getElementById('woodColor').value
            },
            laser: {
              workWidth: document.getElementById('laserWorkWidth').value,
              workHeight: document.getElementById('laserWorkHeight').value,
              originX: document.getElementById('laserOriginX').value,
              originY: document.getElementById('laserOriginY').value,
              edgeMode: document.getElementById('laserEdgeMode').value,
              detail: document.getElementById('laserDetail').value,
              power: document.getElementById('laserPower').value,
              mode: document.getElementById('laserMode').value,
              speed: document.getElementById('laserSpeed').value,
              passes: document.getElementById('laserPasses').value,
              dynamic: document.getElementById('laserDynamic').checked,
              airAssist: document.getElementById('laserAirAssist').checked
            },
            threed: {
              workWidth: document.getElementById('threedWorkWidth').value,
              workHeight: document.getElementById('threedWorkHeight').value,
              workDepth: document.getElementById('threedWorkDepth').value,
              originX: document.getElementById('threedOriginX').value,
              originY: document.getElementById('threedOriginY').value,
              layerHeight: document.getElementById('threedLayerHeight').value,
              fillDensity: document.getElementById('threedFillDensity').value,
              printSpeed: document.getElementById('threedPrintSpeed').value,
              infillPattern: document.getElementById('threedInfillPattern').value,
              support: document.getElementById('threedSupport').checked,
              raft: document.getElementById('threedRaft').checked
            },
            performance: {
              memoryCleanup: document.getElementById('enableMemoryCleanup').checked,
              simplifiedSimulation: document.getElementById('enableSimplifiedSimulation').checked
            },
            colormap: currentColormap,
            timestamp: new Date().toISOString()
          };

          localStorage.setItem(this.storageKey, JSON.stringify(settings));
          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          return true;
        } catch (error) {
          console.error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
          showToast('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
          return false;
        }
      }

      loadSettings() {
        try {
          const saved = localStorage.getItem(this.storageKey);
          if (!saved) {
            showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©');
            return false;
          }

          const settings = JSON.parse(saved);
          
          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
          if (settings.machineCategory) {
            document.getElementById('machineCategory').value = settings.machineCategory;
            document.getElementById('machineCategory').dispatchEvent(new Event('change'));
          }

          // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø§ÙˆØªØ±
          if (settings.router) {
            this.applySettingsToElements(settings.router, 'router');
          }

          // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ÙŠØ²Ø±
          if (settings.laser) {
            this.applySettingsToElements(settings.laser, 'laser');
          }

          // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
          if (settings.threed) {
            this.applySettingsToElements(settings.threed, 'threed');
          }

          // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
          if (settings.performance) {
            document.getElementById('enableMemoryCleanup').checked = settings.performance.memoryCleanup;
            document.getElementById('enableSimplifiedSimulation').checked = settings.performance.simplifiedSimulation;
          }

          // ØªØ­Ù…ÙŠÙ„ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù†
          if (settings.colormap) {
            currentColormap = settings.colormap;
            document.querySelectorAll('#colormapButtons button').forEach(btn => {
              btn.classList.toggle('active', btn.dataset.map === settings.colormap);
            });
          }

          showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          return true;
        } catch (error) {
          console.error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:', error);
          showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
          return false;
        }
      }

      applySettingsToElements(settings, prefix) {
        Object.keys(settings).forEach(key => {
          const elementId = prefix === 'router' ? key : `${prefix}${key.charAt(0).toUpperCase() + key.slice(1)}`;
          const element = document.getElementById(elementId);
          
          if (element) {
            if (element.type === 'checkbox') {
              element.checked = settings[key];
            } else {
              element.value = settings[key];
            }
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            if (element.type === 'range' || element.tagName === 'SELECT') {
              element.dispatchEvent(new Event('input'));
            }
          }
        });
      }

      exportSettings() {
        const settings = localStorage.getItem(this.storageKey);
        if (!settings) {
          showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§');
          return;
        }

        const blob = new Blob([settings], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'cnc_ai_settings.json';
        a.click();
        URL.revokeObjectURL(url);
        showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
      }

      importSettings(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const settings = JSON.parse(e.target.result);
            localStorage.setItem(this.storageKey, JSON.stringify(settings));
            this.loadSettings();
            showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
          } catch (error) {
            showToast('Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­');
          }
        };
        reader.readAsText(file);
      }
    }

    const settingsManager = new SettingsManager();

    // ================= Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª =================
    function handleOpenCVError() {
      const cvState = document.getElementById('cvState');
      if (cvState) {
        cvState.innerHTML = 'âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ OpenCV';
      }
      showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ OpenCV. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 5000);
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ù…ØµØ¯Ø± Ø¨Ø¯ÙŠÙ„
      setTimeout(() => {
        const fallbackScript = document.createElement('script');
        fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/opencv.js/4.8.0/opencv.js';
        fallbackScript.onerror = () => showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ OpenCV Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø¨Ø¯ÙŠÙ„', 5000);
        document.head.appendChild(fallbackScript);
      }, 2000);
    }

    function handleThreeJSError() {
      showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Three.js. Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„', 5000);
    }

    // ================= ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© =================
    function optimizedParseGcodeForSimulation(gcode) {
      if (!gcode || gcode.length === 0) return [];
      
      try {
        const lines = gcode.split('\n');
        const path = [];
        let pos = { x: 0, y: 0, z: 0 };
        let pointCount = 0;
        
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
        const enableSimplified = document.getElementById('enableSimplifiedSimulation');
        const maxPoints = enableSimplified && enableSimplified.checked ? 800 : 1500;
        const samplingRate = enableSimplified && enableSimplified.checked ? 15 : 8;
        
        for (let line of lines) {
          if (pointCount >= maxPoints) {
            showToast('ØªÙ… ØªØ¨Ø³ÙŠØ· Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£ÙØ¶Ù„');
            break;
          }
          
          line = line.trim();
          if (!line || line.startsWith(';')) continue;
          
          if (line.startsWith('G0') || line.startsWith('G1')) {
            const xm = line.match(/X([-\d.]+)/i);
            const ym = line.match(/Y([-\d.]+)/i);
            const zm = line.match(/Z([-\d.]+)/i);
            
            if (xm) pos.x = parseFloat(xm[1]) || pos.x;
            if (ym) pos.y = parseFloat(ym[1]) || pos.y;
            if (zm) pos.z = parseFloat(zm[1]) || pos.z;
            
            // Ø£Ø®Ø° Ø¹ÙŠÙ†Ø§Øª Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡
            if (pointCount % samplingRate === 0) {
              path.push({ x: pos.x, y: pos.y, z: pos.z });
            }
            pointCount++;
          }
        }
        
        console.log(`ØªÙ… ØªØ­Ù„ÙŠÙ„ ${path.length} Ù†Ù‚Ø·Ø© Ù…Ù† Ø£ØµÙ„ ${pointCount} Ù†Ù‚Ø·Ø©`);
        return path;
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ G-code Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©:', error);
        return [];
      }
    }

    // ================= ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­Ø³Ù†Ø© =================
    function optimizePerformance() {
      try {
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        memoryManager.cleanupAll();
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
        cleanupSimulation();
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
        document.getElementById('enableMemoryCleanup').checked = true;
        document.getElementById('enableSimplifiedSimulation').checked = true;
        
        showToast('ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (previewCanvas && cvReady) {
          const machineType = document.getElementById('machineCategory').value;
          if (machineType === 'laser') {
            taskManager.addTask(detectLaserContours, 'Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø³ÙŠÙ†');
          } else if (machineType === 'router') {
            taskManager.addTask(detectContours, 'Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø³ÙŠÙ†');
          }
        }
      } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡:', error);
        showToast('ÙØ´Ù„ ÙÙŠ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡');
      }
    }

    // ================= Debug overlay system =================
    (function initDebugOverlay(){
      try {
        const debugList = document.getElementById('debugList');
        const dbgClear = document.getElementById('dbgClear');
        const dbgCopy = document.getElementById('dbgCopy');
        const dbgToggleSize = document.getElementById('dbgToggleSize');
        const debugOverlay = document.getElementById('debugOverlay');
        const debugSummary = document.getElementById('debugSummary');
        const logs = [];

        function formatTime(d) { 
          try {
            return d.toISOString().slice(11, 23);
          } catch {
            return '--:--:--';
          }
        }
        
        function updateSummary() { 
          debugSummary.textContent = logs.length + ' Ø³Ø¬Ù„Ø§Øª'; 
        }

        function addEntry(type, message, stack) {
          try {
            const time = new Date();
            const entry = { time, type, message, stack };
            logs.push(entry);
            updateSummary();

            const div = document.createElement('div');
            div.className = 'dbg-item ' + (type === 'error' ? 'dbg-error' : (type === 'warn' ? 'dbg-warn' : 'dbg-info'));
            const tspan = document.createElement('span');
            tspan.className = 'dbg-time';
            tspan.textContent = `[${formatTime(time)}] ${type.toUpperCase()}`;
            const msg = document.createElement('div');
            msg.textContent = String(message).substring(0, 500);
            div.appendChild(tspan);
            div.appendChild(msg);
            if (stack && type !== 'info') {
              const meta = document.createElement('div');
              meta.className = 'dbg-meta';
              meta.textContent = String(stack).split('\n').slice(0,2).join(' | ');
              div.appendChild(meta);
            }
            debugList.prepend(div);

            if (logs.length > 100) {
              const oldLog = logs.shift();
              if (debugList.lastChild) {
                debugList.removeChild(debugList.lastChild);
              }
            }
          } catch (e) {
            console.error('ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØªØµØ­ÙŠØ­:', e);
          }
        }

        dbgClear.addEventListener('click', () => {
          try {
            debugList.innerHTML = '';
            logs.length = 0;
            updateSummary();
          } catch (e) {
            console.error('ÙØ´Ù„ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', e);
          }
        });

        dbgCopy.addEventListener('click', async () => {
          try {
            const text = logs.map(l => `[${l.time.toISOString()}] ${l.type.toUpperCase()}: ${l.message}\n${l.stack||''}`).join('\n\n');
            await navigator.clipboard.writeText(text);
            addEntry('info', 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø³Ø¬Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©');
          } catch (e) {
            addEntry('error', 'ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø³Ø¬Ù„: ' + (e.message || e));
          }
        });

        dbgToggleSize.addEventListener('click', (ev) => {
          try {
            ev.stopPropagation();
            debugOverlay.classList.toggle('minimized');
            dbgToggleSize.textContent = debugOverlay.classList.contains('minimized') ? 'ğŸ”¼' : 'ğŸ”½';
          } catch (e) {
            console.error('ÙØ´Ù„ ÙÙŠ ØªØ¨Ø¯ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„ØªØµØ­ÙŠØ­:', e);
          }
        });

        debugOverlay.addEventListener('click', (ev) => {
          try {
            if (debugOverlay.classList.contains('minimized')) {
              debugOverlay.classList.remove('minimized');
              dbgToggleSize.textContent = 'ğŸ”½';
            }
          } catch (e) {
            console.error('ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø¬Ù… Ø§Ù„ØªØµØ­ÙŠØ­:', e);
          }
        });

        // override console methods
        const _log = console.log, _warn = console.warn, _error = console.error;
        console.log = function(...args) {
          try { 
            addEntry('info', args.map(a=> {
              if (typeof a === 'object') {
                try { return JSON.stringify(a); } catch { return String(a); }
              }
              return String(a);
            }).join(' ')); 
          } catch(e){}
          _log.apply(console, args);
        };
        
        console.warn = function(...args) {
          try { 
            addEntry('warn', args.map(a=> {
              if (typeof a === 'object') {
                try { return JSON.stringify(a); } catch { return String(a); }
              }
              return String(a);
            }).join(' '), new Error().stack); 
          } catch(e){}
          _warn.apply(console, args);
        };
        
        console.error = function(...args) {
          try { 
            addEntry('error', args.map(a=> {
              if (typeof a === 'object') {
                try { return JSON.stringify(a); } catch { return String(a); }
              }
              return String(a);
            }).join(' '), new Error().stack); 
          } catch(e){}
          _error.apply(console, args);
        };

        window.addEventListener('error', function(ev){
          try { 
            addEntry('error', 
              (ev.message || 'Unknown error') + ' (' + (ev.filename || 'unknown') + ':' + (ev.lineno || 'unknown') + ')', 
              ev.error && ev.error.stack ? ev.error.stack : ''
            ); 
          } catch(e){}
        });

        window.addEventListener('unhandledrejection', function(ev){
          try { 
            addEntry('error', 
              'UnhandledRejection: ' + (ev.reason && ev.reason.message ? ev.reason.message : String(ev.reason || 'Unknown reason')), 
              ev.reason && ev.reason.stack ? ev.reason.stack : ''
            ); 
          } catch(e){}
        });

        addEntry('info', 'ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµØ­ÙŠØ­');

      } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµØ­ÙŠØ­:', error);
      }
    })();

    // ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø¹ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ parseGcodeForSimulation Ø¨Ù€ optimizedParseGcodeForSimulation)

    // ================= ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø³Ù† =================
    function initApp() {
      try {
        updateDimensionDisplay();
        showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­', 1200);
        
        // ØªÙ‡ÙŠØ¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
        initTabs();
        initMachineCategory();
        initControlElements();
        initFileInput();
        initFileFormatButtons();
        initButtons();
        initColormapButtons();
        
        // Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø¬Ø¯ÙŠØ¯Ø©
        document.getElementById('btnSaveSettings').addEventListener('click', () => {
          settingsManager.saveSettings();
        });
        
        document.getElementById('btnLoadSettings').addEventListener('click', () => {
          settingsManager.loadSettings();
        });
        
        document.getElementById('btnOptimizePerformance').addEventListener('click', () => {
          optimizePerformance();
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        setTimeout(() => {
          settingsManager.loadSettings();
        }, 1000);

        // ... (Ø¨Ù‚ÙŠØ© ÙƒÙˆØ¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©)

        console.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­');

      } catch (error) {
        console.error('ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
        showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 5000);
      }
    }

    // ... (Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯)

    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª parseGcodeForSimulation Ø¨Ù€ optimizedParseGcodeForSimulation
    // ÙÙŠ Ø¯ÙˆØ§Ù„ renderTopViewFromGcode Ùˆ initSimulation

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯Ù…Ø§ ÙŠØµØ¨Ø­ DOM Ø¬Ø§Ù‡Ø²Ø§Ù‹
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }

  </script>
</body>
</html>
