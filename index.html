<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNC AI - النسخة المتطورة مع Top View</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    
    header {
      background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }
    
    header h1 {
      margin-bottom: 10px;
      font-size: 28px;
    }
    
    header p {
      opacity: 0.9;
    }
    
    .main-content {
      display: flex;
      flex-wrap: wrap;
      padding: 20px;
      gap: 20px;
    }
    
    .panel {
      flex: 1;
      min-width: 300px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }
    
    .panel h2 {
      color: #2c3e50;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eaeaea;
    }
    
    .upload-area {
      border: 2px dashed #4a6491;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .upload-area:hover {
      background-color: #f0f4f8;
    }
    
    .upload-area p {
      margin-top: 10px;
      color: #666;
    }
    
    .btn {
      display: inline-block;
      background: #4a6491;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
      margin: 5px;
    }
    
    .btn:hover {
      background: #2c3e50;
    }
    
    .btn-secondary {
      background: #7f8c8d;
    }
    
    .btn-secondary:hover {
      background: #636e72;
    }
    
    .preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 20px;
    }
    
    .preview-box {
      flex: 1;
      min-width: 250px;
      border: 1px solid #eaeaea;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .preview-box h3 {
      background: #f5f7fa;
      padding: 10px;
      margin: 0;
      font-size: 16px;
      text-align: center;
    }
    
    .preview-content {
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fafafa;
    }
    
    canvas {
      max-width: 100%;
      max-height: 100%;
    }
    
    .controls {
      margin-top: 15px;
    }
    
    .control-group {
      margin-bottom: 15px;
    }
    
    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .control-group input[type="range"] {
      width: 100%;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid #eaeaea;
      margin-bottom: 15px;
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      border-bottom: 3px solid #4a6491;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .progress-container {
      margin-top: 15px;
      background: #f0f0f0;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 20px;
      background: linear-gradient(90deg, #4a6491 0%, #2c3e50 100%);
      width: 0%;
      transition: width 0.3s;
      text-align: center;
      color: white;
      line-height: 20px;
      font-size: 12px;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      background: #2c3e50;
      color: white;
      border-radius: 5px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s;
      z-index: 1000;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.error {
      background: #e74c3c;
    }
    
    .notification.success {
      background: #2ecc71;
    }
    
    @media (max-width: 768px) {
      .main-content {
        flex-direction: column;
      }
      
      .panel {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>CNC AI - النسخة المتطورة مع Top View</h1>
      <p>تحويل الصور إلى نماذج ثلاثية الأبعاد ورمز آلة CNC</p>
    </header>
    
    <div class="main-content">
      <div class="panel">
        <h2>تحميل الصورة</h2>
        <div class="upload-area" id="uploadArea">
          <input type="file" id="fileInput" accept="image/*" style="display: none;">
          <div class="btn">اختر صورة</div>
          <p>أو اسحب الصورة إلى هنا</p>
          <p id="fileName" style="margin-top: 10px; color: #4a6491; font-weight: bold;"></p>
        </div>
        
        <h2>معالجة الصورة</h2>
        <div class="controls">
          <div class="control-group">
            <label for="edgeThreshold">حد كشف الحواف: <span id="thresholdValue">128</span></label>
            <input type="range" id="edgeThreshold" min="1" max="255" value="128">
          </div>
          
          <button class="btn" onclick="detectEdges()">كشف الحواف</button>
          <button class="btn btn-secondary" onclick="applyEnhancement('brightness')">تحسين السطوع</button>
          <button class="btn btn-secondary" onclick="applyEnhancement('contrast')">تحسين التباين</button>
        </div>
        
        <div class="preview-container">
          <div class="preview-box">
            <h3>الصورة الأصلية</h3>
            <div class="preview-content">
              <canvas id="preview2d"></canvas>
            </div>
          </div>
          
          <div class="preview-box">
            <h3>خريطة الحرارة</h3>
            <div class="preview-content">
              <canvas id="heatmap"></canvas>
            </div>
          </div>
          
          <div class="preview-box">
            <h3>كشف الحواف</h3>
            <div class="preview-content">
              <canvas id="edgesPreview"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <div class="panel">
        <h2>المعاينة ثلاثية الأبعاد</h2>
        <div class="controls">
          <div class="control-group">
            <label for="rotationSpeed">سرعة الدوران: <span id="speedValue">0.01</span></label>
            <input type="range" id="rotationSpeed" min="0" max="20" value="1" step="0.1">
          </div>
          
          <div class="control-group">
            <label for="heightIntensity">شدة الارتفاع: <span id="intensityValue">80</span></label>
            <input type="range" id="heightIntensity" min="10" max="200" value="80">
          </div>
        </div>
        
        <div class="preview-container">
          <div class="preview-box" style="min-width: 100%;">
            <h3>النموذج ثلاثي الأبعاد</h3>
            <div class="preview-content" style="height: 300px; position: relative;">
              <div id="preview3d"></div>
              <div id="loading3d" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                جاري تحميل المعاينة...
              </div>
            </div>
          </div>
        </div>
        
        <h2>توليد G-code</h2>
        <div class="controls">
          <button class="btn" onclick="generateGcode()">توليد G-code</button>
          <button class="btn btn-secondary" onclick="downloadGcode()">تحميل G-code</button>
        </div>
        
        <div class="preview-container">
          <div class="preview-box" style="min-width: 100%;">
            <h3>رمز G-code</h3>
            <div class="preview-content" style="height: 200px; overflow: auto;">
              <pre id="gcodeOutput" style="padding: 10px; text-align: left;">سيظهر رمز G-code هنا بعد التوليد</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="notification" class="notification">رسالة</div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
  <script>
    // إنشاء Web Worker للمهام الثقيلة
    const createWorker = (workerFunc) => {
      const blob = new Blob(['(' + workerFunc.toString() + ')()'], { type: 'application/javascript' });
      return new Worker(URL.createObjectURL(blob));
    };

    // عامل معالجة الصور
    const imageProcessingWorker = createWorker(() => {
      self.onmessage = function(e) {
        const { imageData, type, threshold } = e.data;
        const data = new Uint8ClampedArray(imageData.data);
        const width = imageData.width;
        const height = imageData.height;

        if (type === 'edges') {
          // تطبيق مرشح كشف الحواف (Sobel)
          const tempData = new Uint8ClampedArray(data);
          for (let y = 1; y < height - 1; y++) {
            for (let x = 1; x < width - 1; x++) {
              for (let c = 0; c < 3; c++) {
                const idx = (y * width + x) * 4 + c;
                
                // مرشح Sobel للأفقية
                let gx = 
                  -1 * tempData[((y-1)*width + (x-1))*4 + c] +
                  -2 * tempData[((y)*width + (x-1))*4 + c] +
                  -1 * tempData[((y+1)*width + (x-1))*4 + c] +
                  1 * tempData[((y-1)*width + (x+1))*4 + c] +
                  2 * tempData[((y)*width + (x+1))*4 + c] +
                  1 * tempData[((y+1)*width + (x+1))*4 + c];
                
                // مرشح Sobel للرأسية
                let gy = 
                  -1 * tempData[((y-1)*width + (x-1))*4 + c] +
                  -2 * tempData[((y-1)*width + (x))*4 + c] +
                  -1 * tempData[((y-1)*width + (x+1))*4 + c] +
                  1 * tempData[((y+1)*width + (x-1))*4 + c] +
                  2 * tempData[((y+1)*width + (x))*4 + c] +
                  1 * tempData[((y+1)*width + (x+1))*4 + c];
                
                // حساب القوة
                const magnitude = Math.min(255, Math.sqrt(gx*gx + gy*gy));
                
                // تطبيق العتبة
                data[idx] = magnitude > threshold ? 255 : 0;
              }
              data[y*width*4 + x*4 + 3] = 255; // القناة alpha
            }
          }
        }

        self.postMessage({ processedData: data.buffer, width, height }, [data.buffer]);
      };
    });

    // عناصر DOM
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const uploadArea = document.getElementById('uploadArea');
    const canvas2d = document.getElementById('preview2d');
    const ctx2d = canvas2d.getContext('2d');
    const heatmap = document.getElementById('heatmap');
    const ctxHeat = heatmap.getContext('2d');
    const edgesPreview = document.getElementById('edgesPreview');
    const ctxEdges = edgesPreview.getContext('2d');
    const preview3d = document.getElementById('preview3d');
    const rotationSpeedInput = document.getElementById('rotationSpeed');
    const speedValue = document.getElementById('speedValue');
    const zoomControl = document.getElementById('zoomControl');
    const heightIntensity = document.getElementById('heightIntensity');
    const intensityValue = document.getElementById('intensityValue');
    const gcodeOutput = document.getElementById('gcodeOutput');
    const notification = document.getElementById('notification');
    const loading3d = document.getElementById('loading3d');
    const edgeThreshold = document.getElementById('edgeThreshold');
    const thresholdValue = document.getElementById('thresholdValue');

    // إعداد Three.js للمعاينة
    let scene, camera, renderer, mesh;
    let rotationSpeed = 0.01;
    let currentColormap = 'jet';
    let heightFactor = 80;
    let heightMapData = null;
    let originalImageData = null;
    let generatedGcode = '';
    let edgeData = null;
    let isPageVisible = true;

    // تهيئة Three.js
    function initThreeJS() {
      // إعداد المشهد
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xf0f0f0);
      
      // إعداد الكاميرا
      camera = new THREE.PerspectiveCamera(45, preview3d.offsetWidth / preview3d.offsetHeight, 0.1, 1000);
      camera.position.z = 200;
      
      // إعداد العارض
      renderer = new THREE.WebGLRenderer({ 
        antialias: true, 
        alpha: true,
        powerPreference: "high-performance"
      });
      renderer.setSize(preview3d.offsetWidth, preview3d.offsetHeight);
      preview3d.appendChild(renderer.domElement);
      
      // إضافة الإضاءة
      const ambientLight = new THREE.AmbientLight(0x404040, 1);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);
      
      const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
      directionalLight2.position.set(-1, -1, -1);
      scene.add(directionalLight2);
    }

    // التحقق من رؤية الصفحة لتحسين الأداء
    document.addEventListener('visibilitychange', () => {
      isPageVisible = !document.hidden;
    });

    // تحسين أداء الرسوم المتحركة
    const animate = () => {
      if (!isPageVisible) {
        requestAnimationFrame(animate);
        return;
      }

      if (mesh) mesh.rotation.y += rotationSpeed;
      if (renderer) renderer.render(scene, camera);
      
      requestAnimationFrame(animate);
    };

    // تحسين إدارة الذاكرة
    const disposeThreeObjects = () => {
      if (!scene) return;
      
      while(scene.children.length > 0) {
        const object = scene.children[0];
        if (object.geometry) object.geometry.dispose();
        if (object.material) {
          if (Array.isArray(object.material)) {
            object.material.forEach(material => material.dispose());
          } else {
            object.material.dispose();
          }
        }
        scene.remove(object);
      }
    };

    // إظهار الإشعارات
    function showNotification(message, isError = false) {
      notification.textContent = message;
      notification.className = 'notification';
      notification.classList.add(isError ? 'error' : 'success');
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // تحديث شريط التقدم
    function updateProgress(percent, message = '') {
      // يمكن تنفيذ هذا لاحقًا عند إضافة شريط تقدم مفصل
      if (message) {
        console.log(`${message}: ${percent}%`);
      }
    }

    // تحميل الصورة وعرضها
    function handleImageUpload(file) {
      if (!file || !file.type.match('image.*')) {
        showNotification('يرجى تحميل صورة صالحة', true);
        return;
      }
      
      fileName.textContent = file.name;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          // ضبط حجم canvas لعرض الصورة
          canvas2d.width = img.width;
          canvas2d.height = img.height;
          heatmap.width = img.width;
          heatmap.height = img.height;
          edgesPreview.width = img.width;
          edgesPreview.height = img.height;
          
          // رسم الصورة على canvas
          ctx2d.drawImage(img, 0, 0, img.width, img.height);
          
          // حفظ بيانات الصورة الأصلية
          originalImageData = ctx2d.getImageData(0, 0, canvas2d.width, canvas2d.height);
          
          // إنشاء خريطة ارتفاع من الصورة
          createHeightMap(img);
          
          showNotification('تم تحميل الصورة بنجاح');
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // إنشاء خريطة ارتفاع من الصورة
    function createHeightMap(image) {
      const w = Math.min(image.width, 80);
      const h = Math.min(image.height, 80);
      
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = w; 
      tempCanvas.height = h;
      const tctx = tempCanvas.getContext('2d');
      tctx.drawImage(image, 0, 0, w, h);
      const imgData = tctx.getImageData(0, 0, w, h).data;

      // حفظ بيانات الارتفاع للاستخدام لاحقاً في توليد G-code
      heightMapData = {
        data: new Uint8Array(imgData),
        width: w,
        height: h
      };

      // إنشاء شكل ثلاثي الأبعاد
      create3DModel(imgData, w, h);
      
      // رسم خريطة الحرارة
      drawHeatmap(imgData, w, h);
    }

    // إنشاء نموذج ثلاثي الأبعاد
    function create3DModel(imgData, width, height) {
      loading3d.style.display = 'block';
      
      // استخدام setTimeout للسماح بواجهة المستخدم بالتحديث قبل البدء في المعالجة الثقيلة
      setTimeout(() => {
        disposeThreeObjects();
        
        const geometry = new THREE.PlaneGeometry(100, 100, width-1, height-1);
        const positions = geometry.attributes.position.array;
        let min = 255, max = 0;
        const colors = [];
        
        for (let i = 0; i < positions.length / 3; i++) {
          const x = i % width;
          const y = Math.floor(i / width);
          const idx = (y * width + x) * 4;
          const brightness = 0.34 * imgData[idx] + 0.5 * imgData[idx+1] + 0.16 * imgData[idx+2];
          min = Math.min(min, brightness);
          max = Math.max(max, brightness);
          positions[i * 3 + 2] = brightness / heightFactor;

          const norm = (brightness - min) / (max - min || 1);
          const color = getHeatColor(norm, currentColormap);
          colors.push(color.r/255, color.g/255, color.b/255);
        }
        
        geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
        geometry.computeVertexNormals();

        const material = new THREE.MeshLambertMaterial({ 
          vertexColors: true, 
          side: THREE.DoubleSide,
          wireframe: false
        });
        
        mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        loading3d.style.display = 'none';
      }, 100);
    }

    // رسم خريطة الحرارة
    function drawHeatmap(imgData, width, height) {
      let min = 255, max = 0;
      
      // حساب القيم الدنيا والقصوى
      for (let i = 0; i < imgData.length; i += 4) {
        const brightness = 0.34 * imgData[i] + 0.5 * imgData[i+1] + 0.16 * imgData[i+2];
        min = Math.min(min, brightness);
        max = Math.max(max, brightness);
      }
      
      // رسم خريطة الحرارة
      const imageData = ctxHeat.createImageData(width, height);
      
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          const idx = (y * width + x) * 4;
          const brightness = 0.34 * imgData[idx] + 0.5 * imgData[idx+1] + 0.16 * imgData[idx+2];
          const norm = (brightness - min) / (max - min || 1);
          const color = getHeatColor(norm, currentColormap);
          
          const destIdx = (y * width + x) * 4;
          imageData.data[destIdx] = color.r;
          imageData.data[destIdx+1] = color.g;
          imageData.data[destIdx+2] = color.b;
          imageData.data[destIdx+3] = 255;
        }
      }
      
      ctxHeat.putImageData(imageData, 0, 0);
    }

    // الحصول على لون خريطة الحرارة
    function getHeatColor(value, colormap) {
      let r, g, b;
      
      if (colormap === 'jet') {
        // خريطة ألوان Jet (الأزرق إلى الأحمر)
        const fourValue = 4 * value;
        r = Math.min(fourValue - 1.5, -fourValue + 4.5) * 255;
        g = Math.min(fourValue - 0.5, -fourValue + 3.5) * 255;
        b = Math.min(fourValue + 0.5, -fourValue + 2.5) * 255;
      } else {
        // خريطة ألوان افتراضية (رمادي)
        r = g = b = value * 255;
      }
      
      return {
        r: Math.max(0, Math.min(255, r)),
        g: Math.max(0, Math.min(255, g)),
        b: Math.max(0, Math.min(255, b))
      };
    }

    // تطبيق تحسينات على الصورة
    function applyEnhancement(type) {
      if (!originalImageData) {
        showNotification('يجب تحميل صورة أولاً', true);
        return;
      }

      const imageData = ctx2d.getImageData(0, 0, canvas2d.width, canvas2d.height);
      const data = imageData.data;

      switch(type) {
        case 'brightness':
          const brightnessFactor = 30;
          for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.min(255, data[i] + brightnessFactor);
            data[i+1] = Math.min(255, data[i+1] + brightnessFactor);
            data[i+2] = Math.min(255, data[i+2] + brightnessFactor);
          }
          break;
        case 'contrast':
          const contrastFactor = 1.2;
          const contrastOffset = 128 * (1 - contrastFactor);
          for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.min(255, Math.max(0, contrastFactor * data[i] + contrastOffset));
            data[i+1] = Math.min(255, Math.max(0, contrastFactor * data[i+1] + contrastOffset));
            data[i+2] = Math.min(255, Math.max(0, contrastFactor * data[i+2] + contrastOffset));
          }
          break;
      }

      ctx2d.putImageData(imageData, 0, 0);
      
      // إنشاء خريطة ارتفاع جديدة من الصورة المحسنة
      const img = new Image();
      img.onload = function() {
        createHeightMap(img);
      };
      img.src = canvas2d.toDataURL();
    }

    // كشف الحواف
    function detectEdges() {
      if (!originalImageData) {
        showNotification('يجب تحميل صورة أولاً', true);
        return;
      }

      updateProgress(10, 'جاري كشف الحدود...');
      
      // استخدام Web Worker لمعالجة الصورة في الخلفية
      imageProcessingWorker.postMessage({
        imageData: {
          data: originalImageData.data,
          width: originalImageData.width,
          height: originalImageData.height
        },
        type: 'edges',
        threshold: parseInt(edgeThreshold.value)
      });
    }

    // معالجة نتائج Web Worker
    imageProcessingWorker.onmessage = function(e) {
      const { processedData, width, height } = e.data;
      const data = new Uint8ClampedArray(processedData);
      
      const imageData = new ImageData(data, width, height);
      ctxEdges.clearRect(0, 0, edgesPreview.width, edgesPreview.height);
      edgesPreview.width = width;
      edgesPreview.height = height;
      ctxEdges.putImageData(imageData, 0, 0);
      
      // حفظ بيانات الحدود
      edgeData = imageData;
      
      updateProgress(100, 'تم كشف الحدود بنجاح');
      showNotification('تم كشف الحواف بنجاح');
    };

    // توليد G-code
    async function generateGcode() {
      if (!heightMapData) {
        showNotification('يجب تحميل صورة أولاً', true);
        return;
      }

      updateProgress(0, 'جاري توليد G-code...');
      
      try {
        // محاكاة عملية توليد G-code (يمكن استبدالها بالمنطق الفعلي)
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        generatedGcode = `; G-code generated by CNC AI
G21 ; Set units to millimeters
G90 ; Use absolute coordinates
G28 ; Home all axes
M3 S1000 ; Spindle on clockwise at 1000 RPM
G4 P2 ; Wait for spindle to reach speed

; Start cutting path
G0 Z5 ; Raise spindle
G0 X0 Y0 ; Move to start position

; Simulated cutting path based on image
G1 Z-1 F500 ; Lower spindle
G1 X10 Y10 F1000 ; Move to first point
G1 X20 Y20 ; Continue path
G1 X30 Y10
G1 X40 Y20
G1 X50 Y10

; Finish cutting
G0 Z5 ; Raise spindle
M5 ; Spindle off
G28 X0 Y0 ; Return to home
M30 ; End program`;

        gcodeOutput.textContent = generatedGcode;
        updateProgress(100, 'تم توليد G-code بنجاح');
        showNotification('تم توليد G-code بنجاح');
      } catch (error) {
        console.error('Error generating G-code:', error);
        showNotification('حدث خطأ أثناء توليد G-code', true);
      }
    }

    // تحميل G-code
    function downloadGcode() {
      if (!generatedGcode) {
        showNotification('لا يوجد G-code لتحميله', true);
        return;
      }
      
      const blob = new Blob([generatedGcode], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cnc-program.gcode';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification('تم تحميل G-code بنجاح');
    }

    // تهيئة التطبيق
    function initApp() {
      // تهيئة Three.js
      initThreeJS();
      animate();
      
      // إعداد مستمعات الأحداث
      uploadArea.addEventListener('click', () => {
        fileInput.click();
      });
      
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = '#e3eaf2';
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.backgroundColor = '';
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = '';
        
        if (e.dataTransfer.files.length) {
          handleImageUpload(e.dataTransfer.files[0]);
        }
      });
      
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
          handleImageUpload(fileInput.files[0]);
        }
      });
      
      rotationSpeedInput.addEventListener('input', () => {
        rotationSpeed = rotationSpeedInput.value / 100;
        speedValue.textContent = rotationSpeed.toFixed(2);
      });
      
      heightIntensity.addEventListener('input', () => {
        heightFactor = heightIntensity.value;
        intensityValue.textContent = heightFactor;
        
        if (originalImageData) {
          const img = new Image();
          img.onload = function() {
            createHeightMap(img);
          };
          img.src = canvas2d.toDataURL();
        }
      });
      
      edgeThreshold.addEventListener('input', () => {
        thresholdValue.textContent = edgeThreshold.value;
      });
    }

    // بدء التطبيق
    initApp();
  </script>
</body>
</html>
