<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>CNC AI â€” Multi Machine Raster Engraving</title>

    <!-- Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="https://docs.opencv.org/4.8.0/opencv.js" async></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

    <style>
        /* Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª */
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: Arial, Segoe UI, system-ui;
            background: #041022;
            color: #e6eef6;
            line-height: 1.5;
        }
        
        /* Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .app {
            max-width: 1400px;
            margin: 16px auto;
            padding: 14px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #1e293b;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 480px;
            gap: 16px;
        }
        
        @media (max-width: 1000px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
        @media (max-width: 768px) {
            .app {
                margin: 8px auto;
                padding: 8px;
            }
            
            .panel {
                padding: 12px;
            }
            
            .input-group {
                grid-template-columns: 1fr;
            }
            
            .settings-row {
                flex-direction: column;
            }
            
            #threeContainer {
                height: 300px;
            }
            
            header {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
        }
        
        /* Ø§Ù„Ù„ÙˆØ­Ø§Øª */
        .panel {
            background: #0b1320;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid #1e293b;
        }
        
        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #1e293b;
        }
        
        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tabs {
            display: flex;
            margin-top: 12px;
            border-bottom: 1px solid #1e293b;
        }
        
        .tabs button {
            margin-left: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            background: transparent;
            color: #9bb0c8;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .tabs button:hover {
            background: #1e293b;
        }
        
        .tabs button.active {
            background: #06b6d4;
            color: #021;
        }
        
        .tab-content {
            display: none;
            margin-top: 12px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±Ø¦ÙŠØ© */
        canvas {
            max-width: 100%;
            border-radius: 6px;
            background: #000;
            display: block;
            margin: 0 auto;
            border: 1px solid #334155;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            background: #021024;
            color: #cfeaf2;
            font-family: monospace;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #1e293b;
            resize: vertical;
        }
        
        #threeContainer {
            width: 100%;
            height: 400px;
            background: #081224;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .simulation-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            display: flex;
            gap: 8px;
        }
        
        .simulation-controls button {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid #06b6d4;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .simulation-controls button:hover {
            background: rgba(6, 182, 212, 0.3);
        }
        
        .simulation-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        /* Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        label {
            display: block;
            margin-top: 12px;
            color: #cfeaf2;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        input, select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #1e293b;
            background: #0f172a;
            color: #e6eef6;
            margin-top: 6px;
            font-size: 0.9rem;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #06b6d4;
        }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
        }
        
        button {
            background: #1e293b;
            color: #e6eef6;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
        }
        
        button:hover {
            background: #334155;
        }
        
        button.primary {
            background: #06b6d4;
            color: #021;
            font-weight: bold;
        }
        
        button.primary:hover {
            background: #0ea5e9;
        }
        
        /* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        #toast {
            position: fixed;
            left: 16px;
            bottom: 16px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            display: none;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* Ø§Ù„Ù†ØµÙˆØµ */
        h1 {
            margin: 0;
            color: #06b6d4;
            font-size: 1.5rem;
        }
        
        h3 {
            margin-top: 0;
            color: #9bb0c8;
            font-size: 1.1rem;
            padding-bottom: 8px;
            border-bottom: 1px solid #1e293b;
        }
        
        #cvState {
            color: #9bb0c8;
            font-size: 0.9em;
            padding: 6px 10px;
            background: #0f172a;
            border-radius: 6px;
        }
        
        #estTime {
            margin-top: 12px;
            color: #9bb0c8;
            text-align: center;
            padding: 8px;
            background: #0f172a;
            border-radius: 6px;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-container input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: block;
            padding: 10px;
            background: #1e293b;
            color: #e6eef6;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            border: 2px dashed #334155;
        }
        
        .file-input-label:hover {
            background: #334155;
        }
        
        .info-text {
            font-size: 0.8rem;
            color: #9bb0c8;
            margin-top: 4px;
        }
        
        .settings-row {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        
        .settings-row .input-group {
            flex: 1;
        }
        
        .material-preset {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .material-preset:hover {
            background: #334155;
        }
        
        .material-preset.active {
            background: #06b6d4;
            color: #021;
            border-color: #06b6d4;
        }
        
        .material-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .material-details {
            font-size: 0.8rem;
            color: #9bb0c8;
        }
        
        .active-material .material-details {
            color: #021;
        }
        
        .dimension-info {
            font-size: 0.8rem;
            color: #06b6d4;
            margin-top: 4px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #1e293b;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #06b6d4;
            width: 0%;
            transition: width 0.3s;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #06b6d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .canvas-placeholder {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9bb0c8;
            border: 1px solid #334155;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 0.8rem;
            margin-top: 4px;
        }
        
        .success-message {
            color: #10b981;
            font-size: 0.8rem;
            margin-top: 4px;
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© */
        .progress-stage {
            margin: 5px 0;
            font-size: 0.8rem;
        }

        .keyboard-shortcuts {
            background: #1e293b;
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }

        .cache-indicator {
            font-size: 0.7rem;
            color: #10b981;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <h1>CNC AI â€” Multi Machine Raster Engraving</h1>
            <div id="cvState">
                <span class="loading"></span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ OpenCV...
            </div>
        </header>

        <div class="grid">
            <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
            <div class="panel">
                <div class="file-input-container">
                    <input id="fileInput" type="file" accept="image/*"/>
                    <label class="file-input-label" for="fileInput">ğŸ“ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„</label>
                </div>
                
                <div class="tabs">
                    <button data-tab="original" class="active">ğŸ–¼ï¸ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
                    <button data-tab="heatmap">ğŸ”¥ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©</button>
                    <button data-tab="contour">ğŸ“ Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø­ÙˆØ§Ù</button>
                    <button data-tab="simulation">ğŸ¬ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</button>
                </div>
                
                <div id="original" class="tab-content active">
                    <div class="canvas-placeholder" id="originalPlaceholder">
                        Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§
                    </div>
                    <canvas id="canvasOriginal" style="display: none;"></canvas>
                </div>
                
                <div id="heatmap" class="tab-content">
                    <div class="canvas-placeholder" id="heatmapPlaceholder">
                        Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                    </div>
                    <canvas id="canvasHeatmap" style="display: none;"></canvas>
                </div>
                
                <div id="contour" class="tab-content">
                    <div class="canvas-placeholder" id="contourPlaceholder">
                        ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
                    </div>
                    <canvas id="canvasContour" style="display: none;"></canvas>
                </div>
                
                <div id="simulation" class="tab-content">
                    <div id="threeContainer">
                        <div class="canvas-placeholder" id="simulationPlaceholder">
                            Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ ØªÙˆÙ„ÙŠØ¯ G-code
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
            <div class="panel">
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© -->
                <div class="panel-section">
                    <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</h3>
                    
                    <label for="machineType">
                        Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©
                    </label>
                    <select id="machineType">
                        <option value="router">Router CNC</option>
                        <option value="laser">Laser Engraver</option>
                        <option value="plasma">Plasma Cutter</option>
                        <option value="3dprinter">3D Printer</option>
                    </select>
                    
                    <div class="info-text" id="machineDescription">
                        Router CNC - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ø­Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø´Ø¨ ÙˆØ§Ù„Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ù„ÙŠÙ†Ø©
                    </div>
                </div>
                
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø¬Ù… Ø§Ù„Ø¹Ù…Ù„ -->
                <div class="panel-section">
                    <h3>ğŸ“ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø¬Ù… Ø§Ù„Ø¹Ù…Ù„</h3>
                    
                    <div class="input-group">
                        <div>
                            <label for="workWidth">
                                Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)
                            </label>
                            <input id="workWidth" type="number" value="30" step="0.1" min="1" max="100"/>
                            <div class="dimension-info" id="widthMm">300.0 Ù…Ù…</div>
                        </div>
                        
                        <div>
                            <label for="workHeight">
                                Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)
                            </label>
                            <input id="workHeight" type="number" value="20" step="0.1" min="1" max="100"/>
                            <div class="dimension-info" id="heightMm">200.0 Ù…Ù…</div>
                        </div>
                    </div>
                    
                    <label for="workDepth">
                        Ø¹Ù…Ù‚ Ø§Ù„Ø¹Ù…Ù„ (Ù…Ù…)
                    </label>
                    <input id="workDepth" type="number" value="3.0" step="0.1" min="0.1" max="20"/>
                    
                    <div class="settings-row">
                        <div class="input-group">
                            <div>
                                <label for="originX">
                                    Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ X (Ø³Ù…)
                                </label>
                                <input id="originX" type="number" value="0" step="0.1"/>
                            </div>
                            
                            <div>
                                <label for="originY">
                                    Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ Y (Ø³Ù…)
                                </label>
                                <input id="originY" type="number" value="0" step="0.1"/>
                            </div>
                        </div>
                        
                        <button id="btnCenterOrigin" class="secondary">ğŸ¯ ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„</button>
                    </div>
                </div>
                
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ù…Ø© -->
                <div class="panel-section">
                    <h3>ğŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ù…Ø©</h3>
                    
                    <label for="materialType">
                        Ù†ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ø©
                    </label>
                    <select id="materialType">
                        <option value="wood">Ø®Ø´Ø¨</option>
                        <option value="acrylic">Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ</option>
                        <option value="aluminum">Ø£Ù„ÙˆÙ…Ù†ÙŠÙˆÙ…</option>
                        <option value="steel">ØµÙ„Ø¨</option>
                        <option value="brass">Ù†Ø­Ø§Ø³</option>
                        <option value="plastic">Ø¨Ù„Ø§Ø³ØªÙŠÙƒ</option>
                        <option value="foam">Ø±ØºÙˆØ©</option>
                        <option value="custom">Ù…Ø®ØµØµ</option>
                    </select>
                    
                    <div id="materialPresets">
                        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
                    </div>
                </div>
                
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ -->
                <div class="panel-section">
                    <h3>ğŸš€ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</h3>
                    
                    <label for="feedRate">
                        Ø³Ø±Ø¹Ø© Ø§Ù„ØªØºØ°ÙŠØ© (Ù…Ù…/Ø¯Ù‚ÙŠÙ‚Ø©)
                    </label>
                    <input id="feedRate" type="number" value="800" min="10" max="5000"/>
                    
                    <label for="safeZ">
                        Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø£Ù…Ø§Ù† (Ù…Ù…)
                    </label>
                    <input id="safeZ" type="number" value="5" step="0.1" min="0" max="50"/>
                    
                    <label for="invertZ">
                        Ø¹ÙƒØ³ Ø§Ù„Ù…Ø­ÙˆØ± Z
                    </label>
                    <select id="invertZ">
                        <option value="no">Ù„Ø§</option>
                        <option value="yes">Ù†Ø¹Ù…</option>
                    </select>
                    
                    <label for="scanDir">
                        Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
                    </label>
                    <select id="scanDir">
                        <option value="x">Ø£ÙÙ‚ÙŠ (X)</option>
                        <option value="y">Ø±Ø£Ø³ÙŠ (Y)</option>
                    </select>
                    
                    <label for="stepOver">
                        Ø®Ø·ÙˆØ© Ø§Ù„Ù…Ø³Ø­ (Ù…Ù…)
                    </label>
                    <input id="stepOver" type="number" value="5" step="0.1" min="0.1" max="20"/>
                    
                    <label for="maxDepth">
                        Ø£Ù‚ØµÙ‰ Ø¹Ù…Ù‚ (Ù…Ù…)
                    </label>
                    <input id="maxDepth" type="number" value="3.0" step="0.1" min="0.1" max="20"/>
                </div>

                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
                <div class="button-group">
                    <button id="btnGen" class="primary">âš¡ ØªÙˆÙ„ÙŠØ¯ G-code</button>
                    <button id="btnQuick" class="secondary">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹</button>
                    <button id="btnDownload" class="secondary">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ G-code</button>
                </div>
                
                <div id="estTime"></div>
                
                <label for="gcodeOut" style="margin-top: 16px;">ğŸ“„ Ù…Ø®Ø±Ø¬Ø§Øª G-code</label>
                <textarea id="gcodeOut" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± G-code Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯..."></textarea>

                <!-- Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ -->
                <div class="keyboard-shortcuts">
                    <div class="shortcut-item">
                        <span>Ctrl+G</span>
                        <span>ØªÙˆÙ„ÙŠØ¯ G-code</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Ctrl+R</span>
                        <span>Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹</span>
                    </div>
                    <div class="shortcut-item">
                        <span>Ctrl+D</span>
                        <span>ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast"></div>

    <script>
        // ========== ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ==========
        let cvReady = false;
        let grayMat = null;
        let contour = null;
        let previewCanvas = null;
        let additionalContours = [];
        
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
        let scene, camera, renderer, controls;
        let simulation = {
            isPlaying: false,
            speed: 1,
            currentLine: 0,
            totalLines: 0,
            animationId: null
        };

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const machineDefaults = {
            router: { 
                feed: 800, 
                safeZ: 5, 
                maxDepth: 3, 
                stepOver: 5,
                description: "Router CNC - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ø­Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø´Ø¨ ÙˆØ§Ù„Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ù„ÙŠÙ†Ø©"
            },
            laser: { 
                feed: 1200, 
                safeZ: 0, 
                maxDepth: 0, 
                stepOver: 0.2,
                description: "Laser Engraver - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ù‚Ø´ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø´Ø¨ ÙˆØ§Ù„Ø¬Ù„ÙˆØ¯ ÙˆØ§Ù„Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ"
            },
            plasma: { 
                feed: 1500, 
                safeZ: 3, 
                maxDepth: 0, 
                stepOver: 1,
                description: "Plasma Cutter - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø¨Ø³Ù…Ùƒ Ù…Ø®ØªÙ„Ù"
            },
            "3dprinter": { 
                feed: 1000, 
                safeZ: 0.2, 
                maxDepth: 0.2, 
                stepOver: 0.4,
                description: "3D Printer - Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© FDM"
            }
        };

        // ========== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ==========
        const processingCache = new Map();
        let currentProgress = 0;

        // ========== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ==========
        
        /**
         * Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡
         */
        function showToast(msg, ms = 3000) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            clearTimeout(t._t);
            t._t = setTimeout(() => t.style.display = 'none', ms);
        }
        
        /**
         * ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ù†ØªÙŠÙ…ØªØ± Ø¥Ù„Ù‰ Ù…Ù„Ù„ÙŠÙ…ØªØ±
         */
        function cmToMm(cm) {
            return cm * 10;
        }
        
        /**
         * ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠÙ…ØªØ±
         */
        function updateDimensionDisplay() {
            const widthCm = parseFloat(document.getElementById('workWidth').value) || 0;
            const heightCm = parseFloat(document.getElementById('workHeight').value) || 0;
            
            document.getElementById('widthMm').textContent = cmToMm(widthCm).toFixed(1) + ' Ù…Ù…';
            document.getElementById('heightMm').textContent = cmToMm(heightCm).toFixed(1) + ' Ù…Ù…';
        }

        /**
         * Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†ØµØ± ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¨Ø¯ÙŠÙ„
         */
        function showElement(elementId, hidePlaceholderId) {
            const element = document.getElementById(elementId);
            const placeholder = document.getElementById(hidePlaceholderId);
            
            if (element && placeholder) {
                element.style.display = 'block';
                placeholder.style.display = 'none';
            }
        }

        /**
         * Ø£Ø®Ø° Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠ
         */
        function sampleGrayAt(x, y) {
            if (!grayMat) return 128;
            
            const gw = grayMat.cols;
            const gh = grayMat.rows;
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
            const gx_f = (x / previewCanvas.width) * (gw - 1);
            const gy_f = (y / previewCanvas.height) * (gh - 1);
            
            // Ù†Ù‚Ø§Ø· Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø­ÙŠØ·Ø©
            const x0 = Math.floor(gx_f);
            const y0 = Math.floor(gy_f);
            const x1 = Math.min(gw - 1, x0 + 1);
            const y1 = Math.min(gh - 1, y0 + 1);
            
            // Ù†Ø³Ø¨ Ø§Ù„Ø§Ø³ØªÙŠÙØ§Ø¡
            const sx = gx_f - x0;
            const sy = gy_f - y0;
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
            const v00 = grayMat.data[y0 * gw + x0];
            const v10 = grayMat.data[y0 * gw + x1];
            const v01 = grayMat.data[y1 * gw + x0];
            const v11 = grayMat.data[y1 * gw + x1];
            
            // Ø§Ù„Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠ
            const v0 = v00 * (1 - sx) + v10 * sx;
            const v1 = v01 * (1 - sx) + v11 * sx;
            
            return Math.round(v0 * (1 - sy) + v1 * sy);
        }

        // ========== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ==========

        /**
         * ØªÙ†Ø¸ÙŠÙ Ø°Ø§ÙƒØ±Ø© OpenCV
         */
        function cleanupMats() {
            const mats = [grayMat, contour, ...additionalContours];
            mats.forEach(mat => {
                if (mat && !mat.isDeleted && mat.delete) {
                    try {
                        mat.delete();
                    } catch (e) {
                        console.warn('Error deleting mat:', e);
                    }
                }
            });
            grayMat = null;
            contour = null;
            additionalContours = [];
        }

        /**
         * Debounce Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /**
         * ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
         */
        function updateProgress(stage, percentage) {
            currentProgress = percentage;
            const estTime = document.getElementById('estTime');
            estTime.innerHTML = `
                <div class="progress-stage">
                    <span>${stage}</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percentage}%"></div>
                    </div>
                    <span>${percentage}%</span>
                </div>
            `;
        }

        /**
         * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ù…Ø­Ø³Ù†Ø©
         */
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            
            const errorMessages = {
                'detectContours': 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©',
                'generateGcode': 'ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ G-code',
                'simulation': 'ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©',
                'imageLoad': 'ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'
            };
            
            showToast(`${errorMessages[context]}: ${error.message}`);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø­Ø§Ù„Ø© Ù…Ø³ØªÙ‚Ø±Ø©
            if (context === 'detectContours' || context === 'imageLoad') {
                document.querySelectorAll('.canvas-placeholder').forEach(el => {
                    el.style.display = 'flex';
                });
                document.querySelectorAll('canvas').forEach(canvas => {
                    canvas.style.display = 'none';
                });
            }
        }

        /**
         * ØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
         */
        function optimizeImageProcessing(img) {
            const maxPixels = 1024 * 1024; // 1MP ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
            const currentPixels = img.width * img.height;
            
            if (currentPixels > maxPixels) {
                const ratio = Math.sqrt(maxPixels / currentPixels);
                return {
                    width: Math.floor(img.width * ratio),
                    height: Math.floor(img.height * ratio),
                    optimized: true
                };
            }
            
            return { width: img.width, height: img.height, optimized: false };
        }

        /**
         * Ù†Ø¸Ø§Ù… cache Ù„Ù„Ù†ØªØ§Ø¦Ø¬
         */
        function getCacheKey(settings) {
            return JSON.stringify(settings);
        }

        function getCachedResult(key) {
            return processingCache.get(key);
        }

        function setCachedResult(key, result) {
            // Ø­ÙØ¸ ÙÙ‚Ø· Ø¢Ø®Ø± 5 Ù†ØªØ§Ø¦Ø¬
            if (processingCache.size >= 5) {
                const firstKey = Array.from(processingCache.keys())[0];
                processingCache.delete(firstKey);
            }
            processingCache.set(key, result);
        }

        /**
         * ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù…Ø¹ Ø§Ù„ØªÙ‚Ø¯Ù…
         */
        function loadImageWithProgress(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                let progress = 0;
                
                const interval = setInterval(() => {
                    progress = Math.min(progress + 10, 90);
                    updateProgress('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©', progress);
                }, 100);
                
                img.onload = function() {
                    clearInterval(interval);
                    updateProgress('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©', 100);
                    setTimeout(() => resolve(img), 100);
                };
                
                img.onerror = function() {
                    clearInterval(interval);
                    reject(new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©'));
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        /**
         * Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡
         */
        function performanceMonitor(func, name) {
            return function(...args) {
                const start = performance.now();
                const result = func.apply(this, args);
                const end = performance.now();
                
                console.log(`${name} executed in: ${(end - start).toFixed(2)}ms`);
                return result;
            };
        }

        // ========== ØªÙ‡ÙŠØ¦Ø© OpenCV ==========
        
        /**
         * Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ OpenCV
         */
        function waitForCv() {
            if (typeof cv !== 'undefined' && cv.getBuildInformation) {
                cvReady = true;
                document.getElementById('cvState').innerHTML = 'âœ… OpenCV Ø¬Ø§Ù‡Ø²';
                showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ OpenCV Ø¨Ù†Ø¬Ø§Ø­', 2000);
            } else {
                setTimeout(waitForCv, 100);
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù†ØªØ¸Ø§Ø± OpenCV
        waitForCv();

        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ==========
        
        document.querySelectorAll('.tabs button').forEach(btn => {
            btn.addEventListener('click', () => {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ù…Ø­Ø§ÙƒØ§Ø©ØŒ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ G-code
                if (btn.dataset.tab === "simulation" && document.getElementById('gcodeOut').value) {
                    initSimulation();
                }
            });
        });

        // ========== Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± ==========
        
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
            if (!file.type.match('image.*')) {
                showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ÙÙ‚Ø·');
                return;
            }
            
            try {
                cleanupMats(); // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø£ÙˆÙ„Ø§Ù‹
                
                const img = await loadImageWithProgress(file);
                previewCanvas = document.getElementById('canvasOriginal');
                const ctx = previewCanvas.getContext('2d');
                
                // ØªØ­Ø³ÙŠÙ† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©
                const optimizedSize = optimizeImageProcessing(img);
                if (optimizedSize.optimized) {
                    showToast('ØªÙ… ØªØ­Ø³ÙŠÙ† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£ÙØ¶Ù„');
                }
                
                previewCanvas.width = optimizedSize.width;
                previewCanvas.height = optimizedSize.height;
                
                // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Canvas
                ctx.drawImage(img, 0, 0, optimizedSize.width, optimizedSize.height);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Canvas ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù†Ø§Ø¦Ø¨
                showElement('canvasOriginal', 'originalPlaceholder');
                
                if (cvReady) {
                    await detectContours();
                } else {
                    showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ OpenCV...');
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
                    setTimeout(async () => {
                        if (cvReady) await detectContours();
                    }, 1000);
                }
                
            } catch (error) {
                handleError(error, 'imageLoad');
            }
        });

        // ========== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ÙŠØ© ==========
        
        /**
         * Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø­ÙˆØ§Ù ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©
         */
        async function detectContours() {
            if (!cvReady) {
                showToast('OpenCV ØºÙŠØ± Ø¬Ø§Ù‡Ø² Ø¨Ø¹Ø¯');
                return;
            }
            
            try {
                updateProgress('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©', 10);
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ OpenCV
                const src = cv.imread(previewCanvas);
                updateProgress('Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©', 30);
                
                // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¯Ø±Ø¬ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ
                const gray = new cv.Mat();
                cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
                updateProgress('Ø¬Ø§Ø±ÙŠ ØªÙ†Ø¹ÙŠÙ… Ø§Ù„ØµÙˆØ±Ø©', 50);
                
                // ØªØ·Ø¨ÙŠÙ‚ Gaussian Blur Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡
                const blurred = new cv.Mat();
                cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
                updateProgress('Ø¬Ø§Ø±ÙŠ ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù', 70);
                
                // ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Canny Ù…Ø¹ Ø¹ØªØ¨Ø§Øª Ù…ØªÙƒÙŠÙØ©
                const edges = new cv.Mat();
                const median = cv.mean(blurred).w;
                const lowerThreshold = Math.max(0, (1.0 - 0.33) * median);
                const upperThreshold = Math.min(255, (1.0 + 0.33) * median);
                cv.Canny(blurred, edges, lowerThreshold, upperThreshold);
                updateProgress('Ø¬Ø§Ø±ÙŠ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­ÙˆØ§Ù', 85);
                
                // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­ÙˆØ§Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… morphology
                const kernel = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(3, 3));
                cv.morphologyEx(edges, edges, cv.MORPH_CLOSE, kernel);
                
                // Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„ÙƒÙ†ØªÙˆØ±Ø§Øª
                const contours = new cv.MatVector();
                const hierarchy = new cv.Mat();
                cv.findContours(edges, contours, hierarchy, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);
                
                // ØªØµÙÙŠØ© Ø§Ù„ÙƒÙ†ØªÙˆØ±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø­Ø©
                const minArea = (gray.cols * gray.rows) * 0.01; // 1% Ù…Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµÙˆØ±Ø©
                const validContours = [];
                
                for (let i = 0; i < contours.size(); i++) {
                    const cnt = contours.get(i);
                    const area = cv.contourArea(cnt);
                    if (area > minArea) {
                        validContours.push({
                            contour: cnt,
                            area: area,
                            boundingRect: cv.boundingRect(cnt)
                        });
                    }
                }
                
                // Ø­ÙØ¸ Ø§Ù„ÙƒÙ†ØªÙˆØ±Ø§Øª Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
                if (validContours.length > 0) {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙƒØ¨Ø± ÙƒÙˆÙ†ØªÙˆØ± ÙƒØ±Ø¦ÙŠØ³ØŒ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨Ù‚ÙŠØ© Ù„Ù„ØªÙØ§ØµÙŠÙ„
                    validContours.sort((a, b) => b.area - a.area);
                    contour = validContours[0].contour;
                    
                    // Ø­ÙØ¸ Ø§Ù„ÙƒÙ†ØªÙˆØ±Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©
                    additionalContours = validContours.slice(1);
                    
                    showToast(`ØªÙ… ÙƒØ´Ù ${validContours.length} ÙƒÙˆÙ†ØªÙˆØ±`);
                } else {
                    showToast('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­ÙˆØ§Ù ÙˆØ§Ø¶Ø­Ø© ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©');
                    return;
                }
                
                // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù„Ø§Ø­Ù‚Ø©
                if (grayMat) grayMat.delete();
                grayMat = gray.clone();
                
                updateProgress('Ø¬Ø§Ø±ÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬', 95);
                
                // Ø¹Ø±Ø¶ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©
                renderHeatmap(gray);
                
                // Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ†ØªÙˆØ±
                renderContour(gray, contour);
                
                updateProgress('Ø§ÙƒØªÙ…Ù„', 100);
                showToast('ØªÙ… ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù Ø¨Ù†Ø¬Ø§Ø­');
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                src.delete();
                blurred.delete();
                edges.delete();
                hierarchy.delete();
                kernel.delete();
                contours.delete();
                
            } catch (error) {
                handleError(error, 'detectContours');
            }
        }

        /**
         * Ø¹Ø±Ø¶ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©
         */
        function renderHeatmap(gray) {
            const heatCanvas = document.getElementById('canvasHeatmap');
            const ctx = heatCanvas.getContext('2d');
            
            heatCanvas.width = gray.cols;
            heatCanvas.height = gray.rows;
            
            // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const imgData = ctx.createImageData(heatCanvas.width, heatCanvas.height);
            const data = gray.data;
            
            for (let i = 0; i < data.length; i++) {
                const value = data[i];
                const idx = i * 4;
                
                // ØªØ¯Ø±Ø¬ Ø£Ù„ÙˆØ§Ù† Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ù…Ø±
                imgData.data[idx] = value;         // Ø§Ù„Ø£Ø­Ù…Ø±
                imgData.data[idx + 1] = 0;         // Ø§Ù„Ø£Ø®Ø¶Ø±
                imgData.data[idx + 2] = 255 - value; // Ø§Ù„Ø£Ø²Ø±Ù‚
                imgData.data[idx + 3] = 255;       // Ø§Ù„Ø´ÙØ§ÙÙŠØ©
            }
            
            ctx.putImageData(imgData, 0, 0);
            showElement('canvasHeatmap', 'heatmapPlaceholder');
        }

        /**
         * Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ†ØªÙˆØ±
         */
        function renderContour(gray, mainContour) {
            const contourCanvas = document.getElementById('canvasContour');
            const ctx = contourCanvas.getContext('2d');
            
            contourCanvas.width = gray.cols;
            contourCanvas.height = gray.rows;
            
            // Ø±Ø³Ù… Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø© ÙƒØ®Ù„ÙÙŠØ©
            const heatCanvas = document.getElementById('canvasHeatmap');
            ctx.drawImage(heatCanvas, 0, 0);
            
            // Ø±Ø³Ù… Ø§Ù„ÙƒÙ†ØªÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            if (mainContour) {
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                const data = mainContour.data32S;
                for (let i = 0; i < data.length; i += 2) {
                    const x = data[i];
                    const y = data[i + 1];
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.closePath();
                ctx.stroke();
            }
            
            // Ø±Ø³Ù… Ø§Ù„ÙƒÙ†ØªÙˆØ±Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 1;
            
            additionalContours.forEach(contourInfo => {
                const cnt = contourInfo.contour;
                ctx.beginPath();
                
                const data = cnt.data32S;
                for (let i = 0; i < data.length; i += 2) {
                    const x = data[i];
                    const y = data[i + 1];
                    
                    if (i === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.closePath();
                ctx.stroke();
            });
            
            showElement('canvasContour', 'contourPlaceholder');
        }

        // ========== ØªÙˆÙ„ÙŠØ¯ G-code ==========
        
        /**
         * Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø¥Ù„Ù‰ Ø§Ù„ØµÙ
         */
        function addSegmentPoints(rowPoints, startX, endX, y, scaleX, scaleY, originX, originY, maxDepth, invertZ) {
            for (let x = startX; x <= endX; x++) {
                const pv = sampleGrayAt(x, y);
                let z = -((255 - pv) / 255.0) * maxDepth;
                if (invertZ) {
                    z = -z;
                }
                
                const scaledX = (x * scaleX) + originX;
                const scaledY = (y * scaleY) + originY;
                
                rowPoints.push({ x: scaledX, y: scaledY, z });
            }
        }

        /**
         * Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†Ù‚Ø§Ø· Ø§Ù„ØµÙ
         */
        function processRowPoints(rowPoints, lines, feed, safeZ, reverse) {
            if (reverse) {
                rowPoints.reverse();
            }
            
            lines.push('G0 X' + rowPoints[0].x.toFixed(2) + ' Y' + rowPoints[0].y.toFixed(2) + ' Z' + safeZ);
            lines.push('G1 F' + feed);
            
            for (let i = 0; i < rowPoints.length; i++) {
                const p = rowPoints[i];
                lines.push('G1 X' + p.x.toFixed(2) + ' Y' + p.y.toFixed(2) + ' Z' + p.z.toFixed(3));
            }
            
            lines.push('G0 Z' + safeZ);
        }

        /**
         * Ø­Ø³Ø§Ø¨ Ø·ÙˆÙ„ Ø§Ù„ØµÙ
         */
        function calculateRowLength(rowPoints) {
            let length = 0;
            for (let i = 1; i < rowPoints.length; i++) {
                length += Math.hypot(
                    rowPoints[i].x - rowPoints[i-1].x,
                    rowPoints[i].y - rowPoints[i-1].y
                );
            }
            return length;
        }

        /**
         * ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ G Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ù†Ù‚Ø·ÙŠ
         */
        function generateRasterGcode(scaleDown = false) {
            if (!grayMat || !contour) {
                showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©");
                return "";
            }
            
            try {
                updateProgress('Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ G-code', 10);
                
                // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                const dir = document.getElementById('scanDir').value;
                const stepOver = parseFloat(document.getElementById('stepOver').value) || 5;
                const maxDepth = parseFloat(document.getElementById('maxDepth').value) || 3;
                const feed = parseFloat(document.getElementById('feedRate').value) || 800;
                const safeZ = parseFloat(document.getElementById('safeZ').value) || 5;
                const invertZ = document.getElementById('invertZ').value === 'yes';
                
                // Ù‚Ø±Ø§Ø¡Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø¬Ù… Ø§Ù„Ø¹Ù…Ù„
                const workWidth = cmToMm(parseFloat(document.getElementById('workWidth').value) || 30);
                const workHeight = cmToMm(parseFloat(document.getElementById('workHeight').value) || 20);
                const originX = cmToMm(parseFloat(document.getElementById('originX').value) || 0);
                const originY = cmToMm(parseFloat(document.getElementById('originY').value) || 0);

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†ØªÙŠØ¬Ø© ÙÙŠ cache
                const cacheKey = getCacheKey({ dir, stepOver, maxDepth, feed, safeZ, invertZ, workWidth, workHeight, originX, originY, scaleDown });
                const cachedResult = getCachedResult(cacheKey);
                
                if (cachedResult) {
                    showToast('ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ âœ“');
                    document.getElementById('estTime').innerHTML = cachedResult.estTime + '<span class="cache-indicator">(Ù…Ø®Ø¨Ø£)</span>';
                    return cachedResult.gcode;
                }

                updateProgress('Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª', 30);
                
                // Ø¨Ø¯Ø¡ ÙƒÙˆØ¯ G
                const lines = [];
                lines.push('G21 G90 G17'); // Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…ØªØ±ÙŠØ©ØŒ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„Ù‚Ø©ØŒ Ù…Ø³ØªÙˆÙ‰ XY
                lines.push('G0 Z' + safeZ.toFixed(2)); // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø£Ù…Ø§Ù†
                
                let totalLen = 0;
                let step = scaleDown ? stepOver * 4 : stepOver;

                // Ø­Ø³Ø§Ø¨ Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³
                const scaleX = workWidth / previewCanvas.width;
                const scaleY = workHeight / previewCanvas.height;

                updateProgress('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª', 60);
                
                // Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø£ÙÙ‚ÙŠ
                if (dir === 'x') {
                    for (let y = 0; y < previewCanvas.height; y += step) {
                        const rowPoints = [];
                        let inContour = false;
                        let segmentStart = -1;
                        
                        // ØªØ­Ø¯ÙŠØ¯ Ù…Ù‚Ø§Ø·Ø¹ Ø§Ù„Ù…Ø³Ø­ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙ†ØªÙˆØ±
                        for (let x = 0; x < previewCanvas.width; x++) {
                            const point = new cv.Point(x, y);
                            const inside = cv.pointPolygonTest(contour, point, false) >= 0;
                            
                            if (inside && !inContour) {
                                // Ø¨Ø¯Ø§ÙŠØ© Ù…Ù‚Ø·Ø¹ Ø¬Ø¯ÙŠØ¯
                                segmentStart = x;
                                inContour = true;
                            } else if (!inside && inContour) {
                                // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù‚Ø·Ø¹
                                addSegmentPoints(rowPoints, segmentStart, x-1, y, scaleX, scaleY, originX, originY, maxDepth, invertZ);
                                inContour = false;
                            }
                        }
                        
                        // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù…Ø³Ø­ ÙˆÙ†Ø­Ù† Ø¯Ø§Ø®Ù„ ÙƒÙˆÙ†ØªÙˆØ±
                        if (inContour) {
                            addSegmentPoints(rowPoints, segmentStart, previewCanvas.width-1, y, scaleX, scaleY, originX, originY, maxDepth, invertZ);
                        }
                        
                        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù†Ù‚Ø§Ø· Ø§Ù„ØµÙ
                        if (rowPoints.length > 1) {
                            processRowPoints(rowPoints, lines, feed, safeZ, (y / step) % 2 !== 0);
                            totalLen += calculateRowLength(rowPoints);
                        }
                    }
                }
                
                updateProgress('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬', 90);
                
                // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                lines.push('M5');  // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ØºØ²Ù„/Ø§Ù„Ù„ÙŠØ²Ø±
                lines.push('M30'); // Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ
                const timeMin = (totalLen / feed);
                const estTimeHTML = "â±ï¸ ØªÙ‚Ø¯ÙŠØ± Ø§Ù„ÙˆÙ‚Øª: " + timeMin.toFixed(1) + " Ø¯Ù‚ÙŠÙ‚Ø©";
                document.getElementById('estTime').innerHTML = estTimeHTML;
                
                const result = lines.join('\n');
                
                // Ø­ÙØ¸ ÙÙŠ cache
                setCachedResult(cacheKey, {
                    gcode: result,
                    estTime: estTimeHTML
                });
                
                updateProgress('Ø§ÙƒØªÙ…Ù„ ØªÙˆÙ„ÙŠØ¯ G-code', 100);
                return result;
                
            } catch (error) {
                handleError(error, 'generateGcode');
                return "";
            }
        }

        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ==========
        
        document.getElementById('btnGen').addEventListener('click', () => {
            const gcode = generateRasterGcode(false);
            document.getElementById('gcodeOut').value = gcode;
            if (gcode) {
                showToast("ØªÙ… ØªÙˆÙ„ÙŠØ¯ G-code Ø¨Ù†Ø¬Ø§Ø­");
                // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                document.querySelector('[data-tab="simulation"]').click();
            }
        });
        
        document.getElementById('btnQuick').addEventListener('click', () => {
            const gcode = generateRasterGcode(true);
            document.getElementById('gcodeOut').value = gcode;
            if (gcode) {
                showToast("ØªÙ… ØªÙˆÙ„ÙŠØ¯ G-code Ø³Ø±ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­");
                document.querySelector('[data-tab="simulation"]').click();
            }
        });
        
        document.getElementById('btnDownload').addEventListener('click', () => {
            const text = document.getElementById('gcodeOut').value;
            if (!text) {
                showToast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ G-code Ù„ØªØ­Ù…ÙŠÙ„Ù‡");
                return;
            }
            
            const blob = new Blob([text], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "cnc_output.gcode";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­");
        });

        document.getElementById('btnCenterOrigin').addEventListener('click', () => {
            const workWidth = parseFloat(document.getElementById('workWidth').value) || 0;
            const workHeight = parseFloat(document.getElementById('workHeight').value) || 0;
            
            document.getElementById('originX').value = (workWidth / 2).toFixed(1);
            document.getElementById('originY').value = (workHeight / 2).toFixed(1);
            
            showToast("ØªÙ… ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„");
        });

        document.getElementById('machineType').addEventListener('change', (e) => {
            const type = e.target.value;
            const def = machineDefaults[type];
            
            if (def) {
                document.getElementById('feedRate').value = def.feed;
                document.getElementById('safeZ').value = def.safeZ;
                document.getElementById('maxDepth').value = def.maxDepth;
                document.getElementById('stepOver').value = def.stepOver;
                document.getElementById('machineDescription').textContent = def.description;
                
                showToast(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ${type}`);
            }
        });

        // ========== Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ==========
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'g':
                        e.preventDefault();
                        document.getElementById('btnGen').click();
                        showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ ØªÙˆÙ„ÙŠØ¯ G-code (Ctrl+G)');
                        break;
                    case 'r':
                        e.preventDefault();
                        document.getElementById('btnQuick').click();
                        showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹ (Ctrl+R)');
                        break;
                    case 'd':
                        e.preventDefault();
                        document.getElementById('btnDownload').click();
                        showToast('ØªÙ… ØªÙØ¹ÙŠÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù (Ctrl+D)');
                        break;
                }
            }
        });

        // ========== ØªØ·Ø¨ÙŠÙ‚ Debounce Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª ==========
        const debouncedUpdate = debounce(updateDimensionDisplay, 500);
        document.getElementById('workWidth').addEventListener('input', debouncedUpdate);
        document.getElementById('workHeight').addEventListener('input', debouncedUpdate);

        // ========== ØªØ·Ø¨ÙŠÙ‚ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø±Ø¬Ø© ==========
        detectContours = performanceMonitor(detectContours, 'detectContours');
        generateRasterGcode = performanceMonitor(generateRasterGcode, 'generateRasterGcode');

        // ========== Ù…Ø­Ø§ÙƒØ§Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ==========
        
        /**
         * ØªØ­Ù„ÙŠÙ„ G-code Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
         */
        function parseGcodeForSimulation(gcode) {
            const lines = gcode.split('\n');
            const pathPoints = [];
            let currentPos = { x: 0, y: 0, z: 0 };
            
            for (const line of lines) {
                const trimmed = line.trim();
                if (trimmed.startsWith('G1') || trimmed.startsWith('G0')) {
                    const xMatch = trimmed.match(/X([\d.-]+)/);
                    const yMatch = trimmed.match(/Y([\d.-]+)/);
                    const zMatch = trimmed.match(/Z([\d.-]+)/);
                    
                    if (xMatch) currentPos.x = parseFloat(xMatch[1]);
                    if (yMatch) currentPos.y = parseFloat(yMatch[1]);
                    if (zMatch) currentPos.z = parseFloat(zMatch[1]);
                    
                    pathPoints.push({ ...currentPos });
                }
            }
            
            return pathPoints;
        }

        /**
         * Ø¥Ù†Ø´Ø§Ø¡ ØªØµÙˆÙŠØ± Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ø¯Ø§Ø©
         */
        function createToolPathVisualization(pathPoints) {
            if (pathPoints.length < 2) return null;
            
            const points = pathPoints.map(p => 
                new THREE.Vector3(p.x, p.z + 5, p.y) // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆØ± Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ù…Ø´Ù‡Ø¯
            );
            
            const pathGeometry = new THREE.BufferGeometry().setFromPoints(points);
            const pathMaterial = new THREE.LineBasicMaterial({ color: 0x00ff00 });
            const pathLine = new THREE.Line(pathGeometry, pathMaterial);
            scene.add(pathLine);
            
            return pathLine;
        }

        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¯Ø§Ø© Ù…Ø­Ø³ÙÙ†
         */
        function createToolModel() {
            const toolGroup = new THREE.Group();
            
            // Ø¬Ø³Ù… Ø§Ù„Ø£Ø¯Ø§Ø©
            const toolGeometry = new THREE.CylinderGeometry(2, 2, 20, 16);
            const toolMaterial = new THREE.MeshPhongMaterial({ color: 0xff4444 });
            const toolBody = new THREE.Mesh(toolGeometry, toolMaterial);
            toolGroup.add(toolBody);
            
            // Ø±Ø£Ø³ Ø§Ù„Ø£Ø¯Ø§Ø©
            const tipGeometry = new THREE.ConeGeometry(3, 8, 16);
            const tipMaterial = new THREE.MeshPhongMaterial({ color: 0xffff00 });
            const toolTip = new THREE.Mesh(tipGeometry, tipMaterial);
            toolTip.position.y = -14;
            toolGroup.add(toolTip);
            
            toolGroup.position.set(0, 25, 0);
            return toolGroup;
        }

        /**
         * Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
         */
        function addSimulationControls(tool, toolPath) {
            const container = document.getElementById('threeContainer');
            
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'simulation-controls';
            controlsDiv.innerHTML = `
                <button id="btnPlay">â–¶ ØªØ´ØºÙŠÙ„</button>
                <button id="btnPause">â¸ Ø¥ÙŠÙ‚Ø§Ù</button>
                <button id="btnReset">â¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            `;
            container.appendChild(controlsDiv);
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'simulation-info';
            infoDiv.innerHTML = `
                <div>Ø§Ù„Ø­Ø§Ù„Ø©: <span id="simStatus">Ø¬Ø§Ù‡Ø²</span></div>
                <div>Ø§Ù„ØªÙ‚Ø¯Ù…: <span id="simProgress">0%</span></div>
            `;
            container.appendChild(infoDiv);
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            document.getElementById('btnPlay').addEventListener('click', () => {
                document.getElementById('simStatus').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„';
                showToast('Ø¨Ø¯Ø£Øª Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
            });
            
            document.getElementById('btnPause').addEventListener('click', () => {
                document.getElementById('simStatus').textContent = 'Ù…ØªÙˆÙ‚Ù';
                showToast('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
            });
            
            document.getElementById('btnReset').addEventListener('click', () => {
                document.getElementById('simStatus').textContent = 'Ø¬Ø§Ù‡Ø²';
                document.getElementById('simProgress').textContent = '0%';
                showToast('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
            });
        }

        /**
         * ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
         */
        function initSimulation() {
            const container = document.getElementById('threeContainer');
            container.innerHTML = '';
            
            try {
                document.getElementById('simulationPlaceholder').style.display = 'none';
                
                // Ù‚Ø±Ø§Ø¡Ø© G-code Ø§Ù„ÙØ¹Ù„ÙŠ
                const gcode = document.getElementById('gcodeOut').value;
                if (!gcode) {
                    throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ G-code Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
                }
                
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x081224);
                
                camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                camera.position.set(100, 100, 100);
                
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(container.clientWidth, container.clientHeight);
                container.appendChild(renderer.domElement);
                
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                
                // Ø¥Ø¶Ø§Ø¡Ø© Ù…Ø­Ø³Ù†Ø©
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(50, 100, 50);
                scene.add(directionalLight);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                const workWidth = cmToMm(parseFloat(document.getElementById('workWidth').value) || 30);
                const workHeight = cmToMm(parseFloat(document.getElementById('workHeight').value) || 20);
                const workDepth = parseFloat(document.getElementById('workDepth').value) || 3;
                
                const materialGeometry = new THREE.BoxGeometry(workWidth, workDepth, workHeight);
                const materialMaterial = new THREE.MeshPhongMaterial({ 
                    color: 0x8B4513,
                    transparent: true,
                    opacity: 0.8
                });
                const material = new THREE.Mesh(materialGeometry, materialMaterial);
                material.position.y = workDepth / 2;
                scene.add(material);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ù…Ù† G-code Ø§Ù„ÙØ¹Ù„ÙŠ
                const toolPath = parseGcodeForSimulation(gcode);
                createToolPathVisualization(toolPath);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø¯Ø§Ø© Ù…Ø­Ø³Ù†Ø©
                const tool = createToolModel();
                scene.add(tool);
                
                // Ø¥Ø¶Ø§ÙØ© Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆØ±
                const gridHelper = new THREE.GridHelper(Math.max(workWidth, workHeight), 10);
                scene.add(gridHelper);
                
                const axesHelper = new THREE.AxesHelper(20);
                scene.add(axesHelper);
                
                // Ø§Ù„ØªØµÙŠÙŠØ±
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();
                
                addSimulationControls(tool, toolPath);
                
                showToast('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ù†Ø¬Ø§Ø­');
                
            } catch (error) {
                handleError(error, 'simulation');
                document.getElementById('simulationPlaceholder').style.display = 'flex';
            }
        }

        // ========== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© ==========
        
        document.addEventListener('DOMContentLoaded', function() {
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
            updateDimensionDisplay();
            
            showToast('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­', 2000);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
            console.log(`
                Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­:
                Ctrl+G: ØªÙˆÙ„ÙŠØ¯ G-code
                Ctrl+R: Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹
                Ctrl+D: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
            `);
        });
    </script>
</body>
</html>
