<!doctype html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>CNC AI â€” Multi Machine Raster Engraving</title>

    <!-- Ù…ÙƒØªØ¨Ø§Øª -->
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

    <style>
        /* Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª */
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: Arial, Segoe UI, system-ui;
            background: #041022;
            color: #e6eef6;
            line-height: 1.5;
        }
        
        /* Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .app {
            max-width: 1400px;
            margin: 16px auto;
            padding: 14px;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #1e293b;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 480px;
            gap: 16px;
        }
        
        @media (max-width: 1000px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Ø§Ù„Ù„ÙˆØ­Ø§Øª */
        .panel {
            background: #0b1320;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid #1e293b;
        }
        
        .panel-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #1e293b;
        }
        
        .panel-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .tabs {
            display: flex;
            margin-top: 12px;
            border-bottom: 1px solid #1e293b;
            flex-wrap: wrap;
        }
        
        .tabs button {
            margin-left: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            background: transparent;
            color: #9bb0c8;
            transition: all 0.2s;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        
        .tabs button:hover {
            background: #1e293b;
        }
        
        .tabs button.active {
            background: #06b6d4;
            color: #021;
        }
        
        .tabs button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .tabs button:disabled:hover {
            background: transparent;
        }
        
        .tab-content {
            display: none;
            margin-top: 12px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø±Ø¦ÙŠØ© */
        canvas {
            max-width: 100%;
            border-radius: 6px;
            background: #000;
            display: block;
            margin: 0 auto;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            background: #021024;
            color: #cfeaf2;
            font-family: monospace;
            border-radius: 8px;
            padding: 10px;
            border: 1px solid #1e293b;
            resize: vertical;
        }
        
        #threeContainer, #gcodeSimContainer {
            width: 100%;
            height: 360px;
            background: #081224;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        /* Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        label {
            display: block;
            margin-top: 12px;
            color: #cfeaf2;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        input, select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #1e293b;
            background: #0f172a;
            color: #e6eef6;
            margin-top: 6px;
            font-size: 0.9rem;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #06b6d4;
        }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
        }
        
        button.primary {
            background: #06b6d4;
            color: #021;
            font-weight: bold;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button.primary:hover {
            background: #0ea5e9;
        }
        
        button.secondary {
            background: #1e293b;
            color: #e6eef6;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        button.secondary:hover {
            background: #334155;
        }
        
        /* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        #toast {
            position: fixed;
            left: 16px;
            bottom: 16px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            display: none;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* Ø§Ù„Ù†ØµÙˆØµ */
        h1 {
            margin: 0;
            color: #06b6d4;
            font-size: 1.5rem;
        }
        
        h3 {
            margin-top: 0;
            color: #9bb0c8;
            font-size: 1.1rem;
            padding-bottom: 8px;
            border-bottom: 1px solid #1e293b;
        }
        
        h4 {
            margin: 0 0 10px 0;
            color: #cfeaf2;
            font-size: 1rem;
        }
        
        #cvState {
            color: #9bb0c8;
            font-size: 0.9em;
            padding: 6px 10px;
            background: #0f172a;
            border-radius: 6px;
        }
        
        #estTime {
            margin-top: 12px;
            color: #9bb0c8;
            text-align: center;
            padding: 8px;
            background: #0f172a;
            border-radius: 6px;
        }
        
        .file-input-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        
        .file-input-container input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .file-input-label {
            display: block;
            padding: 10px;
            background: #1e293b;
            color: #e6eef6;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .file-input-label:hover {
            background: #334155;
        }
        
        .info-text {
            font-size: 0.8rem;
            color: #9bb0c8;
            margin-top: 4px;
        }
        
        .settings-row {
            display: flex;
            gap: 10px;
            align-items: end;
        }
        
        .settings-row .input-group {
            flex: 1;
        }
        
        .material-preset {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .material-preset:hover {
            background: #334155;
        }
        
        .material-preset.active {
            background: #06b6d4;
            color: #021;
            border-color: #06b6d4;
        }
        
        .material-name {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .material-details {
            font-size: 0.8rem;
            color: #9bb0c8;
        }
        
        .active-material .material-details {
            color: #021;
        }
        
        .dimension-info {
            font-size: 0.8rem;
            color: #06b6d4;
            margin-top: 4px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #9bb0c8;
            font-size: 1.1rem;
        }
        
        .sim-controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        
        .sim-controls button {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .sim-controls button:hover {
            background: rgba(0, 0, 0, 0.9);
        }
        
        .sim-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            z-index: 10;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #1e293b;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #06b6d4;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <h1>CNC AI â€” Multi Machine Raster Engraving</h1>
            <div id="cvState">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ OpenCV...</div>
        </header>

        <div class="grid">
            <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
            <div class="panel">
                <div class="file-input-container">
                    <input id="fileInput" type="file" accept="image/*"/>
                    <label class="file-input-label" for="fileInput">ğŸ“ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ù„Ù„ØªØ­Ù…ÙŠÙ„</label>
                </div>
                
                <div class="tabs">
                    <button data-tab="original" class="active">ğŸ–¼ï¸ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
                    <button data-tab="heatmap">ğŸ”¥ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±Ø©</button>
                    <button data-tab="contour">ğŸ“ Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø­ÙˆØ§Ù</button>
                    <button data-tab="threeD">ğŸ“¦ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</button>
                    <button data-tab="gcodeSim" id="gcodeSimTab" disabled>ğŸ® Ù…Ø­Ø§ÙƒØ§Ø© G-code</button>
                </div>
                
                <div id="original" class="tab-content active">
                    <canvas id="canvasOriginal"></canvas>
                </div>
                
                <div id="heatmap" class="tab-content">
                    <canvas id="canvasHeatmap"></canvas>
                </div>
                
                <div id="contour" class="tab-content">
                    <canvas id="canvasContour"></canvas>
                </div>
                
                <div id="threeD" class="tab-content">
                    <div id="threeContainer">
                        <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯...</div>
                    </div>
                </div>
                
                <div id="gcodeSim" class="tab-content">
                    <div id="gcodeSimContainer">
                        <div class="loading">Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø¹Ø¯ ØªÙˆÙ„ÙŠØ¯ G-code</div>
                    </div>
                </div>
            </div>

            <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
            <div class="panel">
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© -->
                <div class="panel-section">
                    <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</h3>
                    
                    <label for="machineType">
                        Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©
                    </label>
                    <select id="machineType">
                        <option value="router">Router CNC</option>
                        <option value="laser">Laser Engraver</option>
                        <option value="plasma">Plasma Cutter</option>
                        <option value="3dprinter">3D Printer</option>
                    </select>
                    
                    <div class="info-text" id="machineDescription">
                        Router CNC - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ø­Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø´Ø¨ ÙˆØ§Ù„Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ù„ÙŠÙ†Ø©
                    </div>
                </div>
                
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø¬Ù… Ø§Ù„Ø¹Ù…Ù„ -->
                <div class="panel-section">
                    <h3>ğŸ“ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø¬Ù… Ø§Ù„Ø¹Ù…Ù„</h3>
                    
                    <div class="input-group">
                        <div>
                            <label for="workWidth">
                                Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)
                            </label>
                            <input id="workWidth" type="number" value="30" step="0.1" min="1" max="100"/>
                            <div class="dimension-info" id="widthMm">300.0 Ù…Ù…</div>
                        </div>
                        
                        <div>
                            <label for="workHeight">
                                Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)
                            </label>
                            <input id="workHeight" type="number" value="20" step="0.1" min="1" max="100"/>
                            <div class="dimension-info" id="heightMm">200.0 Ù…Ù…</div>
                        </div>
                    </div>
                    
                    <label for="workDepth">
                        Ø¹Ù…Ù‚ Ø§Ù„Ø¹Ù…Ù„ (Ù…Ù…)
                    </label>
                    <input id="workDepth" type="number" value="3.0" step="0.1" min="0.1" max="20"/>
                    
                    <div class="settings-row">
                        <div class="input-group">
                            <div>
                                <label for="originX">
                                    Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ X (Ø³Ù…)
                                </label>
                                <input id="originX" type="number" value="0" step="0.1"/>
                            </div>
                            
                            <div>
                                <label for="originY">
                                    Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ Y (Ø³Ù…)
                                </label>
                                <input id="originY" type="number" value="0" step="0.1"/>
                            </div>
                        </div>
                        
                        <button id="btnCenterOrigin" class="secondary" style="height: fit-content;">ğŸ¯ ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„</button>
                    </div>
                </div>
                
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ù…Ø© -->
                <div class="panel-section">
                    <h3>ğŸ“¦ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ù…Ø©</h3>
                    
                    <label for="materialType">
                        Ù†ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ø©
                    </label>
                    <select id="materialType">
                        <option value="wood">Ø®Ø´Ø¨</option>
                        <option value="acrylic">Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ</option>
                        <option value="aluminum">Ø£Ù„ÙˆÙ…Ù†ÙŠÙˆÙ…</option>
                        <option value="steel">ØµÙ„Ø¨</option>
                        <option value="brass">Ù†Ø­Ø§Ø³</option>
                        <option value="plastic">Ø¨Ù„Ø§Ø³ØªÙŠÙƒ</option>
                        <option value="foam">Ø±ØºÙˆØ©</option>
                        <option value="custom">Ù…Ø®ØµØµ</option>
                    </select>
                    
                    <div id="materialPresets">
                        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
                    </div>
                </div>
                
                <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ -->
                <div class="panel-section">
                    <h3>ğŸš€ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</h3>
                    
                    <label for="feedRate">
                        Ø³Ø±Ø¹Ø© Ø§Ù„ØªØºØ°ÙŠØ© (Ù…Ù…/Ø¯Ù‚ÙŠÙ‚Ø©)
                    </label>
                    <input id="feedRate" type="number" value="800" min="10" max="5000"/>
                    
                    <label for="safeZ">
                        Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø£Ù…Ø§Ù† (Ù…Ù…)
                    </label>
                    <input id="safeZ" type="number" value="5" step="0.1" min="0" max="50"/>
                    
                    <label for="invertZ">
                        Ø¹ÙƒØ³ Ø§Ù„Ù…Ø­ÙˆØ± Z
                    </label>
                    <select id="invertZ">
                        <option value="no">Ù„Ø§</option>
                        <option value="yes">Ù†Ø¹Ù…</option>
                    </select>
                    
                    <label for="scanDir">
                        Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
                    </label>
                    <select id="scanDir">
                        <option value="x">Ø£ÙÙ‚ÙŠ (X)</option>
                        <option value="y">Ø±Ø£Ø³ÙŠ (Y)</option>
                    </select>
                    
                    <label for="stepOver">
                        Ø®Ø·ÙˆØ© Ø§Ù„Ù…Ø³Ø­ (Ù…Ù…)
                    </label>
                    <input id="stepOver" type="number" value="5" step="0.1" min="0.1" max="20"/>
                    
                    <label for="maxDepth">
                        Ø£Ù‚ØµÙ‰ Ø¹Ù…Ù‚ (Ù…Ù…)
                    </label>
                    <input id="maxDepth" type="number" value="3.0" step="0.1" min="0.1" max="20"/>
                </div>

                <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
                <div class="button-group">
                    <button id="btnGen" class="primary">âš¡ ØªÙˆÙ„ÙŠØ¯ G-code</button>
                    <button id="btnQuick" class="secondary">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹</button>
                    <button id="btnDownload" class="secondary">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ G-code</button>
                </div>
                
                <div id="estTime"></div>
                
                <label for="gcodeOut" style="margin-top: 16px;">ğŸ“„ Ù…Ø®Ø±Ø¬Ø§Øª G-code</label>
                <textarea id="gcodeOut" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± G-code Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯..."></textarea>
                <div class="progress-bar">
                    <div class="progress-fill" id="genProgress"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast"></div>

    <script>
        // ========== ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ==========
        let cvReady = false;
        let grayMat = null;
        let contour = null;
        let previewCanvas = null;
        let currentScene = null;
        let gcodeSimScene = null;
        let gcodeSimAnimationId = null;
        let isGcodeGenerated = false;
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const machineDefaults = {
            router: { 
                feed: 800, 
                safeZ: 5, 
                maxDepth: 3, 
                stepOver: 5,
                description: "Router CNC - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ø­Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø´Ø¨ ÙˆØ§Ù„Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„Ù„ÙŠÙ†Ø©"
            },
            laser: { 
                feed: 1200, 
                safeZ: 0, 
                maxDepth: 0, 
                stepOver: 0.2,
                description: "Laser Engraver - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ù‚Ø´ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø´Ø¨ ÙˆØ§Ù„Ø¬Ù„ÙˆØ¯ ÙˆØ§Ù„Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ"
            },
            plasma: { 
                feed: 1500, 
                safeZ: 3, 
                maxDepth: 0, 
                stepOver: 1,
                description: "Plasma Cutter - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø¨Ø³Ù…Ùƒ Ù…Ø®ØªÙ„Ù"
            },
            "3dprinter": { 
                feed: 1000, 
                safeZ: 0.2, 
                maxDepth: 0.2, 
                stepOver: 0.4,
                description: "3D Printer - Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ© FDM"
            }
        };
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ù…Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const materialDefaults = {
            wood: {
                feed: 800,
                maxDepth: 3,
                stepOver: 5,
                description: "Ø®Ø´Ø¨ - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ø­Øª ÙˆØ§Ù„ØªÙØ±ÙŠØº Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø´Ø¨"
            },
            acrylic: {
                feed: 600,
                maxDepth: 2,
                stepOver: 3,
                description: "Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ù‚Ø´ ÙˆØ§Ù„Ù‚Ø·Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ"
            },
            aluminum: {
                feed: 400,
                maxDepth: 1,
                stepOver: 2,
                description: "Ø£Ù„ÙˆÙ…Ù†ÙŠÙˆÙ… - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ù‚Ø´ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù„ÙˆÙ…Ù†ÙŠÙˆÙ…"
            },
            steel: {
                feed: 300,
                maxDepth: 0.5,
                stepOver: 1.5,
                description: "ØµÙ„Ø¨ - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ù‚Ø´ Ø¹Ù„Ù‰ Ø§Ù„ØµÙ„Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø§ÙƒÙŠÙ†Ø§Øª Ù‚ÙˆÙŠØ©"
            },
            brass: {
                feed: 500,
                maxDepth: 1.5,
                stepOver: 2.5,
                description: "Ù†Ø­Ø§Ø³ - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ù‚Ø´ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø­Ø§Ø³ ÙˆØ§Ù„Ø£ØµÙØ±"
            },
            plastic: {
                feed: 700,
                maxDepth: 2.5,
                stepOver: 4,
                description: "Ø¨Ù„Ø§Ø³ØªÙŠÙƒ - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ù‚Ø´ Ø¹Ù„Ù‰ Ù…Ø®ØªÙ„Ù Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨Ù„Ø§Ø³ØªÙŠÙƒ"
            },
            foam: {
                feed: 1000,
                maxDepth: 5,
                stepOver: 6,
                description: "Ø±ØºÙˆØ© - Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù†Ø­Øª Ø¹Ù„Ù‰ Ø§Ù„Ø±ØºÙˆØ© Ø¨Ø³Ø±Ø¹Ø§Øª Ø¹Ø§Ù„ÙŠØ©"
            },
            custom: {
                feed: 800,
                maxDepth: 3,
                stepOver: 5,
                description: "Ù…Ø®ØµØµ - Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø®ØµØµØ© Ø­Ø³Ø¨ Ø§Ù„Ø®Ø§Ù…Ø©"
            }
        };
        
        // Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø³Ø¨Ù‚Ø© Ù„Ù„Ø®Ø§Ù…Ø§Øª
        const materialPresets = {
            wood: [
                { name: "Ø®Ø´Ø¨ Ø±Ù‚Ø§Ø¦Ù‚ÙŠ 3Ù…Ù…", feed: 1000, maxDepth: 3, stepOver: 4 },
                { name: "Ø®Ø´Ø¨ MDF 6Ù…Ù…", feed: 800, maxDepth: 6, stepOver: 5 },
                { name: "Ø®Ø´Ø¨ Ø·Ø¨ÙŠØ¹ÙŠ 10Ù…Ù…", feed: 600, maxDepth: 10, stepOver: 6 }
            ],
            acrylic: [
                { name: "Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ 3Ù…Ù…", feed: 800, maxDepth: 3, stepOver: 3 },
                { name: "Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ 5Ù…Ù…", feed: 600, maxDepth: 5, stepOver: 3 },
                { name: "Ø£ÙƒØ±ÙŠÙ„ÙŠÙƒ Ø´ÙØ§Ù 2Ù…Ù…", feed: 1000, maxDepth: 2, stepOver: 2 }
            ],
            aluminum: [
                { name: "Ø£Ù„ÙˆÙ…Ù†ÙŠÙˆÙ… Ø±Ù‚Ø§Ø¦Ù‚ 1Ù…Ù…", feed: 500, maxDepth: 1, stepOver: 2 },
                { name: "Ø£Ù„ÙˆÙ…Ù†ÙŠÙˆÙ… 3Ù…Ù…", feed: 400, maxDepth: 3, stepOver: 2 },
                { name: "Ø£Ù„ÙˆÙ…Ù†ÙŠÙˆÙ… 5Ù…Ù…", feed: 300, maxDepth: 5, stepOver: 1.5 }
            ],
            steel: [
                { name: "ØµÙ„Ø¨ Ø·Ø±ÙŠ 2Ù…Ù…", feed: 400, maxDepth: 2, stepOver: 1.5 },
                { name: "Ø³ØªØ§Ù†Ù„Ø³ Ø³ØªÙŠÙ„ 1Ù…Ù…", feed: 350, maxDepth: 1, stepOver: 1 }
            ],
            brass: [
                { name: "Ù†Ø­Ø§Ø³ Ø£ØµÙØ± 2Ù…Ù…", feed: 600, maxDepth: 2, stepOver: 2.5 },
                { name: "Ù†Ø­Ø§Ø³ Ø£Ø­Ù…Ø± 3Ù…Ù…", feed: 500, maxDepth: 3, stepOver: 2 }
            ],
            plastic: [
                { name: "Ø¨Ù„Ø§Ø³ØªÙŠÙƒ ABS 3Ù…Ù…", feed: 800, maxDepth: 3, stepOver: 4 },
                { name: "Ø¨Ù„Ø§Ø³ØªÙŠÙƒ PVC 2Ù…Ù…", feed: 700, maxDepth: 2, stepOver: 3 }
            ],
            foam: [
                { name: "Ø±ØºÙˆØ© PVC 10Ù…Ù…", feed: 1200, maxDepth: 10, stepOver: 6 },
                { name: "Ø±ØºÙˆØ© Ø¨ÙˆÙ„Ø³ØªØ±ÙŠÙ† 20Ù…Ù…", feed: 1500, maxDepth: 20, stepOver: 8 }
            ],
            custom: [
                { name: "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¨Ø¯Ø¦ÙŠØ©", feed: 800, maxDepth: 3, stepOver: 5 }
            ]
        };

        // ========== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ==========
        
        /**
         * Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªÙ†Ø¨ÙŠÙ‡
         * @param {string} msg - Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
         * @param {number} ms - Ù…Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ (Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ©)
         */
        function showToast(msg, ms = 2000) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            clearTimeout(t._t);
            t._t = setTimeout(() => t.style.display = 'none', ms);
        }
        
        /**
         * ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ù†ØªÙŠÙ…ØªØ± Ø¥Ù„Ù‰ Ù…Ù„Ù„ÙŠÙ…ØªØ±
         * @param {number} cm - Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø³Ù†ØªÙŠÙ…ØªØ±
         * @returns {number} Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠÙ…ØªØ±
         */
        function cmToMm(cm) {
            return cm * 10;
        }
        
        /**
         * ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù„ÙŠÙ…ØªØ± Ø¥Ù„Ù‰ Ø³Ù†ØªÙŠÙ…ØªØ±
         * @param {number} mm - Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠÙ…ØªØ±
         * @returns {number} Ø§Ù„Ù‚ÙŠÙ…Ø© Ø¨Ø§Ù„Ø³Ù†ØªÙŠÙ…ØªØ±
         */
        function mmToCm(mm) {
            return mm / 10;
        }
        
        /**
         * ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠÙ…ØªØ±
         */
        function updateDimensionDisplay() {
            const widthCm = parseFloat(document.getElementById('workWidth').value) || 0;
            const heightCm = parseFloat(document.getElementById('workHeight').value) || 0;
            
            document.getElementById('widthMm').textContent = cmToMm(widthCm).toFixed(1) + ' Ù…Ù…';
            document.getElementById('heightMm').textContent = cmToMm(heightCm).toFixed(1) + ' Ù…Ù…';
        }

        // ========== ØªÙ‡ÙŠØ¦Ø© OpenCV ==========
        
        /**
         * Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ OpenCV
         */
        function waitForCv() {
            if (window.cv && cv.getBuildInformation) {
                cvReady = true;
                document.getElementById('cvState').textContent = 'âœ… OpenCV Ø¬Ø§Ù‡Ø²';
                showToast('OpenCV ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­', 1500);
                return;
            }
            
            if (window.cv) {
                cv['onRuntimeInitialized'] = () => {
                    cvReady = true;
                    document.getElementById('cvState').textContent = 'âœ… OpenCV Ø¬Ø§Ù‡Ø²';
                    showToast('OpenCV ØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­', 1500);
                };
            } else {
                setTimeout(waitForCv, 200);
            }
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù†ØªØ¸Ø§Ø± OpenCV
        waitForCv();

        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ==========
        
        document.querySelectorAll('.tabs button').forEach(btn => {
            btn.addEventListener('click', () => {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„Ø²Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
                btn.classList.add('active');
                const tabId = btn.dataset.tab;
                document.getElementById(tabId).classList.add('active');
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                if (tabId === "threeD" && grayMat) {
                    show3D();
                }
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ù…Ø­Ø§ÙƒØ§Ø© G-codeØŒ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
                if (tabId === "gcodeSim" && isGcodeGenerated) {
                    initGcodeSimulation();
                }
            });
        });

        // ========== Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ± ==========
        
        document.getElementById('fileInput').addEventListener('change', e => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
            if (!file.type.match('image.*')) {
                showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù ØµÙˆØ±Ø© ÙÙ‚Ø·');
                return;
            }
            
            const img = new Image();
            img.onload = function() {
                previewCanvas = document.getElementById('canvasOriginal');
                const maxWidth = 800;
                const maxHeight = 600;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ†Ø§Ø³Ø¨
                let newWidth = img.width;
                let newHeight = img.height;
                
                if (newWidth > maxWidth) {
                    newHeight = (maxWidth / newWidth) * newHeight;
                    newWidth = maxWidth;
                }
                
                if (newHeight > maxHeight) {
                    newWidth = (maxHeight / newHeight) * newWidth;
                    newHeight = maxHeight;
                }
                
                previewCanvas.width = newWidth;
                previewCanvas.height = newHeight;
                
                const ctx = previewCanvas.getContext('2d');
                ctx.drawImage(img, 0, 0, newWidth, newHeight);
                
                if (cvReady) {
                    detectContours();
                } else {
                    showToast('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ OpenCV...');
                }
            }
            
            img.onerror = function() {
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©');
            };
            
            img.src = URL.createObjectURL(file);
        });

        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© ==========
        
        document.getElementById('machineType').addEventListener('change', (e) => {
            const type = e.target.value;
            const def = machineDefaults[type];
            
            if (def) {
                document.getElementById('feedRate').value = def.feed;
                document.getElementById('safeZ').value = def.safeZ;
                document.getElementById('maxDepth').value = def.maxDepth;
                document.getElementById('stepOver').value = def.stepOver;
                document.getElementById('machineDescription').textContent = def.description;
                
                showToast(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ${type}`);
            }
        });

        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ù…Ø© ==========
        
        /**
         * ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø®Ø§Ù…Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯
         */
        function updateMaterialPresets() {
            const materialType = document.getElementById('materialType').value;
            const presetsContainer = document.getElementById('materialPresets');
            
            // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ
            presetsContainer.innerHTML = '';
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø³Ø¨Ù‚Ø©
            if (materialPresets[materialType]) {
                materialPresets[materialType].forEach((preset, index) => {
                    const presetElement = document.createElement('div');
                    presetElement.className = 'material-preset';
                    presetElement.innerHTML = `
                        <div class="material-name">${preset.name}</div>
                        <div class="material-details">
                            Ø³Ø±Ø¹Ø©: ${preset.feed} Ù…Ù…/Ø¯ | Ø¹Ù…Ù‚: ${preset.maxDepth} Ù…Ù… | Ø®Ø·ÙˆØ©: ${preset.stepOver} Ù…Ù…
                        </div>
                    `;
                    
                    presetElement.addEventListener('click', () => {
                        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                        document.getElementById('feedRate').value = preset.feed;
                        document.getElementById('maxDepth').value = preset.maxDepth;
                        document.getElementById('stepOver').value = preset.stepOver;
                        
                        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨
                        document.querySelectorAll('.material-preset').forEach(p => p.classList.remove('active'));
                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø´Ø§Ø· Ù„Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
                        presetElement.classList.add('active');
                        
                        showToast(`âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ${preset.name}`);
                    });
                    
                    // ØªÙØ¹ÙŠÙ„ Ø£ÙˆÙ„ Ù‚Ø§Ù„Ø¨ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
                    if (index === 0) {
                        presetElement.classList.add('active');
                    }
                    
                    presetsContainer.appendChild(presetElement);
                });
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø®Ø§Ù…Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ø©
        document.getElementById('materialType').addEventListener('change', updateMaterialPresets);
        
        // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø®Ø§Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        updateMaterialPresets();

        // ========== Ø¥Ø¯Ø§Ø±Ø© Ø­Ø¬Ù… Ø§Ù„Ø¹Ù…Ù„ ==========
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚ÙŠÙ…
        document.getElementById('workWidth').addEventListener('input', updateDimensionDisplay);
        document.getElementById('workHeight').addEventListener('input', updateDimensionDisplay);
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        updateDimensionDisplay();
        
        document.getElementById('btnCenterOrigin').addEventListener('click', () => {
            const workWidth = parseFloat(document.getElementById('workWidth').value) || 0;
            const workHeight = parseFloat(document.getElementById('workHeight').value) || 0;
            
            document.getElementById('originX').value = (workWidth / 2).toFixed(1);
            document.getElementById('originY').value = (workHeight / 2).toFixed(1);
            
            showToast("âœ… ØªÙ… ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„");
        });

        // ========== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ÙŠØ© ==========
        
        /**
         * Ø£Ø®Ø° Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠ
         * @param {number} x - Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠ X
         * @param {number} y - Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠ Y
         * @returns {number} Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ
         */
        function sampleGrayAt(x, y) {
            if (!grayMat) return 128;
            
            const gw = grayMat.cols;
            const gh = grayMat.rows;
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø©
            if (x < 0 || x >= previewCanvas.width || y < 0 || y >= previewCanvas.height) {
                return 128;
            }
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
            const gx_f = (x / previewCanvas.width) * (gw - 1);
            const gy_f = (y / previewCanvas.height) * (gh - 1);
            
            // Ù†Ù‚Ø§Ø· Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø­ÙŠØ·Ø©
            const x0 = Math.floor(gx_f);
            const y0 = Math.floor(gy_f);
            const x1 = Math.min(gw - 1, x0 + 1);
            const y1 = Math.min(gh - 1, y0 + 1);
            
            // Ù†Ø³Ø¨ Ø§Ù„Ø§Ø³ØªÙŠÙØ§Ø¡
            const sx = gx_f - x0;
            const sy = gy_f - y0;
            
            // Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø­ÙŠØ·Ø©
            const v00 = grayMat.ucharPtr(y0, x0)[0];
            const v10 = grayMat.ucharPtr(y0, x1)[0];
            const v01 = grayMat.ucharPtr(y1, x0)[0];
            const v11 = grayMat.ucharPtr(y1, x1)[0];
            
            // Ø§Ù„Ø§Ø³ØªÙŠÙØ§Ø¡ Ø§Ù„Ø«Ù†Ø§Ø¦ÙŠ
            const v0 = v00 * (1 - sx) + v10 * sx;
            const v1 = v01 * (1 - sx) + v11 * sx;
            return v0 * (1 - sy) + v1 * sy;
        }
        
        /**
         * ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù ÙˆÙ…Ø¹Ø§Ù„Ø¬ØªÙ‡Ø§
         */
        function detectContours() {
            if (!cvReady || !previewCanvas) return;
            
            try {
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© OpenCV
                const src = cv.imread(previewCanvas);
                
                // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØªØ¯Ø±Ø¬ Ø±Ù…Ø§Ø¯ÙŠ
                grayMat = new cv.Mat();
                cv.cvtColor(src, grayMat, cv.COLOR_RGBA2GRAY);
                
                // ØªØ·Ø¨ÙŠÙ‚ Ù…Ø±Ø´Ø­ Gaussian Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡
                const blurred = new cv.Mat();
                cv.GaussianBlur(grayMat, blurred, new cv.Size(5, 5), 0);
                
                // ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Canny
                const edges = new cv.Mat();
                cv.Canny(blurred, edges, 50, 150);
                
                // Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø­ÙˆØ§Ù
                const contours = new cv.MatVector();
                const hierarchy = new cv.Mat();
                cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
                
                // Ø±Ø³Ù… Ø§Ù„Ø­ÙˆØ§Ù Ø¹Ù„Ù‰ canvas Ù…Ù†ÙØµÙ„
                const contourCanvas = document.getElementById('canvasContour');
                contourCanvas.width = previewCanvas.width;
                contourCanvas.height = previewCanvas.height;
                const ctx = contourCanvas.getContext('2d');
                ctx.drawImage(previewCanvas, 0, 0);
                
                // Ø±Ø³Ù… Ø§Ù„Ø­ÙˆØ§Ù
                ctx.strokeStyle = '#06b6d4';
                ctx.lineWidth = 2;
                
                for (let i = 0; i < contours.size(); i++) {
                    const cnt = contours.get(i);
                    ctx.beginPath();
                    
                    for (let j = 0; j < cnt.data32S.length; j += 2) {
                        const x = cnt.data32S[j];
                        const y = cnt.data32S[j + 1];
                        
                        if (j === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    
                    ctx.closePath();
                    ctx.stroke();
                }
                
                // ØªØ­Ø±ÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©
                src.delete();
                blurred.delete();
                edges.delete();
                contours.delete();
                hierarchy.delete();
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ø­Ø±Ø§Ø±Ø©
                createHeatmap();
                
                showToast('âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©:', e);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©');
            }
        }
        
        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ø­Ø±Ø§Ø±Ø© Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠØ©
         */
        function createHeatmap() {
            if (!grayMat || !previewCanvas) return;
            
            const heatmapCanvas = document.getElementById('canvasHeatmap');
            heatmapCanvas.width = previewCanvas.width;
            heatmapCanvas.height = previewCanvas.height;
            const ctx = heatmapCanvas.getContext('2d');
            
            // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙƒØ®Ù„ÙÙŠØ©
            ctx.drawImage(previewCanvas, 0, 0);
            
            // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©
            const imageData = ctx.getImageData(0, 0, heatmapCanvas.width, heatmapCanvas.height);
            const data = imageData.data;
            
            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©
            for (let i = 0; i < data.length; i += 4) {
                const x = (i / 4) % heatmapCanvas.width;
                const y = Math.floor((i / 4) / heatmapCanvas.width);
                
                const grayValue = sampleGrayAt(x, y);
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ Ø¥Ù„Ù‰ Ù„ÙˆÙ† Ø­Ø±Ø§Ø±ÙŠ
                let r, g, b;
                
                if (grayValue < 64) {
                    // Ø£Ø²Ø±Ù‚ Ø¥Ù„Ù‰ Ø³Ù…Ø§ÙˆÙŠ
                    r = 0;
                    g = Math.floor((grayValue / 64) * 255);
                    b = 255;
                } else if (grayValue < 128) {
                    // Ø³Ù…Ø§ÙˆÙŠ Ø¥Ù„Ù‰ Ø£ØµÙØ±
                    r = Math.floor(((grayValue - 64) / 64) * 255);
                    g = 255;
                    b = Math.floor((1 - (grayValue - 64) / 64) * 255);
                } else if (grayValue < 192) {
                    // Ø£ØµÙØ± Ø¥Ù„Ù‰ Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
                    r = 255;
                    g = Math.floor((1 - (grayValue - 128) / 64) * 255);
                    b = 0;
                } else {
                    // Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ø£Ø­Ù…Ø±
                    r = 255;
                    g = Math.floor((1 - (grayValue - 192) / 64) * 128);
                    b = 0;
                }
                
                // Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                const alpha = 0.6;
                data[i] = Math.floor(data[i] * (1 - alpha) + r * alpha);
                data[i + 1] = Math.floor(data[i + 1] * (1 - alpha) + g * alpha);
                data[i + 2] = Math.floor(data[i + 2] * (1 - alpha) + b * alpha);
            }
            
            ctx.putImageData(imageData, 0, 0);
        }

        // ========== Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ ==========
        
        /**
         * Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
         */
        function show3D() {
            if (!grayMat || !previewCanvas) {
                showToast('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
                return;
            }
            
            const container = document.getElementById('threeContainer');
            container.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯...</div>';
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
            if (currentScene) {
                if (currentScene.renderer) {
                    container.removeChild(currentScene.renderer.domElement);
                }
                currentScene = null;
            }
            
            setTimeout(() => {
                try {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ù‡Ø¯
                    const scene = new THREE.Scene();
                    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                    const renderer = new THREE.WebGLRenderer({ antialias: true });
                    
                    renderer.setSize(container.clientWidth, container.clientHeight);
                    renderer.setClearColor(0x041022);
                    container.innerHTML = '';
                    container.appendChild(renderer.domElement);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± ØªØ­ÙƒÙ… Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                    const controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø¥Ø¶Ø§Ø¡Ø©
                    const ambientLight = new THREE.AmbientLight(0x404040);
                    scene.add(ambientLight);
                    
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(1, 1, 1);
                    scene.add(directionalLight);
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø«Ù„Ø§Ø«ÙŠ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©
                    const geometry = new THREE.PlaneGeometry(10, 10, previewCanvas.width - 1, previewCanvas.height - 1);
                    const material = new THREE.MeshPhongMaterial({ 
                        color: 0x06b6d4,
                        wireframe: false,
                        side: THREE.DoubleSide,
                        flatShading: true
                    });
                    
                    const plane = new THREE.Mesh(geometry, material);
                    scene.add(plane);
                    
                    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø´Ø¯Ø© Ø§Ù„Ù„ÙˆÙ†
                    const positions = geometry.attributes.position.array;
                    const scaleFactor = 0.05; // Ø¹Ø§Ù…Ù„ ØªØ­Ø¬ÙŠÙ… Ù„Ù„Ø§Ø±ØªÙØ§Ø¹
                    
                    for (let i = 0; i < positions.length; i += 3) {
                        const vertexIndex = i / 3;
                        const x = vertexIndex % previewCanvas.width;
                        const y = Math.floor(vertexIndex / previewCanvas.width);
                        
                        if (x < previewCanvas.width && y < previewCanvas.height) {
                            const grayValue = sampleGrayAt(x, y);
                            // Ø¹ÙƒØ³ Ø§Ù„Ù‚ÙŠÙ…Ø© (Ù„Ø£Ù† Ø§Ù„Ø£ØºÙ…Ù‚ ÙŠÙƒÙˆÙ† Ø£Ø¹Ù„Ù‰ ÙÙŠ Ø§Ù„Ù†Ø­Øª)
                            const height = (255 - grayValue) / 255 * scaleFactor * 10;
                            positions[i + 2] = height;
                        }
                    }
                    
                    geometry.attributes.position.needsUpdate = true;
                    geometry.computeVertexNormals();
                    
                    // Ø¶Ø¨Ø· ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                    camera.position.set(0, 0, 12);
                    controls.update();
                    
                    // ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØµÙŠÙŠØ±
                    function animate() {
                        requestAnimationFrame(animate);
                        controls.update();
                        renderer.render(scene, camera);
                    }
                    
                    animate();
                    
                    // Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
                    currentScene = { scene, renderer, controls, camera, geometry, material, plane };
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø­Ø¬Ù… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
                    window.addEventListener('resize', () => {
                        camera.aspect = container.clientWidth / container.clientHeight;
                        camera.updateProjectionMatrix();
                        renderer.setSize(container.clientWidth, container.clientHeight);
                    });
                    
                    showToast('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯');
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯:', error);
                    container.innerHTML = '<div class="loading">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</div>';
                    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯');
                }
            }, 100);
        }

        // ========== Ù…Ø­Ø§ÙƒØ§Ø© G-code ==========
        
        /**
         * ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ø§ÙƒØ§Ø© G-code
         */
        function initGcodeSimulation() {
            if (!isGcodeGenerated) {
                showToast('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªÙˆÙ„ÙŠØ¯ G-code Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            const container = document.getElementById('gcodeSimContainer');
            container.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©...</div>';
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
            if (gcodeSimScene) {
                if (gcodeSimScene.renderer) {
                    container.removeChild(gcodeSimScene.renderer.domElement);
                }
                if (gcodeSimAnimationId) {
                    cancelAnimationFrame(gcodeSimAnimationId);
                    gcodeSimAnimationId = null;
                }
                gcodeSimScene = null;
            }
            
            setTimeout(() => {
                try {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ù‡Ø¯
                    const scene = new THREE.Scene();
                    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                    const renderer = new THREE.WebGLRenderer({ antialias: true });
                    
                    renderer.setSize(container.clientWidth, container.clientHeight);
                    renderer.setClearColor(0x081224);
                    container.innerHTML = '';
                    container.appendChild(renderer.domElement);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± ØªØ­ÙƒÙ… Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                    const controls = new THREE.OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.05;
                    
                    // Ø¥Ø¶Ø§Ø¡Ø©
                    const ambientLight = new THREE.AmbientLight(0x404040);
                    scene.add(ambientLight);
                    
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(1, 1, 1);
                    scene.add(directionalLight);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
                    const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
                    scene.add(gridHelper);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø­Ø§ÙˆØ±
                    const axesHelper = new THREE.AxesHelper(5);
                    scene.add(axesHelper);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØµØ© Ø§Ù„Ø¹Ù…Ù„
                    const workWidth = parseFloat(document.getElementById('workWidth').value) || 30;
                    const workHeight = parseFloat(document.getElementById('workHeight').value) || 20;
                    
                    const platformGeometry = new THREE.BoxGeometry(workWidth / 3, workHeight / 3, 0.5);
                    const platformMaterial = new THREE.MeshPhongMaterial({ color: 0x333333 });
                    const platform = new THREE.Mesh(platformGeometry, platformMaterial);
                    platform.position.z = -0.25;
                    scene.add(platform);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø±Ø£Ø³ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©
                    const toolGeometry = new THREE.CylinderGeometry(0.2, 0.2, 1, 8);
                    const toolMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000 });
                    const tool = new THREE.Mesh(toolGeometry, toolMaterial);
                    tool.position.set(0, 0, 0.5);
                    scene.add(tool);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
                    const pathPoints = [];
                    const pathGeometry = new THREE.BufferGeometry().setFromPoints(pathPoints);
                    const pathMaterial = new THREE.LineBasicMaterial({ color: 0x06b6d4, linewidth: 2 });
                    const path = new THREE.Line(pathGeometry, pathMaterial);
                    scene.add(path);
                    
                    // Ø¶Ø¨Ø· ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
                    camera.position.set(10, 10, 10);
                    camera.lookAt(0, 0, 0);
                    controls.update();
                    
                    // Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ù„Ù„Ù…Ø´Ù‡Ø¯
                    gcodeSimScene = {
                        scene: scene,
                        camera: camera,
                        renderer: renderer,
                        controls: controls,
                        tool: tool,
                        path: path,
                        pathPoints: pathPoints
                    };
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©
                    const simControls = document.createElement('div');
                    simControls.className = 'sim-controls';
                    simControls.innerHTML = `
                        <button id="simPlay">â–¶ ØªØ´ØºÙŠÙ„</button>
                        <button id="simPause">â¸ Ø¥ÙŠÙ‚Ø§Ù</button>
                        <button id="simReset">â¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                    `;
                    container.appendChild(simControls);
                    
                    const simInfo = document.createElement('div');
                    simInfo.className = 'sim-info';
                    simInfo.innerHTML = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©';
                    simInfo.id = 'simInfo';
                    container.appendChild(simInfo);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
                    document.getElementById('simPlay').addEventListener('click', () => {
                        startGcodeSimulation();
                    });
                    
                    document.getElementById('simPause').addEventListener('click', () => {
                        if (gcodeSimAnimationId) {
                            cancelAnimationFrame(gcodeSimAnimationId);
                            gcodeSimAnimationId = null;
                            document.getElementById('simInfo').innerHTML = 'Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ù…ØªÙˆÙ‚ÙØ©';
                        }
                    });
                    
                    document.getElementById('simReset').addEventListener('click', () => {
                        if (gcodeSimAnimationId) {
                            cancelAnimationFrame(gcodeSimAnimationId);
                            gcodeSimAnimationId = null;
                        }
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø©
                        gcodeSimScene.tool.position.set(0, 0, 0.5);
                        gcodeSimScene.pathPoints.length = 0;
                        gcodeSimScene.path.geometry.setFromPoints(gcodeSimScene.pathPoints);
                        document.getElementById('simInfo').innerHTML = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©';
                    });
                    
                    // ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØµÙŠÙŠØ±
                    function animate() {
                        requestAnimationFrame(animate);
                        controls.update();
                        renderer.render(scene, camera);
                    }
                    
                    animate();
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø­Ø¬Ù… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø©
                    window.addEventListener('resize', () => {
                        camera.aspect = container.clientWidth / container.clientHeight;
                        camera.updateProjectionMatrix();
                        renderer.setSize(container.clientWidth, container.clientHeight);
                    });
                    
                    showToast('âœ… ØªÙ… ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©:', error);
                    container.innerHTML = '<div class="loading">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</div>';
                    showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
                }
            }, 100);
        }
        
        /**
         * Ø¨Ø¯Ø¡ Ù…Ø­Ø§ÙƒØ§Ø© G-code
         */
        function startGcodeSimulation() {
            if (!gcodeSimScene) {
                showToast('âš ï¸ ÙŠØ±Ø¬Ù‰ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            const gcode = document.getElementById('gcodeOut').value;
            if (!gcode || gcode.trim() === '') {
                showToast('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ G-code Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©');
                return;
            }
            
            const lines = gcode.split('\n');
            const tool = gcodeSimScene.tool;
            const path = gcodeSimScene.path;
            const pathPoints = gcodeSimScene.pathPoints;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø±
            pathPoints.length = 0;
            path.geometry.setFromPoints(pathPoints);
            
            let currentX = 0;
            let currentY = 0;
            let currentZ = 0.5;
            
            let lineIndex = 0;
            const simInfo = document.getElementById('simInfo');
            
            function simulateLine() {
                if (lineIndex >= lines.length) {
                    gcodeSimAnimationId = null;
                    simInfo.innerHTML = 'Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©';
                    return;
                }
                
                const line = lines[lineIndex].trim();
                lineIndex++;
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
                simInfo.innerHTML = `Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø³Ø·Ø± ${lineIndex} Ù…Ù† ${lines.length}`;
                
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ø­Ø±ÙƒØ© G-code
                if (line.startsWith('G1') || line.startsWith('G0')) {
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù…Ù† Ø³Ø·Ø± G-code
                    const xMatch = line.match(/X([\d.-]+)/);
                    const yMatch = line.match(/Y([\d.-]+)/);
                    const zMatch = line.match(/Z([\d.-]+)/);
                    
                    if (xMatch) currentX = parseFloat(xMatch[1]) / 10; // ØªØ­ÙˆÙŠÙ„ Ù…Ù† Ù…Ù… Ø¥Ù„Ù‰ ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ù‡Ø¯
                    if (yMatch) currentY = parseFloat(yMatch[1]) / 10;
                    if (zMatch) currentZ = parseFloat(zMatch[1]) / 10 + 0.5;
                    
                    // ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø£Ø¯Ø§Ø©
                    tool.position.set(currentX, currentY, currentZ);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø·Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø±
                    pathPoints.push(new THREE.Vector3(currentX, currentY, currentZ));
                    path.geometry.setFromPoints(pathPoints);
                }
                
                // Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
                gcodeSimAnimationId = setTimeout(simulateLine, 50);
            }
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
            simulateLine();
        }

        // ========== ØªÙˆÙ„ÙŠØ¯ G-code ==========
        
        document.getElementById('btnGen').addEventListener('click', () => {
            if (!grayMat || !previewCanvas) {
                showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            try {
                // Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                const workWidth = parseFloat(document.getElementById('workWidth').value) || 30;
                const workHeight = parseFloat(document.getElementById('workHeight').value) || 20;
                const workDepth = parseFloat(document.getElementById('workDepth').value) || 3;
                const originX = parseFloat(document.getElementById('originX').value) || 0;
                const originY = parseFloat(document.getElementById('originY').value) || 0;
                const feedRate = parseFloat(document.getElementById('feedRate').value) || 800;
                const safeZ = parseFloat(document.getElementById('safeZ').value) || 5;
                const invertZ = document.getElementById('invertZ').value === 'yes';
                const scanDir = document.getElementById('scanDir').value;
                const stepOver = parseFloat(document.getElementById('stepOver').value) || 5;
                const maxDepth = parseFloat(document.getElementById('maxDepth').value) || 3;
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¥Ù„Ù‰ Ù…Ù…
                const workWidthMm = cmToMm(workWidth);
                const workHeightMm = cmToMm(workHeight);
                const originXMm = cmToMm(originX);
                const originYMm = cmToMm(originY);
                
                // Ø­Ø³Ø§Ø¨ Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØ­Ø¬ÙŠÙ…
                const scaleX = workWidthMm / previewCanvas.width;
                const scaleY = workHeightMm / previewCanvas.height;
                
                // Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                document.getElementById('genProgress').style.width = '0%';
                
                // ØªÙˆÙ„ÙŠØ¯ G-code
                let gcode = `; G-code generated by CNC AI\n`;
                gcode += `; Work area: ${workWidthMm.toFixed(1)} x ${workHeightMm.toFixed(1)} mm\n`;
                gcode += `; Material depth: ${workDepth.toFixed(1)} mm\n`;
                gcode += `; Feed rate: ${feedRate} mm/min\n`;
                gcode += `; Step over: ${stepOver} mm\n\n`;
                
                // Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                gcode += `G21 ; Set units to mm\n`;
                gcode += `G90 ; Absolute positioning\n`;
                gcode += `G17 ; XY plane\n`;
                gcode += `G94 ; Feed per minute\n\n`;
                
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                gcode += `G0 Z${safeZ.toFixed(3)} ; Move to safe Z\n`;
                gcode += `G0 X${originXMm.toFixed(3)} Y${originYMm.toFixed(3)} ; Move to origin\n\n`;
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø­
                const stepOverPx = stepOver / scaleX;
                const maxDepthFactor = maxDepth / 255;
                const totalSteps = Math.ceil(previewCanvas.height / stepOverPx);
                let currentStep = 0;
                
                if (scanDir === 'x') {
                    // Ù…Ø³Ø­ Ø£ÙÙ‚ÙŠ
                    for (let y = 0; y < previewCanvas.height; y += stepOverPx) {
                        let lastZ = safeZ;
                        let isCutting = false;
                        
                        for (let x = 0; x < previewCanvas.width; x++) {
                            const grayValue = sampleGrayAt(x, y);
                            const depth = (255 - grayValue) * maxDepthFactor;
                            const targetZ = invertZ ? -depth : depth;
                            
                            const targetX = originXMm + x * scaleX;
                            const targetY = originYMm + y * scaleY;
                            
                            if (targetZ > 0 && !isCutting) {
                                // Ø¨Ø¯Ø¡ Ø§Ù„Ù‚Ø·Ø¹
                                gcode += `G1 Z${targetZ.toFixed(3)} F${feedRate / 2} ; Start cutting\n`;
                                isCutting = true;
                                lastZ = targetZ;
                            } else if (targetZ <= 0 && isCutting) {
                                // Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„Ù‚Ø·Ø¹
                                gcode += `G1 Z${safeZ.toFixed(3)} ; Stop cutting\n`;
                                isCutting = false;
                                lastZ = safeZ;
                            }
                            
                            if (isCutting) {
                                gcode += `G1 X${targetX.toFixed(3)} Y${targetY.toFixed(3)} Z${targetZ.toFixed(3)} F${feedRate}\n`;
                            } else {
                                gcode += `G0 X${targetX.toFixed(3)} Y${targetY.toFixed(3)} ; Move without cutting\n`;
                            }
                            
                            lastZ = targetZ;
                        }
                        
                        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ
                        if (isCutting) {
                            gcode += `G1 Z${safeZ.toFixed(3)} ; Lift tool\n`;
                            isCutting = false;
                        }
                        
                        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                        currentStep++;
                        document.getElementById('genProgress').style.width = `${(currentStep / totalSteps) * 100}%`;
                    }
                } else {
                    // Ù…Ø³Ø­ Ø±Ø£Ø³ÙŠ
                    for (let x = 0; x < previewCanvas.width; x += stepOverPx) {
                        let lastZ = safeZ;
                        let isCutting = false;
                        
                        for (let y = 0; y < previewCanvas.height; y++) {
                            const grayValue = sampleGrayAt(x, y);
                            const depth = (255 - grayValue) * maxDepthFactor;
                            const targetZ = invertZ ? -depth : depth;
                            
                            const targetX = originXMm + x * scaleX;
                            const targetY = originYMm + y * scaleY;
                            
                            if (targetZ > 0 && !isCutting) {
                                // Ø¨Ø¯Ø¡ Ø§Ù„Ù‚Ø·Ø¹
                                gcode += `G1 Z${targetZ.toFixed(3)} F${feedRate / 2} ; Start cutting\n`;
                                isCutting = true;
                                lastZ = targetZ;
                            } else if (targetZ <= 0 && isCutting) {
                                // Ø§Ù„ØªÙˆÙ‚Ù Ø¹Ù† Ø§Ù„Ù‚Ø·Ø¹
                                gcode += `G1 Z${safeZ.toFixed(3)} ; Stop cutting\n`;
                                isCutting = false;
                                lastZ = safeZ;
                            }
                            
                            if (isCutting) {
                                gcode += `G1 X${targetX.toFixed(3)} Y${targetY.toFixed(3)} Z${targetZ.toFixed(3)} F${feedRate}\n`;
                            } else {
                                gcode += `G0 X${targetX.toFixed(3)} Y${targetY.toFixed(3)} ; Move without cutting\n`;
                            }
                            
                            lastZ = targetZ;
                        }
                        
                        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ
                        if (isCutting) {
                            gcode += `G1 Z${safeZ.toFixed(3)} ; Lift tool\n`;
                            isCutting = false;
                        }
                        
                        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                        currentStep++;
                        document.getElementById('genProgress').style.width = `${(currentStep / totalSteps) * 100}%`;
                    }
                }
                
                // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                gcode += `\nG0 Z${safeZ.toFixed(3)} ; Lift tool\n`;
                gcode += `G0 X${originXMm.toFixed(3)} Y${originYMm.toFixed(3)} ; Return to origin\n`;
                gcode += `M30 ; End program\n`;
                
                // Ø¹Ø±Ø¶ G-code
                document.getElementById('gcodeOut').value = gcode;
                
                // ØªÙ…ÙƒÙŠÙ† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©
                document.getElementById('gcodeSimTab').disabled = false;
                isGcodeGenerated = true;
                
                // Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ
                const lineCount = gcode.split('\n').length;
                const estMinutes = Math.round(lineCount * 0.05);
                document.getElementById('estTime').innerHTML = 
                    `â± ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ: ${estMinutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
                
                showToast('âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ G-code Ø¨Ù†Ø¬Ø§Ø­');
            } catch (e) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ G-code:', e);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ G-code');
            }
        });
        
        // Ø²Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹
        document.getElementById('btnQuick').addEventListener('click', () => {
            // ØªØ¹ÙŠÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø³Ø±ÙŠØ¹Ø©
            document.getElementById('workWidth').value = 15;
            document.getElementById('workHeight').value = 10;
            document.getElementById('stepOver').value = 2;
            document.getElementById('maxDepth').value = 1;
            
            updateDimensionDisplay();
            showToast('âš¡ ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹');
        });
        
        // Ø²Ø± ØªØ­Ù…ÙŠÙ„ G-code
        document.getElementById('btnDownload').addEventListener('click', () => {
            const gcode = document.getElementById('gcodeOut').value;
            
            if (!gcode || gcode.trim() === '') {
                showToast('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ G-code Ù„ØªØ­Ù…ÙŠÙ„Ù‡');
                return;
            }
            
            const blob = new Blob([gcode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cnc_ai_gcode.nc';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('ğŸ’¾ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù G-code');
        });

        // ========== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ==========
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
            updateDimensionDisplay();
            
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
            setTimeout(() => {
                showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹! ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ ØµÙˆØ±Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„', 3000);
            }, 1000);
        });
    </script>
</body>
</html>
