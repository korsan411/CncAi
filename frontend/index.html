<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>CncAi Preview</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #121212;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background: #1e1e1e;
      width: 100%;
      padding: 15px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      color: #00e0ff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }
    .controls {
      margin: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }
    button, input[type=file] {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #00e0ff;
      color: #000;
      font-weight: bold;
      transition: 0.3s;
    }
    button:hover {
      background: #00b8cc;
    }
    .preview {
      margin-top: 15px;
      background: #222;
      padding: 10px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.7);
      max-width: 90%;
      max-height: 70vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    canvas, img {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <header>🔧 CncAi Preview</header>

  <div class="controls">
    <input type="file" id="upload" accept="image/*">
    <button onclick="showOriginal()">الصورة الأصلية</button>
    <button onclick="show2D()">معاينة 2D</button>
    <button onclick="showHeatmap()">Heatmap</button>
    <button onclick="show3D()">معاينة 3D</button>
  </div>

  <div class="preview" id="previewArea">
    <p>قم برفع صورة للمعاينة</p>
  </div>

  <!-- Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    let uploadedImage = null;
    let heatmapCanvas = null;
    let scene, camera, renderer, controls, mesh;

    document.getElementById('upload').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        uploadedImage = new Image();
        uploadedImage.src = ev.target.result;
        uploadedImage.onload = () => {
          showOriginal();
        };
      };
      reader.readAsDataURL(file);
    });

    function clearPreview() {
      const area = document.getElementById("previewArea");
      area.innerHTML = "";
    }

    function showOriginal() {
      if (!uploadedImage) return;
      clearPreview();
      const img = document.createElement("img");
      img.src = uploadedImage.src;
      document.getElementById("previewArea").appendChild(img);
    }

    function show2D() {
      if (!uploadedImage) return;
      clearPreview();
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = uploadedImage.width;
      canvas.height = uploadedImage.height;
      ctx.drawImage(uploadedImage, 0, 0);
      document.getElementById("previewArea").appendChild(canvas);
    }

    function showHeatmap() {
      if (!uploadedImage) return;
      clearPreview();
      heatmapCanvas = document.createElement("canvas");
      const ctx = heatmapCanvas.getContext("2d");
      heatmapCanvas.width = uploadedImage.width;
      heatmapCanvas.height = uploadedImage.height;
      ctx.drawImage(uploadedImage, 0, 0);
      const imgData = ctx.getImageData(0, 0, heatmapCanvas.width, heatmapCanvas.height);
      const data = imgData.data;
      for (let i = 0; i < data.length; i += 4) {
        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
        data[i] = avg;     // R
        data[i+1] = 0;     // G
        data[i+2] = 255-avg; // B
      }
      ctx.putImageData(imgData, 0, 0);
      document.getElementById("previewArea").appendChild(heatmapCanvas);
    }

    function show3D() {
      if (!uploadedImage) return;
      clearPreview();

      // إعداد المشهد
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(500, 500);
      document.getElementById("previewArea").appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      const geometry = new THREE.PlaneGeometry(10, 10, 100, 100);
      const material = new THREE.MeshPhongMaterial({ color: 0x00e0ff, wireframe: false });
      mesh = new THREE.Mesh(geometry, material);
      scene.add(mesh);

      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(0, 10, 10);
      scene.add(light);

      camera.position.z = 15;

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();
    }
  </script>
</body>
</html>
