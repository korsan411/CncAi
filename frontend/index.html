<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNC AI - النسخة المتطورة مع التحليلات المتقدمة</title>
  <style>
    :root {
      --primary-color: #4a90e2;
      --secondary-color: #67b0f5;
      --bg-color: #f8f9fa;
      --text-color: #212529;
      --card-bg: #ffffff;
      --border-color: #dee2e6;
      --header-bg: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      --header-text: #ffffff;
      --button-bg: #e9ecef;
      --button-hover: #dee2e6;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --error-color: #dc3545;
      --ai-color: #9c27b0;
      --wood-color: #8b4513;
      --tab-inactive: #e9ecef;
      --tab-active: var(--primary-color);
      --analysis-color: #17a2b8;
      --roughing-color: #8b4513;
      --finishing-color: #5a2d0c;
      --smoothing-color: #3d2108;
      --drawing-color: #ff5722;
      --refill-color: #795548;
    }

    body.dark {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --card-bg: #1e1e1e;
      --border-color: #444;
      --header-bg: linear-gradient(90deg, #2c2c2c, #444);
      --button-bg: #333;
      --button-hover: #555;
      --ai-color: #ba68c8;
      --wood-color: #a0522d;
      --tab-inactive: #333;
      --tab-active: #4a90e2;
      --analysis-color: #138496;
      --roughing-color: #a0522d;
      --finishing-color: #8b4513;
      --smoothing-color: #5a2d0c;
      --drawing-color: #ff8a65;
      --refill-color: #8d6e63;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      transition: all 0.3s ease;
      padding: 0;
      margin: 0;
    }

    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 1rem;
      text-align: center;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      max-width: 1400px;
    }

    h1 {
      font-size: 1.8rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    #themeToggle {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--header-text);
      transition: transform 0.3s;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #themeToggle:hover {
      transform: scale(1.1);
      background: rgba(255, 255, 255, 0.2);
    }

    /* تنسيق التابات */
    .tabs {
      display: flex;
      margin-bottom: 20px;
      background: var(--card-bg);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tab {
      padding: 12px 20px;
      cursor: pointer;
      background: var(--tab-inactive);
      transition: all 0.3s;
      text-align: center;
      flex: 1;
      font-weight: 500;
    }

    .tab.active {
      background: var(--tab-active);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* محتوى التابات */
    .upload-section {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      text-align: center;
      border: 1px solid var(--border-color);
    }

    .previews-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    @media (min-width: 992px) {
      .previews-container {
        grid-template-columns: 1fr 1fr;
      }
    }

    .preview-block {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid var(--border-color);
    }

    .preview-title {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--primary-color);
    }

    .preview-content {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }

    canvas {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    #preview3d {
      width: 100%;
      height: 300px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: relative;
    }

    .options {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      width: 100%;
      margin-top: 1rem;
    }

    .option-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    .option-group label {
      font-size: 0.9rem;
      font-weight: 500;
    }

    input[type="range"] {
      width: 150px;
      accent-color: var(--primary-color);
    }

    .settings-panel {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .settings-group {
      margin-bottom: 1.5rem;
    }

    .settings-group h3 {
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .form-group select, 
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background: var(--bg-color);
      color: var(--text-color);
    }

    .gcode-output {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 15px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre-wrap;
      margin-top: 1rem;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: var(--secondary-color);
    }

    .btn-secondary {
      background: var(--button-bg);
      color: var(--text-color);
    }

    .btn-secondary:hover {
      background: var(--button-hover);
    }

    .btn-ai {
      background: var(--ai-color);
      color: white;
    }

    .btn-ai:hover {
      background: #7b1fa2;
    }

    .btn-analysis {
      background: var(--analysis-color);
      color: white;
    }

    .btn-analysis:hover {
      background: #138496;
    }

    .btn-roughing {
      background: var(--roughing-color);
      color: white;
    }

    .btn-finishing {
      background: var(--finishing-color);
      color: white;
    }

    .btn-smoothing {
      background: var(--smoothing-color);
      color: white;
    }

    .btn-drawing {
      background: var(--drawing-color);
      color: white;
    }

    .btn-refill {
      background: var(--refill-color);
      color: white;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    footer {
      text-align: center;
      margin-top: 3rem;
      padding: 1.5rem;
      color: var(--text-color);
      font-size: 0.9rem;
      border-top: 1px solid var(--border-color);
    }

    .image-enhancement {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .enhancement-btn {
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background: var(--button-bg);
      color: var(--text-color);
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }

    .enhancement-btn:hover {
      background: var(--button-hover);
    }

    .loading {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      z-index: 100;
      border-radius: 8px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      background: var(--success-color);
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(100%);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .notification.show {
      transform: translateX(0);
      opacity: 1;
    }

    .notification.error {
      background: var(--error-color);
    }

    .notification.ai {
      background: var(--ai-color);
    }

    .notification.analysis {
      background: var(--analysis-color);
    }

    .ai-options {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .path-optimization {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 1rem;
    }

    .optimization-option {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .optimization-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .progress-container {
      width: 100%;
      background-color: var(--border-color);
      border-radius: 5px;
      margin: 15px 0;
      display: none;
    }

    .progress-bar {
      width: 0%;
      height: 20px;
      background-color: var(--primary-color);
      border-radius: 5px;
      transition: width 0.3s ease;
    }

    .edge-detection {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .analysis-panel {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      display: none;
    }

    .analysis-results {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .analysis-item {
      background: var(--bg-color);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .analysis-item h4 {
      margin-bottom: 0.5rem;
      color: var(--analysis-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .analysis-value {
      font-size: 1.2rem;
      font-weight: bold;
    }

    .gcode-preview {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 极速4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 极速1px solid var(--border-color);
      display: none;
    }

    .gcode-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat-item {
      background: var(--bg-color);
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      text-align: center;
    }

    .stat-item h4 {
     极速margin-bottom: 0.5rem;
      color: var(--primary-color);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
    }

    .wood-stages {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .wood-stage {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      border: 1px solid var(--border-color);
    }

    .wood-stage h3 {
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .advanced-settings {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .path-preview {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .path-preview-content {
      width: 100%;
      height: 300px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: var(--bg-color);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-top: 1rem;
      position: relative;
      overflow: hidden;
    }

    .path-s极速vg {
      width: 100%;
      height: 100%;
    }

    .path-controls {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      justify-content: center;
    }

    .drawing-tools {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 1rem 0;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: 8极速;
      border: 1px solid var(--border-color);
    }

    .drawing-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .drawing-instructions {
      font-size: 0.9rem;
      color: var(--text-color);
      text-align: center;
      margin-top: 0.5rem;
    }

    .drawing-canvas-container {
      position: relative;
      width: 100%;
      height: 300px;
      margin-top: 1rem;
    }

    #drawingCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }

    .manual-selection {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 1.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,极速0.05);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
    }

    .filename-input {
      margin-top: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filename-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      background: var(--bg-color);
      color: var(--text-color);
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.4rem;
      }
      
      .header-content {
        flex-direction: column;
        gap: 15px;
      }
      
      .preview-block {
        padding: 1rem;
      }
      
      .options {
        flex-direction: column;
        align-items: center;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .analysis-results, .gcode-stats {
        grid-template-columns: 1fr;
      }

      .wood-stages {
        grid-template-columns: 1fr;
      }

      .drawing-controls {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class极速="header-content">
      <h1><span>🛠️</span> CNC AI - النسخة المحسنة</h1>
      <div class="controls">
        <button id="themeToggle">🌙</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- التابات -->
    <div class="tabs">
      <div class="tab active" data-tab="preview">معاينة الصورة</div>
      <div class="tab" data-tab="gcode">G-code إعدادات</div>
      <div class="tab" data-tab="advanced">إعدادات متقدمة</div>
    </div>

    <!-- تاب المعاينة -->
    <div class="tab-content active" id="preview-tab">
      <section class="upload-section">
        <h2 class="upload-title">📤 تحميل الصورة</h2>
        <div class="file-upload">
          <input type="file" id="fileInput" accept="image/*">
          <label for="fileInput"><span>📁</span> اختر صورة</label>
          <div class="file-name" id="fileName">لم يتم اختيار أي صورة بعد</div>
        </div>

        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="image-enhancement">
          <div class="enhancement-btn" onclick="applyEnhancement('brightness')">🔆 سطوع</div>
          <div class="enhancement-btn" onclick="applyEnhancement('contrast')">🌓 تباين</div>
          <div class="enhancement-btn" onclick="applyEnhancement('sharpen')">🔍 حدة</div>
          <div class="enhancement-btn" onclick="applyEnhancement('smooth')">🔄 نعومة</div>
          <div class="enhancement-btn" onclick="applyEnhancement('grayscale')">⚫ تدرج رمادي</div>
          <div class="enhancement-btn" onclick="applyEnhancement('reset')">🔄 إعادة تعيين</div>
        </div>

        <div class="edge-detection">
          <div class="enhancement-btn" onclick="detectEdges('sobel')">🔍 كشف الحواف (Sobel)</div>
          <div class="enhancement-btn" onclick="detectEdges('canny')">🔍 كشف الحواف (Canny)</div>
          <div class="enhancement-btn" onclick="detectEdges('laplacian')">🔍 كشف الحواف (Laplacian)</div>
        </div>
      </section>

      <div class="previews-container">
        <!-- الصورة الأصلية -->
        <div class="preview-block">
          <h3 class="preview-title">📷 الصورة الأصلية</h3>
          <div class="preview-content">
            <canvas id="preview2d"></canvas>
          </div>
        </div>

        <!-- معاينة 3D -->
        <div class="preview-block">
          <h3 class="preview-title">🌀 المعاينة ثلاثية الأبعاد</h3>
          <div class="preview-content">
            <div id="preview3d">
              <div class="loading" id="loading3d">
                <div class="loading-spinner"></div>
                <p>جاري تحميل النموذج...</p>
              </div>
            </div>
          </div>
          <div class="options">
            <div class="option-group">
              <label for="rotationSpeed">🔄 سرعة الدوران</label>
              <input type="range" id="rotationSpeed" min="0" max="0.05" step="0.001" value="0.01">
            </div>
            <div class="option-group">
              <label for="zoomControl">🔍 زوم</label>
              <input type="range" id="zoomControl" min="50" max="500" step="10" value="200">
            </div>
            <div class="option-group">
              <label for="heightIntensity">📏 شدة الارتفاع</label>
              <input type="range" id="heightIntensity" min="20" max="200" step="5" value="80">
            </div>
          </div>
        </div>

        <!-- Heatmap -->
        <div class="preview-block">
          <h3 class="preview-title">🌈 خريطة الارتفاعات (Heatmap)</h3>
          <div class="preview-content">
            <canvas id="heatmap"></canvas>
          </div>
          <div class="colormap-controls">
            <button class="btn btn-secondary" onclick="setColormap('jet')"><span>🌈</span> Jet</button>
            <button class="btn btn-secondary" onclick="setColormap('hot')"><span>🔥</span> Hot</button>
            <button class="btn btn-secondary" onclick="setColormap('cool')"><span>❄️</span> Cool</button>
            <button class="btn btn-secondary" onclick="setColormap('gray')"><span>⚪</span> Gray</button>
          </div>
        </div>

        <!-- حواف الصورة -->
        <div class="preview-block">
          <h3 class="preview-title">🔍 حواف الصورة</h3>
          <div class="preview-content">
            <canvas id="edgesCanvas"></canvas>
          </div>
          <div class="options">
            <div class="option-group">
              <label for="edgeThreshold">📊 عتبة الحواف</label>
              <input type="range" id="edgeThreshold" min="1" max="100" step="1" value="50" oninput="updateEdgeDetection()">
            </div>
          </div>
        </div>

        <!-- تحديد المناطق يدوياً -->
        <div class="preview-block">
          <h3 class="preview-title">✏️ تحديد المناطق يدوياً</h3>
          <div class="preview-content">
            <div class="drawing-canvas-container">
              <canvas id="drawingCanvas"></canvas>
            </div>
          </div>
          <div class="drawing-tools">
            <div class="drawing-controls">
              <button class="btn btn-drawing" id="startDrawing">
                <span>✏️</span> بدء الرسم
              </button>
              <button class="btn btn-secondary" id="clearDrawing">
                <span>🗑️</span> مسح الرسم
              </button>
              <button class="btn btn-primary" id="applyDrawing">
                <span>✅</span> تطبيق الرسم
              </button>
            </div>
            <div class="drawing-instructions">
              <p>ارسم المنطقة التي تريد قطعها. اضغط على "بدء الرسم" لبدء الرسم، ثم انقر واسحب لرسم المنطقة.</p>
            </div>
            <div class="options">
              <div class="option-group">
                <label for="brushSize">📏 حجم الفرشاة</label>
                <input type="range" id="brushSize" min="1" max="20" step="1" value="5">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- تاب إعدادات G-code -->
    <div class="tab-content" id="gcode-tab">
      <div class="ai-options">
        <h3><span>🤖</span> خيارات الذكاء الاصطناعي</h3>
        <div class="path-optimization">
          <div class="optimization-option">
            <input type="checkbox" id="optimizePaths" checked>
            <label for="optimizePaths">تحسين المسارات لتقليل وقت القطع</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="smoothEdges" checked>
            <label for="smoothEdges">تنعيم الحواف للنتائج الأفضل</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="adaptivePrecision">
            <label for="adaptivePrecision">الدقة التكيفية (تلقائية)</label>
          </极速div>
          <div class="optimization-option">
            <input type="checkbox" id="useEdges" checked>
            <label for="useEdges">استخدام حواف الصورة لتوليد المسارات</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useHeatmap" checked>
            <label for="useHeatmap">استخدام Heatmap لتوليد المسارات</label>
          </div>
          <div class="optimization-option">
            <极速input type="checkbox" id="startFromEdges" checked>
            <label for="startFromEdges">بدء القطع من الحواف</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useManualSelection">
            <label for="useManualSelection">استخدام التحديد اليدوي للمناطق</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useRefillMode">
            <label for="useRefillMode">وضع الـ Refill (للخشب فقط)</label>
          </div>
        </div>
      </div>

      <div class="settings-panel">
        <div class="settings-group">
          <h3><span>🏭</span> إعدادات الماكينة</h3>
          <div class="form-group">
            <label for="machineType">نوع الماكينة</label>
            <select id="machineType">
              <option value="cnc">CNC Router</option>
              <option value="laser">Laser Cutter</option>
              <option value="3dprinter">3D Printer</option>
            </select>
          </div>
        </div>

        <div class="settings-group">
          <h3><span>📦</span> إعدادات الخامة</h3>
          <div class="form-group">
            <label for="materialType">نوع الخامة</label>
            <select id="materialType">
              <option value="wood">خشب</option>
              <option value="refill">Refill خشب</option>
              <option value="acrylic">أكريليك</option>
              <option value="aluminum">ألومنيوم</option>
              <option value="steel">صلب</option>
              <option value="pla">PLA (بلاستيك)</option>
              <option value="abs">ABS (بلاستيك)</option>
            </select>
          </div>
          <div class="form-group" id="refillSettings">
            <label for="refillDepth">عمق الـ Refill (mm)</label>
            <input type="number" id="refillDepth" value="5" step="0.1">
          </div>
        </div>

        <div class="settings-group">
          <h3><span>⚙️</span> إعدادات القطع</h3>
          <div class="form-group">
            <label for="feedRate">سرعة التغذية (mm/min)</label>
            <input type="number" id="feedRate" value="1000">
          </div>
          <div class="form-group">
            <label for="spindleSpeed">سرعة المغزل (RPM)</label>
            <input type="number" id="spindleSpeed" value="10000">
          </div>
          <div class="form-group">
            <label for极速="cutDepth">عمق القطع (mm)</label>
            <input type="number" id="cutDepth" value="2" step="0.1">
          </div>
          <div class="form-group">
            <label for="passDepth">عمق التمريرة (mm)</label>
            <input type="number" id="passDepth" value="0.5" step="0.1">
          </div>
        </div>

        <div class="settings-group">
          <h3><span>🔧</span> إعدادات G-code</h3>
          <div class="form-group">
            <label for="gcodeType">نوع المخرجات</label>
            <select id="gcode极速Type">
              <option value="heatmap">بناءً على Heatmap</option>
              <option value="3dmodel">بناءً على النموذج ثلاثي الأبعاد</option>
              <option value="edges">بناءً على الحواف</option>
              <option value="manual">بناءً على التحديد اليدوي</option>
            </select>
          </div>
          <div class="form-group">
            <label for="precision">الدقة (mm)</label>
            <input type="number" id="precision" value="0.1" step="0.01">
          </div>
          <div class="form-group">
            <label for="toolDiameter">قطر الأداة (mm)</label>
            <input type="number" id="toolDiameter" value="3.175" step="0.01">
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" onclick="generateGcode()"><span>⚙️</span> توليد G-code</button>
        <button class="btn btn-secondary" onclick="simulateCutting()"><span>🎬</span> محاكاة القطع</button>
        <button class="btn btn-secondary" onclick="saveGcode()"><span>💾</span> حفظ G-code</button>
        <button class="btn btn-analysis" onclick="analyzeGcode()"><span>📊</span> تحليل G-code</button>
      </div>

      <div class="gcode-output" id="gcodeOutput">
        // G-code سيظهر هنا
      </div>

      <div class="analysis-panel" id="analysisPanel">
        <h3><span>📊</span> نتائج التحليل</h3>
        <div class="analysis-results">
          <div class="analysis-item">
            <h4><span>⏱️</span> الوقت المتوقع</h4>
            <div class="analysis-value" id="estimatedTime">--:--</div>
          </div>
          <div class="analysis-item">
            <h4><span>📏</span> الطول الإجمالي</h4>
            <div class="analysis-value" id="totalLength">0 mm</div>
          </div>
          <div class="analysis-item">
            <h4><span>🔄</span> عدد التمريرات</h4>
            <div class="analysis-value" id="passCount">0</div>
          </div>
          <div class="analysis-item">
            <h4><span>⚡</span> استهلاك الطاقة</h4>
            <div class="analysis-value" id="powerUsage">0 kWh</div>
          </div>
        </div>
      </div>

      <div class="gcode-preview" id="gcodePreview">
        <h3><span>📋</span> إحصائيات G-code</h3>
        <div class="gcode-stats">
          <div class="stat-item">
            <h4>عدد الأسطر</h4>
            <div class="stat-value" id="lineCount">0</div>
          </div>
          <div class="stat-item">
            <h4>أسرع حركة</h4>
            <div class="stat-value" id="fastestMove">0 mm/min</div>
          </div>
          <div class="stat-item">
            <h4>أبطأ حركة</h4>
            <div class="stat-value" id="slowestMove">0 mm/min</div>
          </div>
          <div class="stat-item">
            <h4>متوسط السرعة</h4>
            <div class="stat-value" id="averageSpeed">0 mm/min</div>
          </div>
        </div>
      </div>
    </div>

    <!-- تاب الإعدادات المتقدمة -->
    <div class="tab-content" id="advanced-tab">
      <div class="advanced-settings">
        <h3><span>🔍</span> إعدادات متقدمة</h3>
        <div class="settings-group">
          <div class="form-group">
            <label for="contourLevels">عدد مستويات الكنتور</label>
            <input type="number" id="contourLevels" value="10" min="1" max="100">
          </div>
          <div class="form-group">
            <label for="contourSensitivity">حساسية الكنتور</label>
            <input type="range" id="contourSensitivity" min="1" max="100" value="50">
          </div>
          <div class="form-group">
            <label for="contourSmoothing">تنعيم الكنتور</label>
            <input type="range" id="contourSmoothing" min="1" max="100" value="30">
          </div>
        </div>
      </div>

      <div class="path-preview">
        <h3><span>🔄</span> معاينة المسارات</h3>
        <div class="path-preview-content">
          <svg class="path-svg" id="pathSvg"></svg>
        </div>
        <div class="path-controls">
          <button class="btn btn-secondary" onclick="showAllPaths()"><span>👁️</span> عرض جميع المسارات</button>
          <button class="btn btn-secondary" onclick="showOptimalPath()"><span>🔍</span> المسار الأمثل</button>
          <button class="btn btn-secondary" onclick="showRoughingPath()"><span>🪚</span> مسار التشكيل</button>
          <button class="btn btn-secondary" onclick="showFinishingPath()"><span>✨</span> مسار التشطيب</button>
        </div>
      </div>

      <div class="manual-selection">
        <h3><span>✋</span> تحديد المناطق يدوياً</h3>
        <p>يمكنك تحديد المناطق التي تريد قطعها يدوياً باستخدام أدوات الرسم.</p>
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="startManualSelection()"><span>✏️</span> بدء التحديد</button>
          <button class="btn btn-secondary" onclick="clearManualSelection()"><span>🗑️</span> مسح التحديد</button>
          <button class="btn btn-primary" onclick="applyManualSelection()"><span>✅</span> تطبيق التحديد</button>
        </div>
      </div>

      <div class="wood-stages">
        <div class="wood-stage">
          <h3><span>🪚</span> مرحلة التشكيل (Roughing)</h3>
          <div class="form-group">
            <label for="roughingTool">أداة التشكيل</label>
            <select id="roughingTool">
              <option value="6mm">6mm End Mill</option>
              <option value="8mm">8mm End Mill</option>
              <option value="10mm">10mm End Mill</option>
              <option value="12mm">12mm End Mill</option>
            </select>
          </div>
          <div class="form-group">
            <label for="roughingStepover">نسبة التداخل (%)</label>
            <input type="number" id="roughingStepover" value="50" min="10" max="80">
          </div>
          <div class="form-group">
            <label for="roughingDepth">عمق القطع (mm)</label>
            <input type="number" id="roughingDepth" value="2" step="0.1">
          </div>
          <button class="btn btn-roughing" onclick="generateRoughingPath()"><span>🔄</span> توليد مسار التشكيل</button>
        </div>

        <div class="wood-stage">
          <h3><span>✨</span> مرحلة التشطيب (Finishing)</h3>
          <div class="form-group">
            <label for="finishingTool">أداة التشطيب</label>
            <select id="finishingTool">
              <option value="3mm">3mm Ball Nose</option>
              <option value="4mm">4mm Ball Nose</option>
              <option value="6mm">6mm Ball Nose</option>
              <option value="8mm">8mm Ball Nose</option>
            </select>
          </div>
          <div class="form-group">
            <label for="finishingStepover">نسبة التداخل (%)</label>
            <input type="number" id="finishingStepover" value="10" min="5" max="30">
          </div>
          <div class="form-group">
            <label for="finishingDepth">عمق القطع (mm)</label>
            <input type="number" id="finishingDepth" value="0.5" step="0.1">
          </div>
          <button class="btn btn-finishing" onclick="generateFinishingPath()"><span>🔄</span> توليد مسار التشطيب</button>
        </div>

        <div class="wood-stage">
          <h3><span>🔍</span> مرحلة التنعيم (Smoothing)</h3>
          <div class="form-group">
            <label for="smoothingTool">أداة التنعيم</label>
            <select id="smoothingTool">
              <option value="1mm">1mm Ball Nose</option>
              <option value="2mm">2mm Ball Nose</option>
              <option value="3mm">3mm Ball Nose</option>
            </select>
          </div>
          <div class="form-group">
            <label for="smoothingStepover">نسبة التداخل (%)</label>
            <input type="number" id="smoothingStepover" value="5" min="2" max="15">
          </div>
          <div class="form-group">
            <label for="smoothingDepth">عمق القطع (mm)</label>
            <input type="number" id="smoothingDepth" value="0.2" step="0.05">
          </div>
          <button class="btn btn-smoothing" onclick="generateSmoothingPath()"><span>🔄</span> توليد مسار التنعيم</button>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" onclick="generateAllPaths()"><span>⚙️</span> توليد جميع المسارات</button>
        <button class="btn btn-secondary" onclick="simulateAllPaths()"><span>🎬</span> محاكاة جميع المسارات</button>
        <button class="btn btn-secondary" onclick="exportAllPaths()"><span>💾</span> تصدير جميع المسارات</button>
        <button class="btn btn-analysis" onclick="analyzeAllPaths()"><span>📊</span> تحليل جميع المسارات</button>
      </div>
    </div>
  </div>

  <footer>
    <p>CNC AI - النسخة المتطورة مع التحليلات المتقدمة | تم التطوير باستخدام HTML5, CSS3 و JavaScript</p>
  </footer>

  <div class="notification" id="notification">
    <span id="notificationMessage"></span>
  </div>

  <script>
    // المتغيرات العامة
    let originalImage = null;
    let currentImage = null;
    let modifiedImage = null;
    let edgesImage = null;
    let isDrawing = false;
    let isManualSelection = false;
    let drawingPoints = [];
    let manualSelectionPoints = [];
    let gcodeData = null;
    let currentColormap = 'jet';
    let threeDScene = null;
    let threeDRenderer = null;
    let threeDCamera = null;
    let threeDModel = null;
    let is3DInitialized = false;

    // تهيئة الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      initializeTabs();
      initializeDrawingCanvas();
      initializeEventListeners();
      initialize3DViewer();
      updateSliderValues();
    });

    // تهيئة التابات
    function initializeTabs() {
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          activateTab(tabId);
        });
      });
    }

    // تفعيل تاب معين
    function activateTab(tabId) {
      // إخفاء جميع المحتويات
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });

      // إلغاء تفعيل جميع التابات
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // تفعيل التاب المحدد
      document.getElementById(`${tabId}-tab`).classList.add('active');
      document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
    }

    // تهيئة لوحة الرسم
    function initializeDrawingCanvas() {
      const canvas = document.getElementById('drawingCanvas');
      const ctx = canvas.getContext('2d');
      
      // تعيين حجم الكانفاس
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
      
      // إعداد أدوات الرسم
      const startDrawingBtn = document.getElementById('startDrawing');
      const clearDrawingBtn = document.getElementById('clearDrawing');
      const applyDrawingBtn = document.getElementById('applyDrawing');
      const brushSize = document.getElementById('brushSize');
      
      startDrawingBtn.addEventListener('click', () => {
        isDrawing = true;
        startDrawingBtn.textContent = '⏹️ إيقاف الرسم';
        startDrawingBtn.classList.remove('btn-drawing');
        startDrawingBtn.classList.add('btn-secondary');
      });
      
      clearDrawingBtn.addEventListener('click', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawingPoints = [];
      });
      
      applyDrawingBtn.addEventListener('click', () => {
        isDrawing = false;
        startDrawingBtn.textContent = '✏️ بدء الرسم';
        startDrawingBtn.classList.remove('btn-secondary');
        startDrawingBtn.classList.add('btn-drawing');
        applyDrawingToImage();
      });
      
      // إضافة مستمعات الأحداث للرسم
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      
      // تحديث حجم الفرشاة
      brushSize.addEventListener('input', () => {
        ctx.lineWidth = brushSize.value;
      });
      
      // إعدادات الرسم الأولية
      ctx.lineWidth = brushSize.value;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)';
    }

    // بدء الرسم
    function startDrawing(e) {
      if (!isDrawing) return;
      
      const canvas = document.getElementById('drawingCanvas');
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      drawingPoints.push({x, y});
      
      const ctx = canvas.getContext('2d');
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    // الرسم
    function draw(e) {
      if (!isDrawing) return;
      
      const canvas = document.getElementById('drawingCanvas');
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      drawingPoints.push({x, y});
      
      const ctx = canvas.getContext('2d');
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    // إيقاف الرسم
    function stopDrawing() {
      if (!isDrawing) return;
      
      const ctx = document.getElementById('drawingCanvas').getContext('2d');
      ctx.closePath();
    }

    // تطبيق الرسم على الصورة
    function applyDrawingToImage() {
      if (drawingPoints.length === 0) {
        showNotification('لم تقم برسم أي منطقة', 'error');
        return;
      }
      
      showNotification('تم تطبيق الرسم على الصورة', 'success');
      // هنا سيتم تطبيق الرسم على الصورة
    }

    // تهيئة مستمعات الأحداث
    function initializeEventListeners() {
      // تحميل الملف
      const fileInput = document.getElementById('fileInput');
      fileInput.addEventListener('change', handleFileUpload);
      
      // تبديل المظهر
      const themeToggle = document.getElementById('themeToggle');
      themeToggle.addEventListener('click', toggleTheme);
      
      // تحديث قيم المنزلقات
      const sliders = document.querySelectorAll('input[type="range"]');
      sliders.forEach(slider => {
        slider.addEventListener('input', updateSliderValues);
      });
      
      // تحديث إعدادات Refill
      const materialType = document.getElementById('materialType');
      materialType.addEventListener('change', updateRefillSettings);
      
      // تحديث كشف الحواف
      const edgeThreshold = document.getElementById('edgeThreshold');
      edgeThreshold.addEventListener('input', updateEdgeDetection);
    }

    // تحديث قيم المنزلقات
    function updateSliderValues() {
      const sliders = document.querySelectorAll('input[type="range"]');
      sliders.forEach(slider => {
        const valueDisplay = document.getElementById(`${slider.id}Value`);
        if (valueDisplay) {
          valueDisplay.textContent = slider.value;
        }
      });
    }

    // تحديث إعدادات Refill
    function updateRefillSettings() {
      const materialType = document.getElementById('materialType').value;
      const refillSettings = document.getElementById('refillSettings');
      
      if (materialType === 'refill') {
        refillSettings.style.display = 'block';
      } else {
        refillSettings.style.display = 'none';
      }
    }

    // تبديل المظهر
    function toggleTheme() {
      document.body.classList.toggle('dark');
      const themeToggle = document.getElementById('themeToggle');
      
      if (document.body.classList.contains('dark')) {
        themeToggle.textContent = '☀️';
      } else {
        themeToggle.textContent = '🌙';
      }
    }

    // التعامل مع تحميل الملف
    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const fileName = document.getElementById('fileName');
      fileName.textContent = file.name;
      
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      
      progressContainer.style.display = 'block';
      
      // محاكاة تقدم التحميل
      let progress = 0;
      const interval = setInterval(() => {
        progress += 5;
        progressBar.style.width = `${progress}%`;
        
        if (progress >= 100) {
          clearInterval(interval);
          progressContainer.style.display = 'none';
          loadImage(file);
        }
      }, 50);
    }

    // تحميل الصورة
    function loadImage(file) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          originalImage = img;
          currentImage = img;
          displayImage(img);
          showNotification('تم تحميل الصورة بنجاح', 'success');
        };
        img.src = e.target.result;
      };
      
      reader.readAsDataURL(file);
    }

    // عرض الصورة
    function displayImage(img) {
      const canvas = document.getElementById('preview2d');
      const ctx = canvas.getContext('2d');
      
      // تعيين حجم الكانفاس
      canvas.width = 500;
      canvas.height = (img.height / img.width) * 500;
      
      // رسم الصورة
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      
      // إنشاء نسخة للصورة المعدلة
      modifiedImage = document.createElement('canvas');
      modifiedImage.width = canvas.width;
      modifiedImage.height = canvas.height;
      const modifiedCtx = modifiedImage.getContext('2d');
      modifiedCtx.drawImage(img, 0, 0, canvas.width, canvas.height);
      
      // إنشاء Heatmap
      generateHeatmap();
      
      // إنشاء حواف الصورة
      detectEdges('sobel');
      
      // تحديث العرض ثلاثي الأبعاد
      update3DView();
    }

    // تطبيق تحسينات على الصورة
    function applyEnhancement(type) {
      if (!currentImage) {
        showNotification('يرجى تحميل صورة أولاً', 'error');
        return;
      }
      
      const canvas = document.getElementById('preview2d');
      const ctx = canvas.getContext('2d');
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;
      
      switch(type) {
        case 'brightness':
          // زيادة السطوع
          for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.min(255, data[i] + 30);
            data[i+1] = Math.min(255, data[i+1] + 30);
            data[i+2] = Math.min(255, data[i+2] + 30);
          }
          break;
        case 'contrast':
          // زيادة التباين
          const factor = 1.5;
          for (let i = 0; i < data.length; i += 4) {
            data[i] = Math.min(255, Math.max(0, factor * (data[i] - 128) + 128));
            data[i+1] = Math.min(255, Math.max(0, factor * (data[i+1] - 128) + 128));
            data[i+2] = Math.min(255, Math.max(0, factor * (data[i+2] - 128) + 128));
          }
          break;
        case 'sharpen':
          // زيادة الحدة
          // تطبيق مرشح Sharpen البسيط
          const tempCanvas = document.createElement('canvas');
          const tempCtx = tempCanvas.getContext('2d');
          tempCanvas.width = canvas.width;
          tempCanvas.height = canvas.height;
          tempCtx.putImageData(imgData, 0, 0);
          
          ctx.filter = 'contrast(1.2) saturate(1.2)';
          ctx.drawImage(tempCanvas, 0, 0);
          ctx.filter = 'none';
          return;
        case 'smooth':
          // تنعيم الصورة
          ctx.filter = 'blur(1px)';
          ctx.drawImage(canvas, 0, 0);
          ctx.filter = 'none';
          return;
        case 'grayscale':
          // تحويل إلى تدرج رمادي
          for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i+1] + data[i+2]) / 3;
            data[i] = avg;
            data[i+1] = avg;
            data[i+2] = avg;
          }
          break;
        case 'reset':
          // إعادة تعيين الصورة
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
          return;
      }
      
      ctx.putImageData(imgData, 0, 0);
      showNotification(`تم تطبيق ${type} على الصورة`, 'success');
    }

    // كشف الحواف
    function detectEdges(type) {
      if (!currentImage) {
        showNotification('يرجى تحميل صورة أولاً', 'error');
        return;
      }
      
      const canvas = document.getElementById('edgesCanvas');
      const ctx = canvas.getContext('2d');
      
      // تعيين حجم الكانفاس
      canvas.width = document.getElementById('preview2d').width;
      canvas.height = document.getElementById('preview2d').height;
      
      // رسم الصورة الأصلية
      ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
      
      // الحصول على بيانات الصورة
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;
      
      // تطبيق خوارزمية كشف الحواف
      switch(type) {
        case 'sobel':
          applySobel(data, canvas.width, canvas.height);
          break;
        case 'canny':
          applyCanny(data, canvas.width, canvas.height);
          break;
        case 'laplacian':
          applyLaplacian(data, canvas.width, canvas.height);
          break;
      }
      
      ctx.putImageData(imgData, 0, 0);
      edgesImage = canvas.toDataURL();
      showNotification(`تم تطبيق ${type} لاكتشاف الحواف`, 'success');
    }

    // تطبيق مرشح Sobel
    function applySobel(data, width, height) {
      // تطبيق خوارزمية Sobel لكشف الحواف
      // هذه نسخة مبسطة لأغراض العرض
      
      const sobelData = new Uint8ClampedArray(data.length);
      
      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          const i = (y * width + x) * 4;
          
          // حساب التدرج في اتجاه X
          let gx = 
            -1 * getRed(data, width, x-1, y-1) + 
            1 * getRed(data, width, x+1, y-1) +
            -2 * getRed(data, width, x-1, y) +
            2 * getRed(data, width, x+1, y) +
            -1 * getRed(data, width, x-1, y+1) +
            1 * getRed(data, width, x+1, y+1);
          
          // حساب التدرج في اتجاه Y
          let gy = 
            -1 * getRed(data, width, x-1, y-1) +
            -2 * getRed(data, width, x, y-1) +
            -1 * getRed(data, width, x+1, y-1) +
            1 * getRed(data, width, x-1, y+1) +
            2 * getRed(data, width, x, y+1) +
            1 * getRed(data, width, x+1, y+1);
          
          // حساب حجم التدرج
          const magnitude = Math.min(255, Math.sqrt(gx * gx + gy * gy));
          
          // تعيين القيمة للبكسل
          sobelData[i] = magnitude;
          sobelData[i+1] = magnitude;
          sobelData[i+2] = magnitude;
          sobelData[i+3] = 255;
        }
      }
      
      // نسخ البيانات إلى الصورة الأصلية
      for (let i = 0; i < data.length; i++) {
        data[i] = sobelData[i];
      }
    }

    // تطبيق مرشح Canny
    function applyCanny(data, width, height) {
      // تطبيق خوارزمية Canny المبسطة
      // هذه نسخة مبسطة لأغراض العرض
      
      // أولاً: تطبيق مرشح Gaussian لتخفيف الضوضاء
      applyGaussian(data, width, height);
      
      // ثانياً: استخدام Sobel لاكتشاف الحواف
      applySobel(data, width, height);
      
      // ثالثاً: تطبيق Non-Maximum Suppression
      // (متبسيط لأغراض العرض)
      
      // رابعاً: تطبيق Hysteresis Thresholding
      // (متبسيط لأغراض العرض)
    }

    // تطبيق مرشح Laplacian
    function applyLaplacian(data, width, height) {
      // تطبيق مرشح Laplacian المبسط
      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          const i = (y * width + x) * 4;
          
          const laplacian = 
            -1 * getRed(data, width, x-1, y-1) +
            -1 * getRed(data, width, x, y-1) +
            -1 * getRed(data, width, x+1, y-1) +
            -1 * getRed(data, width, x-1, y) +
            8 * getRed(data, width, x, y) +
            -1 * getRed(data, width, x+1, y) +
            -1 * getRed(data, width, x-1, y+1) +
            -1 * getRed(data, width, x, y+1) +
            -1 * getRed(data, width, x+1, y+1);
          
          const magnitude = Math.min(255, Math.max(0, laplacian));
          
          data[i] = magnitude;
          data[i+1] = magnitude;
          data[i+2] = magnitude;
          data[i+3] = 255;
        }
      }
    }

    // تطبيق مرشح Gaussian
    function applyGaussian(data, width, height) {
      // تطبيق مرشح Gaussian المبسط
      const kernel = [1, 2, 1, 2, 4, 2, 1, 2, 1];
      const kernelSize = 3;
      const kernelSum = 16;
      
      const tempData = new Uint8ClampedArray(data.length);
      
      for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
          let r = 0, g = 0, b = 0;
          
          for (let ky = -1; ky <= 1; ky++) {
            for (let kx = -1; kx <= 1; kx++) {
              const ki = (ky + 1) * kernelSize + (kx + 1);
              const i = ((y + ky) * width + (x + kx)) * 4;
              
              r += data[i] * kernel[ki];
              g += data[i+1] * kernel[ki];
              b += data[i+2] * kernel[ki];
            }
          }
          
          const i = (y * width + x) * 4;
          tempData[i] = r / kernelSum;
          tempData[i+1] = g / kernelSum;
          tempData[i+2] = b / kernelSum;
          tempData[i+3] = data[i+3];
        }
      }
      
      // نسخ البيانات إلى الصورة الأصلية
      for (let i = 0; i < data.length; i++) {
        data[i] = tempData[i];
      }
    }

    // الحصول على قيمة الأحمر من البيانات
    function getRed(data, width, x, y) {
      const i = (y * width + x) * 4;
      return data[i];
    }

    // تحديث كشف الحواف
    function updateEdgeDetection() {
      if (!edgesImage) return;
      
      const threshold = document.getElementById('edgeThreshold').value;
      // تطبيق العتبة على حواف الصورة
      // (سيتم تطبيقه في المرة القادمة التي يتم فيها كشف الحواف)
      detectEdges('sobel');
    }

    // توليد Heatmap
    function generateHeatmap() {
      if (!currentImage) return;
      
      const canvas = document.getElementById('heatmap');
      const ctx = canvas.getContext('2d');
      
      // تعيين حجم الكانفاس
      canvas.width = document.getElementById('preview2d').width;
      canvas.height = document.getElementById('preview2d').height;
      
      // رسم الصورة الأصلية
      ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
      
      // الحصول على بيانات الصورة
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;
      
      // تحويل إلى تدرج رمادي
      for (let i = 0; i < data.length; i += 4) {
        const avg = (data[i] + data[i+1] + data[i+2]) / 3;
        data[i] = avg;
        data[i+1] = avg;
        data[i+2] = avg;
      }
      
      // تطبيق خريطة الألوان
      applyColormap(data, currentColormap);
      
      ctx.putImageData(imgData, 0, 0);
    }

    // تطبيق خريطة الألوان
    function applyColormap(data, colormap) {
      for (let i = 0; i < data.length; i += 4) {
        const value = data[i]; // قيمة التدرج الرمادي
        
        let r, g, b;
        
        switch(colormap) {
          case 'jet':
            // خريطة ألوان Jet
            r = Math.min(255, Math.max(0, 255 * Math.sin(0.03 * value)));
            g = Math.min(255, Math.max(0, 255 * Math.sin(0.03 * value + 1)));
            b = Math.min(255, Math.max(0, 255 * Math.sin(0.03 * value + 2)));
            break;
          case 'hot':
            // خريطة ألوان Hot
            r = Math.min(255, value * 2);
            g = Math.min(255, Math.max(0, value * 2 - 128));
            b = Math.min(255, Math.max(0, value * 2 - 255));
            break;
          case 'cool':
            // خريطة ألوان Cool
            r = value;
            g = 255 - value;
            b = 255;
            break;
          case 'gray':
          default:
            // التدرج الرمادي (لا تغيير)
            r = value;
            g = value;
            b = value;
            break;
        }
        
        data[i] = r;
        data[i+1] = g;
        data[i+2] = b;
      }
    }

    // تعيين خريطة الألوان
    function setColormap(colormap) {
      currentColormap = colormap;
      generateHeatmap();
      showNotification(`تم تطبيق خريطة الألوان ${colormap}`, 'success');
    }

    // تهيئة العارض ثلاثي الأبعاد
    function initialize3DViewer() {
      // هذه وظيفة افتراضية لتهيئة العارض ثلاثي الأبعاد
      // في التطبيق الحقيقي، سيتم استخدام Three.js أو مكتبة مماثلة
      const preview3d = document.getElementById('preview3d');
      preview3d.innerHTML = '<p>العرض ثلاثي الأبعاد سيظهر هنا بعد تحميل الصورة</p>';
      is3DInitialized = true;
    }

    // تحديث العرض ثلاثي الأبعاد
    function update3DView() {
      if (!currentImage || !is3DInitialized) return;
      
      const preview3d = document.getElementById('preview3d');
      preview3d.innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <p>جاري إنشاء النموذج ثلاثي الأبعاد...</p>
          <div class="loading-spinner" style="margin: 0 auto;"></div>
        </div>
      `;
      
      // محاكاة إنشاء النموذج ثلاثي الأبعاد
      setTimeout(() => {
        preview3d.innerHTML = `
          <div style="text-align: center; padding: 20px;">
            <p>✅ تم إنشاء النموذج ثلاثي الأبعاد بنجاح</p>
            <p>استخدم عناصر التحكم للتحكم في النموذج</p>
          </div>
        `;
        showNotification('تم إنشاء النموذج ثلاثي الأبعاد', 'success');
      }, 2000);
    }

    // توليد G-code
    function generateGcode() {
      if (!currentImage) {
        showNotification('يرجى تحميل صورة أولاً', 'error');
        return;
      }
      
      showNotification('جاري توليد G-code...', 'ai');
      
      // محاكاة توليد G-code
      setTimeout(() => {
        const gcodeOutput = document.getElementById('gcodeOutput');
        gcodeOutput.textContent = `
; G-code generated by CNC AI
; Date: ${new Date().toLocaleString()}
; Image: ${document.getElementById('fileName').textContent}
; Material: ${document.getElementById('materialType').value}
; Tool Diameter: ${document.getElementById('toolDiameter').value} mm

G21 ; Set to millimeters
G90 ; Absolute positioning
G94 ; Units per minute feed rate

; Start cutting
G0 X0 Y0 Z5
G1 Z-${document.getElementById('cutDepth').value} F${document.getElementById('feedRate').value / 2}
G1 X10 Y10 F${document.getElementById('feedRate').value}
G1 X90 Y10
G1 X90 Y90
G1 X10 Y90
G1 X10 Y10
G0 Z5

; Finish cutting
G0 X0 Y0
M30 ; End program
        `.trim();
        
        gcodeData = gcodeOutput.textContent;
        
        // عرض لوحة التحليل
        document.getElementById('analysisPanel').style.display = 'block';
        document.getElementById('gcodePreview').style.display = 'block';
        
        // تحديث نتائج التحليل
        document.getElementById('estimatedTime').textContent = '00:15:30';
        document.getElementById('totalLength').textContent = '520 mm';
        document.getElementById('passCount').textContent = '1';
        document.getElementById('powerUsage').textContent = '0.8 kWh';
        
        // تحديث إحصائيات G-code
        document.getElementById('lineCount').textContent = '15';
        document.getElementById('fastestMove').textContent = '1000 mm/min';
        document.getElementById('slowestMove').textContent = '500 mm/min';
        document.getElementById('averageSpeed').textContent = '750 mm/min';
        
        showNotification('تم توليد G-code بنجاح', 'success');
      }, 3000);
    }

    // محاكاة القطع
    function simulateCutting() {
      if (!gcodeData) {
        showNotification('يرجى توليد G-code أولاً', 'error');
        return;
      }
      
      showNotification('جاري محاكاة عملية القطع...', 'analysis');
      
      // محاكاة المحاكاة
      setTimeout(() => {
        showNotification('تمت محاكاة عملية القطع بنجاح', 'success');
      }, 2000);
    }

    // حفظ G-code
    function saveGcode() {
      if (!gcodeData) {
        showNotification('يرجى توليد G-code أولاً', 'error');
        return;
      }
      
      const fileName = prompt('أدخل اسم الملف:', `cnc_ai_${new Date().getTime()}.gcode`);
      if (!fileName) return;
      
      const blob = new Blob([gcodeData], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification('تم حفظ ملف G-code', 'success');
    }

    // تحليل G-code
    function analyzeGcode() {
      if (!gcodeData) {
        showNotification('يرجى توليد G-code أولاً', 'error');
        return;
      }
      
      showNotification('جاري تحليل G-code...', 'analysis');
      
      // محاكاة التحليل
      setTimeout(() => {
        showNotification('تم تحليل G-code بنجاح', 'success');
      }, 2000);
    }

    // عرض الإشعارات
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      const notificationMessage = document.getElementById('notificationMessage');
      
      notificationMessage.textContent = message;
      notification.className = 'notification';
      notification.classList.add(type);
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // وظائف إضافية للنسخة المتقدمة
    function startManualSelection() {
      isManualSelection = true;
      showNotification('تم تفعيل وضع التحديد اليدوي', 'success');
    }

    function clearManualSelection() {
      manualSelectionPoints = [];
      showNotification('تم مسح التحديد اليدوي', 'success');
    }

    function applyManualSelection() {
      if (manualSelectionPoints.length === 0) {
        showNotification('لم تقم بتحديد أي منطقة', 'error');
        return;
      }
      
      showNotification('تم تطبيق التحديد اليدوي', 'success');
    }

    function generateRoughingPath() {
      showNotification('جاري توليد مسار التشكيل...', 'roughing');
    }

    function generateFinishingPath() {
      showNotification('جاري توليد مسار التشطيب...', 'finishing');
    }

    function generateSmoothingPath() {
      showNotification('جاري توليد مسار التنعيم...', 'smoothing');
    }

    function generateAllPaths() {
      showNotification('جاري توليد جميع المسارات...', 'ai');
    }

    function simulateAllPaths() {
      showNotification('جاري محاكاة جميع المسارات...', 'analysis');
    }

    function exportAllPaths() {
      showNotification('جاري تصدير جميع المسارات...', 'success');
    }

    function analyzeAllPaths() {
      showNotification('جاري تحليل جميع المسارات...', 'analysis');
    }

    function showAllPaths() {
      showNotification('عرض جميع المسارات', 'success');
    }

    function showOptimalPath() {
      showNotification('عرض المسار الأمثل', 'success');
    }

    function showRoughingPath() {
      showNotification('عرض مسار التشكيل', 'roughing');
    }

    function showFinishingPath() {
      showNotification('عرض مسار التشطيب', 'finishing');
    }
  </script>
</body>
</html>
