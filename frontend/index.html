<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CNC AI — Heatmap Colormaps + Edge Sensitivity + Colored TopView</title>

  <!-- مكتبات -->
  <script src="https://docs.opencv.org/4.8.0/opencv.js" async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #041022 0%, #0a1a2e 100%); 
      color:#e6eef6; 
      line-height:1.45;
      overflow-x: hidden;
    }
    
    .app { 
      max-width:1400px; 
      margin:12px auto; 
      padding:14px;
      position: relative;
    }
    
    /* تأثير خلفي */
    .bg-effects {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }
    
    .bg-effect {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(6,182,212,0.1) 0%, rgba(6,182,212,0) 70%);
      animation: float 15s infinite linear;
    }
    
    .bg-effect:nth-child(1) {
      width: 300px;
      height: 300px;
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }
    
    .bg-effect:nth-child(2) {
      width: 200px;
      height: 200px;
      top: 60%;
      right: 15%;
      animation-delay: -5s;
    }
    
    .bg-effect:nth-child(3) {
      width: 400px;
      height: 400px;
      bottom: 10%;
      left: 20%;
      animation-delay: -10s;
    }
    
    @keyframes float {
      0% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(30px, -50px) rotate(120deg); }
      66% { transform: translate(-20px, 20px) rotate(240deg); }
      100% { transform: translate(0, 0) rotate(360deg); }
    }
    
    header { 
      display:flex; 
      justify-content:space-between; 
      align-items:center; 
      margin-bottom:20px; 
      padding-bottom:15px; 
      border-bottom:1px solid rgba(30, 41, 59, 0.6);
      background: rgba(11, 19, 32, 0.7);
      padding: 15px 20px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }
    
    h1 {
      background: linear-gradient(90deg, #06b6d4, #3b82f6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
      font-size: 1.8rem;
      font-weight: 700;
    }
    
    .grid { 
      display:grid; 
      grid-template-columns:1fr 520px; 
      gap:20px;
    }
    
    @media (max-width:1100px){ 
      .grid{ grid-template-columns:1fr; } 
    }
    
    .panel { 
      background: rgba(11, 19, 32, 0.7); 
      padding:20px; 
      border-radius:12px; 
      border:1px solid rgba(30, 41, 59, 0.5);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .panel:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    }
    
    /* tabs improved */
    .tab-buttons { 
      display:flex; 
      gap:8px; 
      margin-top:15px; 
      background: rgba(14,23,33,0.6); 
      padding:8px; 
      border-radius:10px;
      border: 1px solid rgba(30, 41, 59, 0.3);
    }
    
    .tab-buttons button { 
      flex:1; 
      border:none; 
      padding:10px 12px; 
      border-radius:8px; 
      background:transparent; 
      color:#9bb0c8; 
      cursor:pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .tab-buttons button:hover { 
      background: rgba(6, 182, 212, 0.1);
      color: #e6eef6;
    }
    
    .tab-buttons button.active { 
      background: linear-gradient(135deg, #06b6d4, #0ea5e9); 
      color:#fff; 
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }
    
    .tab-content { 
      display:none; 
      margin-top:15px;
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .tab-content.active { 
      display:block; 
    }
    
    canvas { 
      max-width:100%; 
      border-radius:8px; 
      background:#000; 
      display:block; 
      margin:0 auto; 
      border:1px solid rgba(51, 65, 85, 0.5);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    #threeContainer { 
      width:100%; 
      height:420px; 
      background: linear-gradient(135deg, #081224 0%, #0d1b2a 100%); 
      border-radius:10px; 
      overflow:hidden; 
      position:relative;
      border: 1px solid rgba(51, 65, 85, 0.5);
    }
    
    label { 
      display:block; 
      margin-top:15px; 
      color:#cfeaf2; 
      font-weight:600;
      font-size: 0.95rem;
    }
    
    input, select, textarea, button { 
      font-size:0.95rem;
      transition: all 0.3s ease;
    }
    
    input, select { 
      width:100%; 
      padding:10px 12px; 
      border-radius:8px; 
      border:1px solid rgba(30, 41, 59, 0.5); 
      background: rgba(15, 23, 42, 0.7); 
      color:#e6eef6; 
      margin-top:8px;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #06b6d4;
      box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.2);
    }
    
    .button-group { 
      display:flex; 
      flex-direction:column; 
      gap:10px; 
      margin-top:15px; 
    }
    
    .button-row { 
      display:flex; 
      gap:10px; 
    }
    
    button { 
      background: rgba(30, 41, 59, 0.8); 
      color:#e6eef6; 
      border:none; 
      padding:12px 16px; 
      border-radius:10px; 
      cursor:pointer;
      transition: all 0.3s ease;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    
    button:hover::before {
      left: 100%;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    button.primary { 
      background: linear-gradient(135deg, #06b6d4, #0ea5e9); 
      color:#fff; 
      font-weight:600;
      box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }
    
    button.primary:hover {
      background: linear-gradient(135deg, #0ea5e9, #06b6d4);
      box-shadow: 0 6px 20px rgba(6, 182, 212, 0.4);
    }
    
    button.secondary { 
      background: rgba(51, 65, 85, 0.7); 
    }
    
    button.secondary:hover {
      background: rgba(51, 65, 85, 0.9);
    }
    
    #toast { 
      position:fixed; 
      left:16px; 
      bottom:16px; 
      background:rgba(0,0,0,0.85); 
      color:#fff; 
      padding:12px 16px; 
      border-radius:10px; 
      display:none; 
      z-index:10000;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: slideInUp 0.3s ease;
    }
    
    @keyframes slideInUp {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .canvas-placeholder { 
      width:100%; 
      min-height:260px; 
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); 
      border-radius:8px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      color:#9bb0c8; 
      border:1px solid rgba(51, 65, 85, 0.5);
      flex-direction: column;
      gap: 15px;
    }
    
    .small-meta { 
      font-size:12px; 
      color:#9bb0c8; 
      margin-top:8px;
      line-height: 1.5;
    }
    
    /* Loading Spinners */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(6, 182, 212, 0.2);
      border-top: 4px solid #06b6d4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .loading-spinner.small {
      width: 20px;
      height: 20px;
      border-width: 2px;
    }
    
    .loading-pulse {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #06b6d4;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(0.8); opacity: 0.8; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(0.8); opacity: 0.8; }
    }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 10px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #06b6d4, #3b82f6);
      border-radius: 3px;
      width: 0%;
      transition: width 0.5s ease;
    }
    
    /* Card hover effects */
    .feature-card {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      border: 1px solid rgba(30, 41, 59, 0.3);
      transition: all 0.3s ease;
    }
    
    .feature-card:hover {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(6, 182, 212, 0.3);
      transform: translateY(-3px);
    }
    
    /* Simulation controls */
    .sim-controls { 
      position:absolute; 
      top:10px; 
      left:10px; 
      z-index:120; 
      display:flex; 
      gap:8px; 
      align-items:center; 
      background:rgba(0,0,0,0.5); 
      padding:10px;
      border-radius:8px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .sim-controls button { 
      background:rgba(0,0,0,0.6); 
      color:white; 
      border:1px solid #06b6d4; 
      border-radius:6px; 
      padding:8px 12px; 
      cursor:pointer; 
      font-size:0.9rem;
    }
    
    .sim-progress { 
      position:absolute; 
      bottom:10px; 
      left:10px; 
      z-index:120; 
      background:rgba(0,0,0,0.5); 
      padding:8px 12px;
      border-radius:8px; 
      color:#cfeaf2; 
      font-size:12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* Top view + legend */
    #topViewContainer { 
      margin-top:15px; 
      display:flex; 
      flex-direction:column; 
      gap:8px; 
      align-items:center; 
    }
    
    #topView { 
      width:100%; 
      height:200px; 
      background: linear-gradient(135deg, #0d1722 0%, #152232 100%); 
      border-radius:8px; 
      border:1px solid rgba(51, 65, 85, 0.5); 
      display:block;
    }
    
    #topLegend { 
      width:100%; 
      height:20px; 
      border-radius:8px; 
      border:1px solid rgba(43, 56, 68, 0.5); 
      background:linear-gradient(90deg,#ddd,#333); 
    }

    /* colormap buttons under heatmap */
    .colormap-buttons { 
      display:flex; 
      gap:8px; 
      justify-content:center; 
      margin-top:12px; 
    }
    
    .colormap-buttons button { 
      background:rgba(20, 27, 34, 0.7); 
      color:#cfeaf2; 
      border:1px solid rgba(38, 52, 63, 0.5); 
      padding:8px 12px; 
      border-radius:8px; 
      cursor:pointer; 
      font-size:13px;
    }
    
    .colormap-buttons button.active { 
      background:linear-gradient(135deg, #06b6d4, #0ea5e9); 
      color:#fff; 
      border-color:#06b6d4; 
    }

    /* Status indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(30, 41, 59, 0.3);
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9bb0c8;
      animation: pulse 2s infinite;
    }
    
    .status-dot.ready { background: #10b981; }
    .status-dot.loading { background: #f59e0b; }
    .status-dot.error { background: #ef4444; }

    /* Responsive improvements */
    @media (max-width: 768px) {
      .grid { gap: 15px; }
      .panel { padding: 15px; }
      .button-row { flex-direction: column; }
      header { flex-direction: column; gap: 10px; text-align: center; }
      h1 { font-size: 1.5rem; }
    }

    @keyframes spin { 
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); } 
    }
  </style>
</head>
<body>
  <!-- تأثيرات الخلفية -->
  <div class="bg-effects">
    <div class="bg-effect"></div>
    <div class="bg-effect"></div>
    <div class="bg-effect"></div>
  </div>

  <div class="app">
    <header>
      <h1>CNC AI — Heatmap Colormaps + Edge Sensitivity</h1>
      <div class="status-indicator" id="cvState">
        <div class="status-dot loading"></div>
        <span>جاري تحميل OpenCV...</span>
        <div class="loading-spinner small"></div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT panel -->
      <div class="panel">
        <div class="feature-card">
          <div style="display:flex;gap:10px;align-items:center;">
            <input id="fileInput" type="file" accept="image/*" style="display:none"/>
            <label class="file-input-label" for="fileInput" style="display:inline-flex;align-items:center;gap:8px;padding:10px 16px;background:rgba(30,41,59,0.7);border-radius:8px;color:#e6eef6;cursor:pointer;border:1px dashed rgba(51,65,85,0.5);transition:all 0.3s ease;">
              <span>📁</span>
              <span>اختر صورة</span>
            </label>
            <div style="flex:1"></div>

            <label for="edgeMode" style="font-weight:normal;color:#9bb0c8;white-space:nowrap;">وضع الحواف:</label>
            <select id="edgeMode" style="width:140px">
              <option value="auto">Canny (عادي)</option>
              <option value="sobel">Sobel (دقيق)</option>
              <option value="laplace">Laplacian (ناعم)</option>
            </select>
          </div>

          <!-- Edge sensitivity slider -->
          <div style="display:flex;align-items:center;gap:10px;margin-top:12px">
            <label style="margin:0;color:#9bb0c8;white-space:nowrap;">حساسية الحواف:</label>
            <input id="edgeSensitivity" type="range" min="0.1" max="1.0" step="0.05" value="0.33" style="flex:1">
            <div id="edgeValue" style="min-width:44px;text-align:center;color:#cfeaf2;font-weight:600;">0.33</div>
          </div>
        </div>

        <div class="tab-buttons" role="tablist">
          <button data-tab="original" class="active">🖼️ الأصلية</button>
          <button data-tab="heatmap">🔥 Heatmap</button>
          <button data-tab="contour">📐 Contours</button>
          <button data-tab="topview">🔝 Top View</button>
          <button data-tab="simulation">🎬 المحاكاة</button>
        </div>

        <div id="original" class="tab-content active">
          <div class="canvas-placeholder" id="originalPlaceholder">
            <div class="loading-spinner"></div>
            <div>الصورة الأصلية ستظهر هنا</div>
            <div class="small-meta">قم بتحميل صورة لبدء المعالجة</div>
          </div>
          <canvas id="canvasOriginal" style="display:none;"></canvas>
        </div>

        <div id="heatmap" class="tab-content">
          <div class="canvas-placeholder" id="heatmapPlaceholder">
            <div class="loading-spinner"></div>
            <div>Heatmap ستظهر هنا</div>
            <div class="small-meta">سيتم إنشاء خريطة الحرارة بعد تحميل الصورة</div>
          </div>
          <canvas id="canvasHeatmap" style="display:none;"></canvas>

          <!-- colormap buttons under heatmap -->
          <div class="colormap-buttons" id="colormapButtons">
            <button data-map="jet" class="active">Jet</button>
            <button data-map="hot">Hot</button>
            <button data-map="cool">Cool</button>
            <button data-map="gray">Gray</button>
          </div>

          <div class="small-meta">اختَر نموذج الـ colormap. التغيير يحدث لحظياً ويؤثر على Heatmap وTop View.</div>
        </div>

        <div id="contour" class="tab-content">
          <div class="canvas-placeholder" id="contourPlaceholder">
            <div class="loading-spinner"></div>
            <div>Contours ستظهر هنا</div>
            <div class="small-meta">سيتم اكتشاف الحواف بعد تحميل الصورة</div>
          </div>
          <canvas id="canvasContour" style="display:none;"></canvas>
          <div class="small-meta">تبديل وضع كشف الحواف أو تحريك حساسية الحواف يحدث إعادة معالجة تلقائية</div>
        </div>

        <div id="topview" class="tab-content">
          <div id="topViewContainer">
            <div class="canvas-placeholder" id="topViewPlaceholder">
              <div class="loading-spinner"></div>
              <div>Top View ستظهر هنا</div>
              <div class="small-meta">سيتم إنشاء العرض العلوي بعد توليد G-code</div>
            </div>
            <canvas id="topView" style="display:none;"></canvas>
            <div id="topLegend" title="عمق النقش — الألوان فقط" style="display:none;"></div>
          </div>
          <div class="small-meta">معاينة من الأعلى للعمق المتوقع بعد تنفيذ G-code (الألوان تتبع اختيار Colormap)</div>
        </div>

        <div id="simulation" class="tab-content">
          <div id="threeContainer">
            <div class="canvas-placeholder" id="simulationPlaceholder">
              <div class="loading-spinner"></div>
              <div>المحاكاة ستظهر هنا</div>
              <div class="small-meta">سيتم تحميل المحاكاة بعد توليد G-code</div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT panel -->
      <div class="panel">
        <h3 style="margin-top:0;background:linear-gradient(90deg, #06b6d4, #3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">⚙️ إعدادات التحكم</h3>

        <div class="feature-card">
          <label for="machineType">نوع الماكينة</label>
          <select id="machineType">
            <option value="router">Router CNC</option>
            <option value="laser">Laser Engraver</option>
            <option value="plasma">Plasma Cutter</option>
            <option value="3dprinter">3D Printer</option>
          </select>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:15px">
            <div>
              <label for="workWidth">عرض العمل (سم)</label>
              <input id="workWidth" type="number" value="30" step="0.1" min="1" max="200"/>
              <div class="small-meta" id="widthMm">300.0 مم</div>
            </div>
            <div>
              <label for="workHeight">ارتفاع العمل (سم)</label>
              <input id="workHeight" type="number" value="20" step="0.1" min="1" max="200"/>
              <div class="small-meta" id="heightMm">200.0 مم</div>
            </div>
          </div>

          <label for="workDepth">عمق العمل (مم)</label>
          <input id="workDepth" type="number" value="3.0" step="0.1" min="0.1" max="50"/>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:15px">
            <div>
              <label for="originX">نقطة الأصل X (سم)</label>
              <input id="originX" type="number" value="0" step="0.1"/>
            </div>
            <div>
              <label for="originY">نقطة الأصل Y (سم)</label>
              <input id="originY" type="number" value="0" step="0.1"/>
            </div>
          </div>
          <div style="margin-top:10px">
            <button id="btnCenterOrigin" class="secondary">🎯 توسيط نقطة الأصل</button>
          </div>
        </div>

        <div class="feature-card">
          <label for="feedRate">سرعة التغذية (مم/دقيقة)</label>
          <input id="feedRate" type="number" value="800" min="10" max="5000"/>
          <label for="safeZ">ارتفاع الأمان (مم)</label>
          <input id="safeZ" type="number" value="5" step="0.1" min="0" max="100"/>

          <label for="scanDir">اتجاه المسارات (Raster)</label>
          <select id="scanDir">
            <option value="x">أفقي (X)</option>
            <option value="y">رأسي (Y)</option>
          </select>

          <label for="stepOver">خطوة المسح (مم)</label>
          <input id="stepOver" type="number" value="5" step="0.1" min="0.1" max="50"/>
          <label for="maxDepth">أقصى عمق (مم)</label>
          <input id="maxDepth" type="number" value="3.0" step="0.1" min="0.1" max="50"/>

          <!-- NEW: Fixed Z + Invert Z -->
          <div style="display:flex;gap:10px;margin-top:12px;align-items:center">
            <label style="font-weight:normal;flex:1;"><input id="fixedZ" type="checkbox" /> استخدام Z ثابت</label>
            <input id="fixedZValue" type="number" value="-1.0" step="0.1" style="width:120px" />
          </div>
          <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
            <label style="font-weight:normal;flex:1;"><input id="invertZ" type="checkbox" /> عكس Z</label>
            <div style="flex:1"></div>
            <label style="font-weight:normal;color:#9bb0c8">لون الخشب:</label>
            <select id="woodColor" style="width:140px">
              <option value="#deb887">خشب فاتح</option>
              <option value="#a0522d" selected>خشب متوسط</option>
              <option value="#d2b48c">بيج</option>
              <option value="#8b5a2b">ماهوجني</option>
            </select>
          </div>
        </div>

        <div class="button-group">
          <div class="button-row">
            <button id="btnGen" class="primary">
              <span>⚡ توليد G-code (Raster)</span>
            </button>
            <button id="btnQuick" class="secondary">
              <span>🧪 اختبار سريع</span>
            </button>
          </div>

          <div style="margin-top:12px">
            <label for="contourMode">نطاق الحواف (Contour)</label>
            <select id="contourMode">
              <option value="outer">الخارجية فقط</option>
              <option value="all">كل الحواف</option>
            </select>
            <div style="height:10px"></div>
            <div class="button-row">
              <button id="btnContour" class="secondary">
                <span>🌀 توليد G-code (Contour)</span>
              </button>
              <button id="btnDownload" class="secondary">
                <span>💾 تحميل G-code</span>
              </button>
            </div>
          </div>
        </div>

        <div id="estTime" style="margin-top:15px;color:#9bb0c8;text-align:center;padding:12px;background:rgba(15,23,42,0.5);border-radius:8px;border:1px solid rgba(30,41,59,0.3);">
          ⏱️ تقدير الوقت: سيظهر بعد التوليد
        </div>

        <label for="gcodeOut" style="margin-top:15px">📄 مخرجات G-code</label>
        <textarea id="gcodeOut" readonly placeholder="سيظهر G-code هنا بعد التوليد..." style="height:180px;background:rgba(2,16,36,0.7);color:#cfeaf2;border-radius:8px;padding:12px;border:1px solid rgba(30,41,59,0.5);resize:vertical;"></textarea>

      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toast"></div>

  <script>
    // ================= متغيرات عامة =================
    let cvReady = false;
    let grayMat = null;
    let contour = null;
    let previewCanvas = null;
    let additionalContours = [];
    let lastScanDir = 'x';
    let lastGeneratedGcode = '';
    let currentColormap = 'jet';

    // Simulation / Three
    let scene, camera, renderer, controls;
    let simulation = { isPlaying: false, animationFrame: null, tool: null, toolPath: null, pathPoints: [], index: 0, speed: 1 };

    // ================= مؤشرات التحميل =================
    function showLoading(elementId, message = "جاري التحميل...") {
      const element = document.getElementById(elementId);
      if (element) {
        element.innerHTML = `
          <div class="loading-spinner"></div>
          <div>${message}</div>
          <div class="progress-bar">
            <div class="progress-fill" id="${elementId}-progress"></div>
          </div>
        `;
        element.style.display = 'flex';
        
        // محاكاة تقدم التحميل
        let progress = 0;
        const interval = setInterval(() => {
          progress += Math.random() * 10;
          const progressBar = document.getElementById(`${elementId}-progress`);
          if (progressBar) {
            progressBar.style.width = Math.min(progress, 90) + '%';
          }
          if (progress >= 90) {
            clearInterval(interval);
          }
        }, 200);
      }
    }

    function hideLoading(elementId, showCanvasId = null) {
      const element = document.getElementById(elementId);
      if (element) {
        element.style.display = 'none';
      }
      if (showCanvasId) {
        const canvas = document.getElementById(showCanvasId);
        if (canvas) {
          canvas.style.display = 'block';
        }
      }
    }

    function updateProgress(elementId, progress) {
      const progressBar = document.getElementById(`${elementId}-progress`);
      if (progressBar) {
        progressBar.style.width = progress + '%';
      }
    }

    // ================= Helper UI funcs =================
    function showToast(msg, ms = 3000) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(t._t);
      t._t = setTimeout(() => {
        t.style.display = 'none';
      }, ms);
      console.log(msg);
    }

    function cmToMm(cm) { return cm * 10; }
    function mmToCm(mm) { return mm / 10; }

    function updateDimensionDisplay() {
      const widthCm = parseFloat(document.getElementById('workWidth').value) || 0;
      const heightCm = parseFloat(document.getElementById('workHeight').value) || 0;
      document.getElementById('widthMm').textContent = cmToMm(widthCm).toFixed(1) + ' مم';
      document.getElementById('heightMm').textContent = cmToMm(heightCm).toFixed(1) + ' مم';
    }

    // ================= OpenCV readiness =================
    function waitForCv() {
      if (typeof cv !== 'undefined' && cv.getBuildInformation) {
        cvReady = true;
        const cvState = document.getElementById('cvState');
        cvState.innerHTML = `
          <div class="status-dot ready"></div>
          <span>✅ OpenCV جاهز</span>
        `;
        showToast('تم تحميل OpenCV بنجاح', 1400);
      } else {
        setTimeout(waitForCv, 100);
      }
    }
    waitForCv();

    // ================= Tabs behavior =================
    document.querySelectorAll('.tab-buttons button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');

        if (btn.dataset.tab === 'simulation' && document.getElementById('gcodeOut').value) {
          initSimulation();
        }
      });
    });

    // ================= Load image =================
    document.getElementById('fileInput').addEventListener('change', async function (e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.match('image.*')) {
        showToast('الرجاء اختيار ملف صورة فقط');
        return;
      }
      
      try {
        showLoading('originalPlaceholder', 'جاري تحميل الصورة...');
        
        const img = new Image();
        img.src = URL.createObjectURL(file);
        
        img.onload = async function() {
          updateProgress('originalPlaceholder', 50);
          
          previewCanvas = document.getElementById('canvasOriginal');
          const ctx = previewCanvas.getContext('2d');

          const maxPixels = 1024 * 1024;
          let w = img.width, h = img.height;
          const currentPixels = w * h;
          if (currentPixels > maxPixels) {
            const ratio = Math.sqrt(maxPixels / currentPixels);
            w = Math.floor(w * ratio);
            h = Math.floor(h * ratio);
            showToast('تم تحسين حجم الصورة للأداء الأفضل');
          }

          previewCanvas.width = w;
          previewCanvas.height = h;
          ctx.drawImage(img, 0, 0, w, h);
          
          updateProgress('originalPlaceholder', 100);
          setTimeout(() => {
            hideLoading('originalPlaceholder', 'canvasOriginal');
          }, 500);

          if (cvReady) {
            await detectContours();
          } else {
            showToast('في انتظار OpenCV...');
            setTimeout(async () => { if (cvReady) await detectContours(); }, 800);
          }
        };
        
        img.onerror = function() {
          showToast('فشل في تحميل الصورة');
          hideLoading('originalPlaceholder');
        };
        
      } catch (error) {
        console.error('image load error', error);
        showToast('فشل في تحميل الصورة');
        hideLoading('originalPlaceholder');
      }
    });

    // ================= باقي الدوال تبقى كما هي مع إضافة مؤشرات التحميل =================
    // [يتبع باقي الكود الأصلي مع إضافة مؤشرات التحميل في الدوال المناسبة]
    
    // في دالة detectContours يمكن إضافة:
    async function detectContours() {
      if (!cvReady) {
        showToast('OpenCV غير جاهز بعد');
        return;
      }
      
      showLoading('heatmapPlaceholder', 'جاري إنشاء Heatmap...');
      showLoading('contourPlaceholder', 'جاري اكتشاف الحواف...');
      
      try {
        // ... الكود الأصلي لمعالجة الصورة
        
        // عند الانتهاء:
        setTimeout(() => {
          hideLoading('heatmapPlaceholder', 'canvasHeatmap');
          hideLoading('contourPlaceholder', 'canvasContour');
        }, 500);
        
      } catch (err) {
        console.error('detectContours error', err);
        showToast('فشل في تحليل الصورة');
        hideLoading('heatmapPlaceholder');
        hideLoading('contourPlaceholder');
      }
    }

    // في دوال توليد G-code يمكن إضافة:
    function generateRasterGcode(scaleDown = false) {
      showLoading('simulationPlaceholder', 'جاري توليد G-code...');
      // ... الكود الأصلي
      
      // عند الانتهاء:
      setTimeout(() => {
        hideLoading('simulationPlaceholder');
      }, 500);
    }

    // ... باقي الكود الأصلي

  </script>
</body>
</html>
