<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CNC 3D Preview</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; color: white; }
    #scaleControl {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="scaleControl">
    <label>ارتفاع Z: </label>
    <input type="range" id="scaleZ" min="1" max="50" value="20">
  </div>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    let scene = new THREE.Scene();
    let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    let renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Controls
    let controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // إضاءة
    let light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(0, 0, 100).normalize();
    scene.add(light);

    // Geometry
    const width = 200, height = 200, segments = 100;
    let geometry = new THREE.PlaneGeometry(width, height, segments, segments);
    let material = new THREE.MeshPhongMaterial({color: 0xcccccc, wireframe: false, side: THREE.DoubleSide});
    let mesh = new THREE.Mesh(geometry, material);
    scene.add(mesh);

    camera.position.z = 200;

    // دالة توليد الارتفاع من صورة
    function createHeightMap(img, scaleZ=20) {
      let canvas = document.createElement("canvas");
      let ctx = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      let imgData = ctx.getImageData(0, 0, img.width, img.height).data;

      for (let i = 0; i < geometry.attributes.position.count; i++) {
        let ix = i % (segments + 1);
        let iy = Math.floor(i / (segments + 1));
        let px = Math.floor(ix / (segments + 1) * img.width);
        let py = Math.floor(iy / (segments + 1) * img.height);
        let idx = (py * img.width + px) * 4;

        let brightness = (imgData[idx] + imgData[idx+1] + imgData[idx+2]) / 3;
        geometry.attributes.position.setZ(i, (brightness / 255) * scaleZ);
      }
      geometry.computeVertexNormals();
      geometry.attributes.position.needsUpdate = true;
    }

    // تحميل صورة
    let img = new Image();
    img.src = "https://threejs.org/examples/textures/uv_grid_opengl.jpg"; // هنا حط صورتك
    img.onload = () => createHeightMap(img, document.getElementById("scaleZ").value);

    // تحكم في الارتفاع بالـ Slider
    document.getElementById("scaleZ").addEventListener("input", (e) => {
      createHeightMap(img, e.target.value);
    });

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
