<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CNC AI Preview</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; text-align: center; }
    h2 { margin: 10px 0; }
    .section { margin-bottom: 40px; }
    canvas, #preview3d { border: 1px solid #ccc; background: #fff; }
    #preview2d, #heatmap { width: 300px; height: 300px; }
    #preview3d { width: 400px; height: 400px; margin: auto; }
    #progress-container { width: 80%; max-width: 400px; margin: 15px auto; background: #ddd; height: 20px; border-radius: 10px; overflow: hidden; display: none; }
    #progress-bar { height: 100%; width: 0%; background: linear-gradient(to right, #4caf50, #8bc34a); transition: width 0.2s; }
    #resetView { margin-top: 10px; padding: 6px 12px; border: none; border-radius: 5px; background: #2196f3; color: white; cursor: pointer; }
  </style>
</head>
<body>
  <h1>CNC AI - معاينة الصور والمسارات</h1>
  <input type="file" id="fileInput" accept="image/*">

  <div id="progress-container"><div id="progress-bar"></div></div>

  <!-- الصورة الأصلية -->
  <div class="section">
    <h2>الصورة الأصلية</h2>
    <canvas id="preview2d"></canvas>
  </div>

  <!-- Heatmap -->
  <div class="section">
    <h2>خريطة الارتفاع (Heatmap)</h2>
    <canvas id="heatmap"></canvas>
  </div>

  <!-- 3D Preview -->
  <div class="section">
    <h2>معاينة ثلاثية الأبعاد</h2>
    <div id="preview3d"></div>
    <button id="resetView">إعادة ضبط العرض</button>
  </div>

  <!-- three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const canvas2d = document.getElementById('preview2d');
    const ctx2d = canvas2d.getContext('2d');
    const heatmapCanvas = document.getElementById('heatmap');
    const heatmapCtx = heatmapCanvas.getContext('2d');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');

    // إعداد 3D
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, 400/400, 0.1, 1000);
    camera.position.set(0, 150, 200);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(400, 400);
    document.getElementById('preview3d').appendChild(renderer.domElement);
    const controls = new THREE.OrbitControls(camera, renderer.domElement);

    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(0, 1, 1);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x999999));

    let mesh;

    function updateProgress(percent) {
      progressContainer.style.display = 'block';
      progressBar.style.width = percent + '%';
      if (percent >= 100) {
        setTimeout(() => { progressContainer.style.display = 'none'; }, 500);
      }
    }

    function createHeatmap(image) {
      const w = 100, h = 100;
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = w; tempCanvas.height = h;
      const tctx = tempCanvas.getContext('2d');
      tctx.drawImage(image, 0, 0, w, h);
      const imgData = tctx.getImageData(0, 0, w, h).data;

      heatmapCanvas.width = w; heatmapCanvas.height = h;
      const heatmapData = heatmapCtx.createImageData(w, h);

      for (let i = 0; i < w * h; i++) {
        const idx = i * 4;
        const gray = (imgData[idx] + imgData[idx+1] + imgData[idx+2]) / 3;
        const color = getHeatColor(gray / 255);
        heatmapData.data[idx] = color[0];
        heatmapData.data[idx+1] = color[1];
        heatmapData.data[idx+2] = color[2];
        heatmapData.data[idx+3] = 255;
      }
      heatmapCtx.putImageData(heatmapData, 0, 0);
    }

    function getHeatColor(value) {
      const r = Math.floor(255 * value);
      const g = Math.floor(255 * (1 - Math.abs(value - 0.5) * 2));
      const b = Math.floor(255 * (1 - value));
      return [r, g, b];
    }

    function createHeightMap(image) {
      const w = 100, h = 100;
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = w; tempCanvas.height = h;
      const tctx = tempCanvas.getContext('2d');
      tctx.drawImage(image, 0, 0, w, h);
      const imgData = tctx.getImageData(0, 0, w, h).data;

      const geometry = new THREE.PlaneGeometry(100, 100, w-1, h-1);
      for (let i = 0; i < geometry.attributes.position.count; i++) {
        const stride = i * 3;
        const x = i % w;
        const y = Math.floor(i / w);
        const idx = (y * w + x) * 4;
        const brightness = (imgData[idx] + imgData[idx+1] + imgData[idx+2]) / 3;
        geometry.attributes.position.array[stride + 2] = brightness / 3; // ارتفاع Z
        if (i % 500 === 0) updateProgress(Math.round((i / geometry.attributes.position.count) * 100));
      }
      geometry.computeVertexNormals();

      const material = new THREE.MeshLambertMaterial({ color: 0xaaaaaa, side: THREE.DoubleSide });
      if (mesh) scene.remove(mesh);
      mesh = new THREE.Mesh(geometry, material);
      mesh.rotation.x = -Math.PI / 2;
      scene.add(mesh);

      updateProgress(100);
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }
    animate();

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        canvas2d.width = img.width;
        canvas2d.height = img.height;
        ctx2d.drawImage(img, 0, 0, canvas2d.width, canvas2d.height);
        createHeatmap(img);
        createHeightMap(img);
      };
      img.src = URL.createObjectURL(file);
    });

    document.getElementById('resetView').addEventListener('click', () => {
      controls.reset();
      camera.position.set(0, 150, 200);
    });
  </script>
</body>
</html>
