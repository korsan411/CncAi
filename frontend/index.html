<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CNC AI — Router Raster Engraving</title>

<!-- مكتبات -->
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipper-lib@6.4.2/clipper.js"></script>

<style>
body{margin:0;font-family:Arial,Segoe UI,system-ui;background:#041022;color:#e6eef6}
.app{max-width:1200px;margin:16px auto;padding:14px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
h1{margin:0;color:#06b6d4}
.grid{display:grid;grid-template-columns:1fr 420px;gap:12px}
.panel{background:#0b1320;padding:12px;border-radius:10px}
.tabs button{margin-right:6px;padding:6px 10px;border:none;border-radius:6px;cursor:pointer}
.tabs button.active{background:#06b6d4;color:#021}
.tab-content{display:none;margin-top:8px}
.tab-content.active{display:block}
canvas{max-width:100%;border-radius:6px;background:#000}
textarea{width:100%;height:200px;background:#021024;color:#cfeaf2;font-family:monospace;border-radius:8px;padding:8px}
#threeContainer{width:100%;height:360px;background:#081224;border-radius:8px}
label{display:block;margin-top:8px}
button.primary{background:#06b6d4;color:#021;font-weight:bold;border:none;padding:8px;border-radius:8px;cursor:pointer}
#toast{position:fixed;left:16px;bottom:16px;background:rgba(0,0,0,0.85);color:#fff;padding:8px 10px;border-radius:8px;display:none;z-index:10000}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>CNC AI — Router Raster 3D</h1>
    <div id="cvState">انتظر OpenCV</div>
  </header>

  <div class="grid">
    <!-- يسار -->
    <div class="panel">
      <input id="fileInput" type="file" accept="image/*"/>
      <div class="tabs" style="margin-top:8px">
        <button data-tab="original" class="active">Original</button>
        <button data-tab="heatmap">Heatmap</button>
        <button data-tab="contour">Contour</button>
        <button data-tab="threeD">3D Preview</button>
      </div>
      <div id="original" class="tab-content active"><canvas id="canvasOriginal"></canvas></div>
      <div id="heatmap" class="tab-content"><canvas id="canvasHeatmap"></canvas></div>
      <div id="contour" class="tab-content"><canvas id="canvasContour"></canvas></div>
      <div id="threeD" class="tab-content"><div id="threeContainer"></div></div>
    </div>

    <!-- يمين -->
    <div class="panel">
      <h3>إعدادات Router</h3>
      <label>Feed (مم/دقيقة)<input id="feedRate" type="number" value="800"/></label>
      <label>Safe Z (مم)<input id="safeZ" type="number" value="5"/></label>
      <label>Invert Z<select id="invertZ"><option value="no">لا</option><option value="yes">نعم</option></select></label>
      <label>اتجاه المسارات<select id="scanDir"><option value="x">أفقي (X)</option><option value="y">رأسي (Y)</option></select></label>
      <label>خطوة المسح (مم)<input id="stepOver" type="number" value="5" step="0.5"/></label>
      <label>أقصى عمق (مم)<input id="maxDepth" type="number" value="3.0" step="0.1"/></label>

      <button id="btnGen" class="primary" style="margin-top:10px">توليد G-code</button>
      <button id="btnQuick" style="margin-top:6px">اختبار سريع</button>
      <div id="estTime" style="margin-top:6px;color:#9bb0c8"></div>
      <textarea id="gcodeOut" readonly></textarea>
    </div>
  </div>
</div>
<div id="toast"></div>

<script>
/* Toast */
function showToast(msg, ms=2000){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.display='block';
  clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',ms);
}

/* OpenCV */
let cvReady=false, grayMat=null, contour=null;
function waitForCv(){
  if(window.cv&&cv.getBuildInformation){
    cvReady=true;document.getElementById('cvState').textContent='OpenCV جاهز';
  } else if(window.cv){cv.onRuntimeInitialized=()=>{cvReady=true;document.getElementById('cvState').textContent='OpenCV جاهز';};}
  else setTimeout(waitForCv,200);
}
waitForCv();

/* Tabs */
document.querySelectorAll('.tabs button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
    btn.classList.add('active');document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

/* Load Image */
document.getElementById('fileInput').addEventListener('change',e=>{
  const file=e.target.files[0];if(!file)return;
  const img=new Image();
  img.onload=function(){
    let canv=document.getElementById('canvasOriginal');
    canv.width=img.width;canv.height=img.height;
    canv.getContext('2d').drawImage(img,0,0,canv.width,canv.height);

    if(cvReady){
      let src=cv.imread(canv);
      let gray=new cv.Mat();cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY,0);
      grayMat=gray;src.delete();

      // contour extraction
      let contours=new cv.MatVector(), hierarchy=new cv.Mat();
      cv.findContours(gray,contours,hierarchy,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);
      let maxArea=0;let chosen=null;
      for(let i=0;i<contours.size();i++){
        let area=cv.contourArea(contours.get(i));
        if(area>maxArea){maxArea=area;chosen=contours.get(i);}
      }
      contour=chosen;

      // Heatmap render
      let heat=document.getElementById('canvasHeatmap');
      heat.width=gray.cols;heat.height=gray.rows;
      let hctx=heat.getContext('2d');
      let imgData=hctx.createImageData(heat.width,heat.height);
      for(let y=0;y<gray.rows;y++){
        for(let x=0;x<gray.cols;x++){
          let v=gray.ucharPtr(y,x)[0];
          let idx=(y*gray.cols+x)*4;
          imgData.data[idx]=v;imgData.data[idx+1]=0;imgData.data[idx+2]=255-v;imgData.data[idx+3]=255;
        }
      }
      hctx.putImageData(imgData,0,0);

      // Contour render
      let ccan=document.getElementById('canvasContour');
      ccan.width=gray.cols;ccan.height=gray.rows;
      let cctx=ccan.getContext('2d');
      cctx.drawImage(heat,0,0);
      cctx.strokeStyle="lime";cctx.lineWidth=2;
      cctx.beginPath();
      for(let i=0;i<contour.data32S.length;i+=2){
        let x=contour.data32S[i],y=contour.data32S[i+1];
        if(i===0)cctx.moveTo(x,y);else cctx.lineTo(x,y);
      }
      cctx.closePath();cctx.stroke();

      showToast("تم تحميل الصورة ومعالجتها");
    }
  }
  img.src=URL.createObjectURL(file);
});

/* Sample Heatmap */
function sampleGrayAt(x,y){
  x=Math.max(0,Math.min(grayMat.cols-1,Math.round(x)));
  y=Math.max(0,Math.min(grayMat.rows-1,Math.round(y)));
  return grayMat.ucharPtr(y,x)[0];
}

/* Raster & Gcode */
function generateRasterGcode(scaleDown=false){
  if(!grayMat||!contour){showToast("لم يتم تجهيز الصورة");return"";}
  const dir=document.getElementById('scanDir').value;
  const stepOver=parseFloat(document.getElementById('stepOver').value);
  const maxDepth=parseFloat(document.getElementById('maxDepth').value);
  const feed=parseFloat(document.getElementById('feedRate').value);
  const safeZ=parseFloat(document.getElementById('safeZ').value);
  const invertZ=document.getElementById('invertZ').value==='yes';

  const lines=[];lines.push('G21 G90 G17');lines.push(`G0 Z${safeZ.toFixed(2)}`);
  let totalLen=0;

  let step=stepOver;
  if(scaleDown)step*=4;

  if(dir==='x'){
    for(let y=0;y<grayMat.rows;y+=step){
      let rowPoints=[];
      for(let x=0;x<grayMat.cols;x++){
        let inside=cv.pointPolygonTest(contour,new cv.Point(x,y),false);
        if(inside>=0){
          let pv=sampleGrayAt(x,y);
          let z=-((255-pv)/255.0)*maxDepth;if(invertZ)z=-z;
          rowPoints.push({x,y,z});
        }
      }
      if(rowPoints.length>1){
        if((y/step)%2===0){ // ذهاب
          lines.push(`G0 X${rowPoints[0].x} Y${rowPoints[0].y} Z${safeZ}`);
          lines.push(`G1 F${feed}`);
          for(let i=0;i<rowPoints.length;i++){let p=rowPoints[i];
            lines.push(`G1 X${p.x} Y${p.y} Z${p.z.toFixed(3)}`);
            if(i>0)totalLen+=Math.hypot(p.x-rowPoints[i-1].x,p.y-rowPoints[i-1].y);
          }
        }else{ // اياب
          rowPoints.reverse();
          lines.push(`G0 X${rowPoints[0].x} Y${rowPoints[0].y} Z${safeZ}`);
          lines.push(`G1 F${feed}`);
          for(let i=0;i<rowPoints.length;i++){let p=rowPoints[i];
            lines.push(`G1 X${p.x} Y${p.y} Z${p.z.toFixed(3)}`);
            if(i>0)totalLen+=Math.hypot(p.x-rowPoints[i-1].x,p.y-rowPoints[i-1].y);
          }
        }
        lines.push(`G0 Z${safeZ}`);
      }
    }
  }
  lines.push('M5');lines.push('M30');
  let timeMin=(totalLen/feed);
  document.getElementById('estTime').textContent="تقدير الوقت: "+timeMin.toFixed(1)+" دقيقة";
  return lines.join('\n');
}

/* زر توليد */
document.getElementById('btnGen').addEventListener('click',()=>{
  let gcode=generateRasterGcode(false);
  document.getElementById('gcodeOut').value=gcode;showToast("تم توليد G-code");
});
document.getElementById('btnQuick').addEventListener('click',()=>{
  let gcode=generateRasterGcode(true);
  document.getElementById('gcodeOut').value=gcode;showToast("توليد سريع");
});

/* 3D Preview */
function show3D(){
  const cont=document.getElementById('threeContainer');cont.innerHTML="";
  const scene=new THREE.Scene();
  const camera=new THREE.PerspectiveCamera(45,cont.clientWidth/cont.clientHeight,0.1,1000);
  const renderer=new THREE.WebGLRenderer();renderer.setSize(cont.clientWidth,cont.clientHeight);
  cont.appendChild(renderer.domElement);

  const geom=new THREE.PlaneGeometry(grayMat.cols,grayMat.rows,grayMat.cols-1,grayMat.rows-1);
  for(let y=0;y<grayMat.rows;y++){
    for(let x=0;x<grayMat.cols;x++){
      let v=sampleGrayAt(x,y);let z=(v/255.0)*10;
      let idx=y*grayMat.cols+x;geom.attributes.position.setZ(idx,z);
    }
  }
  geom.computeVertexNormals();
  const mesh=new THREE.Mesh(geom,new THREE.MeshStandardMaterial({color:0xcccccc,side:THREE.DoubleSide}));
  scene.add(mesh);
  const light=new THREE.DirectionalLight(0xffffff,1);light.position.set(0,0,100);scene.add(light);
  scene.add(new THREE.AmbientLight(0x404040));
  camera.position.set(0,-grayMat.rows,grayMat.rows);
  const controls=new THREE.OrbitControls(camera,renderer.domElement);

  function animate(){requestAnimationFrame(animate);controls.update();renderer.render(scene,camera);}
  animate();
}
document.querySelector('button[data-tab="threeD"]').addEventListener('click',()=>{if(grayMat)show3D();});
</script>
</body>
</html>
