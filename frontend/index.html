<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CNC AI — Router Raster Engraving</title>

<!-- مكتبات -->
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

<style>
:root{--bg:#071022;--panel:#0b1320;--accent:#06b6d4;--muted:#9bb0c8}
body{margin:0;font-family:Arial,Segoe UI,system-ui;background:#041022;color:#e6eef6}
.app{max-width:1200px;margin:16px auto;padding:14px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
h1{margin:0;color:var(--accent)}
.grid{display:grid;grid-template-columns:1fr 420px;gap:12px}
.panel{background:var(--panel);padding:12px;border-radius:10px}
.small{font-size:13px;color:var(--muted)}
.preview-wrap{position:relative;background:#000;border-radius:8px;overflow:hidden}
canvas#previewCanvas{display:block;width:100%;height:auto;background:#000}
#threeContainer{width:100%;height:360px;background:#081224;border-radius:8px;margin-top:10px}
label{display:block;margin-top:8px;color:var(--muted)}
input,select,button,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:#e6eef6;box-sizing:border-box}
button.primary{background:var(--accent);color:#042;border:none;cursor:pointer;font-weight:700}
textarea{height:200px;background:#021024;color:#cfeaf2;font-family:monospace;white-space:pre-wrap;overflow:auto}
#toast{position:fixed;left:16px;bottom:16px;background:rgba(0,0,0,0.85);color:#fff;padding:8px 10px;border-radius:8px;display:none;z-index:10000}
@media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>CNC AI — Router Raster 3D Engraving</h1>
    <div class="small" id="cvState">انتظر OpenCV</div>
  </header>

  <div class="grid">
    <!-- يسار -->
    <div class="panel">
      <input id="fileInput" type="file" accept="image/*"/>
      <div class="preview-wrap" style="margin-top:8px">
        <canvas id="previewCanvas" width="600" height="400"></canvas>
      </div>
      <div id="threeContainer"></div>
    </div>

    <!-- يمين -->
    <div class="panel">
      <h3>إعدادات Router</h3>
      <label>Feed (مم/دقيقة)<input id="feedRate" type="number" value="800"/></label>
      <label>Safe Z (مم)<input id="safeZ" type="number" value="5"/></label>
      <label>Invert Z<select id="invertZ"><option value="no">لا</option><option value="yes">نعم</option></select></label>
      <label>اتجاه المسارات
        <select id="scanDir">
          <option value="x">أفقي (X)</option>
          <option value="y">رأسي (Y)</option>
        </select>
      </label>
      <label>خطوة المسح (مم)<input id="stepOver" type="number" value="1.0" step="0.1"/></label>
      <label>أقصى عمق (مم)<input id="maxDepth" type="number" value="3.0" step="0.1"/></label>

      <button id="btnGen" class="primary" style="margin-top:10px">توليد G-code</button>
      <textarea id="gcodeOut" readonly></textarea>
    </div>
  </div>
</div>
<div id="toast"></div>

<script>
/* Toast */
function showToast(msg, ms=2000){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.display='block';
  clearTimeout(t._t);
  t._t=setTimeout(()=>t.style.display='none',ms);
}

/* OpenCV */
let cvReady=false, grayMat=null;
function waitForCv(){
  if(window.cv&&cv.getBuildInformation){
    cvReady=true;
    document.getElementById('cvState').textContent='OpenCV جاهز';
  } else if(window.cv){
    cv.onRuntimeInitialized=()=>{
      cvReady=true;
      document.getElementById('cvState').textContent='OpenCV جاهز';
    };
  } else setTimeout(waitForCv,200);
}
waitForCv();

/* Canvas */
const preview=document.getElementById('previewCanvas');
const ctx=preview.getContext('2d');

/* رفع صورة */
document.getElementById('fileInput').addEventListener('change',e=>{
  const file=e.target.files[0];
  if(!file) return;
  const img=new Image();
  img.onload=function(){
    preview.width=img.width>600?600:img.width;
    preview.height=img.height*(preview.width/img.width);
    ctx.drawImage(img,0,0,preview.width,preview.height);
    if(cvReady){
      let src=cv.imread(preview);
      let gray=new cv.Mat();
      cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY,0);
      grayMat=gray;
      src.delete();
      showToast("تم تحميل ومعالجة الصورة");
      show3DPreview();
    }
  }
  img.src=URL.createObjectURL(file);
});

/* عينة من Heatmap */
function sampleGrayAtPreviewXY(x,y){
  if(!grayMat) return 128;
  x=Math.min(Math.max(x,0),grayMat.cols-1);
  y=Math.min(Math.max(y,0),grayMat.rows-1);
  return grayMat.ucharPtr(y,x)[0];
}

/* Raster G-code */
function generateRasterGcode(){
  if(!grayMat){showToast("لم يتم تحميل صورة");return "";}
  const dir=document.getElementById('scanDir').value;
  const stepOver=parseFloat(document.getElementById('stepOver').value);
  const realW=grayMat.cols;
  const realH=grayMat.rows;
  const maxDepth=parseFloat(document.getElementById('maxDepth').value);
  const feed=parseFloat(document.getElementById('feedRate').value);
  const safeZ=parseFloat(document.getElementById('safeZ').value);
  const invertZ=document.getElementById('invertZ').value==='yes';

  const lines=[];
  lines.push('; --- Raster Engraving ---');
  lines.push('G21 G90 G17');
  lines.push(`G0 Z${safeZ.toFixed(3)}`);

  if(dir==='x'){
    const rows=Math.floor(realH/stepOver);
    for(let i=0;i<=rows;i++){
      const y=Math.round(i*stepOver);
      let rowPoints=[];
      for(let x=0;x<realW;x++){
        const pv=sampleGrayAtPreviewXY(x,y);
        let z=-((255-pv)/255.0)*maxDepth;
        if(invertZ) z=-z;
        rowPoints.push({x,y,z});
      }
      if(rowPoints.length>0){
        if(i%2===0){
          lines.push(`G0 X${rowPoints[0].x} Y${rowPoints[0].y} Z${safeZ}`);
          lines.push(`G1 F${feed}`);
          rowPoints.forEach(p=>{
            lines.push(`G1 X${p.x} Y${p.y} Z${p.z.toFixed(3)}`);
          });
        } else {
          rowPoints.reverse();
          lines.push(`G0 X${rowPoints[0].x} Y${rowPoints[0].y} Z${safeZ}`);
          lines.push(`G1 F${feed}`);
          rowPoints.forEach(p=>{
            lines.push(`G1 X${p.x} Y${p.y} Z${p.z.toFixed(3)}`);
          });
        }
        lines.push(`G0 Z${safeZ}`);
      }
    }
  } else {
    const cols=Math.floor(realW/stepOver);
    for(let i=0;i<=cols;i++){
      const x=Math.round(i*stepOver);
      let colPoints=[];
      for(let y=0;y<realH;y++){
        const pv=sampleGrayAtPreviewXY(x,y);
        let z=-((255-pv)/255.0)*maxDepth;
        if(invertZ) z=-z;
        colPoints.push({x,y,z});
      }
      if(colPoints.length>0){
        if(i%2===0){
          lines.push(`G0 X${colPoints[0].x} Y${colPoints[0].y} Z${safeZ}`);
          lines.push(`G1 F${feed}`);
          colPoints.forEach(p=>{
            lines.push(`G1 X${p.x} Y${p.y} Z${p.z.toFixed(3)}`);
          });
        } else {
          colPoints.reverse();
          lines.push(`G0 X${colPoints[0].x} Y${colPoints[0].y} Z${safeZ}`);
          lines.push(`G1 F${feed}`);
          colPoints.forEach(p=>{
            lines.push(`G1 X${p.x} Y${p.y} Z${p.z.toFixed(3)}`);
          });
        }
        lines.push(`G0 Z${safeZ}`);
      }
    }
  }

  lines.push('M5');
  lines.push('M30');
  return lines.join('\n');
}

/* زر التوليد */
document.getElementById('btnGen').addEventListener('click',()=>{
  const gcode=generateRasterGcode();
  document.getElementById('gcodeOut').value=gcode;
  showToast("تم توليد G-code");
});

/* معاينة 3D */
function show3DPreview(){
  const container=document.getElementById('threeContainer');
  container.innerHTML="";
  const scene=new THREE.Scene();
  const camera=new THREE.PerspectiveCamera(45,container.clientWidth/container.clientHeight,0.1,1000);
  const renderer=new THREE.WebGLRenderer();
  renderer.setSize(container.clientWidth,container.clientHeight);
  container.appendChild(renderer.domElement);

  const geometry=new THREE.PlaneGeometry(grayMat.cols,grayMat.rows,grayMat.cols-1,grayMat.rows-1);
  for(let y=0;y<grayMat.rows;y++){
    for(let x=0;x<grayMat.cols;x++){
      const pv=sampleGrayAtPreviewXY(x,y);
      const z=(pv/255.0)*10;
      const idx=y*grayMat.cols+x;
      geometry.attributes.position.setZ(idx,z);
    }
  }
  geometry.computeVertexNormals();
  const material=new THREE.MeshStandardMaterial({color:0xcccccc,wireframe:false,side:THREE.DoubleSide});
  const mesh=new THREE.Mesh(geometry,material);
  scene.add(mesh);

  const light=new THREE.DirectionalLight(0xffffff,1);
  light.position.set(0,0,100);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0x404040));

  camera.position.set(0,-grayMat.rows,grayMat.rows);
  const controls=new THREE.OrbitControls(camera,renderer.domElement);

  function animate(){requestAnimationFrame(animate);controls.update();renderer.render(scene,camera);}
  animate();
}
</script>
</body>
</html>
