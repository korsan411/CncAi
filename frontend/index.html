<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNC AI - ุงููุณุฎุฉ ุงููุชุทูุฑุฉ ูุน Top View</title>
  <style>
    /* ุฃููุงุท CSS ุงูุญุงููุฉ (ููุณูุง) */
    :root {
      --primary-color: #4a90e2;
      --secondary-color: #67b0f5;
      --bg-color: #f8f9fa;
      --text-color: #212529;
      --card-bg: #ffffff;
      --border-color: #dee2e6;
      --header-bg: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      --header-text: #ffffff;
      --button-bg: #e9ecef;
      --button-hover: #dee2e6;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --error-color: #dc3545;
      --ai-color: #9c27b0;
      --wood-color: #8b4513;
      --tab-inactive: #e9ecef;
      --tab-active: var(--primary-color);
    }

    body.dark {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --card-bg: #1e1e1e;
      --border-color: #444;
      --header-bg: linear-gradient(90deg, #2c2c2c, #444);
      --button-bg: #333;
      --button-hover: #555;
      --ai-color: #ba68c8;
      --wood-color: #a0522d;
      --tab-inactive: #333;
      --tab-active: #4a90e2;
    }

    /* ุจุงูู ุงูุฃููุงุท ุชุจูู ููุง ูู */
    /* ... */
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1><span>๐๏ธ</span> CNC AI - ุงููุณุฎุฉ ุงููุญุณูุฉ</h1>
      <div class="controls">
        <button id="themeToggle">๐</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- ุงูุชุงุจุงุช -->
    <div class="tabs">
      <div class="tab active" data-tab="preview">ูุนุงููุฉ ุงูุตูุฑุฉ</div>
      <div class="tab" data-tab="gcode">G-code ุฅุนุฏุงุฏุงุช</div>
      <div class="tab" data-tab="simulation">ูุญุงูุงุฉ G-code</div>
    </div>

    <!-- ุชุงุจ ุงููุนุงููุฉ -->
    <div class="tab-content active" id="preview-tab">
      <section class="upload-section">
        <h2 class="upload-title">๐ค ุชุญููู ุงูุตูุฑุฉ</h2>
        <div class="file-upload">
          <input type="file" id="fileInput" accept="image/*">
          <label for="fileInput"><span>๐</span> ุงุฎุชุฑ ุตูุฑุฉ</label>
          <div class="file-name" id="fileName">ูู ูุชู ุงุฎุชูุงุฑ ุฃู ุตูุฑุฉ ุจุนุฏ</div>
        </div>

        <div class="progress-container" id="progressContainer">
          <div class="progress-bar" id="progressBar"></div>
        </div>

        <div class="image-enhancement">
          <div class="enhancement-btn" onclick="applyEnhancement('brightness')">๐ ุณุทูุน</div>
          <div class="enhancement-btn" onclick="applyEnhancement('contrast')">๐ ุชุจุงูู</div>
          <div class="enhancement-btn" onclick="applyEnhancement('sharpen')">๐ ุญุฏุฉ</div>
          <div class="enhancement-btn" onclick="applyEnhancement('smooth')">๐ ูุนููุฉ</div>
          <div class="enhancement-btn" onclick="applyEnhancement('grayscale')">โซ ุชุฏุฑุฌ ุฑูุงุฏู</div>
          <div class="enhancement-btn" onclick="applyEnhancement('reset')">๐ ุฅุนุงุฏุฉ ุชุนููู</div>
        </div>

        <div class="edge-detection">
          <div class="enhancement-btn" onclick="detectEdges('sobel')">๐ ูุดู ุงูุญูุงู (Sobel)</div>
          <div class="enhancement-btn" onclick="detectEdges('canny')">๐ ูุดู ุงูุญูุงู (Canny)</div>
          <div class="enhancement-btn" onclick="detectEdges('laplacian')">๐ ูุดู ุงูุญูุงู (Laplacian)</div>
        </div>
      </section>

      <div class="previews-container">
        <!-- ุงูุตูุฑุฉ ุงูุฃุตููุฉ -->
        <div class="preview-block">
          <h3 class="preview-title">๐ท ุงูุตูุฑุฉ ุงูุฃุตููุฉ</h3>
          <div class="preview-content">
            <canvas id="preview2d"></canvas>
          </div>
          <div class="options">
            <div class="option-group">
              <label for="startPointX">๐ ููุทุฉ ุงูุจุฏุงูุฉ X</label>
              <input type="range" id="startPointX" min="0" max="100" step="1" value="50">
            </div>
            <div class="option-group">
              <label for="startPointY">๐ ููุทุฉ ุงูุจุฏุงูุฉ Y</label>
              <input type="range" id="startPointY" min="0" max="100" step="1" value="50">
            </div>
            <button class="btn btn-secondary" onclick="selectStartPoint()">ุชุญุฏูุฏ ููุทุฉ ุงูุจุฏุงูุฉ</button>
          </div>
        </div>

        <!-- ูุนุงููุฉ 3D -->
        <div class="preview-block">
          <h3 class="preview-title">๐ ุงููุนุงููุฉ ุซูุงุซูุฉ ุงูุฃุจุนุงุฏ</h3>
          <div class="preview-content">
            <div id="preview3d">
              <div class="loading" id="loading3d">
                <div class="loading-spinner"></div>
                <p>ุฌุงุฑู ุชุญููู ุงููููุฐุฌ...</p>
              </div>
            </div>
          </div>
          <div class="options">
            <div class="option-group">
              <label for="rotationSpeed">๐ ุณุฑุนุฉ ุงูุฏูุฑุงู</label>
              <input type="range" id="rotationSpeed" min="0" max="0.05" step="0.001" value="0.01">
            </div>
            <div class="option-group">
              <label for="zoomControl">๐ ุฒูู</label>
              <input type="range" id="zoomControl" min="50" max="500" step="10" value="200">
            </div>
            <div class="option-group">
              <label for="heightIntensity">๐ ุดุฏุฉ ุงูุงุฑุชูุงุน</label>
              <input type="range" id="heightIntensity" min="20" max="200" step="5" value="80">
            </div>
          </div>
        </div>

        <!-- Heatmap -->
        <div class="preview-block">
          <h3 class="preview-title">๐ ุฎุฑูุทุฉ ุงูุงุฑุชูุงุนุงุช (Heatmap)</h3>
          <div class="preview-content">
            <canvas id="heatmap"></canvas>
          </div>
          <div class="colormap-controls">
            <button class="btn btn-secondary" onclick="setColormap('jet')"><span>๐</span> Jet</button>
            <button class="btn btn-secondary" onclick="setColormap('hot')"><span>๐ฅ</span> Hot</button>
            <button class="btn btn-secondary" onclick="setColormap('cool')"><span>โ๏ธ</span> Cool</button>
            <button class="btn btn-secondary" onclick="setColormap('gray')"><span>โช</span> Gray</button>
          </div>
        </div>

        <!-- ุญูุงู ุงูุตูุฑุฉ -->
        <div class="preview-block">
          <h3 class="preview-title">๐ ุญูุงู ุงูุตูุฑุฉ</h3>
          <div class="preview-content">
            <canvas id="edgesCanvas"></canvas>
          </div>
          <div class="options">
            <div class="option-group">
              <label for="edgeThreshold">๐ ุนุชุจุฉ ุงูุญูุงู</label>
              <input type="range" id="edgeThreshold" min="1" max="100" step="1" value="50" oninput="updateEdgeDetection()">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ุชุงุจ ุฅุนุฏุงุฏุงุช G-code -->
    <div class="tab-content" id="gcode-tab">
      <div class="ai-options">
        <h3><span>๐ค</span> ุฎูุงุฑุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู</h3>
        <div class="path-optimization">
          <div class="optimization-option">
            <input type="checkbox" id="optimizePaths" checked>
            <label for="optimizePaths">ุชุญุณูู ุงููุณุงุฑุงุช ูุชูููู ููุช ุงููุทุน</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="smoothEdges" checked>
            <label for="smoothEdges">ุชูุนูู ุงูุญูุงู ูููุชุงุฆุฌ ุงูุฃูุถู</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="adaptivePrecision">
            <label for="adaptivePrecision">ุงูุฏูุฉ ุงูุชููููุฉ (ุชููุงุฆูุฉ)</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useEdges" checked>
            <label for="useEdges">ุงุณุชุฎุฏุงู ุญูุงู ุงูุตูุฑุฉ ูุชูููุฏ ุงููุณุงุฑุงุช</label>
          </div>
          <div class="optimization-option">
            <input type="checkbox" id="useHeatmap" checked>
            <label for="useHeatmap">ุฏูุฌ Heatmap ูุน ุงูุญูุงู</label>
          </div>
        </div>
      </div>

      <div class="settings-panel">
        <!-- ุฅุนุฏุงุฏุงุช ุงููุงูููุฉ ูุงูุฎุงูุฉ ูุงููุทุน (ููุณูุง) -->
        <!-- ... -->

        <div class="settings-group">
          <h3><span>๐ง</span> ุฅุนุฏุงุฏุงุช G-code</h3>
          <div class="form-group">
            <label for="gcodeType">ููุน ุงููุฎุฑุฌุงุช</label>
            <select id="gcodeType">
              <option value="heatmap">ุจูุงุกู ุนูู Heatmap</option>
              <option value="3dmodel">ุจูุงุกู ุนูู ุงููููุฐุฌ ุซูุงุซู ุงูุฃุจุนุงุฏ</option>
              <option value="edges">ุจูุงุกู ุนูู ุญูุงู ุงูุตูุฑุฉ</option>
              <option value="hybrid">ูุฌูู (ุญูุงู + Heatmap)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="gcodePrecision">ุฏูุฉ ุงูุชูููุฏ</label>
            <select id="gcodePrecision">
              <option value="low">ููุฎูุถุฉ (ุฃุณุฑุน)</option>
              <option value="medium" selected>ูุชูุณุทุฉ</option>
              <option value="high">ุนุงููุฉ (ุฃุจุทุฃ)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="startPointStrategy">ุงุณุชุฑุงุชูุฌูุฉ ููุทุฉ ุงูุจุฏุงูุฉ</label>
            <select id="startPointStrategy">
              <option value="auto">ุชููุงุฆู (ุฃูุฑุจ ููุทุฉ)</option>
              <option value="manual">ูุฏูู (ูุญุฏุฏ ูู ุงููุณุชุฎุฏู)</option>
              <option value="center">ูู ุงููุฑูุฒ</option>
            </select>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn btn-primary" onclick="generateGcode()">
            <span>โก</span> ุชูููุฏ G-code
          </button>
          <button class="btn btn-secondary" onclick="downloadGcode()">
            <span>๐พ</span> ุญูุธ G-code
          </button>
          <button class="btn btn-secondary" onclick="simulateGcode()">
            <span>๐</span> ูุญุงูุงุฉ G-code
          </button>
        </div>

        <div class="gcode-output" id="gcodeOutput">
// ุณูุธูุฑ ููุฏ G-code ููุง ุจุนุฏ ุงูุชูููุฏ
// ุงุถุบุท ุนูู "ุชูููุฏ G-code" ูุจุฏุก ุนูููุฉ ุงูุชูููุฏ
        </div>
      </div>
    </div>

    <!-- ุชุงุจ ูุญุงูุงุฉ G-code (ููุณูุง) -->
    <!-- ... -->
  </div>

  <footer>
    <p>ุชู ุงูุชุทููุฑ ุจุงุณุชุฎุฏุงู Three.js ู TensorFlow.js - ูุดุฑูุน CncAI ูุน ูุนุงูุฌุฉ ูุชูุฏูุฉ ููุตูุฑ</p>
  </footer>

  <div class="notification" id="notification">ุชู ุชุญููู ุงูุตูุฑุฉ ุจูุฌุงุญ!</div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
  <script>
    // ============== ุงููุชุบูุฑุงุช ุงูุนุงูุฉ ==============
    let startPoint = { x: 0, y: 0 }; // ููุทุฉ ุงูุจุฏุงูุฉ ุงูุงูุชุฑุงุถูุฉ
    let isSelectingStartPoint = false;

    // ============== ุฏูุงู ุฌุฏูุฏุฉ ==============

    // ุฏุงูุฉ ูุชุญุฏูุฏ ููุทุฉ ุงูุจุฏุงูุฉ ูุฏููุงู
    function selectStartPoint() {
      isSelectingStartPoint = true;
      showNotification('ุงููุฑ ุนูู ุงูุตูุฑุฉ ูุชุญุฏูุฏ ููุทุฉ ุงูุจุฏุงูุฉ');
      
      // ุฅุถุงูุฉ ูุณุชูุน ุญุฏุซ ููููุฑ ุนูู ุงูุตูุฑุฉ
      canvas2d.addEventListener('click', setStartPointHandler);
      canvas2d.style.cursor = 'crosshair';
    }

    // ูุนุงูุฌ ุญุฏุซ ุชุญุฏูุฏ ููุทุฉ ุงูุจุฏุงูุฉ
    function setStartPointHandler(event) {
      if (!isSelectingStartPoint) return;
      
      const rect = canvas2d.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      
      // ุชุญููู ุงูุฅุญุฏุงุซูุงุช ุฅูู ูุณุจุฉ ูุฆููุฉ
      startPoint = {
        x: (x / canvas2d.width) * 100,
        y: (y / canvas2d.height) * 100
      };
      
      // ุชุญุฏูุซ ุนูุงุตุฑ ุงูุชุญูู
      document.getElementById('startPointX').value = startPoint.x;
      document.getElementById('startPointY').value = startPoint.y;
      
      // ุฑุณู ุฏุงุฆุฑุฉ ุนูู ููุทุฉ ุงูุจุฏุงูุฉ
      drawStartPointMarker(x, y);
      
      // ุฅุฒุงูุฉ ูุณุชูุน ุงูุฃุญุฏุงุซ
      canvas2d.removeEventListener('click', setStartPointHandler);
      canvas2d.style.cursor = 'default';
      isSelectingStartPoint = false;
      
      showNotification('ุชู ุชุญุฏูุฏ ููุทุฉ ุงูุจุฏุงูุฉ ุจูุฌุงุญ');
    }

    // ุฏุงูุฉ ูุฑุณู ุนูุงูุฉ ููุทุฉ ุงูุจุฏุงูุฉ ุนูู Canvas
    function drawStartPointMarker(x, y) {
      ctx2d.save();
      ctx2d.beginPath();
      ctx2d.arc(x, y, 10, 0, Math.PI * 2);
      ctx2d.strokeStyle = '#00ff00';
      ctx2d.lineWidth = 3;
      ctx2d.stroke();
      ctx2d.restore();
    }

    // ุฏุงูุฉ ูุงุณุชุฎุฑุงุฌ ููุงุท ูู Heatmap
    function extractHeatmapPoints(heightData, width, height, cutDepth, resolution) {
      const points = [];
      
      for (let y = 0; y < height; y += resolution) {
        for (let x = 0; x < width; x += resolution) {
          const idx = y * width + x;
          if (idx < heightData.length) {
            const pixelValue = heightData[idx] / 255; // ุชุทุจูุน ุงููููุฉ ุจูู 0 ู1
            // ุชุญููู ูููุฉ ุงูุจููุณู ุฅูู ุนูู ูุทุน (ุงูููู ุงูุฃุบูู = ูุทุน ุฃุนูู)
            const depth = (1 - pixelValue) * cutDepth;
            
            points.push({
              x: (x / width) * 100 - 50, // ุชุญููู ุฅูู ุฅุญุฏุงุซูุงุช ูู -50 ุฅูู 50
              y: (y / height) * 100 - 50,
              z: -depth,
              value: pixelValue // ุญูุธ ูููุฉ ุงูุจูุณู ูุฃุบุฑุงุถ ุงูุชุฑุฌูุญ
            });
          }
        }
      }
      
      return points;
    }

    // ุฏุงูุฉ ูุฏูุฌ ูุณุงุฑุงุช ุงูุญูุงู ู Heatmap
    function mergeEdgeAndHeatmapPaths(edgePoints, heatmapPoints, mergeFactor) {
      if (edgePoints.length === 0) return heatmapPoints;
      if (heatmapPoints.length === 0) return edgePoints;
      
      const mergedPoints = [...edgePoints];
      
      // ุฏูุฌ ุงูููุงุท ุจูุงุกู ุนูู ุนุงูู ุงูุฏูุฌ
      for (const heatPoint of heatmapPoints) {
        // ุงูุจุญุซ ุนู ุฃูุฑุจ ููุทุฉ ุญุงูุฉ
        let closestDist = Infinity;
        let closestPoint = null;
        
        for (const edgePoint of edgePoints) {
          const dist = Math.sqrt(
            Math.pow(heatPoint.x - edgePoint.x, 2) + 
            Math.pow(heatPoint.y - edgePoint.y, 2)
          );
          
          if (dist < closestDist) {
            closestDist = dist;
            closestPoint = edgePoint;
          }
        }
        
        // ุฅุฐุง ูุงูุช ุงูููุทุฉ ูุฑูุจุฉ ุจูุง ููููุ ุฏูุฌูุง
        if (closestDist < 5) { // ุนุชุจุฉ ุงููุฑุจ
          const mergedPoint = {
            x: (heatPoint.x * mergeFactor + closestPoint.x * (1 - mergeFactor)),
            y: (heatPoint.y * mergeFactor + closestPoint.y * (1 - mergeFactor)),
            z: (heatPoint.z * mergeFactor + closestPoint.z * (1 - mergeFactor))
          };
          mergedPoints.push(mergedPoint);
        } else {
          mergedPoints.push(heatPoint);
        }
      }
      
      return mergedPoints;
    }

    // ุฏุงูุฉ ูุชุญุฏูุฏ ููุทุฉ ุงูุจุฏุงูุฉ ุจูุงุกู ุนูู ุงูุงุณุชุฑุงุชูุฌูุฉ ุงููุฎุชุงุฑุฉ
    function determineStartPoint(points, strategy) {
      if (points.length === 0) return { x: 0, y: 0, z: 0 };
      
      if (strategy === 'manual') {
        // ุงุณุชุฎุฏุงู ุงูููุทุฉ ุงููุญุฏุฏุฉ ูุฏููุงู ูุชุญููููุง ุฅูู ุฅุญุฏุงุซูุงุช ุงููุธุงู
        return {
          x: startPoint.x - 50,
          y: startPoint.y - 50,
          z: 0
        };
      } else if (strategy === 'center') {
        // ุงูุจุฏุก ูู ุงููุฑูุฒ
        return { x: 0, y: 0, z: 0 };
      } else {
        // ุงุณุชุฑุงุชูุฌูุฉ ุชููุงุฆูุฉ: ุงูุนุซูุฑ ุนูู ุฃูุฑุจ ููุทุฉ ุฅูู ุงูุฃุตู
        let closestPoint = points[0];
        let minDist = Math.sqrt(
          Math.pow(points[0].x, 2) + 
          Math.pow(points[0].y, 2)
        );
        
        for (let i = 1; i < points.length; i++) {
          const dist = Math.sqrt(
            Math.pow(points[i].x, 2) + 
            Math.pow(points[i].y, 2)
          );
          
          if (dist < minDist) {
            minDist = dist;
            closestPoint = points[i];
          }
        }
        
        return closestPoint;
      }
    }

    // ============== ุชุนุฏูู ุฏูุงู ููุฌูุฏุฉ ==============

    // ุชุนุฏูู ุฏุงูุฉ generateRealGcode ูุฏุนู ุงูุฎูุงุฑุงุช ุงูุฌุฏูุฏุฉ
    async function generateRealGcode() {
      if (!heightMapData || !originalImageData) {
        showNotification('ูุฌุจ ุชุญููู ุตูุฑุฉ ุฃููุงู', true);
        return '';
      }

      const machineType = document.getElementById('machineType').value;
      const materialType = document.getElementById('materialType').value;
      const feedRate = parseInt(document.getElementById('feedRate').value);
      const spindleSpeed = parseInt(document.getElementById('spindleSpeed').value);
      const cutDepth = parseFloat(document.getElementById('cutDepth').value);
      const passDepth = parseFloat(document.getElementById('passDepth').value);
      const gcodePrecision = document.getElementById('gcodePrecision').value;
      const gcodeType = document.getElementById('gcodeType').value;
      const optimizePaths = document.getElementById('optimizePaths').checked;
      const smoothEdges = document.getElementById('smoothEdges').checked;
      const useEdges = document.getElementById('useEdges').checked;
      const useHeatmap = document.getElementById('useHeatmap').checked;
      const startStrategy = document.getElementById('startPointStrategy').value;
      
      // ุชุญุฏูุฏ ุงูุฏูุฉ ุจูุงุกู ุนูู ุงูุฅุนุฏุงุฏุงุช
      let resolution = 5; // ููุฎูุถุฉ
      if (gcodePrecision === 'medium') resolution = 3;
      if (gcodePrecision === 'high') resolution = 1;
      
      updateProgress(10);
      
      let points = [];
      let edgePoints = [];
      let heatmapPoints = [];
      
      // ูุนุงูุฌุฉ ุงูุญูุงู ุฅุฐุง ูุงูุช ููุนูุฉ ุฃู ุฅุฐุง ูุงู ุงูููุน ูุฌูู
      if (useEdges && edgesImageData && (gcodeType === 'edges' || gcodeType === 'hybrid')) {
        const width = edgesCanvas.width;
        const height = edgesCanvas.height;
        const edgeData = new Uint8ClampedArray(width * height);
        
        for (let i = 0; i < edgesImageData.data.length; i += 4) {
          edgeData[i/4] = edgesImageData.data[i];
        }
        
        edgePoints = extractEdgePoints(edgeData, width, height, cutDepth);
        updateProgress(30);
      }
      
      // ูุนุงูุฌุฉ Heatmap ุฅุฐุง ูุงูุช ููุนูุฉ ุฃู ุฅุฐุง ูุงู ุงูููุน ูุฌูู
      if (useHeatmap && heightMapData && (gcodeType === 'heatmap' || gcodeType === 'hybrid')) {
        heatmapPoints = extractHeatmapPoints(
          heightMapData.data, 
          heightMapData.width, 
          heightMapData.height, 
          cutDepth, 
          resolution
        );
        updateProgress(50);
      }
      
      // ุฏูุฌ ุงููุณุงุฑุงุช ุจูุงุกู ุนูู ููุน ุงููุฎุฑุฌุงุช ุงููุทููุจ
      if (gcodeType === 'edges') {
        points = edgePoints;
      } else if (gcodeType === 'heatmap') {
        points = heatmapPoints;
      } else if (gcodeType === 'hybrid') {
        points = mergeEdgeAndHeatmapPaths(edgePoints, heatmapPoints, 0.5);
      }
      
      updateProgress(70);
      
      // ุฅุฐุง ูู ููู ููุงู ููุงุทุ ูุณุชุฎุฏู ูุนุงูุฌุฉ ุงูุตูุฑุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุฎูุงุฑ ุงุญุชูุงุทู
      if (points.length === 0) {
        showNotification('ุฌุงุฑู ุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุงุณุชุฎุฑุงุฌ ุงููุนุงูู...', false, 'ai');
        const heightData = await processImageWithAI(originalImageData);
        
        const width = canvas2d.width;
        const height = canvas2d.height;
        
        for (let y = 0; y < height; y += resolution) {
          for (let x = 0; x < width; x += resolution) {
            const idx = Math.floor(y) * width + Math.floor(x);
            if (idx < heightData.length * width) {
              const pixelValue = heightData[Math.floor(y)][Math.floor(x)] || 0;
              const depth = (1 - pixelValue) * cutDepth;
              
              points.push({
                x: (x / width) * 100 - 50,
                y: (y / height) * 100 - 50,
                z: -depth
              });
            }
          }
        }
      }
      
      // ุชุญุฏูุฏ ููุทุฉ ุงูุจุฏุงูุฉ
      const startPoint = determineStartPoint(points, startStrategy);
      
      // ุชุญุณูู ุงููุณุงุฑุงุช ุฅุฐุง ูุงู ุงูุฎูุงุฑ ููุนูุงู
      const toolPaths = optimizePaths ? optimizeToolpaths(points, startPoint) : points;
      updateProgress(80);
      
      // ุชูููุฏ G-code
      let gcode = `; G-code generated by CNC AI with TensorFlow.js\n`;
      gcode += `; Machine: ${machineType}\n`;
      gcode += `; Material: ${materialType}\n`;
      gcode += `; Feed rate: ${feedRate} mm/min\n`;
      gcode += `; Spindle speed: ${spindleSpeed} RPM\n`;
      gcode += `; Start point: X${startPoint.x.toFixed(2)} Y${startPoint.y.toFixed(2)}\n`;
      gcode += `; Total points: ${toolPaths.length}\n\n`;
      
      gcode += `G21 ; Set units to millimeters\n`;
      gcode += `G90 ; Absolute positioning\n`;
      gcode += `G0 Z5 ; Lift spindle\n`;
      gcode += `M3 S${spindleSpeed} ; Spindle on\n`;
      gcode += `G4 P2 ; Wait for spindle to reach speed\n\n`;
      
      gcode += `; Move to start position\n`;
      gcode += `G0 X${startPoint.x.toFixed(3)} Y${startPoint.y.toFixed(3)} Z5\n`;
      gcode += `G1 Z${startPoint.z.toFixed(3)} F${feedRate/2}\n\n`;
      
      gcode += `; Start cutting path\n`;
      
      // ุฅุถุงูุฉ ุฃูุงูุฑ ุงูุญุฑูุฉ
      for (let i = 0; i < toolPaths.length; i++) {
        const point = toolPaths[i];
        gcode += `G1 X${point.x.toFixed(3)} Y${point.y.toFixed(3)} Z${point.z.toFixed(3)} F${feedRate}\n`;
      }
      
      gcode += `\nG0 Z5 ; Lift spindle\n`;
      gcode += `M5 ; Spindle off\n`;
      gcode += `G0 X0 Y0 ; Return to home\n`;
      gcode += `M30 ; End program\n`;
      
      updateProgress(100);
      return gcode;
    }

    // ุชุนุฏูู ุฏุงูุฉ optimizeToolpaths ููุจูู ููุทุฉ ุงูุจุฏุงูุฉ
    function optimizeToolpaths(points, startPoint) {
      if (points.length <= 1) return points;
      
      // ุฅุฐุง ูุงูุช ููุงู ููุทุฉ ุจุฏุงูุฉ ูุญุฏุฏุฉุ ูุจุฏุฃ ูููุง
      const optimized = [startPoint];
      const remaining = points.filter(p => p !== startPoint);
      
      // ุฅุฐุง ูู ุชูู ููุทุฉ ุงูุจุฏุงูุฉ ููุฌูุฏุฉ ูู ุงูููุงุทุ ูุถูููุง
      if (!points.includes(startPoint)) {
        remaining.unshift(startPoint);
      }
      
      // ุงุณุชุฎุฏุงู ุฎูุงุฑุฒููุฉ ุฃูุฑุจ ุงูุฌุงุฑ ูุชุญุณูู ุงููุณุงุฑ
      while (remaining.length > 0) {
        const lastPoint = optimized[optimized.length - 1];
        let closestIdx = 0;
        let minDist = Infinity;
        
        for (let i = 0; i < remaining.length; i++) {
          const dist = Math.sqrt(
            Math.pow(lastPoint.x - remaining[i].x, 2) + 
            Math.pow(lastPoint.y - remaining[i].y, 2) +
            Math.pow(lastPoint.z - remaining[i].z, 2) * 0.2 // ูุฒู ุฃูู ููุจุนุฏ Z
          );
          
          if (dist < minDist) {
            minDist = dist;
            closestIdx = i;
          }
        }
        
        optimized.push(remaining[closestIdx]);
        remaining.splice(closestIdx, 1);
      }
      
      return optimized;
    }

    // ============== ุจุงูู ุงูุฏูุงู ุชุจูู ููุง ูู ูุน ุชุนุฏููุงุช ุทูููุฉ ==============
    // ... (ุงูุฏูุงู ุงูุฃุฎุฑู ุชุจูู ููุง ูู)

    // ุชุญุฏูุซ ุฎูุงุฑุงุช ูุงุฌูุฉ ุงููุณุชุฎุฏู ุนูุฏ ุชุบููุฑ ููุน G-code
    document.getElementById('gcodeType').addEventListener('change', function() {
      const gcodeType = this.value;
      const useEdges = document.getElementById('useEdges');
      const useHeatmap = document.getElementById('useHeatmap');
      
      if (gcodeType === 'edges') {
        useEdges.checked = true;
        useHeatmap.checked = false;
      } else if (gcodeType === 'heatmap') {
        useEdges.checked = false;
        useHeatmap.checked = true;
      } else if (gcodeType === 'hybrid') {
        useEdges.checked = true;
        useHeatmap.checked = true;
      }
    });

    // ุชุญุฏูุซ ุนูุงุตุฑ ุงูุชุญูู ุจููุทุฉ ุงูุจุฏุงูุฉ ุนูุฏ ุชุญููู ุงูุตูุฑุฉ
    // ุฅุถุงูุฉ ูุฐุง ูู ุฌุฒุก ุชุญููู ุงูุตูุฑุฉ
    fileInput.addEventListener('change', (e) => {
      // ุงูููุฏ ุงูุฃุตูู ูุชุญููู ุงูุตูุฑุฉ
      // ...
      
      // ุฅุนุงุฏุฉ ุชุนููู ููุทุฉ ุงูุจุฏุงูุฉ ุฅูู ุงููุฑูุฒ
      startPoint = { x: 50, y: 50 };
      document.getElementById('startPointX').value = 50;
      document.getElementById('startPointY').value = 50;
    });

    // ุชููุฆุฉ ููุทุฉ ุงูุจุฏุงูุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    window.addEventListener('load', function() {
      startPoint = { x: 50, y: 50 };
      document.getElementById('startPointX').value = 50;
      document.getElementById('startPointY').value = 50;
    });
  </script>
</body>
</html>
