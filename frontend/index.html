<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CNC AI — Multi Machine Raster Engraving</title>

<!-- مكتبات -->
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

<style>
body{margin:0;font-family:Arial,Segoe UI,system-ui;background:#041022;color:#e6eef6}
.app{max-width:1200px;margin:16px auto;padding:14px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
h1{margin:0;color:#06b6d4}
.grid{display:grid;grid-template-columns:1fr 420px;gap:12px}
.panel{background:#0b1320;padding:12px;border-radius:10px}
.tabs button{margin-right:6px;padding:6px 10px;border:none;border-radius:6px;cursor:pointer}
.tabs button.active{background:#06b6d4;color:#021}
.tab-content{display:none;margin-top:8px}
.tab-content.active{display:block}
canvas{max-width:100%;border-radius:6px;background:#000}
textarea{width:100%;height:200px;background:#021024;color:#cfeaf2;font-family:monospace;border-radius:8px;padding:8px}
#threeContainer{width:100%;height:360px;background:#081224;border-radius:8px}
label{display:block;margin-top:8px}
button.primary{background:#06b6d4;color:#021;font-weight:bold;border:none;padding:8px;border-radius:8px;cursor:pointer}
#toast{position:fixed;left:16px;bottom:16px;background:rgba(0,0,0,0.85);color:#fff;padding:8px 10px;border-radius:8px;display:none;z-index:10000}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>CNC AI — Multi Machine Raster</h1>
    <div id="cvState">انتظر OpenCV</div>
  </header>

  <div class="grid">
    <!-- يسار -->
    <div class="panel">
      <input id="fileInput" type="file" accept="image/*"/>
      <div class="tabs" style="margin-top:8px">
        <button data-tab="original" class="active">Original</button>
        <button data-tab="heatmap">Heatmap</button>
        <button data-tab="contour">Contour</button>
        <button data-tab="threeD">3D Preview</button>
      </div>
      <div id="original" class="tab-content active"><canvas id="canvasOriginal"></canvas></div>
      <div id="heatmap" class="tab-content"><canvas id="canvasHeatmap"></canvas></div>
      <div id="contour" class="tab-content"><canvas id="canvasContour"></canvas></div>
      <div id="threeD" class="tab-content"><div id="threeContainer"></div></div>
    </div>

    <!-- يمين -->
    <div class="panel">
      <h3>إعدادات التشغيل</h3>

      <label>نوع الماكينة
        <select id="machineType">
          <option value="router">Router</option>
          <option value="laser">Laser</option>
          <option value="plasma">Plasma</option>
        </select>
      </label>

      <label>Feed (مم/دقيقة)<input id="feedRate" type="number" value="800"/></label>
      <label>Safe Z (مم)<input id="safeZ" type="number" value="5"/></label>
      <label>Invert Z<select id="invertZ"><option value="no">لا</option><option value="yes">نعم</option></select></label>
      <label>اتجاه المسارات<select id="scanDir"><option value="x">أفقي (X)</option><option value="y">رأسي (Y)</option></select></label>
      <label>خطوة المسح (مم)<input id="stepOver" type="number" value="5" step="0.5"/></label>
      <label>أقصى عمق (مم)<input id="maxDepth" type="number" value="3.0" step="0.1"/></label>

      <button id="btnGen" class="primary" style="margin-top:10px">توليد G-code</button>
      <button id="btnQuick" style="margin-top:6px">اختبار سريع</button>
      <button id="btnDownload" style="margin-top:6px">تحميل G-code</button>
      <div id="estTime" style="margin-top:6px;color:#9bb0c8"></div>
      <textarea id="gcodeOut" readonly></textarea>
    </div>
  </div>
</div>
<div id="toast"></div>

<script>
/* Toast */
function showToast(msg, ms=2000){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.display='block';
  clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',ms);
}

/* OpenCV */
let cvReady=false, grayMat=null, contour=null, previewCanvas=null;
function waitForCv(){
  if(window.cv&&cv.getBuildInformation){
    cvReady=true;document.getElementById('cvState').textContent='OpenCV جاهز';
  } else if(window.cv){cv.onRuntimeInitialized=()=>{cvReady=true;document.getElementById('cvState').textContent='OpenCV جاهز';};}
  else setTimeout(waitForCv,200);
}
waitForCv();

/* Tabs */
document.querySelectorAll('.tabs button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
    btn.classList.add('active');document.getElementById(btn.dataset.tab).classList.add('active');
    if(btn.dataset.tab==="threeD" && grayMat){show3D();}
  });
});

/* Load Image */
document.getElementById('fileInput').addEventListener('change',e=>{
  const file=e.target.files[0];if(!file)return;
  const img=new Image();
  img.onload=function(){
    previewCanvas=document.getElementById('canvasOriginal');
    previewCanvas.width=img.width;previewCanvas.height=img.height;
    previewCanvas.getContext('2d').drawImage(img,0,0,previewCanvas.width,previewCanvas.height);
    if(cvReady){ detectContours(); }
  }
  img.src=URL.createObjectURL(file);
});

/* Bilinear Sampling */
function sampleGrayAt(x,y){
  if(!grayMat) return 128;
  const gw=grayMat.cols, gh=grayMat.rows;
  const gx_f=(x/previewCanvas.width)*(gw-1);
  const gy_f=(y/previewCanvas.height)*(gh-1);
  const x0=Math.floor(gx_f), y0=Math.floor(gy_f);
  const x1=Math.min(gw-1,x0+1), y1=Math.min(gh-1,y0+1);
  const sx=gx_f-x0, sy=gy_f-y0;
  const v00=grayMat.ucharPtr(y0,x0)[0];
  const v10=grayMat.ucharPtr(y0,x1)[0];
  const v01=grayMat.ucharPtr(y1,x0)[0];
  const v11=grayMat.ucharPtr(y1,x1)[0];
  const v0=v00*(1-sx)+v10*sx;
  const v1=v01*(1-sx)+v11*sx;
  return Math.round(v0*(1-sy)+v1*sy);
}

/* Enhanced Contour Detection */
function detectContours(){
  let src=cv.imread(previewCanvas);
  let gray=new cv.Mat();
  cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
  cv.GaussianBlur(gray,gray,new cv.Size(3,3),0,0);

  // auto Canny thresholds
  function medianGray(mat){
    const total=mat.rows*mat.cols, step=Math.max(1,Math.floor(total/5000));
    const vals=[];for(let i=0;i<total;i+=step) vals.push(mat.data[i]);
    vals.sort((a,b)=>a-b);
    return vals[Math.floor(vals.length/2)];
  }
  const med=medianGray(gray), sigma=0.33;
  const lower=Math.max(0,Math.round((1.0-sigma)*med));
  const upper=Math.min(255,Math.round((1.0+sigma)*med));

  let edges=new cv.Mat();
  cv.Canny(gray,edges,lower,upper);
  let k=cv.getStructuringElement(cv.MORPH_RECT,new cv.Size(3,3));
  cv.morphologyEx(edges,edges,cv.MORPH_CLOSE,k);

  let contours=new cv.MatVector(),hier=new cv.Mat();
  cv.findContours(edges,contours,hier,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);
  let maxArea=0;let chosen=null;
  for(let i=0;i<contours.size();i++){
    const cnt=contours.get(i);const a=cv.contourArea(cnt);
    if(a>maxArea){maxArea=a;chosen=cnt.clone();}
  }
  contour=chosen;

  if(grayMat){grayMat.delete();}
  grayMat=gray.clone();

  // render heatmap
  let heat=document.getElementById('canvasHeatmap');
  heat.width=gray.cols;heat.height=gray.rows;
  let hctx=heat.getContext('2d'), imgData=hctx.createImageData(heat.width,heat.height);
  for(let y=0;y<gray.rows;y++){
    for(let x=0;x<gray.cols;x++){
      let v=gray.ucharPtr(y,x)[0];
      let idx=(y*gray.cols+x)*4;
      imgData.data[idx]=v;imgData.data[idx+1]=0;imgData.data[idx+2]=255-v;imgData.data[idx+3]=255;
    }
  }
  hctx.putImageData(imgData,0,0);

  // contour preview
  let ccan=document.getElementById('canvasContour');
  ccan.width=gray.cols;ccan.height=gray.rows;
  let cctx=ccan.getContext('2d');
  cctx.drawImage(heat,0,0);
  if(contour){
    cctx.strokeStyle="lime";cctx.lineWidth=2;
    cctx.beginPath();
    for(let i=0;i<contour.data32S.length;i+=2){
      let x=contour.data32S[i], y=contour.data32S[i+1];
      if(i===0)cctx.moveTo(x,y);else cctx.lineTo(x,y);
    }
    cctx.closePath();cctx.stroke();
  }
  showToast("تم الكشف عن الحواف");
  src.delete();edges.delete();hier.delete();
}

/* Generate Raster Gcode */
function generateRasterGcode(scaleDown=false){
  if(!grayMat||!contour){showToast("لا توجد صورة جاهزة");return"";}
  const dir=document.getElementById('scanDir').value;
  const stepOver=parseFloat(document.getElementById('stepOver').value);
  const maxDepth=parseFloat(document.getElementById('maxDepth').value);
  const feed=parseFloat(document.getElementById('feedRate').value);
  const safeZ=parseFloat(document.getElementById('safeZ').value);
  const invertZ=document.getElementById('invertZ').value==='yes';

  const lines=[];lines.push('G21 G90 G17');lines.push(`G0 Z${safeZ.toFixed(2)}`);
  let totalLen=0, step=scaleDown?stepOver*4:stepOver;

  if(dir==='x'){
    for(let y=0;y<previewCanvas.height;y+=step){
      let row=[];
      for(let x=0;x<previewCanvas.width;x++){
        let inside=cv.pointPolygonTest(contour,new cv.Point(x,y),false);
        if(inside>=0){
          let pv=sampleGrayAt(x,y);
          let z=-((255-pv)/255.0)*maxDepth;if(invertZ)z=-z;
          row.push({x,y,z});
        }
      }
      if(row.length>1){
        if((y/step)%2!==0) row.reverse();
        lines.push(`G0 X${row[0].x} Y${row[0].y} Z${safeZ}`);
        lines.push(`G1 F${feed}`);
        for(let i=0;i<row.length;i++){
          let p=row[i];
          lines.push(`G1 X${p.x} Y${p.y} Z${p.z.toFixed(3)}`);
          if(i>0) totalLen+=Math.hypot(p.x-row[i-1].x,p.y-row[i-1].y);
        }
        lines.push(`G0 Z${safeZ}`);
      }
    }
  }
  lines.push('M5');lines.push('M30');
  let timeMin=(totalLen/feed);
  document.getElementById('estTime').textContent="تقدير الوقت: "+timeMin.toFixed(1)+" دقيقة";
  return lines.join('\n');
}

/* Machine defaults */
const machineDefaults = {
  router: {feed:800, safeZ:5, maxDepth:3, stepOver:5},
  laser:  {feed:1200, safeZ:0, maxDepth:0, stepOver:0.2},
  plasma: {feed:1500, safeZ:3, maxDepth:0, stepOver:1}
};
document.getElementById('machineType').addEventListener('change',(e)=>{
  const type=e.target.value, def=machineDefaults[type];
  if(def){
    document.getElementById('feedRate').value=def.feed;
    document.getElementById('safeZ').value=def.safeZ;
    document.getElementById('maxDepth').value=def.maxDepth;
    document.getElementById('stepOver').value=def.stepOver;
    showToast(`تم تحميل إعدادات ${type}`);
  }
});

/* Buttons */
document.getElementById('btnGen').addEventListener('click',()=>{
  let gcode=generateRasterGcode(false);
  document.getElementById('gcodeOut').value=gcode;showToast("تم توليد G-code");
});
document.getElementById('btnQuick').addEventListener('click',()=>{
  let gcode=generateRasterGcode(true);
  document.getElementById('gcodeOut').value=gcode;showToast("توليد سريع");
});
document.getElementById('btnDownload').addEventListener('click',()=>{
  const text=document.getElementById('gcodeOut').value;
  const blob=new Blob([text],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download="cnc_output.gcode";
  document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
});

/* 3D Preview */
function show3D(){
  const cont=document.getElementById('threeContainer');cont.innerHTML="";
  const scene=new THREE.Scene();
  const camera=new THREE.PerspectiveCamera(45,cont.clientWidth/cont.clientHeight,0.1,5000);
  const renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(cont.clientWidth,cont.clientHeight);
  cont.appendChild(renderer.domElement);

  const geom=new THREE.PlaneGeometry(grayMat.cols,grayMat.rows,grayMat.cols-1,grayMat.rows-1);
  for(let y=0;y<grayMat.rows;y++){
    for(let x=0;x<grayMat.cols;x++){
      let v=grayMat.ucharPtr(y,x)[0];let z=(v/255.0)*10;
      let idx=y*grayMat.cols+x;geom.attributes.position.setZ(idx,z);
    }
  }
  geom.attributes.position.needsUpdate=true;
  geom.computeVertexNormals();
  geom.rotateX(-Math.PI/2);

  const mesh=new THREE.Mesh(geom,new THREE.MeshStandardMaterial({color:0xcccccc,side:THREE.DoubleSide,flatShading:true}));
  scene.add(mesh);
  const light=new THREE.DirectionalLight(0xffffff,1);light.position.set(50,100,150);scene.add(light);
  scene.add(new THREE.AmbientLight(0x404040));

  camera.position.set(0,-grayMat.rows,grayMat.rows*1.2);
  const controls=new THREE.OrbitControls(camera,renderer.domElement);
  function animate(){requestAnimationFrame(animate);controls.update();renderer.render(scene,camera);}
  animate();
}
</script>
</body>
</html>
