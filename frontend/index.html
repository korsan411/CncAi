<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>CncAi - معاينات و G-code</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f9fa;
      color: #222;
    }
    header {
      background: #343a40;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 { font-size: 20px; }
    .container {
      padding: 20px;
      text-align: center;
    }
    canvas {
      border: 1px solid #ccc;
      margin: 10px 0;
      max-width: 100%;
    }
    .buttons {
      margin: 15px 0;
    }
    button {
      padding: 8px 15px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: #007bff;
      color: white;
      font-size: 14px;
    }
    button:hover { background: #0056b3; }
    #downloadLink {
      display: none;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <header>
    <h1>CncAi</h1>
    <input type="file" id="upload" accept="image/*">
  </header>

  <div class="container">
    <div class="buttons">
      <button onclick="showOriginal()">الصورة الأصلية</button>
      <button onclick="show2D()">معاينة 2D</button>
      <button onclick="showHeatmap()">Heatmap</button>
      <button onclick="show3D()">معاينة 3D</button>
      <button onclick="generateGcode()">توليد G-code</button>
    </div>
    <canvas id="canvas"></canvas>
    <a id="downloadLink" download="output.gcode">تحميل G-code</a>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");
    let img = new Image();
    let currentMode = "original";
    let imageData;

    // تحميل الصورة
    document.getElementById("upload").addEventListener("change", e => {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = ev => {
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
          imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // معاينة الصورة الأصلية
    function showOriginal() {
      currentMode = "original";
      ctx.drawImage(img, 0, 0);
    }

    // معاينة 2D (رمادي)
    function show2D() {
      currentMode = "2d";
      let gray = ctx.createImageData(imageData);
      for (let i = 0; i < imageData.data.length; i += 4) {
        let avg = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
        gray.data[i] = gray.data[i+1] = gray.data[i+2] = avg;
        gray.data[i+3] = 255;
      }
      ctx.putImageData(gray, 0, 0);
    }

    // معاينة Heatmap
    function showHeatmap() {
      currentMode = "heatmap";
      let heat = ctx.createImageData(imageData);
      for (let i = 0; i < imageData.data.length; i += 4) {
        let avg = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
        let r = avg, g = 0, b = 255 - avg;
        heat.data[i] = r;
        heat.data[i+1] = g;
        heat.data[i+2] = b;
        heat.data[i+3] = 255;
      }
      ctx.putImageData(heat, 0, 0);
    }

    // معاينة 3D
    function show3D() {
      currentMode = "3d";
      let width = canvas.width, height = canvas.height;

      let scene = new THREE.Scene();
      let camera = new THREE.PerspectiveCamera(45, canvas.clientWidth/canvas.clientHeight, 0.1, 1000);
      let renderer = new THREE.WebGLRenderer({canvas: canvas});
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);

      let geometry = new THREE.PlaneGeometry(width/100, height/100, width/10, height/10);
      let material = new THREE.MeshNormalMaterial({wireframe: false, side: THREE.DoubleSide});
      let plane = new THREE.Mesh(geometry, material);

      // تعديل الارتفاعات حسب التدرج
      let pos = geometry.attributes.position;
      for (let i = 0; i < pos.count; i++) {
        let x = Math.floor((i % (width/10)) * 10);
        let y = Math.floor((i / (width/10)) * 10);
        let idx = (y * width + x) * 4;
        let avg = (imageData.data[idx] + imageData.data[idx+1] + imageData.data[idx+2]) / 3;
        pos.setZ(i, avg / 50);
      }
      pos.needsUpdate = true;

      scene.add(plane);
      camera.position.z = 5;

      let animate = function() {
        requestAnimationFrame(animate);
        plane.rotation.y += 0.01;
        renderer.render(scene, camera);
      };
      animate();
    }

    // توليد G-code
    function generateGcode() {
      if (!imageData) { alert("حمّل صورة أولاً"); return; }
      let gcode = ["G21 ; Set units to mm", "G90 ; Absolute positioning"];
      let step = 10;
      for (let y = 0; y < canvas.height; y += step) {
        for (let x = 0; x < canvas.width; x += step) {
          let idx = (y * canvas.width + x) * 4;
          let avg = (imageData.data[idx] + imageData.data[idx+1] + imageData.data[idx+2]) / 3;
          let z = (avg / 255) * -5;
          gcode.push(`G1 X${(x/10).toFixed(2)} Y${(y/10).toFixed(2)} Z${z.toFixed(2)} F1000`);
        }
      }
      let blob = new Blob([gcode.join("\n")], {type: "text/plain"});
      let url = URL.createObjectURL(blob);
      let link = document.getElementById("downloadLink");
      link.href = url;
      link.style.display = "block";
    }
  </script>
</body>
</html>
