<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CNC AI — CNC Router & Laser Engraving</title>

  <!-- مكتبات -->
  <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

  <style>
    /* الأنماط تبقى كما هي */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, Segoe UI, system-ui; background: #041022; color:#e6eef6; line-height:1.45 }
    .app { max-width:1400px; margin:12px auto; padding:14px }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #1e293b }
    .grid { display:grid; grid-template-columns:1fr 520px; gap:16px }
    @media (max-width:1100px){ .grid{ grid-template-columns:1fr } }
    .panel { background:#0b1320; padding:16px; border-radius:10px; border:1px solid #1e293b }
    .tab-buttons { display:flex; gap:8px; margin-top:12px; background: rgba(14,23,33,0.6); padding:6px; border-radius:8px }
    .tab-buttons button { flex:1; border:none; padding:8px 10px; border-radius:6px; background:transparent; color:#9bb0c8; cursor:pointer }
    .tab-buttons button.active { background:#0f172a; color:#e6eef6; box-shadow: inset 0 -3px 0 #06b6d4; }
    .tab-content { display:none; margin-top:12px }
    .tab-content.active { display:block }
    canvas { max-width:100%; border-radius:6px; background:#000; display:block; margin:0 auto; border:1px solid #334155 }
    #threeContainer { width:100%; height:420px; background:#081224; border-radius:8px; overflow:hidden; position:relative }
    label { display:block; margin-top:12px; color:#cfeaf2; font-weight:bold }
    input, select, textarea, button { font-size:0.9rem }
    input, select { width:100%; padding:8px 10px; border-radius:6px; border:1px solid #1e293b; background:#0f172a; color:#e6eef6; margin-top:6px }
    .button-group { display:flex; flex-direction:column; gap:8px; margin-top:12px }
    .button-row { display:flex; gap:8px; }
    button { background:#1e293b; color:#e6eef6; border:none; padding:10px; border-radius:8px; cursor:pointer }
    button.primary { background:#06b6d4; color:#021; font-weight:bold }
    button.secondary { background:#334155; }
    #toast { position:fixed; left:16px; bottom:16px; background:rgba(0,0,0,0.85); color:#fff; padding:10px 14px; border-radius:8px; display:none; z-index:10000 }
    .canvas-placeholder { width:100%; min-height:260px; background:#000; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#9bb0c8; border:1px solid #334155 }
    .small-meta { font-size:12px; color:#9bb0c8; margin-top:6px }
    .laser-preview {
      border: 2px solid #ff4444;
      background: rgba(255, 68, 68, 0.05);
      padding: 8px;
      border-radius: 6px;
      margin-top: 8px;
    }
    .power-indicator {
      height: 4px;
      background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
      border-radius: 2px;
      margin-top: 4px;
    }
    .laser-specific { border-left: 3px solid #ff4444; padding-left: 10px; margin: 8px 0; background: rgba(255, 0, 0, 0.05); }
    .laser-edge-settings {
      border: 1px solid #ff4444;
      border-radius: 6px;
      padding: 10px;
      margin: 8px 0;
      background: rgba(255, 68, 68, 0.05);
    }
    .laser-mode-description {
      font-size: 11px;
      color: #9bb0c8;
      margin-top: 4px;
      line-height: 1.3;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- الهيكل الأساسي يبقى كما هو -->
    <header>
      <h1>CNC AI — CNC Router & Laser Engraving</h1>
      <div id="cvState" class="loading-indicator">
        <div class="loading-spinner"></div>
        <span>جاري تحميل OpenCV...</span>
      </div>
    </header>

    <div class="grid">
      <!-- اللوحة اليسرى -->
      <div class="panel">
        <!-- ... العناصر الأخرى تبقى كما هي ... -->
        
        <div class="tab-buttons" role="tablist">
          <button data-tab="original" class="active">🖼️ الأصلية</button>
          <button data-tab="heatmap">🔥 Heatmap</button>
          <button data-tab="contour">📐 Contours</button>
          <button data-tab="topview">🔝 Top View</button>
          <button data-tab="simulation">🎬 المحاكاة</button>
          <button data-tab="laserpreview" id="laserPreviewTab" style="display:none">🔴 معاينة الليزر</button>
        </div>

        <!-- محتوى التبويبات -->
        <div id="laserpreview" class="tab-content">
          <div class="laser-preview">
            <div class="canvas-placeholder" id="laserPreviewPlaceholder">معاينة نقش الليزر ستظهر هنا</div>
            <canvas id="canvasLaserPreview" style="display:none;"></canvas>
            <div class="small-meta">معاينة تأثير الليزر على المادة - الأحمر = قوة عالية، الأصفر = قوة متوسطة، الأخضر = قوة منخفضة</div>
            <div class="power-indicator"></div>
          </div>
        </div>
      </div>

      <!-- اللوحة اليمنى -->
      <div class="panel">
        <h3>⚙️ إعدادات الماكينة</h3>

        <select id="machineCategory">
          <option value="router">CNC Router (نحت خشب)</option>
          <option value="laser">Laser Engraver (نقش ليزر)</option>
        </select>

        <!-- إعدادات الليزر -->
        <div id="laserSettings" class="machine-settings" style="display:none;">
          <h4 class="laser-specific">⚡ إعدادات Laser Engraver</h4>
          
          <label for="laserWorkWidth">عرض العمل (مم)</label>
          <input id="laserWorkWidth" type="number" value="300" step="1" min="10" max="2000"/>
          
          <label for="laserWorkHeight">ارتفاع العمل (مم)</label>
          <input id="laserWorkHeight" type="number" value="200" step="1" min="10" max="2000"/>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label for="laserOriginX">نقطة الأصل X (مم)</label>
              <input id="laserOriginX" type="number" value="0" step="1"/>
            </div>
            <div>
              <label for="laserOriginY">نقطة الأصل Y (مم)</label>
              <input id="laserOriginY" type="number" value="0" step="1"/>
            </div>
          </div>
          <div style="margin-top:6px"><button id="btnLaserCenterOrigin" class="secondary">🎯 توسيط نقطة الأصل</button></div>

          <!-- إعدادات كشف الحواف للليزر -->
          <div class="laser-edge-settings">
            <label for="laserEdgeMode">نمط كشف الحواف للليزر</label>
            <select id="laserEdgeMode">
              <option value="canny">Canny (عادي)</option>
              <option value="adaptive">Adaptive Threshold (للنقش)</option>
              <option value="morphological">Morphological (للتفاصيل الدقيقة)</option>
              <option value="gradient">Gradient-Based (للتدرجات)</option>
            </select>
            <div class="laser-mode-description" id="laserModeDesc">
              Adaptive Threshold - ممتاز للصور ذات الإضاءة غير المتجانسة
            </div>

            <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
              <label style="margin:0;color:#9bb0c8">دقة الليزر:</label>
              <input id="laserDetail" type="range" min="1" max="10" value="5" step="1" style="flex:1">
              <div id="laserDetailValue" style="min-width:44px;text-align:center;color:#ff4444">5</div>
            </div>
          </div>

          <div style="margin-top: 8px;">
            <button id="btnRedetectLaser" class="secondary">🔄 إعادة كشف حواف الليزر</button>
          </div>

          <hr style="border-color:#ff4444;margin:12px 0"/>

          <!-- قوة وسرعة الليزر -->
          <div style="display:flex;align-items:center;gap:8px;margin-top:12px">
            <label style="margin:0;color:#9bb0c8">قوة الليزر:</label>
            <input id="laserPower" type="range" min="0" max="100" value="80" step="1" style="flex:1">
            <div id="laserPowerValue" style="min-width:44px;text-align:center;color:#ff4444">80%</div>
          </div>

          <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
            <label style="margin:0;color:#9bb0c8">سرعة الليزر:</label>
            <input id="laserSpeed" type="range" min="100" max="5000" value="2000" step="100" style="flex:1">
            <div id="laserSpeedValue" style="min-width:60px;text-align:center;color:#06b6d4">2000</div>
          </div>

          <!-- وضع الليزر -->
          <label for="laserMode">وضع الليزر</label>
          <select id="laserMode">
            <option value="grayscale">نقش تدرج الرمادي</option>
            <option value="dithering">نقش متقطع (Dithering)</option>
            <option value="contour">قص كونتور</option>
            <option value="combined">نقش + قص</option>
          </select>

          <!-- إعدادات Dithering -->
          <div id="ditheringSettings" style="margin-top:8px; padding:8px; background:rgba(255,68,68,0.05); border-radius:6px; border:1px solid rgba(255,68,68,0.3)">
            <label for="ditheringType">نوع التقطيع</label>
            <select id="ditheringType">
              <option value="floyd">Floyd-Steinberg</option>
              <option value="atkinson">Atkinson</option>
              <option value="bayer">Bayer Matrix</option>
            </select>
            
            <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
              <label style="margin:0;color:#9bb0c8">دقة التقطيع:</label>
              <input id="ditheringQuality" type="range" min="1" max="10" value="5" step="1" style="flex:1">
              <div id="ditheringQualityValue" style="min-width:44px;text-align:center;color:#ffaa00">5</div>
            </div>
          </div>

          <!-- الإعدادات المتقدمة -->
          <div style="margin-top:12px; padding:8px; background:rgba(6,182,212,0.05); border-radius:6px; border:1px solid rgba(6,182,212,0.3)">
            <label style="color:#06b6d4">🛠️ إعدادات متقدمة</label>
            
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <label style="font-weight:normal;">
                <input id="laserDynamic" type="checkbox" checked /> 
                قوة ديناميكية (حسب الظلام)
              </label>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <label style="font-weight:normal;">
                <input id="laserAirAssist" type="checkbox" /> 
                Air Assist
              </label>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <label style="font-weight:normal;">
                <input id="laserOptimize" type="checkbox" checked /> 
                تحسين المسارات
              </label>
            </div>

            <label for="laserPasses" style="margin-top:8px">عدد المرات</label>
            <input id="laserPasses" type="number" value="1" min="1" max="10"/>
          </div>

          <!-- أزرار الليزر -->
          <div class="button-group">
            <div class="button-row">
              <button id="btnLaserEngrave" class="primary" style="background:#ff4444;">⚡ توليد كود ليزر</button>
              <button id="btnLaserPreview" class="secondary">👁️ معاينة الليزر</button>
            </div>
            <div class="button-row">
              <button id="btnLaserOptimize" class="secondary">🔄 تحسين المسارات</button>
              <button id="btnLaserDownload" class="secondary">💾 تحميل كود الليزر</button>
            </div>
          </div>
        </div>

        <div id="estTime" style="margin-top:12px;color:#9bb0c8;text-align:center;padding:8px;background:#0f172a;border-radius:6px"></div>

        <label for="gcodeOut" style="margin-top:12px">📄 مخرجات G-code</label>
        <textarea id="gcodeOut" readonly placeholder="سيظهر G-code هنا بعد التوليد..." style="height:180px;background:#021024;color:#cfeaf2;border-radius:8px;padding:10px;"></textarea>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <script>
    // ================= نظام الليزر المحسّن والمصحح =================

    // متغيرات الليزر
    let laserPreviewData = null;
    let optimizedPath = null;
    let laserContour = null;

    // دوال مساعدة للليزر
    function updateLaserUI() {
        const isLaser = document.getElementById('machineCategory').value === 'laser';
        const laserPreviewTab = document.getElementById('laserPreviewTab');
        
        if (isLaser) {
            laserPreviewTab.style.display = 'block';
            const ditheringSettings = document.getElementById('ditheringSettings');
            const laserMode = document.getElementById('laserMode').value;
            ditheringSettings.style.display = laserMode === 'dithering' ? 'block' : 'none';
        } else {
            laserPreviewTab.style.display = 'none';
        }
    }

    // وصف أنماط الليزر
    const laserModeDescriptions = {
        canny: 'Canny - كشف حواف تقليدي مناسب للصور العامة',
        adaptive: 'Adaptive Threshold - ممتاز للصور ذات الإضاءة غير المتجانسة',
        morphological: 'Morphological - للحواف الدقيقة والناعمة والتفاصيل الصغيرة',
        gradient: 'Gradient-Based - للتدرجات اللونية والصور ذات التباين العالي'
    };

    // ================= نظام معاينة الليزر المحسّن =================
    function generateLaserPreview() {
        if (!grayMat || !previewCanvas) {
            showToast("لا توجد صورة للمعاينة");
            return;
        }

        try {
            const canvas = document.getElementById('canvasLaserPreview');
            const ctx = canvas.getContext('2d');
            canvas.width = previewCanvas.width;
            canvas.height = previewCanvas.height;
            
            const laserPower = parseInt(document.getElementById('laserPower').value) || 80;
            const laserMode = document.getElementById('laserMode').value;
            const dynamicPower = document.getElementById('laserDynamic').checked;
            
            // إنشاء صورة المعاينة
            const imgData = ctx.createImageData(canvas.width, canvas.height);
            
            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const grayValue = sampleGrayAt(x, y);
                    let power;
                    
                    if (dynamicPower) {
                        // عكس القيمة: المناطق الداكنة تحتاج قوة أكبر
                        power = Math.round((1 - grayValue / 255) * laserPower);
                    } else {
                        power = laserPower;
                    }
                    
                    const idx = (y * canvas.width + x) * 4;
                    
                    // تلوين حسب قوة الليزر
                    if (power > 70) {
                        imgData.data[idx] = 255;     // أحمر
                        imgData.data[idx + 1] = 50;
                        imgData.data[idx + 2] = 50;
                    } else if (power > 40) {
                        imgData.data[idx] = 255;     // أصفر
                        imgData.data[idx + 1] = 200;
                        imgData.data[idx + 2] = 0;
                    } else if (power > 10) {
                        imgData.data[idx] = 100;     // أخضر
                        imgData.data[idx + 1] = 255;
                        imgData.data[idx + 2] = 100;
                    } else {
                        imgData.data[idx] = 40;      // خلفية داكنة
                        imgData.data[idx + 1] = 40;
                        imgData.data[idx + 2] = 40;
                    }
                    
                    imgData.data[idx + 3] = 255;   // alpha
                }
            }
            
            ctx.putImageData(imgData, 0, 0);
            showElement('canvasLaserPreview', 'laserPreviewPlaceholder');
            laserPreviewData = imgData;
            
            showToast("تم إنشاء معاينة الليزر");
            
        } catch (error) {
            console.error('Laser preview error:', error);
            showToast('فشل في إنشاء معاينة الليزر');
        }
    }

    // ================= نظام تحسين مسارات الليزر =================
    function optimizeLaserPath(points) {
        if (!points || points.length < 2) return points;
        
        const optimized = [];
        const tolerance = 2; // مم
        
        // إضافة النقطة الأولى
        optimized.push(points[0]);
        
        for (let i = 1; i < points.length - 1; i++) {
            const prev = optimized[optimized.length - 1];
            const current = points[i];
            const next = points[i + 1];
            
            // حساب المسافة والزاوية
            const distToPrev = Math.hypot(current.x - prev.x, current.y - prev.y);
            const distToNext = Math.hypot(next.x - current.x, next.y - current.y);
            
            // إذا كانت النقطة قريبة جداً أو على خط مستقيم، نتخطاها
            if (distToPrev > tolerance && distToNext > tolerance) {
                optimized.push(current);
            }
        }
        
        // إضافة النقطة الأخيرة
        optimized.push(points[points.length - 1]);
        
        return optimized;
    }

    // ================= نظام توليد G-code للليزر المحسّن =================
    function generateLaserGcode() {
        if (!grayMat || !previewCanvas) {
            showToast("لا توجد صورة جاهزة للمعالجة");
            return "";
        }

        try {
            showToast("جاري توليد كود الليزر...");
            
            const laserPower = parseInt(document.getElementById('laserPower').value) || 80;
            const laserSpeed = parseInt(document.getElementById('laserSpeed').value) || 2000;
            const laserMode = document.getElementById('laserMode').value;
            const dynamicPower = document.getElementById('laserDynamic').checked;
            const optimizePaths = document.getElementById('laserOptimize').checked;
            const airAssist = document.getElementById('laserAirAssist').checked;
            const passes = parseInt(document.getElementById('laserPasses').value) || 1;

            const workWidth = parseFloat(document.getElementById('laserWorkWidth').value) || 300;
            const workHeight = parseFloat(document.getElementById('laserWorkHeight').value) || 200;
            const originX = parseFloat(document.getElementById('laserOriginX').value) || 0;
            const originY = parseFloat(document.getElementById('laserOriginY').value) || 0;

            const lines = [];
            lines.push('; Laser G-code - Generated by CNC AI');
            lines.push('; Power: ' + laserPower + '%, Speed: ' + laserSpeed + 'mm/min');
            lines.push('G21 G90 G17');
            lines.push('G0 X0 Y0');
            if (airAssist) lines.push('M8'); // تشغيل Air Assist
            
            const scaleX = workWidth / previewCanvas.width;
            const scaleY = workHeight / previewCanvas.height;
            
            let totalPoints = 0;
            let totalLength = 0;
            const allPoints = [];

            // نمط المسح المتعرج
            const stepOver = 1.0; // مم بين الخطوط
            const pointSpacing = 1.0; // مم بين النقاط
            
            for (let pass = 0; pass < passes; pass++) {
                for (let y = 0; y < previewCanvas.height; y += stepOver / scaleY) {
                    const rowPoints = [];
                    
                    for (let x = 0; x < previewCanvas.width; x += pointSpacing / scaleX) {
                        const grayValue = sampleGrayAt(x, y);
                        let power;
                        
                        if (dynamicPower) {
                            // عكس القيمة: المناطق الداكنة تحتاج قوة أكبر
                            power = Math.round((1 - grayValue / 255) * laserPower);
                        } else {
                            power = laserPower;
                        }
                        
                        // تجاهل النقاط ذات القوة المنخفضة جداً
                        if (power < 5) continue;
                        
                        const scaledX = (x * scaleX) + originX;
                        const scaledY = (y * scaleY) + originY;
                        
                        rowPoints.push({ 
                            x: scaledX, 
                            y: scaledY, 
                            power: power,
                            grayValue: grayValue
                        });
                        totalPoints++;
                    }
                    
                    if (rowPoints.length > 0) {
                        // اتجاه متعرج
                        const reverse = (y / (stepOver / scaleY)) % 2 !== 0;
                        if (reverse) rowPoints.reverse();
                        
                        allPoints.push(...rowPoints);
                    }
                }
            }

            // تحسين المسارات إذا طلب المستخدم
            let finalPoints = allPoints;
            if (optimizePaths && allPoints.length > 100) {
                finalPoints = optimizeLaserPath(allPoints);
                showToast(`تم تحسين المسار من ${allPoints.length} إلى ${finalPoints.length} نقطة`);
            }

            optimizedPath = finalPoints;

            // توليد G-code
            if (finalPoints.length > 0) {
                lines.push('G0 X' + finalPoints[0].x.toFixed(2) + ' Y' + finalPoints[0].y.toFixed(2));
                lines.push('M3 S' + Math.round(finalPoints[0].power * 10));
                lines.push('G1 F' + laserSpeed.toFixed(0));
                
                let lastPower = finalPoints[0].power;
                
                for (let i = 0; i < finalPoints.length; i++) {
                    const point = finalPoints[i];
                    
                    // تحديث قوة الليزر فقط إذا تغيرت بشكل كبير
                    if (Math.abs(point.power - lastPower) > 10) {
                        lines.push('M3 S' + Math.round(point.power * 10));
                        lastPower = point.power;
                    }
                    
                    lines.push('G1 X' + point.x.toFixed(2) + ' Y' + point.y.toFixed(2));
                    
                    if (i > 0) {
                        const prev = finalPoints[i - 1];
                        totalLength += Math.hypot(point.x - prev.x, point.y - prev.y);
                    }
                }

                lines.push('M5'); // إيقاف الليزر
                if (airAssist) lines.push('M9'); // إيقاف Air Assist
            } else {
                lines.push('; No points to engrave');
            }

            lines.push('M30');

            // حساب الوقت التقديري
            const timeMinutes = totalLength / laserSpeed;
            const hours = Math.floor(timeMinutes / 60);
            const minutes = Math.floor(timeMinutes % 60);
            const seconds = Math.round((timeMinutes * 60) % 60);
            
            let timeText = "⏱️ الوقت التقديري: ";
            if (hours > 0) timeText += hours + " ساعة ";
            if (minutes > 0) timeText += minutes + " دقيقة ";
            timeText += seconds + " ثانية";
            
            document.getElementById('estTime').innerHTML = timeText + ` | ${finalPoints.length} نقطة`;

            showToast(`تم توليد كود الليزر: ${finalPoints.length} نقطة`);
            return lines.join('\n');

        } catch (error) {
            console.error('Laser G-code generation error:', error);
            showToast('فشل في توليد كود الليزر');
            return "";
        }
    }

    // ================= نظام كشف حواف الليزر المحسّن =================
    async function detectLaserContours() {
        if (!cvReady) {
            showToast('OpenCV غير جاهز بعد');
            return;
        }
        
        if (!previewCanvas || previewCanvas.width === 0 || previewCanvas.height === 0) {
            showToast('لا توجد صورة صالحة للمعالجة');
            return;
        }
        
        showToast('جاري كشف حواف الليزر...');
        
        let src = null, gray = null, edges = null, hierarchy = null, contours = null;
        
        try {
            src = cv.imread(previewCanvas);
            if (src.empty()) {
                showToast('الصورة غير صالحة للمعالجة');
                return;
            }
            
            gray = new cv.Mat();
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            
            const mode = document.getElementById('laserEdgeMode').value || 'adaptive';
            const detailLevel = parseInt(document.getElementById('laserDetail').value) || 5;
            
            edges = new cv.Mat();
            
            if (mode === 'adaptive') {
                const adaptive = new cv.Mat();
                const blockSize = Math.max(3, 2 * Math.floor(detailLevel) + 1);
                cv.adaptiveThreshold(gray, adaptive, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY, blockSize, 2);
                
                const kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(3, 3));
                cv.morphologyEx(adaptive, edges, cv.MORPH_CLOSE, kernel);
                
                safeMatDelete(adaptive);
                safeMatDelete(kernel);
                
            } else if (mode === 'morphological') {
                const blurred = new cv.Mat();
                cv.GaussianBlur(gray, blurred, new cv.Size(3, 3), 0);
                
                const kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(3, 3));
                const dilated = new cv.Mat();
                const eroded = new cv.Mat();
                
                cv.dilate(blurred, dilated, kernel);
                cv.erode(blurred, eroded, kernel);
                cv.subtract(dilated, eroded, edges);
                
                cv.normalize(edges, edges, 0, 255, cv.NORM_MINMAX);
                
                safeMatDelete(blurred);
                safeMatDelete(kernel);
                safeMatDelete(dilated);
                safeMatDelete(eroded);
                
            } else if (mode === 'gradient') {
                const blurred = new cv.Mat();
                cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);
                
                const gradX = new cv.Mat();
                const gradY = new cv.Mat();
                const absGradX = new cv.Mat();
                const absGradY = new cv.Mat();
                
                cv.Sobel(blurred, gradX, cv.CV_16S, 1, 0, 3, 1, 0, cv.BORDER_DEFAULT);
                cv.Sobel(blurred, gradY, cv.CV_16S, 0, 1, 3, 1, 0, cv.BORDER_DEFAULT);
                
                cv.convertScaleAbs(gradX, absGradX);
                cv.convertScaleAbs(gradY, absGradY);
                cv.addWeighted(absGradX, 0.5, absGradY, 0.5, 0, edges);
                
                const kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(2, 2));
                cv.morphologyEx(edges, edges, cv.MORPH_CLOSE, kernel);
                
                safeMatDelete(blurred);
                safeMatDelete(gradX);
                safeMatDelete(gradY);
                safeMatDelete(absGradX);
                safeMatDelete(absGradY);
                safeMatDelete(kernel);
                
            } else {
                // Canny default
                const blurred = new cv.Mat();
                cv.GaussianBlur(gray, blurred, new cv.Size(3, 3), 0);
                cv.Canny(blurred, edges, 50, 150);
                safeMatDelete(blurred);
            }

            // تحسين الحواف بناءً على مستوى الدقة
            if (detailLevel > 5) {
                const kernelSize = Math.min(3, Math.floor(detailLevel / 3));
                const kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(kernelSize, kernelSize));
                cv.morphologyEx(edges, edges, cv.MORPH_CLOSE, kernel);
                safeMatDelete(kernel);
            }

            contours = new cv.MatVector();
            hierarchy = new cv.Mat();
            cv.findContours(edges, contours, hierarchy, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);

            const minArea = (gray.cols * gray.rows) * 0.002;
            const validContours = [];
            
            for (let i = 0; i < contours.size(); i++) {
                const cnt = contours.get(i);
                const area = cv.contourArea(cnt);
                if (area > minArea) {
                    validContours.push({ contour: cnt, area });
                } else {
                    safeMatDelete(cnt);
                }
            }

            if (validContours.length > 0) {
                validContours.sort((a,b)=> b.area - a.area);
                laserContour = validContours[0].contour;
                additionalContours = validContours.slice(1).map(v => ({ contour: v.contour, area: v.area }));
                showToast(`تم كشف ${validContours.length} كونتور للليزر`);
            } else {
                showToast('لم يتم العثور على حواف مناسبة للليزر');
                return;
            }

            if (grayMat) { 
                safeMatDelete(grayMat);
            }
            grayMat = gray.clone();

            renderHeatmap();
            renderContour(gray, laserContour);

        } catch (err) {
            console.error('detectLaserContours error', err);
            showToast('فشل في تحليل الصورة للليزر');
        } finally {
            safeMatDelete(src);
            safeMatDelete(gray);
            safeMatDelete(edges);
            safeMatDelete(hierarchy);
            safeMatDelete(contours);
        }
    }

    // ================= ربط أحداث الليزر =================
    function initializeLaserEvents() {
        // تحديث واجهة الليزر
        document.getElementById('laserPower').addEventListener('input', function(e) {
            document.getElementById('laserPowerValue').textContent = e.target.value + '%';
            document.getElementById('laserPowerValue').style.color = `hsl(${e.target.value * 1.2}, 100%, 60%)`;
        });

        document.getElementById('laserSpeed').addEventListener('input', function(e) {
            document.getElementById('laserSpeedValue').textContent = e.target.value;
        });

        document.getElementById('ditheringQuality').addEventListener('input', function(e) {
            document.getElementById('ditheringQualityValue').textContent = e.target.value;
        });

        document.getElementById('laserDetail').addEventListener('input', function(e) {
            document.getElementById('laserDetailValue').textContent = e.target.value;
        });

        document.getElementById('laserMode').addEventListener('change', function() {
            updateLaserUI();
        });

        document.getElementById('laserEdgeMode').addEventListener('change', function(e) {
            document.getElementById('laserModeDesc').textContent = laserModeDescriptions[e.target.value] || '';
            if (!previewCanvas) return;
            const isLaser = document.getElementById('machineCategory').value === 'laser';
            if (isLaser && cvReady && previewCanvas && previewCanvas.width > 0) {
                detectLaserContours();
            }
        });

        // أزرار الليزر
        document.getElementById('btnLaserPreview').addEventListener('click', function() {
            generateLaserPreview();
            document.querySelector('.tab-buttons button[data-tab="laserpreview"]').click();
        });

        document.getElementById('btnLaserEngrave').addEventListener('click', function() {
            const gcode = generateLaserGcode();
            document.getElementById('gcodeOut').value = gcode;
            lastGeneratedGcode = gcode;
            if (gcode) {
                showToast("تم توليد كود الليزر بنجاح");
                renderTopViewFromGcode(gcode);
                document.querySelector('.tab-buttons button[data-tab="simulation"]').click();
            }
        });

        document.getElementById('btnLaserOptimize').addEventListener('click', function() {
            if (optimizedPath) {
                const originalLength = optimizedPath.length;
                const newPath = optimizeLaserPath(optimizedPath);
                optimizedPath = newPath;
                showToast(`تم تحسين المسار من ${originalLength} إلى ${newPath.length} نقطة`);
            } else {
                showToast("قم أولاً بتوليد كود الليزر للتحسين");
            }
        });

        document.getElementById('btnLaserDownload').addEventListener('click', function() {
            const text = document.getElementById('gcodeOut').value;
            if (!text) { 
                showToast("لا يوجد G-code لتحميله"); 
                return; 
            }
            try {
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const filename = `laser_output_${dateStr}.gcode`;
                const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; 
                a.download = filename; 
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast(`تم تحميل الملف: ${filename}`);
            } catch (error) {
                console.error('file download error', error);
                showToast('فشل في تحميل الملف');
            }
        });

        document.getElementById('btnRedetectLaser').addEventListener('click', () => {
            if (!previewCanvas) {
                showToast('لا توجد صورة محملة');
                return;
            }
            if (cvReady) {
                detectLaserContours();
            }
        });

        document.getElementById('btnLaserCenterOrigin').addEventListener('click', function() {
            const workWidth = parseFloat(document.getElementById('laserWorkWidth').value) || 0;
            const workHeight = parseFloat(document.getElementById('laserWorkHeight').value) || 0;
            document.getElementById('laserOriginX').value = (workWidth / 2).toFixed(1);
            document.getElementById('laserOriginY').value = (workHeight / 2).toFixed(1);
            showToast("تم توسيط نقطة الأصل للليزر");
        });
    }

    // ================= التهيئة =================
    document.addEventListener('DOMContentLoaded', function() {
        initializeLaserEvents();
        updateLaserUI();
        
        // تحديث واجهة الليزر عند تغيير نوع الماكينة
        document.getElementById('machineCategory').addEventListener('change', function(e) {
            const isLaser = e.target.value === 'laser';
            updateLaserUI();
            
            if (isLaser && previewCanvas && cvReady) {
                detectLaserContours();
            }
        });
    });

    // دوال مساعدة إضافية
    function showToast(msg, ms = 3000) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.display = 'block';
        clearTimeout(t._t);
        t._t = setTimeout(() => t.style.display = 'none', ms);
        console.log('Toast:', msg);
    }

    function showElement(elementId, hidePlaceholderId) {
        const element = document.getElementById(elementId);
        const placeholder = document.getElementById(hidePlaceholderId);
        if (element && placeholder) {
            element.style.display = 'block';
            placeholder.style.display = 'none';
        }
    }

    function safeMatDelete(mat) {
        if (mat && !mat.isDeleted && mat.delete) {
            try {
                mat.delete();
            } catch (e) {
                console.warn('Error deleting mat:', e);
            }
        }
    }

  </script>
</body>
</html>
