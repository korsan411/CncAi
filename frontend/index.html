<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CncAi</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Tahoma', sans-serif; }
    .hidden { display: none; }
    #gcodeCanvas { border: 1px solid #ccc; margin-top: 10px; }
    #threeContainer { width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 10px; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">CncAi</h1>
    <nav>
      <button class="tab-btn mx-2" data-tab="previewTab">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
      <button class="tab-btn mx-2" data-tab="gcodeTab">G-code</button>
    </nav>
  </header>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
  <main class="p-6">
    <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© -->
    <div id="previewTab" class="tab-content">
      <h2 class="text-lg font-bold mb-4">ğŸ“· Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±</h2>
      <input type="file" id="uploadImage" class="mb-4" accept="image/*"/>
      <canvas id="canvas2d" class="border w-full max-w-lg"></canvas>
    </div>

    <!-- ØªØ¨ÙˆÙŠØ¨ G-code -->
    <div id="gcodeTab" class="tab-content hidden">
      <h2 class="text-xl font-bold mb-4">âš™ï¸ ØªÙˆÙ„ÙŠØ¯ G-code</h2>

      <label class="block mb-2">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©:</label>
      <select id="machineType" class="border p-2 mb-4 w-full">
        <option value="cnc">CNC</option>
        <option value="laser">Laser</option>
        <option value="3dprinter">3D Printer</option>
      </select>

      <label class="block mb-2">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø§Ù…Ø©:</label>
      <select id="materialType" class="border p-2 mb-4 w-full">
        <option value="wood">Wood</option>
        <option value="plastic">Plastic</option>
        <option value="metal">Metal</option>
      </select>

      <label class="block mb-2">Feedrate:</label>
      <input id="feedrate" type="number" value="800" class="border p-2 mb-4 w-full"/>

      <label class="block mb-2">Spindle RPM:</label>
      <input id="rpm" type="number" value="12000" class="border p-2 mb-4 w-full"/>

      <label class="block mb-2">Ø¹Ù…Ù‚ Ø§Ù„Ù‚Ø·Ø¹ (mm):</label>
      <input id="depth" type="number" value="2" class="border p-2 mb-4 w-full"/>

      <button id="generateGcode" class="bg-blue-500 text-white px-4 py-2 rounded mb-2">ØªÙˆÙ„ÙŠØ¯ G-code</button>
      <button id="downloadGcode" class="bg-green-500 text-white px-4 py-2 rounded mb-4 hidden">ØªØ­Ù…ÙŠÙ„ G-code</button>

      <pre id="gcodeOutput" class="bg-gray-100 p-4 border rounded h-48 overflow-auto"></pre>

      <h3 class="text-lg font-bold mt-6">ğŸ“Š Ù…Ø¹Ø§ÙŠÙ†Ø© 2D</h3>
      <canvas id="gcodeCanvas" width="500" height="500"></canvas>

      <h3 class="text-lg font-bold mt-6">ğŸ”² Ù…Ø¹Ø§ÙŠÙ†Ø© 3D</h3>
      <div id="threeContainer"></div>
    </div>
  </main>

  <!-- Ù…ÙƒØªØ¨Ø© Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tabContents = document.querySelectorAll(".tab-content");
    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        tabContents.forEach(tab => tab.classList.add("hidden"));
        document.getElementById(btn.dataset.tab).classList.remove("hidden");
      });
    });

    // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ 2D
    const uploadImage = document.getElementById("uploadImage");
    const canvas2d = document.getElementById("canvas2d");
    const ctx2d = canvas2d.getContext("2d");

    uploadImage.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        canvas2d.width = img.width;
        canvas2d.height = img.height;
        ctx2d.drawImage(img, 0, 0);
      };
      img.src = URL.createObjectURL(file);
    });

    // Ù…ØªØºÙŠØ±Ø§Øª G-code
    let currentGcode = "";
    let pathPoints = [];

    document.getElementById("generateGcode").addEventListener("click", () => {
      const machine = document.getElementById("machineType").value;
      const material = document.getElementById("materialType").value;
      const feedrate = document.getElementById("feedrate").value;
      const rpm = document.getElementById("rpm").value;
      const depth = document.getElementById("depth").value;

      currentGcode = `; G-code Generated
; Machine: ${machine}
; Material: ${material}
G21 ; Set units to mm
G90 ; Absolute positioning
M3 S${rpm} ; Spindle on
`;

      pathPoints = [];
      const step = 10;
      for (let y = 0; y <= 100; y += step) {
        for (let x = 0; x <= 100; x += step) {
          currentGcode += `G1 X${x} Y${y} Z-${depth} F${feedrate}\n`;
          pathPoints.push({x, y, z: -depth});
        }
      }

      currentGcode += `G0 Z5\nM5 ; Spindle off\nM30 ; Program end`;

      document.getElementById("gcodeOutput").textContent = currentGcode;
      document.getElementById("downloadGcode").classList.remove("hidden");

      draw2DPath();
      draw3DPath();
    });

    // ØªØ­Ù…ÙŠÙ„ G-code
    document.getElementById("downloadGcode").addEventListener("click", () => {
      const blob = new Blob([currentGcode], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "output.gcode";
      link.click();
    });

    // Ø±Ø³Ù… 2D
    function draw2DPath() {
      const canvas = document.getElementById("gcodeCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.beginPath();
      pathPoints.forEach((p, i) => {
        const scale = 5;
        if (i === 0) ctx.moveTo(p.x * scale, p.y * scale);
        else ctx.lineTo(p.x * scale, p.y * scale);
      });
      ctx.strokeStyle = "blue";
      ctx.lineWidth = 1.5;
      ctx.stroke();
    }

    // Ø±Ø³Ù… 3D
    let scene, camera, renderer, controls;
    function draw3DPath() {
      if (!scene) {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(45, document.getElementById("threeContainer").clientWidth / 400, 0.1, 1000);
        camera.position.set(150, 150, 150);

        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(document.getElementById("threeContainer").clientWidth, 400);
        document.getElementById("threeContainer").appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(1, 1, 1).normalize();
        scene.add(light);
      }

      while(scene.children.length > 0){ scene.remove(scene.children[0]); }

      const material = new THREE.LineBasicMaterial({ color: 0x0000ff });
      const points = pathPoints.map(p => new THREE.Vector3(p.x, p.y, p.z));
      const geometry = new THREE.BufferGeometry().setFromPoints(points);
      const line = new THREE.Line(geometry, material);
      scene.add(line);

      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }
  </script>
</body>
</html>
