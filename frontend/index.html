<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>CncAi - Preview</title>
  <style>
    :root {
      --bg-color: #fdfdfd;
      --text-color: #333;
      --header-bg: linear-gradient(90deg, #4a90e2, #67b0f5);
      --header-text: #fff;
      --card-bg: #fff;
      --border-color: #ccc;
      --button-bg: #f0f0f0;
      --button-hover: #e0e0e0;
    }
    body.dark {
      --bg-color: #1e1e1e;
      --text-color: #eee;
      --header-bg: linear-gradient(90deg, #222, #555);
      --header-text: #f5f5f5;
      --card-bg: #2a2a2a;
      --border-color: #555;
      --button-bg: #444;
      --button-hover: #666;
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: 0.3s;
    }
    header {
      background: var(--header-bg);
      color: var(--header-text);
      padding: 10px;
      text-align: center;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    header h1 {
      flex: 1 1 100%;
      margin: 0;
    }
    header button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background: var(--button-bg);
      color: var(--text-color);
    }
    header button:hover {
      background: var(--button-hover);
    }
    main {
      padding: 15px;
      max-width: 900px;
      margin: auto;
    }
    .tab { display: none; }
    .tab.active { display: block; }
    canvas {
      max-width: 100%;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--card-bg);
    }
    .colormap-buttons, .gcode-controls, .controls3d {
      margin: 10px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    textarea {
      width: 100%;
      background: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>CncAi</h1>
    <button onclick="showTab('original')">الصورة الأصلية</button>
    <button onclick="showTab('preview2d')">معاينة 2D</button>
    <button onclick="showTab('heatmap')">Heatmap</button>
    <button onclick="showTab('preview3d')">معاينة 3D</button>
    <button onclick="showTab('gcode')">G-code</button>
    <button onclick="toggleTheme()">تبديل الثيم</button>
  </header>

  <main>
    <!-- Original -->
    <div id="originalTab" class="tab active">
      <h2>📷 الصورة الأصلية</h2>
      <input type="file" id="imageUpload" accept="image/*">
      <canvas id="originalCanvas"></canvas>
    </div>

    <!-- 2D -->
    <div id="preview2dTab" class="tab">
      <h2>معاينة 2D</h2>
      <canvas id="preview2dCanvas"></canvas>
    </div>

    <!-- Heatmap -->
    <div id="heatmapTab" class="tab">
      <h2>🌈 Heatmap</h2>
      <div class="colormap-buttons">
        <button onclick="setColormap('jet')">Jet</button>
        <button onclick="setColormap('hot')">Hot</button>
        <button onclick="setColormap('cool')">Cool</button>
        <button onclick="setColormap('gray')">Gray</button>
      </div>
      <canvas id="heatmapCanvas"></canvas>
    </div>

    <!-- 3D -->
    <div id="preview3dTab" class="tab">
      <h2>🌀 المعاينة 3D</h2>
      <div id="preview3d"></div>
      <div class="controls3d">
        <label>🔄 دوران: <input type="range" id="rotationSpeed" min="0" max="0.05" step="0.001" value="0.01"></label>
        <label>🔍 زوم: <input type="range" id="zoomControl" min="50" max="500" step="10" value="200"></label>
        <label>⬆️ ارتفاع Z: <input type="range" id="zScale" min="0.1" max="5" step="0.1" value="1"></label>
      </div>
    </div>

    <!-- G-code -->
    <div id="gcodeTab" class="tab">
      <h2>🛠️ G-code Generator</h2>
      <label>اختر نوع الماكينة:</label>
      <select id="machineType">
        <option value="laser">Laser Cutter</option>
        <option value="router">CNC Router</option>
        <option value="printer">3D Printer</option>
      </select>
      <br><br>
      <label>اختر الخامة:</label>
      <select id="material">
        <option value="wood">خشب</option>
        <option value="acrylic">أكريليك</option>
        <option value="aluminum">ألومنيوم</option>
        <option value="pla">PLA (طباعة ثلاثية)</option>
      </select>
      <div class="gcode-controls">
        <button onclick="generateGcode()">توليد G-code</button>
        <button onclick="downloadGcode()">تحميل G-code</button>
      </div>
      <textarea id="gcodeEditor" rows="12"></textarea>
    </div>
  </main>

  <!-- مكتبات 3D -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    // Tabs
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
      document.getElementById(tab+'Tab').classList.add('active');
    }

    // Theme
    function toggleTheme() {
      document.body.classList.toggle("dark");
    }

    // Image upload
    const upload = document.getElementById('imageUpload');
    const originalCanvas = document.getElementById('originalCanvas');
    const ctxOriginal = originalCanvas.getContext('2d');
    const preview2dCanvas = document.getElementById('preview2dCanvas');
    const ctx2d = preview2dCanvas.getContext('2d');
    const heatmapCanvas = document.getElementById('heatmapCanvas');
    const ctxHeat = heatmapCanvas.getContext('2d');

    let currentImage = null;
    let currentColormap = "jet";

    upload.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => {
        currentImage = img;
        originalCanvas.width = img.width;
        originalCanvas.height = img.height;
        ctxOriginal.drawImage(img, 0, 0);
        preview2dCanvas.width = img.width;
        preview2dCanvas.height = img.height;
        ctx2d.drawImage(img, 0, 0);
        drawHeatmap();
        createHeightMap();
      };
      img.src = URL.createObjectURL(file);
    });

    // Colormap
    function setColormap(map) {
      currentColormap = map;
      if (currentImage) {
        drawHeatmap();
        createHeightMap();
      }
    }

    function getHeatColor(value, map) {
      let r=0,g=0,b=0;
      if(map==='jet'){ 
        r = Math.floor(255 * Math.max(Math.min(1.5 - Math.abs(4*value-3),1),0));
        g = Math.floor(255 * Math.max(Math.min(1.5 - Math.abs(4*value-2),1),0));
        b = Math.floor(255 * Math.max(Math.min(1.5 - Math.abs(4*value-1),1),0));
      } else if(map==='hot'){ 
        r = Math.min(255, value*3*255);
        g = Math.min(255, Math.max(0,(value*3-1)*255));
        b = Math.min(255, Math.max(0,(value*3-2)*255));
      } else if(map==='cool'){ r=255*value; g=255*(1-value); b=255; }
      else if(map==='gray'){ r=g=b=255*value; }
      return {r,g,b};
    }

    function drawHeatmap() {
      const w = currentImage.width, h = currentImage.height;
      heatmapCanvas.width = w; heatmapCanvas.height = h;
      const tempCtx = document.createElement("canvas").getContext("2d");
      tempCtx.canvas.width = w; tempCtx.canvas.height = h;
      tempCtx.drawImage(currentImage, 0, 0);
      const imgData = tempCtx.getImageData(0,0,w,h);
      for (let i=0;i<w*h;i++) {
        const v = imgData.data[i*4]/255;
        const c = getHeatColor(v, currentColormap);
        imgData.data[i*4]=c.r; imgData.data[i*4+1]=c.g; imgData.data[i*4+2]=c.b; imgData.data[i*4+3]=255;
      }
      ctxHeat.putImageData(imgData,0,0);
    }

    // 3D
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(500, 500);
    document.getElementById("preview3d").appendChild(renderer.domElement);
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    camera.position.z = 200;
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(0,1,1).normalize();
    scene.add(light);
    let mesh;

    function createHeightMap() {
      if (!currentImage) return;
      const w = currentImage.width, h = currentImage.height;
      const tempCtx = document.createElement("canvas").getContext("2d");
      tempCtx.canvas.width=w; tempCtx.canvas.height=h;
      tempCtx.drawImage(currentImage,0,0);
      const imgData = tempCtx.getImageData(0,0,w,h).data;

      const geometry = new THREE.PlaneGeometry(100,100,w-1,h-1);
      const colors = [];
      for (let i=0;i<geometry.attributes.position.count;i++) {
        const x=i%w, y=Math.floor(i/w);
        const idx=(y*w+x)*4;
        const brightness=imgData[idx]/255;
        geometry.attributes.position.array[i*3+2]=brightness*10;
        const c=getHeatColor(brightness,currentColormap);
        colors.push(c.r/255,c.g/255,c.b/255);
      }
      geometry.setAttribute("color", new THREE.Float32BufferAttribute(colors,3));
      geometry.computeVertexNormals();
      const material=new THREE.MeshLambertMaterial({vertexColors:true,side:THREE.DoubleSide});
      if(mesh) scene.remove(mesh);
      mesh=new THREE.Mesh(geometry,material);
      scene.add(mesh);
    }

    let rotationSpeed=0.01, zScale=1;
    document.getElementById("rotationSpeed").addEventListener("input",e=>rotationSpeed=parseFloat(e.target.value));
    document.getElementById("zoomControl").addEventListener("input",e=>camera.position.z=parseFloat(e.target.value));
    document.getElementById("zScale").addEventListener("input",e=>{
      zScale=parseFloat(e.target.value);
      if(mesh){
        mesh.scale.z=zScale;
      }
    });

    function animate(){
      requestAnimationFrame(animate);
      if(mesh) mesh.rotation.y+=rotationSpeed;
      renderer.render(scene,camera);
    }
    animate();

    // G-code
    function generateGcode(){
      const machine=document.getElementById("machineType").value;
      const material=document.getElementById("material").value;
      let gcode="; G-code Generated\n";
      gcode+=`; Machine: ${machine}\n; Material: ${material}\n`;
      if(machine==="laser") gcode+="M3 S1000 ; Laser ON\n";
      if(machine==="router") gcode+="M3 ; Spindle ON\nF500 ; Feedrate\n";
      if(machine==="printer") gcode+="M104 S200 ; Set extruder temp\nM109 S200\n";
      gcode+="G0 X0 Y0 Z0\n";
      gcode+="; Path example\nG1 X10 Y10 Z-1 F300\nG1 X20 Y10 Z-1\nG1 X20 Y20 Z-1\n";
      document.getElementById("gcodeEditor").value=gcode;
    }
    function downloadGcode(){
      const blob=new Blob([document.getElementById("gcodeEditor").value],{type:"text/plain"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download="cnc_output.gcode";
      a.click();
    }
  </script>
</body>
</html>
