<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CNC AI â€” CNC Router & Laser Engraving</title>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, Segoe UI, system-ui; background: #041022; color:#e6eef6; line-height:1.45 }
    .app { max-width:1400px; margin:12px auto; padding:14px }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #1e293b }
    .grid { display:grid; grid-template-columns:1fr 520px; gap:16px }
    @media (max-width:1100px){ .grid{ grid-template-columns:1fr } }
    .panel { background:#0b1320; padding:16px; border-radius:10px; border:1px solid #1e293b }
    /* tabs improved */
    .tab-buttons { display:flex; gap:8px; margin-top:12px; background: rgba(14,23,33,0.6); padding:6px; border-radius:8px }
    .tab-buttons button { flex:1; border:none; padding:8px 10px; border-radius:6px; background:transparent; color:#9bb0c8; cursor:pointer }
    .tab-buttons button.active { background:#0f172a; color:#e6eef6; box-shadow: inset 0 -3px 0 #06b6d4; }
    .tab-content { display:none; margin-top:12px }
    .tab-content.active { display:block }
    canvas { max-width:100%; border-radius:6px; background:#000; display:block; margin:0 auto; border:1px solid #334155 }
    #threeContainer { width:100%; height:420px; background:#081224; border-radius:8px; overflow:hidden; position:relative }
    label { display:block; margin-top:12px; color:#cfeaf2; font-weight:bold }
    input, select, textarea, button { font-size:0.9rem }
    input, select { width:100%; padding:8px 10px; border-radius:6px; border:1px solid #1e293b; background:#0f172a; color:#e6eef6; margin-top:6px }
    .button-group { display:flex; flex-direction:column; gap:8px; margin-top:12px }
    .button-row { display:flex; gap:8px; }
    button { background:#1e293b; color:#e6eef6; border:none; padding:10px; border-radius:8px; cursor:pointer }
    button.primary { background:#06b6d4; color:#021; font-weight:bold }
    button.secondary { background:#334155; }
    #toast { position:fixed; left:16px; bottom:16px; background:rgba(0,0,0,0.85); color:#fff; padding:10px 14px; border-radius:8px; display:none; z-index:10000 }
    .canvas-placeholder { width:100%; min-height:260px; background:#000; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#9bb0c8; border:1px solid #334155 }
    .small-meta { font-size:12px; color:#9bb0c8; margin-top:6px }

    /* Debug overlay */
    #debugOverlay {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 420px;
      max-height: 55vh;
      background: rgba(2,6,23,0.9);
      color: #e6eef6;
      border: 1px solid rgba(102, 126, 234, 0.08);
      border-radius: 8px;
      font-size: 13px;
      z-index: 20000;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 8px 40px rgba(0,0,0,0.6);
    }
    #debugOverlay.minimized { height: 36px; width: 160px; cursor: pointer; }
    #debugHeader {
      display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.03);
      background: linear-gradient(90deg, rgba(6,182,212,0.06), rgba(8,145,178,0.02));
    }
    #debugHeader b { color:#aee8f2; }
    #debugControls { display:flex; gap:6px; align-items:center; }
    .dbg-btn { background:transparent; border:1px solid rgba(255,255,255,0.06); color:#cfeaf2; padding:6px 8px; border-radius:6px; cursor:pointer; font-size:12px; }
    #debugList { overflow:auto; padding:8px; display:flex; flex-direction:column; gap:6px; }
    .dbg-item { padding:8px; border-radius:6px; background:rgba(255,255,255,0.02); line-height:1.2; max-height:120px; overflow:auto; font-family:monospace; font-size:12px; }
    .dbg-time { opacity:0.7; font-size:11px; margin-bottom:6px; display:block; }
    .dbg-error { border-left:4px solid #ef4444; }
    .dbg-warn { border-left:4px solid #f59e0b; }
    .dbg-info { border-left:4px solid #06b6d4; color:#cfeaf2; }
    .dbg-meta { opacity:0.75; font-size:11px; margin-top:6px; color:#9bb0c8; }
    #debugFooter { padding:6px 10px; border-top:1px solid rgba(255,255,255,0.02); text-align:right; font-size:12px; color:#9bb0c8; background:rgba(0,0,0,0.03); display:flex; justify-content:space-between; align-items:center; }

    /* Simulation controls */
    .sim-controls { position:absolute; top:10px; left:10px; z-index:120; display:flex; gap:8px; align-items:center; background:rgba(0,0,0,0.35); padding:6px;border-radius:6px }
    .sim-controls button { background:rgba(0,0,0,0.55); color:white; border:1px solid #06b6d4; border-radius:4px; padding:6px 8px; cursor:pointer; font-size:0.9rem }
    .sim-progress { position:absolute; bottom:10px; left:10px; z-index:120; background:rgba(0,0,0,0.35); padding:6px 8px;border-radius:6px; color:#cfeaf2; font-size:12px }

    /* Top view + legend */
    #topViewContainer { margin-top:12px; display:flex; flex-direction:column; gap:6px; align-items:center; }
    #topView { width:100%; height:200px; background:#0d1722; border-radius:6px; border:1px solid #334155; display:block }
    #topLegend { width:100%; height:18px; border-radius:6px; border:1px solid #2b3844; background:linear-gradient(90deg,#ddd,#333); }

    /* colormap buttons */
    .colormap-section {
      margin: 16px 0;
      padding: 16px;
      background: rgba(14, 23, 33, 0.8);
      border-radius: 10px;
      border: 1px solid #334155;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .colormap-title {
      text-align: center;
      margin-bottom: 12px;
      color: #cfeaf2;
      font-weight: bold;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .colormap-buttons { display:flex; gap:8px; justify-content:center; margin-top:8px; flex-wrap:wrap; }
    .colormap-buttons button {
      background:#141b22; color:#cfeaf2; border:1px solid #26343f; padding:10px 16px; border-radius:8px; 
      cursor:pointer; font-size:14px; font-weight:bold; transition:all 0.3s ease; min-width:80px;
    }
    .colormap-buttons button:hover { background:#1e293b; border-color:#06b6d4; transform:translateY(-2px); }
    .colormap-buttons button.active { background:#06b6d4; color:#021; border-color:#06b6d4; box-shadow:0 4px 12px rgba(6,182,212,0.3); }

    /* Machine category styles */
    .machine-settings { transition: all 0.3s ease; }
    .laser-specific { border-left: 3px solid #ff4444; padding-left: 10px; margin: 8px 0; background: rgba(255, 0, 0, 0.05); }
    .router-specific { border-left: 3px solid #06b6d4; padding-left: 10px; margin: 8px 0; background: rgba(6, 182, 212, 0.05); }
    .laser-edge-settings {
      border: 1px solid #ff4444;
      border-radius: 6px;
      padding: 10px;
      margin: 8px 0;
      background: rgba(255, 68, 68, 0.05);
    }
    .laser-mode-description {
      font-size: 11px;
      color: #9bb0c8;
      margin-top: 4px;
      line-height: 1.3;
    }

    .loading-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(6, 182, 212, 0.1);
      border-radius: 6px;
      border: 1px solid rgba(6, 182, 212, 0.3);
    }

    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #06b6d4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }
    
    /* Laser preview styles */
    .laser-preview {
      border: 2px solid #ff4444;
      background: rgba(255, 68, 68, 0.05);
      padding: 8px;
      border-radius: 6px;
      margin-top: 8px;
    }
    
    .power-indicator {
      height: 4px;
      background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
      border-radius: 2px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>CNC AI â€” CNC Router & Laser Engraving</h1>
      <div id="cvState" class="loading-indicator">
        <div class="loading-spinner"></div>
        <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ OpenCV...</span>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT panel -->
      <div class="panel">
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="fileInput" type="file" accept="image/*"/>
          <label class="file-input-label" for="fileInput" style="display:inline-block;padding:8px 12px;background:#1e293b;border-radius:6px;color:#e6eef6;cursor:pointer;border:1px dashed #334155">ğŸ“ Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
          <div style="flex:1"></div>

          <label for="edgeMode" style="font-weight:normal;color:#9bb0c8">Edge Mode:</label>
          <select id="edgeMode" style="width:140px">
            <option value="auto">Canny (Ø¹Ø§Ø¯ÙŠ)</option>
            <option value="sobel">Sobel (Ø¯Ù‚ÙŠÙ‚)</option>
            <option value="laplace">Laplacian (Ù†Ø§Ø¹Ù€Ù…)</option>
          </select>
        </div>

        <!-- Edge sensitivity slider -->
        <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
          <label style="margin:0;color:#9bb0c8">Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ù:</label>
          <input id="edgeSensitivity" type="range" min="0.1" max="1.0" step="0.05" value="0.33" style="flex:1">
          <div id="edgeValue" style="min-width:44px;text-align:center;color:#cfeaf2">0.33</div>
        </div>

        <!-- ========== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù€ Colormap Ø§Ù„Ø«Ø§Ø¨ØªØ© ========== -->
        <div class="colormap-section">
          <div class="colormap-title">
            <span>ğŸ¨</span>
            Ø®ÙŠØ§Ø±Ø§Øª ØªØ¯Ø±Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù†
            <span>ğŸ¨</span>
          </div>
          <div class="colormap-buttons" id="colormapButtons">
            <button data-map="jet" class="active" title="Jet - Ø§Ù„Ø£Ø²Ø±Ù‚ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ù…Ø±">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>Jet</div>
                <div style="width:100%;height:4px;background:linear-gradient(90deg,#0000ff,#00ffff,#ffff00,#ff0000);border-radius:2px"></div>
              </div>
            </button>
            <button data-map="hot" title="Hot - Ø§Ù„Ø£Ø³ÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø­Ù…Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø£ØµÙØ±">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>Hot</div>
                <div style="width:100%;height:4px;background:linear-gradient(90deg,#000000,#ff0000,#ffff00,#ffffff);border-radius:2px"></div>
              </div>
            </button>
            <button data-map="cool" title="Cool - Ø§Ù„Ø³Ù…Ø§ÙˆÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¬ÙˆØ§Ù†ÙŠ">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>Cool</div>
                <div style="width:100%;height:4px;background:linear-gradient(90deg,#00ffff,#ff00ff);border-radius:2px"></div>
              </div>
            </button>
            <button data-map="gray" title="Gray - Ø§Ù„ØªØ¯Ø±Ø¬ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>Gray</div>
                <div style="width:100%;height:4px;background:linear-gradient(90deg,#000000,#ffffff);border-radius:2px"></div>
              </div>
            </button>
          </div>
          <div class="small-meta" style="text-align: center; margin-top: 8px;">
            Ø§Ù„ØªØºÙŠÙŠØ± ÙŠØ·Ø¨Ù‚ Ø¹Ù„Ù‰: Heatmap â€¢ Top View â€¢ Contours â€¢ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª
          </div>
        </div>

        <div class="tab-buttons" role="tablist">
          <button data-tab="original" class="active">ğŸ–¼ï¸ Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
          <button data-tab="heatmap">ğŸ”¥ Heatmap</button>
          <button data-tab="contour">ğŸ“ Contours</button>
          <button data-tab="topview">ğŸ” Top View</button>
          <button data-tab="simulation">ğŸ¬ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</button>
          <button data-tab="laserpreview" id="laserPreviewTab" style="display:none">ğŸ”´ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù„ÙŠØ²Ø±</button>
        </div>

        <div id="original" class="tab-content active">
          <div class="canvas-placeholder" id="originalPlaceholder">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          <canvas id="canvasOriginal" style="display:none;"></canvas>
        </div>

        <div id="heatmap" class="tab-content">
          <div class="canvas-placeholder" id="heatmapPlaceholder">Heatmap Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          <canvas id="canvasHeatmap" style="display:none;"></canvas>
        </div>

        <div id="contour" class="tab-content">
          <div class="canvas-placeholder" id="contourPlaceholder">Contours Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          <canvas id="canvasContour" style="display:none;"></canvas>
          <div class="small-meta">ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù Ø£Ùˆ ØªØ­Ø±ÙŠÙƒ Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ù ÙŠØ­Ø¯Ø« Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</div>
        </div>

        <div id="topview" class="tab-content">
          <div id="topViewContainer">
            <canvas id="topView"></canvas>
            <div id="topLegend" title="Ø¹Ù…Ù‚ Ø§Ù„Ù†Ù‚Ø´ â€” Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙ‚Ø·"></div>
          </div>
          <div class="small-meta">Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø¹Ù…Ù‚ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° G-code (Ø§Ù„Ø£Ù„ÙˆØ§Ù† ØªØªØ¨Ø¹ Ø§Ø®ØªÙŠØ§Ø± Colormap)</div>
        </div>

        <div id="simulation" class="tab-content">
          <div id="threeContainer">
            <div class="canvas-placeholder" id="simulationPlaceholder">Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ ØªÙˆÙ„ÙŠØ¯ G-code</div>
          </div>
        </div>

        <div id="laserpreview" class="tab-content">
          <div class="laser-preview">
            <div class="canvas-placeholder" id="laserPreviewPlaceholder">Ù…Ø¹Ø§ÙŠÙ†Ø© Ù†Ù‚Ø´ Ø§Ù„Ù„ÙŠØ²Ø± Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
            <canvas id="canvasLaserPreview" style="display:none;"></canvas>
            <div class="small-meta">Ù…Ø¹Ø§ÙŠÙ†Ø© ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„ÙŠØ²Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ø¯Ø© - Ø§Ù„Ø£Ø­Ù…Ø± = Ù‚ÙˆØ© Ø¹Ø§Ù„ÙŠØ©ØŒ Ø§Ù„Ø£ØµÙØ± = Ù‚ÙˆØ© Ù…ØªÙˆØ³Ø·Ø©ØŒ Ø§Ù„Ø£Ø®Ø¶Ø± = Ù‚ÙˆØ© Ù…Ù†Ø®ÙØ¶Ø©</div>
            <div class="power-indicator"></div>
          </div>
        </div>
      </div>

      <!-- RIGHT panel -->
      <div class="panel">
        <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</h3>

        <!-- Machine Category Selection -->
        <label for="machineCategory">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
        <select id="machineCategory">
          <option value="router">CNC Router (Ù†Ø­Øª Ø®Ø´Ø¨)</option>
          <option value="laser">Laser Engraver (Ù†Ù‚Ø´ Ù„ÙŠØ²Ø±)</option>
        </select>

        <!-- CNC Router Settings -->
        <div id="routerSettings" class="machine-settings">
          <!-- ... Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø§ÙˆØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ... -->
        </div>

        <!-- Laser Engraver Settings -->
        <div id="laserSettings" class="machine-settings" style="display:none;">
          <h4 class="laser-specific">âš¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Laser Engraver</h4>
          
          <label for="laserWorkWidth">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ (Ù…Ù…)</label>
          <input id="laserWorkWidth" type="number" value="300" step="1" min="10" max="2000"/>
          
          <label for="laserWorkHeight">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ù…Ù…)</label>
          <input id="laserWorkHeight" type="number" value="200" step="1" min="10" max="2000"/>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label for="laserOriginX">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ X (Ù…Ù…)</label>
              <input id="laserOriginX" type="number" value="0" step="1"/>
            </div>
            <div>
              <label for="laserOriginY">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ Y (Ù…Ù…)</label>
              <input id="laserOriginY" type="number" value="0" step="1"/>
            </div>
          </div>
          <div style="margin-top:6px"><button id="btnLaserCenterOrigin" class="secondary">ğŸ¯ ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„</button></div>

          <!-- Laser Power & Speed -->
          <div style="display:flex;align-items:center;gap:8px;margin-top:12px">
            <label style="margin:0;color:#9bb0c8">Ù‚ÙˆØ© Ø§Ù„Ù„ÙŠØ²Ø±:</label>
            <input id="laserPower" type="range" min="0" max="100" value="80" step="1" style="flex:1">
            <div id="laserPowerValue" style="min-width:44px;text-align:center;color:#ff4444">80%</div>
          </div>

          <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
            <label style="margin:0;color:#9bb0c8">Ø³Ø±Ø¹Ø© Ø§Ù„Ù„ÙŠØ²Ø±:</label>
            <input id="laserSpeed" type="range" min="100" max="5000" value="2000" step="100" style="flex:1">
            <div id="laserSpeedValue" style="min-width:60px;text-align:center;color:#06b6d4">2000</div>
          </div>

          <!-- Laser Mode -->
          <label for="laserMode">ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠØ²Ø±</label>
          <select id="laserMode">
            <option value="grayscale">Ù†Ù‚Ø´ ØªØ¯Ø±Ø¬ Ø§Ù„Ø±Ù…Ø§Ø¯ÙŠ</option>
            <option value="dithering">Ù†Ù‚Ø´ Ù…ØªÙ‚Ø·Ø¹ (Dithering)</option>
            <option value="contour">Ù‚Øµ ÙƒÙˆÙ†ØªÙˆØ±</option>
            <option value="combined">Ù†Ù‚Ø´ + Ù‚Øµ</option>
          </select>

          <!-- Dithering Settings -->
          <div id="ditheringSettings" style="margin-top:8px; padding:8px; background:rgba(255,68,68,0.05); border-radius:6px; border:1px solid rgba(255,68,68,0.3)">
            <label for="ditheringType">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø·ÙŠØ¹</label>
            <select id="ditheringType">
              <option value="floyd">Floyd-Steinberg</option>
              <option value="atkinson">Atkinson</option>
              <option value="bayer">Bayer Matrix</option>
            </select>
            
            <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
              <label style="margin:0;color:#9bb0c8">Ø¯Ù‚Ø© Ø§Ù„ØªÙ‚Ø·ÙŠØ¹:</label>
              <input id="ditheringQuality" type="range" min="1" max="10" value="5" step="1" style="flex:1">
              <div id="ditheringQualityValue" style="min-width:44px;text-align:center;color:#ffaa00">5</div>
            </div>
          </div>

          <!-- Advanced Settings -->
          <div style="margin-top:12px; padding:8px; background:rgba(6,182,212,0.05); border-radius:6px; border:1px solid rgba(6,182,212,0.3)">
            <label style="color:#06b6d4">ğŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</label>
            
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <label style="font-weight:normal;">
                <input id="laserDynamic" type="checkbox" checked /> 
                Ù‚ÙˆØ© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© (Ø­Ø³Ø¨ Ø§Ù„Ø¸Ù„Ø§Ù…)
              </label>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <label style="font-weight:normal;">
                <input id="laserAirAssist" type="checkbox" /> 
                Air Assist
              </label>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
              <label style="font-weight:normal;">
                <input id="laserOptimize" type="checkbox" checked /> 
                ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
              </label>
            </div>

            <label for="laserPasses" style="margin-top:8px">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª</label>
            <input id="laserPasses" type="number" value="1" min="1" max="10"/>
          </div>

          <!-- Laser Buttons -->
          <div class="button-group">
            <div class="button-row">
              <button id="btnLaserEngrave" class="primary" style="background:#ff4444; display:none;">âš¡ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ù„ÙŠØ²Ø±</button>
              <button id="btnLaserPreview" class="secondary" style="display:none;">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù„ÙŠØ²Ø±</button>
            </div>
            <div class="button-row">
              <button id="btnLaserOptimize" class="secondary" style="display:none;">ğŸ”„ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª</button>
              <button id="btnLaserDownload" class="secondary" style="display:none;">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠØ²Ø±</button>
            </div>
          </div>
        </div>

        <div id="estTime" style="margin-top:12px;color:#9bb0c8;text-align:center;padding:8px;background:#0f172a;border-radius:6px"></div>

        <label for="gcodeOut" style="margin-top:12px">ğŸ“„ Ù…Ø®Ø±Ø¬Ø§Øª G-code</label>
        <textarea id="gcodeOut" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± G-code Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯..." style="height:180px;background:#021024;color:#cfeaf2;border-radius:8px;padding:10px;"></textarea>

      </div>
    </div>
  </div>

  <!-- Debug Overlay -->
  <div id="debugOverlay" aria-live="polite" role="status">
    <!-- ... Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù€ debug overlay Ø§Ù„Ø­Ø§Ù„ÙŠ ... -->
  </div>

  <div id="toast"></div>

  <script>
    // ================= Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„ÙŠØ²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© =================
    let laserPreviewData = null;
    let optimizedPath = null;

    // ================= Ù†Ø¸Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù„ÙŠØ²Ø± Ø§Ù„Ù…Ø­Ø³Ù† =================

    // Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© ØªØ£Ø«ÙŠØ± Ø§Ù„Ù„ÙŠØ²Ø±
    function generateLaserPreview() {
      if (!grayMat || !previewCanvas) {
        showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©");
        return;
      }

      try {
        const canvas = document.getElementById('canvasLaserPreview');
        const ctx = canvas.getContext('2d');
        canvas.width = previewCanvas.width;
        canvas.height = previewCanvas.height;
        
        const laserPower = parseInt(document.getElementById('laserPower').value) || 80;
        const laserMode = document.getElementById('laserMode').value;
        const dynamicPower = document.getElementById('laserDynamic').checked;
        
        // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        const imgData = ctx.createImageData(canvas.width, canvas.height);
        
        for (let y = 0; y < canvas.height; y++) {
          for (let x = 0; x < canvas.width; x++) {
            const grayValue = sampleGrayAt(x, y);
            let power;
            
            if (dynamicPower) {
              power = Math.round((grayValue / 255) * laserPower);
            } else {
              power = laserPower;
            }
            
            const idx = (y * canvas.width + x) * 4;
            
            // ØªÙ„ÙˆÙŠÙ† Ø­Ø³Ø¨ Ù‚ÙˆØ© Ø§Ù„Ù„ÙŠØ²Ø±
            if (power > 70) {
              imgData.data[idx] = 255;     // Ø£Ø­Ù…Ø±
              imgData.data[idx + 1] = 0;
              imgData.data[idx + 2] = 0;
            } else if (power > 40) {
              imgData.data[idx] = 255;     // Ø£ØµÙØ±
              imgData.data[idx + 1] = 255;
              imgData.data[idx + 2] = 0;
            } else if (power > 10) {
              imgData.data[idx] = 0;       // Ø£Ø®Ø¶Ø±
              imgData.data[idx + 1] = 255;
              imgData.data[idx + 2] = 0;
            } else {
              imgData.data[idx] = 40;      // Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø©
              imgData.data[idx + 1] = 40;
              imgData.data[idx + 2] = 40;
            }
            
            imgData.data[idx + 3] = 255;   // alpha
          }
        }
        
        ctx.putImageData(imgData, 0, 0);
        showElement('canvasLaserPreview', 'laserPreviewPlaceholder');
        laserPreviewData = imgData;
        
        showToast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù„ÙŠØ²Ø±");
        
      } catch (error) {
        console.error('Laser preview error:', error);
        showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù„ÙŠØ²Ø±');
      }
    }

    // Ø¯Ø§Ù„Ø© ØªØ­Ø³ÙŠÙ† Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù„ÙŠØ²Ø±
    function optimizeLaserPath(points) {
      if (!points || points.length < 2) return points;
      
      const optimized = [];
      const tolerance = 2; // Ù…Ù…
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
      optimized.push(points[0]);
      
      for (let i = 1; i < points.length - 1; i++) {
        const prev = optimized[optimized.length - 1];
        const current = points[i];
        const next = points[i + 1];
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø²Ø§ÙˆÙŠØ©
        const distToPrev = Math.hypot(current.x - prev.x, current.y - prev.y);
        const distToNext = Math.hypot(next.x - current.x, next.y - current.y);
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ù‚Ø·Ø© Ù‚Ø±ÙŠØ¨Ø© Ø¬Ø¯Ø§Ù‹ Ø£Ùˆ Ø¹Ù„Ù‰ Ø®Ø· Ù…Ø³ØªÙ‚ÙŠÙ…ØŒ Ù†ØªØ®Ø·Ø§Ù‡Ø§
        if (distToPrev > tolerance && distToNext > tolerance) {
          optimized.push(current);
        }
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©
      optimized.push(points[points.length - 1]);
      
      return optimized;
    }

    // Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ G-code Ù„Ù„Ù„ÙŠØ²Ø± Ù…Ø­Ø³Ù†Ø©
    function generateLaserGcode() {
      if (!grayMat || !previewCanvas) {
        showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©");
        return "";
      }

      try {
        showToast("Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠØ²Ø±...");
        
        const laserPower = parseInt(document.getElementById('laserPower').value) || 80;
        const laserSpeed = parseInt(document.getElementById('laserSpeed').value) || 2000;
        const laserMode = document.getElementById('laserMode').value;
        const dynamicPower = document.getElementById('laserDynamic').checked;
        const optimizePaths = document.getElementById('laserOptimize').checked;
        const airAssist = document.getElementById('laserAirAssist').checked;
        const passes = parseInt(document.getElementById('laserPasses').value) || 1;

        const workWidth = parseFloat(document.getElementById('laserWorkWidth').value) || 300;
        const workHeight = parseFloat(document.getElementById('laserWorkHeight').value) || 200;
        const originX = parseFloat(document.getElementById('laserOriginX').value) || 0;
        const originY = parseFloat(document.getElementById('laserOriginY').value) || 0;

        const lines = [];
        lines.push('; Laser G-code - Generated by CNC AI');
        lines.push('G21 G90 G17');
        lines.push('G0 X0 Y0');
        if (airAssist) lines.push('M8'); // ØªØ´ØºÙŠÙ„ Air Assist
        
        const scaleX = workWidth / previewCanvas.width;
        const scaleY = workHeight / previewCanvas.height;
        
        let totalPoints = 0;
        let totalLength = 0;
        const allPoints = [];

        // Ù†Ù…Ø· Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ØªØ¹Ø±Ø¬
        const stepOver = 2.0; // Ù…Ù… Ø¨ÙŠÙ† Ø§Ù„Ø®Ø·ÙˆØ·
        const pointSpacing = 2.0; // Ù…Ù… Ø¨ÙŠÙ† Ø§Ù„Ù†Ù‚Ø§Ø·
        
        for (let pass = 0; pass < passes; pass++) {
          for (let y = 0; y < previewCanvas.height; y += stepOver / scaleY) {
            const rowPoints = [];
            let inImage = false;
            let segmentStart = -1;
            
            for (let x = 0; x < previewCanvas.width; x += pointSpacing / scaleX) {
              const pt = new cv.Point(x, y);
              const inside = contour ? cv.pointPolygonTest(contour, pt, false) >= 0 : true;
              
              if (inside && !inImage) {
                segmentStart = x;
                inImage = true;
              } else if (!inside && inImage) {
                // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø·Ø¹Ø© Ø§Ù„Ù…Ø³Ø§Ø±
                for (let sx = segmentStart; sx < x; sx += pointSpacing / scaleX) {
                  const grayValue = sampleGrayAt(sx, y);
                  let power;
                  
                  if (dynamicPower) {
                    power = Math.round((grayValue / 255) * laserPower);
                  } else {
                    power = laserPower;
                  }
                  
                  const scaledX = (sx * scaleX) + originX;
                  const scaledY = (y * scaleY) + originY;
                  
                  rowPoints.push({ 
                    x: scaledX, 
                    y: scaledY, 
                    power: power,
                    grayValue: grayValue
                  });
                  totalPoints++;
                }
                inImage = false;
              }
            }
            
            // Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ù„Ø§ Ù†Ø²Ø§Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
            if (inImage) {
              for (let sx = segmentStart; sx < previewCanvas.width; sx += pointSpacing / scaleX) {
                const grayValue = sampleGrayAt(sx, y);
                let power;
                
                if (dynamicPower) {
                  power = Math.round((grayValue / 255) * laserPower);
                } else {
                  power = laserPower;
                }
                
                const scaledX = (sx * scaleX) + originX;
                const scaledY = (y * scaleY) + originY;
                
                rowPoints.push({ 
                  x: scaledX, 
                  y: scaledY, 
                  power: power,
                  grayValue: grayValue
                });
                totalPoints++;
              }
            }
            
            if (rowPoints.length > 0) {
              // Ø§ØªØ¬Ø§Ù‡ Ù…ØªØ¹Ø±Ø¬
              const reverse = (y / (stepOver / scaleY)) % 2 !== 0;
              if (reverse) rowPoints.reverse();
              
              allPoints.push(...rowPoints);
            }
          }
        }

        // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø¥Ø°Ø§ Ø·Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        let finalPoints = allPoints;
        if (optimizePaths && allPoints.length > 100) {
          finalPoints = optimizeLaserPath(allPoints);
          showToast(`ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ù† ${allPoints.length} Ø¥Ù„Ù‰ ${finalPoints.length} Ù†Ù‚Ø·Ø©`);
        }

        optimizedPath = finalPoints;

        // ØªÙˆÙ„ÙŠØ¯ G-code
        lines.push('G0 X' + finalPoints[0].x.toFixed(2) + ' Y' + finalPoints[0].y.toFixed(2));
        lines.push('M3 S' + Math.round(finalPoints[0].power * 10));
        lines.push('G1 F' + laserSpeed.toFixed(0));
        
        let lastPower = finalPoints[0].power;
        
        for (let i = 0; i < finalPoints.length; i++) {
          const point = finalPoints[i];
          
          // ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ© Ø§Ù„Ù„ÙŠØ²Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø¨Ø´ÙƒÙ„ ÙƒØ¨ÙŠØ±
          if (Math.abs(point.power - lastPower) > 5) {
            lines.push('M3 S' + Math.round(point.power * 10));
            lastPower = point.power;
          }
          
          lines.push('G1 X' + point.x.toFixed(2) + ' Y' + point.y.toFixed(2));
          
          if (i > 0) {
            const prev = finalPoints[i - 1];
            totalLength += Math.hypot(point.x - prev.x, point.y - prev.y);
          }
        }

        lines.push('M5'); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù„ÙŠØ²Ø±
        if (airAssist) lines.push('M9'); // Ø¥ÙŠÙ‚Ø§Ù Air Assist
        lines.push('M30');

        // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ
        const timeMinutes = totalLength / laserSpeed;
        const hours = Math.floor(timeMinutes / 60);
        const minutes = Math.floor(timeMinutes % 60);
        const seconds = Math.round((timeMinutes * 60) % 60);
        
        let timeText = "â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ: ";
        if (hours > 0) timeText += hours + " Ø³Ø§Ø¹Ø© ";
        if (minutes > 0) timeText += minutes + " Ø¯Ù‚ÙŠÙ‚Ø© ";
        timeText += seconds + " Ø«Ø§Ù†ÙŠØ©";
        
        document.getElementById('estTime').innerHTML = timeText + ` | ${finalPoints.length} Ù†Ù‚Ø·Ø©`;

        showToast(`ØªÙ… ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠØ²Ø±: ${finalPoints.length} Ù†Ù‚Ø·Ø©`);
        return lines.join('\n');

      } catch (error) {
        console.error('Laser G-code generation error:', error);
        showToast('ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠØ²Ø±');
        return "";
      }
    }

    // ================= event listeners Ù„Ù„Ù„ÙŠØ²Ø± =================

    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„ÙŠØ²Ø±
    function updateLaserUI() {
      const isLaser = document.getElementById('machineCategory').value === 'laser';
      const laserPreviewTab = document.getElementById('laserPreviewTab');
      
      if (isLaser) {
        laserPreviewTab.style.display = 'block';
        // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø·ÙŠØ¹ ÙÙ‚Ø· ÙÙŠ ÙˆØ¶Ø¹ Dithering
        const ditheringSettings = document.getElementById('ditheringSettings');
        const laserMode = document.getElementById('laserMode').value;
        ditheringSettings.style.display = laserMode === 'dithering' ? 'block' : 'none';
      } else {
        laserPreviewTab.style.display = 'none';
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ… Ø§Ù„Ù„ÙŠØ²Ø±
    document.getElementById('laserPower').addEventListener('input', function(e) {
      document.getElementById('laserPowerValue').textContent = e.target.value + '%';
      document.getElementById('laserPowerValue').style.color = `hsl(${e.target.value * 1.2}, 100%, 60%)`;
    });

    document.getElementById('laserSpeed').addEventListener('input', function(e) {
      document.getElementById('laserSpeedValue').textContent = e.target.value;
    });

    document.getElementById('ditheringQuality').addEventListener('input', function(e) {
      document.getElementById('ditheringQualityValue').textContent = e.target.value;
    });

    document.getElementById('laserMode').addEventListener('change', function() {
      updateLaserUI();
    });

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„ÙŠØ²Ø±
    document.getElementById('btnLaserPreview').addEventListener('click', function() {
      generateLaserPreview();
      document.querySelector('.tab-buttons button[data-tab="laserpreview"]').click();
    });

    document.getElementById('btnLaserEngrave').addEventListener('click', function() {
      const gcode = generateLaserGcode();
      document.getElementById('gcodeOut').value = gcode;
      lastGeneratedGcode = gcode;
      if (gcode) {
        showToast("ØªÙ… ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠØ²Ø± Ø¨Ù†Ø¬Ø§Ø­");
        renderTopViewFromGcode(gcode);
        document.querySelector('.tab-buttons button[data-tab="simulation"]').click();
      }
    });

    document.getElementById('btnLaserOptimize').addEventListener('click', function() {
      if (optimizedPath) {
        showToast(`Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ø­Ø³Ù† Ø¨Ø§Ù„ÙØ¹Ù„: ${optimizedPath.length} Ù†Ù‚Ø·Ø©`);
      } else {
        showToast("Ù‚Ù… Ø£ÙˆÙ„Ø§Ù‹ Ø¨ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠØ²Ø± Ù„Ù„ØªØ­Ø³ÙŠÙ†");
      }
    });

    document.getElementById('btnLaserDownload').addEventListener('click', function() {
      document.getElementById('btnDownload').click();
    });

    document.getElementById('btnLaserCenterOrigin').addEventListener('click', function() {
      const workWidth = parseFloat(document.getElementById('laserWorkWidth').value) || 0;
      const workHeight = parseFloat(document.getElementById('laserWorkHeight').value) || 0;
      document.getElementById('laserOriginX').value = (workWidth / 2).toFixed(1);
      document.getElementById('laserOriginY').value = (workHeight / 2).toFixed(1);
      showToast("ØªÙ… ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ Ù„Ù„Ù„ÙŠØ²Ø±");
    });

    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„ÙŠØ²Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
    document.getElementById('machineCategory').addEventListener('change', function() {
      updateLaserUI();
    });

    // ================= ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„ÙŠØ²Ø± =================
    document.addEventListener('DOMContentLoaded', function() {
      updateLaserUI();
    });

    // ... Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (OpenCV, Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©ØŒ Ø¥Ù„Ø®) ...
    
  </script>
</body>
</html>
