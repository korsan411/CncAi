<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CNC AI — Multi Machine Raster Engraving</title>

  <!-- مكتبات -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
  <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>

  <style>
    /* الأساسيات */
    body {
      margin: 0;
      font-family: Arial, Segoe UI, system-ui;
      background: #041022;
      color: #e6eef6;
    }
    
    /* التخطيط */
    .app {
      max-width: 1200px;
      margin: 16px auto;
      padding: 14px;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 12px;
    }
    
    .panel {
      background: #0b1320;
      padding: 12px;
      border-radius: 10px;
    }
    
    /* التبويبات */
    .tabs button {
      margin-right: 6px;
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .tabs button.active {
      background: #06b6d4;
      color: #021;
    }
    
    .tab-content {
      display: none;
      margin-top: 8px;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* العناصر المرئية */
    canvas {
      max-width: 100%;
      border-radius: 6px;
      background: #000;
    }
    
    textarea {
      width: 100%;
      height: 200px;
      background: #021024;
      color: #cfeaf2;
      font-family: monospace;
      border-radius: 8px;
      padding: 8px;
    }
    
    #threeContainer {
      width: 100%;
      height: 360px;
      background: #081224;
      border-radius: 8px;
    }
    
    /* النماذج */
    label {
      display: block;
      margin-top: 8px;
    }
    
    input, select {
      width: 100%;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #1e293b;
      background: #0f172a;
      color: #e6eef6;
      margin-top: 4px;
    }
    
    /* الأزرار */
    button.primary {
      background: #06b6d4;
      color: #021;
      font-weight: bold;
      border: none;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
    }
    
    button.secondary {
      background: #1e293b;
      color: #e6eef6;
      border: none;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      margin-top: 6px;
    }
    
    /* التنبيهات */
    #toast {
      position: fixed;
      left: 16px;
      bottom: 16px;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      display: none;
      z-index: 10000;
    }
    
    /* النصوص */
    h1 {
      margin: 0;
      color: #06b6d4;
    }
    
    h3 {
      margin-top: 0;
      color: #9bb0c8;
    }
    
    #cvState {
      color: #9bb0c8;
      font-size: 0.9em;
    }
    
    #estTime {
      margin-top: 6px;
      color: #9bb0c8;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>CNC AI — Multi Machine Raster</h1>
      <div id="cvState">انتظر OpenCV</div>
    </header>

    <div class="grid">
      <!-- لوحة الصورة والمعاينة -->
      <div class="panel">
        <input id="fileInput" type="file" accept="image/*"/>
        
        <div class="tabs" style="margin-top: 8px">
          <button data-tab="original" class="active">الصورة الأصلية</button>
          <button data-tab="heatmap">خريطة الحرارة</button>
          <button data-tab="contour">الكشف عن الحواف</button>
          <button data-tab="threeD">المعاينة ثلاثية الأبعاد</button>
        </div>
        
        <div id="original" class="tab-content active">
          <canvas id="canvasOriginal"></canvas>
        </div>
        
        <div id="heatmap" class="tab-content">
          <canvas id="canvasHeatmap"></canvas>
        </div>
        
        <div id="contour" class="tab-content">
          <canvas id="canvasContour"></canvas>
        </div>
        
        <div id="threeD" class="tab-content">
          <div id="threeContainer"></div>
        </div>
      </div>

      <!-- لوحة التحكم والإعدادات -->
      <div class="panel">
        <h3>إعدادات التشغيل</h3>

        <label>
          نوع الماكينة
          <select id="machineType">
            <option value="router">Router</option>
            <option value="laser">Laser</option>
            <option value="plasma">Plasma</option>
          </select>
        </label>

        <label>
          سرعة التغذية (مم/دقيقة)
          <input id="feedRate" type="number" value="800"/>
        </label>
        
        <label>
          ارتفاع الأمان (مم)
          <input id="safeZ" type="number" value="5"/>
        </label>
        
        <label>
          عكس المحور Z
          <select id="invertZ">
            <option value="no">لا</option>
            <option value="yes">نعم</option>
          </select>
        </label>
        
        <label>
          اتجاه المسارات
          <select id="scanDir">
            <option value="x">أفقي (X)</option>
            <option value="y">رأسي (Y)</option>
          </select>
        </label>
        
        <label>
          خطوة المسح (مم)
          <input id="stepOver" type="number" value="5" step="0.5"/>
        </label>
        
        <label>
          أقصى عمق (مم)
          <input id="maxDepth" type="number" value="3.0" step="0.1"/>
        </label>

        <button id="btnGen" class="primary" style="margin-top: 10px">توليد G-code</button>
        <button id="btnQuick" class="secondary">اختبار سريع</button>
        <button id="btnDownload" class="secondary">تحميل G-code</button>
        
        <div id="estTime"></div>
        
        <textarea id="gcodeOut" readonly></textarea>
      </div>
    </div>
  </div>
  
  <div id="toast"></div>

  <script>
    // ========== المتغيرات العامة ==========
    let cvReady = false;
    let grayMat = null;
    let contour = null;
    let previewCanvas = null;
    
    // إعدادات الماكينات الافتراضية
    const machineDefaults = {
      router: { feed: 800, safeZ: 5, maxDepth: 3, stepOver: 5 },
      laser: { feed: 1200, safeZ: 0, maxDepth: 0, stepOver: 0.2 },
      plasma: { feed: 1500, safeZ: 3, maxDepth: 0, stepOver: 1 }
    };

    // ========== وظائف المساعدة ==========
    
    /**
     * عرض رسالة تنبيه
     * @param {string} msg - نص الرسالة
     * @param {number} ms - مدة العرض (ميلي ثانية)
     */
    function showToast(msg, ms = 2000) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(t._t);
      t._t = setTimeout(() => t.style.display = 'none', ms);
    }

    // ========== OpenCV ==========
    
    /**
     * انتظار تحميل OpenCV
     */
    function waitForCv() {
      if (window.cv && cv.getBuildInformation) {
        cvReady = true;
        document.getElementById('cvState').textContent = 'OpenCV جاهز';
      } else if (window.cv) {
        cv.onRuntimeInitialized = () => {
          cvReady = true;
          document.getElementById('cvState').textContent = 'OpenCV جاهز';
        };
      } else {
        setTimeout(waitForCv, 200);
      }
    }
    
    // بدء انتظار OpenCV
    waitForCv();

    // ========== التبويبات ==========
    
    document.querySelectorAll('.tabs button').forEach(btn => {
      btn.addEventListener('click', () => {
        // إزالة النشاط من جميع الأزرار
        document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        
        // إضافة النشاط للزر المحدد
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
        
        // إذا كانت التبويبة ثلاثية الأبعاد، عرض المعاينة
        if (btn.dataset.tab === "threeD" && grayMat) {
          show3D();
        }
      });
    });

    // ========== تحميل الصورة ==========
    
    document.getElementById('fileInput').addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      
      const img = new Image();
      img.onload = function() {
        previewCanvas = document.getElementById('canvasOriginal');
        previewCanvas.width = img.width;
        previewCanvas.height = img.height;
        
        const ctx = previewCanvas.getContext('2d');
        ctx.drawImage(img, 0, 0, previewCanvas.width, previewCanvas.height);
        
        if (cvReady) {
          detectContours();
        }
      }
      img.src = URL.createObjectURL(file);
    });

    // ========== معالجة الصور ==========
    
    /**
     * أخذ عينة من الصورة الرمادية باستخدام الاستيفاء الثنائي
     * @param {number} x - الإحداثي X
     * @param {number} y - الإحداثي Y
     * @returns {number} قيمة الرمادي
     */
    function sampleGrayAt(x, y) {
      if (!grayMat) return 128;
      
      const gw = grayMat.cols;
      const gh = grayMat.rows;
      
      // تحويل الإحداثيات
      const gx_f = (x / previewCanvas.width) * (gw - 1);
      const gy_f = (y / previewCanvas.height) * (gh - 1);
      
      // نقاط الشبكة المحيطة
      const x0 = Math.floor(gx_f);
      const y0 = Math.floor(gy_f);
      const x1 = Math.min(gw - 1, x0 + 1);
      const y1 = Math.min(gh - 1, y0 + 1);
      
      // نسب الاستيفاء
      const sx = gx_f - x0;
      const sy = gy_f - y0;
      
      // القيم المحيطة
      const v00 = grayMat.ucharPtr(y0, x0)[0];
      const v10 = grayMat.ucharPtr(y0, x1)[0];
      const v01 = grayMat.ucharPtr(y1, x0)[0];
      const v11 = grayMat.ucharPtr(y1, x1)[0];
      
      // الاستيفاء الثنائي
      const v0 = v00 * (1 - sx) + v10 * sx;
      const v1 = v01 * (1 - sx) + v11 * sx;
      
      return Math.round(v0 * (1 - sy) + v1 * sy);
    }

    /**
     * الكشف عن الحواف في الصورة
     */
    function detectContours() {
      // تحميل الصورة
      let src = cv.imread(previewCanvas);
      let gray = new cv.Mat();
      cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(gray, gray, new cv.Size(3, 3), 0, 0);

      // حساب عتبات Canny تلقائياً
      function medianGray(mat) {
        const total = mat.rows * mat.cols;
        const step = Math.max(1, Math.floor(total / 5000));
        const vals = [];
        
        for (let i = 0; i < total; i += step) {
          vals.push(mat.data[i]);
        }
        
        vals.sort((a, b) => a - b);
        return vals[Math.floor(vals.length / 2)];
      }
      
      const med = medianGray(gray);
      const sigma = 0.33;
      const lower = Math.max(0, Math.round((1.0 - sigma) * med));
      const upper = Math.min(255, Math.round((1.0 + sigma) * med));

      // كشف الحواف
      let edges = new cv.Mat();
      cv.Canny(gray, edges, lower, upper);
      
      // تحسين الحواف
      let k = cv.getStructuringElement(cv.MORPH_RECT, new cv.Size(3, 3));
      cv.morphologyEx(edges, edges, cv.MORPH_CLOSE, k);

      // إيجاد الكنتورات
      let contours = new cv.MatVector();
      let hier = new cv.Mat();
      cv.findContours(edges, contours, hier, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
      
      // اختيار الكنتور الأكبر
      let maxArea = 0;
      let chosen = null;
      
      for (let i = 0; i < contours.size(); i++) {
        const cnt = contours.get(i);
        const a = cv.contourArea(cnt);
        
        if (a > maxArea) {
          maxArea = a;
          chosen = cnt.clone();
        }
      }
      
      contour = chosen;

      // حفظ الصورة الرمادية
      if (grayMat) {
        grayMat.delete();
      }
      grayMat = gray.clone();

      // عرض خريطة الحرارة
      let heat = document.getElementById('canvasHeatmap');
      heat.width = gray.cols;
      heat.height = gray.rows;
      
      let hctx = heat.getContext('2d');
      let imgData = hctx.createImageData(heat.width, heat.height);
      
      for (let y = 0; y < gray.rows; y++) {
        for (let x = 0; x < gray.cols; x++) {
          let v = gray.ucharPtr(y, x)[0];
          let idx = (y * gray.cols + x) * 4;
          
          imgData.data[idx] = v;        // الأحمر
          imgData.data[idx + 1] = 0;    // الأخضر
          imgData.data[idx + 2] = 255 - v; // الأزرق
          imgData.data[idx + 3] = 255;  // الشفافية
        }
      }
      
      hctx.putImageData(imgData, 0, 0);

      // عرض الكنتور
      let ccan = document.getElementById('canvasContour');
      ccan.width = gray.cols;
      ccan.height = gray.rows;
      
      let cctx = ccan.getContext('2d');
      cctx.drawImage(heat, 0, 0);
      
      if (contour) {
        cctx.strokeStyle = "lime";
        cctx.lineWidth = 2;
        cctx.beginPath();
        
        for (let i = 0; i < contour.data32S.length; i += 2) {
          let x = contour.data32S[i];
          let y = contour.data32S[i + 1];
          
          if (i === 0) {
            cctx.moveTo(x, y);
          } else {
            cctx.lineTo(x, y);
          }
        }
        
        cctx.closePath();
        cctx.stroke();
      }
      
      showToast("تم الكشف عن الحواف");
      
      // تنظيف الذاكرة
      src.delete();
      edges.delete();
      hier.delete();
    }

    // ========== توليد G-code ==========
    
    /**
     * توليد كود G للمسح النقطي
     * @param {boolean} scaleDown - تقليل حجم المسارات للاختبار السريع
     * @returns {string} كود G المولد
     */
    function generateRasterGcode(scaleDown = false) {
      if (!grayMat || !contour) {
        showToast("لا توجد صورة جاهزة");
        return "";
      }
      
      // قراءة الإعدادات
      const dir = document.getElementById('scanDir').value;
      const stepOver = parseFloat(document.getElementById('stepOver').value);
      const maxDepth = parseFloat(document.getElementById('maxDepth').value);
      const feed = parseFloat(document.getElementById('feedRate').value);
      const safeZ = parseFloat(document.getElementById('safeZ').value);
      const invertZ = document.getElementById('invertZ').value === 'yes';

      // بدء كود G
      const lines = [];
      lines.push('G21 G90 G17'); // الوحدات المترية، الإحداثيات المطلقة، مستوى XY
      lines.push(`G0 Z${safeZ.toFixed(2)}`); // الانتقال لارتفاع الأمان
      
      let totalLen = 0;
      let step = scaleDown ? stepOver * 4 : stepOver;

      // المسح الأفقي
      if (dir === 'x') {
        for (let y = 0; y < previewCanvas.height; y += step) {
          let row = [];
          
          // جمع النقاط داخل الكنتور
          for (let x = 0; x < previewCanvas.width; x++) {
            let inside = cv.pointPolygonTest(contour, new cv.Point(x, y), false);
            
            if (inside >= 0) {
              let pv = sampleGrayAt(x, y);
              let z = -((255 - pv) / 255.0) * maxDepth;
              
              if (invertZ) {
                z = -z;
              }
              
              row.push({ x, y, z });
            }
          }
          
          // إذا كان هناك نقاط في الصف
          if (row.length > 1) {
            // عكس اتجاه الصفوف الفردية
            if ((y / step) % 2 !== 0) {
              row.reverse();
            }
            
            // الانتقال للنقطة الأولى
            lines.push(`G0 X${row[0].x} Y${row[0].y} Z${safeZ}`);
            lines.push(`G1 F${feed}`); // تعيين سرعة التغذية
            
            // رسم المسار
            for (let i = 0; i < row.length; i++) {
              let p = row[i];
              lines.push(`G1 X${p.x} Y${p.y} Z${p.z.toFixed(3)}`);
              
              // حساب الطول الإجمالي
              if (i > 0) {
                totalLen += Math.hypot(p.x - row[i - 1].x, p.y - row[i - 1].y);
              }
            }
            
            // العودة لارتفاع الأمان
            lines.push(`G0 Z${safeZ}`);
          }
        }
      }
      
      // نهاية البرنامج
      lines.push('M5');  // إيقاف المغزل/الليزر
      lines.push('M30'); // نهاية البرنامج
      
      // حساب الوقت التقريبي
      let timeMin = (totalLen / feed);
      document.getElementById('estTime').textContent = "تقدير الوقت: " + timeMin.toFixed(1) + " دقيقة";
      
      return lines.join('\n');
    }

    // ========== إعدادات الماكينة ==========
    
    document.getElementById('machineType').addEventListener('change', (e) => {
      const type = e.target.value;
      const def = machineDefaults[type];
      
      if (def) {
        document.getElementById('feedRate').value = def.feed;
        document.getElementById('safeZ').value = def.safeZ;
        document.getElementById('maxDepth').value = def.maxDepth;
        document.getElementById('stepOver').value = def.stepOver;
        
        showToast(`تم تحميل إعدادات ${type}`);
      }
    });

    // ========== الأزرار ==========
    
    document.getElementById('btnGen').addEventListener('click', () => {
      let gcode = generateRasterGcode(false);
      document.getElementById('gcodeOut').value = gcode;
      showToast("تم توليد G-code");
    });
    
    document.getElementById('btnQuick').addEventListener('click', () => {
      let gcode = generateRasterGcode(true);
      document.getElementById('gcodeOut').value = gcode;
      showToast("توليد سريع");
    });
    
    document.getElementById('btnDownload').addEventListener('click', () => {
      const text = document.getElementById('gcodeOut').value;
      const blob = new Blob([text], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = "cnc_output.gcode";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ========== المعاينة ثلاثية الأبعاد ==========
    
    /**
     * عرض معاينة ثلاثية الأبعاد للصورة
     */
    function show3D() {
      const cont = document.getElementById('threeContainer');
      cont.innerHTML = "";
      
      // إنشاء المشهد
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(45, cont.clientWidth / cont.clientHeight, 0.1, 5000);
      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(cont.clientWidth, cont.clientHeight);
      cont.appendChild(renderer.domElement);

      // إنشاء سطح ثلاثي الأبعاد من الصورة الرمادية
      const geom = new THREE.PlaneGeometry(grayMat.cols, grayMat.rows, grayMat.cols - 1, grayMat.rows - 1);
      
      for (let y = 0; y < grayMat.rows; y++) {
        for (let x = 0; x < grayMat.cols; x++) {
          let v = grayMat.ucharPtr(y, x)[0];
          let z = (v / 255.0) * 10;
          let idx = y * grayMat.cols + x;
          
          geom.attributes.position.setZ(idx, z);
        }
      }
      
      geom.attributes.position.needsUpdate = true;
      geom.computeVertexNormals();
      geom.rotateX(-Math.PI / 2); // تدوير السطح ليكون أفقي

      // إنشاء الشبكة وإضافتها للمشهد
      const mesh = new THREE.Mesh(
        geom,
        new THREE.MeshStandardMaterial({
          color: 0xcccccc,
          side: THREE.DoubleSide,
          flatShading: true
        })
      );
      
      scene.add(mesh);
      
      // الإضاءة
      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(50, 100, 150);
      scene.add(light);
      scene.add(new THREE.AmbientLight(0x404040));

      // وضع الكاميرا
      camera.position.set(0, -grayMat.rows, grayMat.rows * 1.2);
      
      // التحكم بالكاميرا
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      
      // التصيير المستمر
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      
      animate();
    }
  </script>
</body>
</html>
