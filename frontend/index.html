<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>CncAi</title>
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#f4f4f4; color:#333; }
    header { background:#222; color:#fff; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { margin:0; font-size:20px; }
    header button { background:#444; color:#fff; border:none; padding:5px 10px; cursor:pointer; border-radius:6px; }
    .tabs { display:flex; background:#ddd; }
    .tabs button { flex:1; padding:10px; border:none; cursor:pointer; font-weight:bold; }
    .tabs button.active { background:#fff; border-bottom:3px solid #222; }
    .tab-content { display:none; padding:15px; }
    .tab-content.active { display:block; }
    canvas { border:1px solid #ccc; max-width:100%; background:#fff; }
    .preview-controls { margin:10px 0; }
    .preview-controls button { margin:2px; padding:5px 8px; border:none; border-radius:6px; cursor:pointer; background:#eee; }
    .form-group { margin:10px 0; }
    textarea { width:100%; height:150px; }
    /* Dark theme */
    body.dark { background:#222; color:#eee; }
    body.dark header { background:#111; }
    body.dark .tabs { background:#444; }
    body.dark .tabs button.active { background:#222; color:#fff; }
  </style>
</head>
<body>
  <header>
    <h1>CncAi</h1>
    <button onclick="toggleTheme()">🌙/☀️</button>
  </header>

  <!-- تبويبات -->
  <div class="tabs">
    <button class="active" onclick="openTab('preview',event)">📷 المعاينة</button>
    <button onclick="openTab('gcode',event)">⚙️ إعدادات G-code</button>
  </div>

  <!-- تبويب المعاينة -->
  <div id="preview" class="tab-content active">
    <input type="file" id="upload" accept="image/*"><br><br>
    <div class="preview-controls">
      <button onclick="setView('original')">الصورة</button>
      <button onclick="setView('heatmap')">Heatmap</button>
      <button onclick="setView('3d')">3D</button>
      <button onclick="changeColormap('jet')">Jet</button>
      <button onclick="changeColormap('hot')">Hot</button>
      <button onclick="changeColormap('cool')">Cool</button>
      <button onclick="changeColormap('gray')">Gray</button>
    </div>
    <canvas id="canvas" width="500" height="500"></canvas>
    <div id="three-container" style="width:500px; height:500px; display:none;"></div>
  </div>

  <!-- تبويب G-code -->
  <div id="gcode" class="tab-content">
    <div class="form-group">
      <label>العرض (مم):</label>
      <input type="number" id="width" value="100">
    </div>
    <div class="form-group">
      <label>الطول (مم):</label>
      <input type="number" id="height" value="100">
    </div>
    <div class="form-group">
      <label>عمق القطع (مم):</label>
      <input type="number" id="depth" value="2">
    </div>
    <div class="form-group">
      <label>سرعة التغذية (مم/دقيقة):</label>
      <input type="number" id="feedrate" value="500">
    </div>
    <button onclick="generateGCode()">توليد G-code</button>
    <button onclick="downloadGCode()">تحميل الملف</button>
    <textarea id="gcodeOutput" readonly></textarea>
    <h3>معاينة 2D للمسار:</h3>
    <canvas id="gcodeCanvas" width="500" height="500"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    // --- تبويبات ---
    function openTab(tab,event) {
      document.querySelectorAll('.tab-content').forEach(div=>div.classList.remove('active'));
      document.querySelectorAll('.tabs button').forEach(btn=>btn.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      event.target.classList.add('active');
      if(tab==="preview"){ renderCurrentView(); }
    }

    function toggleTheme() { document.body.classList.toggle('dark'); }

    // --- متغيرات المعاينة ---
    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");
    let img = new Image();
    let currentView = "original";
    let colormap = "jet";
    let scene, camera, renderer, mesh;

    document.getElementById("upload").addEventListener("change", e => {
      let file = e.target.files[0];
      let reader = new FileReader();
      reader.onload = ev => {
        img.onload = () => { renderCurrentView(); };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    function setView(v){ currentView=v; renderCurrentView(); }
    function changeColormap(m){ colormap=m; if(currentView!=="original") renderCurrentView(); }

    function renderCurrentView(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      document.getElementById("three-container").style.display="none";
      canvas.style.display="block";

      if(currentView==="original"){
        ctx.drawImage(img,0,0,500,500);
      }
      else if(currentView==="heatmap"){
        ctx.drawImage(img,0,0,500,500);
        let imageData = ctx.getImageData(0,0,500,500);
        let data = imageData.data;
        for(let i=0;i<data.length;i+=4){
          let gray = (data[i]+data[i+1]+data[i+2])/3;
          let c = getColor(gray,colormap);
          data[i]=c[0]; data[i+1]=c[1]; data[i+2]=c[2];
        }
        ctx.putImageData(imageData,0,0);
      }
      else if(currentView==="3d"){
        show3D();
      }
    }

    // --- Colormap ---
    function getColor(val,map){
      let t=val/255;
      if(map==="jet") return [t*255,(1-t)*255,128];
      if(map==="hot") return [255*t,128*(1-t),0];
      if(map==="cool") return [0,255*t,255*(1-t)];
      if(map==="gray") return [val,val,val];
      return [val,val,val];
    }

    // --- 3D Preview ---
    function show3D(){
      canvas.style.display="none";
      let container=document.getElementById("three-container");
      container.style.display="block";
      if(!renderer){
        renderer=new THREE.WebGLRenderer();
        renderer.setSize(500,500);
        container.appendChild(renderer.domElement);
        scene=new THREE.Scene();
        camera=new THREE.PerspectiveCamera(45,1,0.1,1000);
        camera.position.set(0,0,200);
        let light=new THREE.DirectionalLight(0xffffff,1);
        light.position.set(0,0,100).normalize();
        scene.add(light);
      }
      if(mesh) scene.remove(mesh);
      let geometry=new THREE.PlaneGeometry(100,100,50,50);
      let mat=new THREE.MeshPhongMaterial({color:0x00ff00,wireframe:false,side:THREE.DoubleSide});
      mesh=new THREE.Mesh(geometry,mat);
      scene.add(mesh);
      animate3D();
    }

    function animate3D(){
      requestAnimationFrame(animate3D);
      if(mesh){ mesh.rotation.x+=0.01; mesh.rotation.y+=0.01; }
      renderer.render(scene,camera);
    }

    // --- G-code ---
    function generateGCode(){
      let w = +document.getElementById("width").value;
      let h = +document.getElementById("height").value;
      let d = +document.getElementById("depth").value;
      let f = +document.getElementById("feedrate").value;
      let gcode = `G21 ; mm\nG90 ; absolute\nG1 Z5 F500\n`;
      for(let y=0;y<=h;y+=10){
        let dir = (y/10)%2==0?1:-1;
        for(let x=0;x<=w;x+=10){
          let X = dir==1?x:w-x;
          gcode += `G1 X${X} Y${y} Z-${d} F${f}\n`;
        }
      }
      gcode += "M30";
      document.getElementById("gcodeOutput").value = gcode;
      drawGcodePath(gcode);
    }

    function downloadGCode(){
      let text = document.getElementById("gcodeOutput").value;
      let blob = new Blob([text],{type:"text/plain"});
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "cnc.nc";
      a.click();
    }

    function drawGcodePath(code){
      let c = document.getElementById("gcodeCanvas");
      let cx = c.getContext("2d");
      cx.clearRect(0,0,c.width,c.height);
      cx.strokeStyle = "blue"; cx.beginPath();
      let x=0,y=0;
      code.split("\n").forEach(line=>{
        if(line.startsWith("G1")){
          let X = /X([\d\.\-]+)/.exec(line);
          let Y = /Y([\d\.\-]+)/.exec(line);
          if(X) x=+X[1]; if(Y) y=+Y[1];
          cx.lineTo(x/2,y/2);
        }
      });
      cx.stroke();
    }
  </script>
</body>
</html>
