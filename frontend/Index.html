<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CNC AI â€” CNC Router & Laser Engraving</title>

  <!-- Ù…ÙƒØªØ¨Ø§Øª -->
  <script src="https://docs.opencv.org/4.8.0/opencv.js" async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, Segoe UI, system-ui; background: #041022; color:#e6eef6; line-height:1.45 }
    .app { max-width:1400px; margin:12px auto; padding:14px }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid #1e293b }
    .grid { display:grid; grid-template-columns:1fr 520px; gap:16px }
    @media (max-width:1100px){ .grid{ grid-template-columns:1fr } }
    .panel { background:#0b1320; padding:16px; border-radius:10px; border:1px solid #1e293b }
    
    .tab-buttons { display:flex; gap:8px; margin-top:12px; background: rgba(14,23,33,0.6); padding:6px; border-radius:8px }
    .tab-buttons button { flex:1; border:none; padding:8px 10px; border-radius:6px; background:transparent; color:#9bb0c8; cursor:pointer }
    .tab-buttons button.active { background:#0f172a; color:#e6eef6; box-shadow: inset 0 -3px 0 #06b6d4; }
    .tab-content { display:none; margin-top:12px }
    .tab-content.active { display:block }
    
    canvas { max-width:100%; border-radius:6px; background:#000; display:block; margin:0 auto; border:1px solid #334155 }
    #threeContainer { width:100%; height:420px; background:#081224; border-radius:8px; overflow:hidden; position:relative }
    
    label { display:block; margin-top:12px; color:#cfeaf2; font-weight:bold }
    input, select, textarea, button { font-size:0.9rem }
    input, select { width:100%; padding:8px 10px; border-radius:6px; border:1px solid #1e293b; background:#0f172a; color:#e6eef6; margin-top:6px }
    
    .button-group { display:flex; flex-direction:column; gap:8px; margin-top:12px }
    .button-row { display:flex; gap:8px; }
    button { background:#1e293b; color:#e6eef6; border:none; padding:10px; border-radius:8px; cursor:pointer; transition: all 0.2s ease; }
    button:hover { background:#2d3748; }
    button.primary { background:#06b6d4; color:#021; font-weight:bold }
    button.primary:hover { background:#0891b2; }
    button.secondary { background:#334155; }
    button.secondary:hover { background:#475569; }
    button:disabled { opacity:0.6; cursor:not-allowed; background:#4b5563 !important; }
    
    #toast { 
        position:fixed; 
        left:50%; 
        bottom:20px; 
        transform:translateX(-50%);
        background:rgba(0,0,0,0.9); 
        color:#fff; 
        padding:12px 20px; 
        border-radius:8px; 
        display:none; 
        z-index:10000;
        border:1px solid #334155;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        max-width: 400px;
        text-align: center;
    }
    
    .canvas-placeholder { 
        width:100%; 
        min-height:260px; 
        background:#000; 
        border-radius:6px; 
        display:flex; 
        align-items:center; 
        justify-content:center; 
        color:#9bb0c8; 
        border:1px solid #334155;
        font-size: 14px;
    }
    
    .small-meta { font-size:12px; color:#9bb0c8; margin-top:6px }

    /* Progress indicator */
    .progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 30000;
      flex-direction: column;
      gap: 20px;
    }
    .progress-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(243, 243, 243, 0.3);
      border-top: 4px solid #06b6d4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .progress-text {
      color: white;
      font-size: 18px;
      font-weight: bold;
    }
    .progress-details {
      color: #cfeaf2;
      font-size: 14px;
      text-align: center;
      max-width: 400px;
      line-height: 1.5;
    }
    .cancel-btn {
      background: #ef4444 !important;
      color: white !important;
      margin-top: 15px;
      padding: 10px 20px;
    }
    .cancel-btn:hover {
      background: #dc2626 !important;
    }

    @keyframes spin { 
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Performance warning */
    .performance-warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid #f59e0b;
      border-radius: 6px;
      padding: 10px;
      margin: 10px 0;
      color: #fbbf24;
      font-size: 13px;
      text-align: center;
      line-height: 1.4;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {
        .app { padding: 8px; }
        .grid { grid-template-columns: 1fr; gap: 12px; }
        .button-row { flex-direction: column; }
        .tab-buttons { flex-wrap: wrap; }
        .tab-buttons button { min-width: 120px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1 style="margin:0; font-size:1.5rem;">CNC AI â€” CNC Router & Laser Engraving</h1>
      <div id="cvState">
        <span class="loading" style="display:inline-block;width:16px;height:16px;border:3px solid #f3f3f3;border-top:3px solid #06b6d4;border-radius:50%;animation:spin 1s linear infinite;margin-left:8px;"></span>
        Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ OpenCV...
      </div>
    </header>

    <div class="grid">
      <!-- LEFT panel -->
      <div class="panel">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <input id="fileInput" type="file" accept="image/*" style="display:none;"/>
          <label class="file-input-label" for="fileInput" style="display:inline-block;padding:10px 16px;background:#1e293b;border-radius:6px;color:#e6eef6;cursor:pointer;border:1px dashed #334155;flex:1;text-align:center;">
            ğŸ“ Ø§Ø®ØªØ± ØµÙˆØ±Ø©
          </label>
          
          <div style="display:flex;gap:8px;align-items:center;">
            <label for="edgeMode" style="font-weight:normal;color:#9bb0c8;white-space:nowrap;">ÙˆØ¶Ø¹ Ø§Ù„Ø­ÙˆØ§Ù:</label>
            <select id="edgeMode" style="width:140px">
              <option value="auto">Canny (Ø¹Ø§Ø¯ÙŠ)</option>
              <option value="sobel">Sobel (Ø¯Ù‚ÙŠÙ‚)</option>
              <option value="laplace">Laplacian (Ù†Ø§Ø¹Ù…)</option>
            </select>
          </div>
        </div>

        <!-- Edge sensitivity slider -->
        <div style="display:flex;align-items:center;gap:8px;margin-top:12px">
          <label style="margin:0;color:#9bb0c8;min-width:100px;">Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ù:</label>
          <input id="edgeSensitivity" type="range" min="0.1" max="1.0" step="0.05" value="0.33" style="flex:1">
          <div id="edgeValue" style="min-width:44px;text-align:center;color:#cfeaf2;font-weight:bold;">0.33</div>
        </div>

        <!-- Colormap Section -->
        <div style="margin: 20px 0; padding: 16px; background: rgba(14, 23, 33, 0.8); border-radius: 10px; border: 1px solid #334155;">
          <div style="text-align: center; margin-bottom: 12px; color: #cfeaf2; font-weight: bold; font-size: 16px;">
            ğŸ¨ Ø®ÙŠØ§Ø±Ø§Øª ØªØ¯Ø±Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ğŸ¨
          </div>
          <div style="display:flex; gap:8px; justify-content:center; margin-top:8px; flex-wrap:wrap;" id="colormapButtons">
            <button data-map="jet" class="active" style="background:#141b22; color:#cfeaf2; border:1px solid #26343f; padding:10px 16px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:bold; transition:all 0.3s ease; min-width:80px;">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>Jet</div>
                <div style="width:100%;height:4px;background:linear-gradient(90deg,#0000ff,#00ffff,#ffff00,#ff0000);border-radius:2px"></div>
              </div>
            </button>
            <button data-map="hot" style="background:#141b22; color:#cfeaf2; border:1px solid #26343f; padding:10px 16px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:bold; transition:all 0.3s ease; min-width:80px;">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>Hot</div>
                <div style="width:100%;height:4px;background:linear-gradient(90deg,#000000,#ff0000,#ffff00,#ffffff);border-radius:2px"></div>
              </div>
            </button>
            <button data-map="cool" style="background:#141b22; color:#cfeaf2; border:1px solid #26343f; padding:10px 16px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:bold; transition:all 0.3s ease; min-width:80px;">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>Cool</div>
                <div style="width:100%;height:4px;background:linear-gradient(90deg,#00ffff,#ff00ff);border-radius:2px"></div>
              </div>
            </button>
            <button data-map="gray" style="background:#141b22; color:#cfeaf2; border:1px solid #26343f; padding:10px 16px; border-radius:8px; cursor:pointer; font-size:14px; font-weight:bold; transition:all 0.3s ease; min-width:80px;">
              <div style="display:flex;flex-direction:column;align-items:center;gap:4px">
                <div>Gray</div>
                <div style="width:100%;height:4px;background:linear-gradient(90deg,#000000,#ffffff);border-radius:2px"></div>
              </div>
            </button>
          </div>
          <div class="small-meta" style="text-align: center; margin-top: 12px;">
            Ø§Ù„ØªØºÙŠÙŠØ± ÙŠØ·Ø¨Ù‚ Ø¹Ù„Ù‰: Heatmap â€¢ Top View â€¢ Contours â€¢ ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø§Øª
          </div>
        </div>

        <div class="tab-buttons" role="tablist">
          <button data-tab="original" class="active">ğŸ–¼ï¸ Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
          <button data-tab="heatmap">ğŸ”¥ Heatmap</button>
          <button data-tab="contour">ğŸ“ Contours</button>
          <button data-tab="topview">ğŸ” Top View</button>
          <button data-tab="simulation">ğŸ¬ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</button>
        </div>

        <div id="original" class="tab-content active">
          <div class="canvas-placeholder" id="originalPlaceholder">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          <canvas id="canvasOriginal" style="display:none;"></canvas>
        </div>

        <div id="heatmap" class="tab-content">
          <div class="canvas-placeholder" id="heatmapPlaceholder">Heatmap Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          <canvas id="canvasHeatmap" style="display:none;"></canvas>
        </div>

        <div id="contour" class="tab-content">
          <div class="canvas-placeholder" id="contourPlaceholder">Contours Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§</div>
          <canvas id="canvasContour" style="display:none;"></canvas>
          <div class="small-meta">ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù Ø£Ùˆ ØªØ­Ø±ÙŠÙƒ Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ù ÙŠØ­Ø¯Ø« Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</div>
        </div>

        <div id="topview" class="tab-content">
          <div style="margin-top:12px; display:flex; flex-direction:column; gap:6px; align-items:center;">
            <canvas id="topView" style="width:100%; height:200px; background:#0d1722; border-radius:6px; border:1px solid #334155; display:block"></canvas>
            <div id="topLegend" style="width:100%; height:18px; border-radius:6px; border:1px solid #2b3844; background:linear-gradient(90deg,#ddd,#333);" title="Ø¹Ù…Ù‚ Ø§Ù„Ù†Ù‚Ø´ â€” Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙ‚Ø·"></div>
          </div>
          <div class="small-meta">Ù…Ø¹Ø§ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø¹Ù…Ù‚ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ ØªÙ†ÙÙŠØ° G-code (Ø§Ù„Ø£Ù„ÙˆØ§Ù† ØªØªØ¨Ø¹ Ø§Ø®ØªÙŠØ§Ø± Colormap)</div>
        </div>

        <div id="simulation" class="tab-content">
          <div id="threeContainer">
            <div class="canvas-placeholder" id="simulationPlaceholder">Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ ØªÙˆÙ„ÙŠØ¯ G-code</div>
          </div>
        </div>
      </div>

      <!-- RIGHT panel -->
      <div class="panel">
        <h3 style="margin-top:0;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©</h3>

        <!-- Machine Category Selection -->
        <label for="machineCategory">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
        <select id="machineCategory">
          <option value="router">CNC Router (Ù†Ø­Øª Ø®Ø´Ø¨)</option>
          <option value="laser">Laser Engraver (Ù†Ù‚Ø´ Ù„ÙŠØ²Ø±)</option>
        </select>

        <!-- CNC Router Settings -->
        <div id="routerSettings" class="machine-settings">
          <h4 style="color:#06b6d4; border-left: 3px solid #06b6d4; padding-left: 10px; margin: 12px 0;">ğŸ”„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª CNC Router</h4>
          
          <label for="workWidth">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
          <input id="workWidth" type="number" value="30" step="0.1" min="1" max="200"/>
          <div class="small-meta" id="widthMm">300.0 Ù…Ù…</div>

          <label for="workHeight">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
          <input id="workHeight" type="number" value="20" step="0.1" min="1" max="200"/>
          <div class="small-meta" id="heightMm">200.0 Ù…Ù…</div>

          <label for="workDepth">Ø¹Ù…Ù‚ Ø§Ù„Ø¹Ù…Ù„ (Ù…Ù…)</label>
          <input id="workDepth" type="number" value="3.0" step="0.1" min="0.1" max="50"/>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px; margin-top:12px;">
            <div>
              <label for="originX">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ X (Ø³Ù…)</label>
              <input id="originX" type="number" value="0" step="0.1"/>
            </div>
            <div>
              <label for="originY">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ Y (Ø³Ù…)</label>
              <input id="originY" type="number" value="0" step="0.1"/>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button id="btnCenterOrigin" class="secondary">ğŸ¯ ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„</button>
          </div>

          <hr style="border-color:#1e293b;margin:16px 0;"/>

          <label for="feedRate">Ø³Ø±Ø¹Ø© Ø§Ù„ØªØºØ°ÙŠØ© (Ù…Ù…/Ø¯Ù‚ÙŠÙ‚Ø©)</label>
          <input id="feedRate" type="number" value="800" min="10" max="5000"/>
          
          <label for="safeZ">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø£Ù…Ø§Ù† (Ù…Ù…)</label>
          <input id="safeZ" type="number" value="5" step="0.1" min="0" max="100"/>

          <label for="scanDir">Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª (Raster)</label>
          <select id="scanDir">
            <option value="x">Ø£ÙÙ‚ÙŠ (X)</option>
            <option value="y">Ø±Ø£Ø³ÙŠ (Y)</option>
          </select>

          <label for="stepOver">Ø®Ø·ÙˆØ© Ø§Ù„Ù…Ø³Ø­ (Ù…Ù…)</label>
          <input id="stepOver" type="number" value="5" step="0.1" min="0.1" max="50"/>
          
          <label for="maxDepth">Ø£Ù‚ØµÙ‰ Ø¹Ù…Ù‚ (Ù…Ù…)</label>
          <input id="maxDepth" type="number" value="3.0" step="0.1" min="0.1" max="50"/>

          <!-- Fixed Z + Invert Z -->
          <div style="display:flex;gap:8px;margin-top:12px;align-items:center; flex-wrap:wrap;">
            <label style="font-weight:normal; display:flex; align-items:center; gap:6px;">
              <input id="fixedZ" type="checkbox" /> 
              Ø§Ø³ØªØ®Ø¯Ø§Ù… Z Ø«Ø§Ø¨Øª
            </label>
            <input id="fixedZValue" type="number" value="-1.0" step="0.1" style="width:120px" />
          </div>
          
          <div style="display:flex;gap:8px;margin-top:10px;align-items:center; flex-wrap:wrap;">
            <label style="font-weight:normal; display:flex; align-items:center; gap:6px;">
              <input id="invertZ" type="checkbox" /> 
              Ø¹ÙƒØ³ Z
            </label>
            <div style="flex:1"></div>
            <label style="font-weight:normal;color:#9bb0c8; white-space:nowrap;">Ù„ÙˆÙ† Ø§Ù„Ø®Ø´Ø¨:</label>
            <select id="woodColor" style="width:140px">
              <option value="#deb887">Ø®Ø´Ø¨ ÙØ§ØªØ­</option>
              <option value="#a0522d" selected>Ø®Ø´Ø¨ Ù…ØªÙˆØ³Ø·</option>
              <option value="#d2b48c">Ø¨ÙŠØ¬</option>
              <option value="#8b5a2b">Ù…Ø§Ù‡ÙˆØ¬Ù†ÙŠ</option>
            </select>
          </div>

          <div class="button-group">
            <div class="button-row">
              <button id="btnGen" class="primary">âš¡ ØªÙˆÙ„ÙŠØ¯ G-code (Raster)</button>
              <button id="btnQuick" class="secondary">ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹</button>
            </div>

            <div style="margin-top:12px">
              <label for="contourMode">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø­ÙˆØ§Ù (Contour)</label>
              <select id="contourMode">
                <option value="outer">Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© ÙÙ‚Ø·</option>
                <option value="all">ÙƒÙ„ Ø§Ù„Ø­ÙˆØ§Ù</option>
              </select>
              <div style="height:8px"></div>
              <div class="button-row">
                <button id="btnContour" class="secondary">ğŸŒ€ ØªÙˆÙ„ÙŠØ¯ G-code (Contour)</button>
                <button id="btnDownload" class="secondary">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ G-code</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Laser Engraver Settings -->
        <div id="laserSettings" class="machine-settings" style="display:none;">
          <h4 style="color:#ff4444; border-left: 3px solid #ff4444; padding-left: 10px; margin: 12px 0;">âš¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Laser Engraver</h4>
          
          <label for="laserWorkWidth">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
          <input id="laserWorkWidth" type="number" value="30" step="0.1" min="1" max="200"/>
          <div class="small-meta" id="laserWidthMm">300.0 Ù…Ù…</div>

          <label for="laserWorkHeight">Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø¹Ù…Ù„ (Ø³Ù…)</label>
          <input id="laserWorkHeight" type="number" value="20" step="0.1" min="1" max="200"/>
          <div class="small-meta" id="laserHeightMm">200.0 Ù…Ù…</div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px; margin-top:12px;">
            <div>
              <label for="laserOriginX">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ X (Ø³Ù…)</label>
              <input id="laserOriginX" type="number" value="0" step="0.1"/>
            </div>
            <div>
              <label for="laserOriginY">Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„ Y (Ø³Ù…)</label>
              <input id="laserOriginY" type="number" value="0" step="0.1"/>
            </div>
          </div>
          <div style="margin-top:10px;">
            <button id="btnLaserCenterOrigin" class="secondary">ğŸ¯ ØªÙˆØ³ÙŠØ· Ù†Ù‚Ø·Ø© Ø§Ù„Ø£ØµÙ„</button>
          </div>

          <!-- Laser Edge Detection Settings -->
          <div style="border: 1px solid #ff4444; border-radius: 6px; padding: 12px; margin: 12px 0; background: rgba(255, 68, 68, 0.05);">
            <label for="laserEdgeMode">Ù†Ù…Ø· ÙƒØ´Ù Ø§Ù„Ø­ÙˆØ§Ù Ù„Ù„Ù„ÙŠØ²Ø±</label>
            <select id="laserEdgeMode">
              <option value="canny">Canny (Ø¹Ø§Ø¯ÙŠ)</option>
              <option value="adaptive">Adaptive Threshold (Ù„Ù„Ù†Ù‚Ø´)</option>
              <option value="morphological">Morphological (Ù„Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©)</option>
              <option value="gradient">Gradient-Based (Ù„Ù„ØªØ¯Ø±Ø¬Ø§Øª)</option>
            </select>
            <div style="font-size: 11px; color: #9bb0c8; margin-top: 6px; line-height: 1.3;" id="laserModeDesc">
              Adaptive Threshold - Ù…Ù…ØªØ§Ø² Ù„Ù„ØµÙˆØ± Ø°Ø§Øª Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© ØºÙŠØ± Ø§Ù„Ù…ØªØ¬Ø§Ù†Ø³Ø©
            </div>

            <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
              <label style="margin:0;color:#9bb0c8; min-width: 70px;">Ø¯Ù‚Ø© Ø§Ù„Ù„ÙŠØ²Ø±:</label>
              <input id="laserDetail" type="range" min="1" max="10" value="5" step="1" style="flex:1">
              <div id="laserDetailValue" style="min-width:30px;text-align:center;color:#ff4444; font-weight:bold;">5</div>
            </div>
          </div>

          <div style="margin-top: 12px;">
            <button id="btnRedetectLaser" class="secondary">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ÙƒØ´Ù Ø­ÙˆØ§Ù Ø§Ù„Ù„ÙŠØ²Ø±</button>
          </div>

          <hr style="border-color:#ff4444;margin:16px 0;"/>

          <!-- Laser Power -->
          <div style="display:flex;align-items:center;gap:8px;margin-top:8px">
            <label style="margin:0;color:#9bb0c8; min-width: 70px;">Ù‚ÙˆØ© Ø§Ù„Ù„ÙŠØ²Ø±:</label>
            <input id="laserPower" type="range" min="0" max="100" value="80" step="1" style="flex:1">
            <div id="laserPowerValue" style="min-width:44px;text-align:center;color:#ff4444; font-weight:bold;">80%</div>
          </div>

          <label for="laserMode">ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠØ²Ø±</label>
          <select id="laserMode">
            <option value="engrave">Ù†Ù‚Ø´ (Grayscale)</option>
            <option value="cut">Ù‚Øµ (Contour)</option>
            <option value="combine">Ù†Ù‚Ø´ + Ù‚Øµ</option>
          </select>

          <label for="laserSpeed">Ø³Ø±Ø¹Ø© Ø§Ù„Ù„ÙŠØ²Ø± (Ù…Ù…/Ø¯Ù‚ÙŠÙ‚Ø©)</label>
          <input id="laserSpeed" type="number" value="2000" min="100" max="10000"/>

          <label for="laserPasses">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª</label>
          <input id="laserPasses" type="number" value="1" min="1" max="10"/>

          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <label style="font-weight:normal; display:flex; align-items:center; gap:6px;">
              <input id="laserDynamic" type="checkbox" checked /> 
              Ù‚ÙˆØ© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© (Ø­Ø³Ø¨ Ø§Ù„Ø¸Ù„Ø§Ù…)
            </label>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <label style="font-weight:normal; display:flex; align-items:center; gap:6px;">
              <input id="laserAirAssist" type="checkbox" /> 
              Air Assist
            </label>
          </div>

          <!-- Laser Buttons -->
          <div class="button-group">
            <div class="button-row">
              <button id="btnLaserEngrave" class="primary" style="background:#ff4444; display:none;">âš¡ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ù„ÙŠØ²Ø± (Ù†Ù‚Ø´)</button>
              <button id="btnLaserQuick" class="secondary" style="display:none;">ğŸ§ª Ù†Ù‚Ø´ Ø³Ø±ÙŠØ¹</button>
            </div>
            <div class="button-row">
              <button id="btnLaserCut" class="secondary" style="display:none;">âœ‚ï¸ ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ù„ÙŠØ²Ø± (Ù‚Øµ)</button>
              <button id="btnLaserDownload" class="secondary" style="display:none;">ğŸ’¾ ØªØ­Ù…ÙŠÙ„ ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠØ²Ø±</button>
            </div>
          </div>
        </div>

        <div id="estTime" style="margin-top:16px;color:#9bb0c8;text-align:center;padding:10px;background:#0f172a;border-radius:6px; border:1px solid #1e293b;"></div>

        <label for="gcodeOut" style="margin-top:16px">ğŸ“„ Ù…Ø®Ø±Ø¬Ø§Øª G-code</label>
        <textarea id="gcodeOut" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± G-code Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆÙ„ÙŠØ¯..." style="height:180px;background:#021024;color:#cfeaf2;border-radius:8px;padding:12px; border:1px solid #1e293b; resize:vertical; font-family: monospace; font-size: 12px;"></textarea>

      </div>
    </div>
  </div>

  <!-- Progress Overlay -->
  <div class="progress-overlay" id="progressOverlay">
    <div class="progress-spinner"></div>
    <div class="progress-text" id="progressText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>
    <div class="progress-details" id="progressDetails"></div>
    <button id="btnCancel" class="cancel-btn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
  </div>

  <div id="toast"></div>

  <script>
    // ================= Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© =================
    let cvReady = false;
    let grayMat = null;
    let contour = null;
    let previewCanvas = null;
    let additionalContours = [];
    let lastScanDir = 'x';
    let lastGeneratedGcode = '';
    let isProcessing = false;
    let currentTaskId = null;
    let currentColormap = 'jet';

    // Simulation / Three
    let scene = null, camera = null, renderer = null, controls = null;
    let simulation = { 
        isPlaying: false, 
        animationFrame: null, 
        tool: null, 
        toolPath: null, 
        pathPoints: [], 
        index: 0, 
        speed: 1 
    };

    // ================= Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† =================
    class TaskManager {
      constructor() {
        this.queue = [];
        this.isRunning = false;
        this.currentTask = null;
        this.maxConcurrent = 1;
        this.concurrentTasks = 0;
        this.cancelRequested = false;
        this.taskIdCounter = 0;
        this.processingLock = false;
      }

      async addTask(taskFn, description = 'Ù…Ù‡Ù…Ø©') {
        const taskId = ++this.taskIdCounter;
        currentTaskId = taskId;
        
        return new Promise((resolve, reject) => {
          this.queue.push({ 
            taskFn, 
            description, 
            resolve, 
            reject, 
            taskId,
            timestamp: Date.now()
          });
          
          if (!this.isRunning && !this.processingLock) {
            this.processQueue();
          }
        });
      }

      async processQueue() {
        // Ù…Ù†Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
        if (this.processingLock || this.concurrentTasks >= this.maxConcurrent) {
            return;
        }

        if (this.queue.length === 0) {
            this.isRunning = false;
            return;
        }

        this.processingLock = true;
        this.isRunning = true;
        this.concurrentTasks++;
        
        const task = this.queue.shift();
        this.currentTask = task;

        try {
            showProgress(task.description, `Ø§Ù„Ù…Ù‡Ù…Ø© #${task.taskId}`);
            this.cancelRequested = false;
            
            console.log(`ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©: ${task.description} (ID: ${task.taskId})`);
            const startTime = Date.now();
            
            const result = await task.taskFn();
            const endTime = Date.now();
            const duration = (endTime - startTime) / 1000;
            
            if (this.cancelRequested) {
                console.log(`âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø©: ${task.description} Ø¨Ø¹Ø¯ ${duration.toFixed(1)} Ø«Ø§Ù†ÙŠØ©`);
                task.reject(new Error('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'));
            } else {
                console.log(`âœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ù‡Ù…Ø©: ${task.description} ÙÙŠ ${duration.toFixed(1)} Ø«Ø§Ù†ÙŠØ©`);
                task.resolve(result);
            }
        } catch (error) {
            if (!this.cancelRequested) {
                console.error(`âŒ ÙØ´Ù„ ÙÙŠ ${task.description}:`, error);
                showToast(`ÙØ´Ù„ ÙÙŠ ${task.description}: ${error.message}`, 5000);
                task.reject(error);
            }
        } finally {
            this.currentTask = null;
            this.concurrentTasks--;
            this.processingLock = false;
            currentTaskId = null;
            hideProgress();
            
            // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ø¨ÙŠÙ† Ø§Ù„Ù…Ù‡Ø§Ù…
            setTimeout(() => {
                this.processQueue();
            }, 100);
        }
      }

      cancelCurrentTask() {
        if (this.currentTask) {
            this.cancelRequested = true;
            this.queue = [];
            console.log('ğŸ›‘ ØªÙ… Ø·Ù„Ø¨ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©');
            return true;
        }
        return false;
      }

      clear() {
        this.queue = [];
        this.isRunning = false;
        this.currentTask = null;
        this.concurrentTasks = 0;
        this.cancelRequested = false;
        this.processingLock = false;
      }

      getQueueLength() {
        return this.queue.length;
      }

      getCurrentTask() {
        return this.currentTask;
      }

      getStats() {
          return {
              queueLength: this.queue.length,
              isRunning: this.isRunning,
              currentTask: this.currentTask ? this.currentTask.description : 'Ù„Ø§ Ø´ÙŠØ¡',
              concurrentTasks: this.concurrentTasks
          };
      }
    }

    const taskManager = new TaskManager();

    // ================= Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø­Ø³Ù† =================
    function showProgress(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...', details = '') {
      try {
        const progressText = document.getElementById('progressText');
        const progressDetails = document.getElementById('progressDetails');
        const progressOverlay = document.getElementById('progressOverlay');
        const btnCancel = document.getElementById('btnCancel');
        
        if (progressText) progressText.textContent = message;
        if (progressDetails) progressDetails.textContent = details;
        if (progressOverlay) progressOverlay.style.display = 'flex';
        if (btnCancel) btnCancel.style.display = 'block';
        
        console.log(`ğŸ“Š Ø§Ù„ØªÙ‚Ø¯Ù…: ${message} - ${details}`);
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø¯Ù…:', error);
      }
    }

    function updateProgressDetails(details) {
      try {
        const progressDetails = document.getElementById('progressDetails');
        if (progressDetails) {
          progressDetails.textContent = details;
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ø¯Ù…:', error);
      }
    }

    function hideProgress() {
      try {
        const progressOverlay = document.getElementById('progressOverlay');
        const btnCancel = document.getElementById('btnCancel');
        if (progressOverlay) progressOverlay.style.display = 'none';
        if (btnCancel) btnCancel.style.display = 'none';
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ‚Ø¯Ù…:', error);
      }
    }

    // Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
    document.getElementById('btnCancel').addEventListener('click', function() {
      console.log('ğŸ‘† ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
      if (taskManager.cancelCurrentTask()) {
        showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©...', 3000);
        isProcessing = false;
        memoryManager.comprehensiveCleanup();
        cleanupSimulation();
      } else {
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ù…Ø© Ø¬Ø§Ø±ÙŠØ© Ù„Ù„Ø¥Ù„ØºØ§Ø¡', 2000);
      }
    });

    // ================= Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ø³Ù† =================
    class MemoryManager {
      constructor() {
        this.mats = new Set();
        this.maxMats = 10;
        this.cleanupInterval = null;
        this.startCleanupMonitor();
      }

      track(mat) {
        if (mat && !mat.isDeleted && mat.delete) {
          this.mats.add(mat);
          
          if (this.mats.size > this.maxMats) {
            this.cleanupOldest();
          }
        }
      }

      cleanupOldest() {
        if (this.mats.size > 0) {
          const oldest = this.mats.values().next().value;
          if (this.safeDelete(oldest)) {
            this.mats.delete(oldest);
            console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø£Ù‚Ø¯Ù… Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©');
          }
        }
      }

      safeDelete(mat) {
        if (mat && !mat.isDeleted && mat.delete) {
          try {
            mat.delete();
            return true;
          } catch (e) {
            console.warn('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ØµÙÙˆÙØ©:', e);
            return false;
          }
        }
        return false;
      }

      cleanupAll() {
        console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø¬Ù…ÙŠØ¹ Ù…ØµÙÙˆÙØ§Øª OpenCV...');
        let deletedCount = 0;
        
        this.mats.forEach(mat => {
          if (this.safeDelete(mat)) {
            deletedCount++;
          }
        });
        
        this.mats.clear();
        console.log(`âœ… ØªÙ… Ø­Ø°Ù ${deletedCount} Ù…ØµÙÙˆÙØ©`);
        this.forceGarbageCollection();
      }

      cleanupMats() {
        console.log('ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØµÙÙˆÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©...');
        let deletedCount = 0;
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØµÙÙˆÙØ§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        const mainMats = [grayMat, contour];
        mainMats.forEach(mat => {
          if (this.safeDelete(mat)) {
            deletedCount++;
          }
        });
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙ†ØªÙˆØ± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
        additionalContours.forEach(item => {
          if (item && item.contour && this.safeDelete(item.contour)) {
            deletedCount++;
          }
        });
        
        grayMat = null;
        contour = null;
        additionalContours = [];
        
        console.log(`âœ… ØªÙ… ØªÙ†Ø¸ÙŠÙ ${deletedCount} Ù…ØµÙÙˆÙØ© Ù…Ø¤Ù‚ØªØ©`);
        this.forceGarbageCollection();
      }

      comprehensiveCleanup() {
        console.log('ğŸ”§ ØªÙ†Ø¸ÙŠÙ Ø´Ø§Ù…Ù„ Ù„Ù„Ø°Ø§ÙƒØ±Ø©...');
        this.cleanupMats();
        this.cleanupAll();
      }

      forceGarbageCollection() {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù…Ø¹ Ø§Ù„Ù‚Ù…Ø§Ù…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
        if (cv && typeof cv.getGarbageCollection === 'function') {
          try {
            cv.getGarbageCollection();
            console.log('âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø¬Ù…Ø¹ Ø§Ù„Ù‚Ù…Ø§Ù…Ø© Ù„Ù€ OpenCV');
          } catch (e) {
            console.log('â„¹ï¸ OpenCV GC ØºÙŠØ± Ù…ØªØ§Ø­');
          }
        }
      }

      startCleanupMonitor() {
        this.cleanupInterval = setInterval(() => {
          const usage = this.getMemoryUsage();
          if (usage > this.maxMats * 0.7) {
            console.log(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù…Ø±ØªÙØ¹ (${usage} Ù…ØµÙÙˆÙØ©)`);
            this.cleanupOldest();
          }
        }, 30000);
      }

      stopCleanupMonitor() {
        if (this.cleanupInterval) {
          clearInterval(this.cleanupInterval);
          this.cleanupInterval = null;
        }
      }

      getMemoryUsage() {
        return this.mats.size;
      }

      checkMemoryLeaks() {
        let leaked = 0;
        this.mats.forEach(mat => {
          if (mat.isDeleted) {
            console.warn('ğŸš¨ Ù…ØµÙÙˆÙØ© Ù…Ø­Ø°ÙˆÙØ© Ù„Ø§ ØªØ²Ø§Ù„ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©');
            leaked++;
          }
        });
        return leaked;
      }
    }

    const memoryManager = new MemoryManager();

    // ================= Ù†Ø¸Ø§Ù… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù† =================
    function waitForCv() {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 150;
        const startTime = Date.now();

        function check() {
          attempts++;
          
          try {
            if (typeof cv !== 'undefined' && cv.getBuildInformation) {
              // Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù…Ù„ÙŠ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† OpenCV ÙŠØ¹Ù…Ù„
              const testMat = new cv.Mat();
              if (testMat) {
                cvReady = true;
                testMat.delete();
                
                const loadTime = (Date.now() - startTime) / 1000;
                document.getElementById('cvState').innerHTML = 'âœ… OpenCV Ø¬Ø§Ù‡Ø²';
                showToast(`ØªÙ… ØªØ­Ù…ÙŠÙ„ OpenCV Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ ${loadTime.toFixed(1)} Ø«Ø§Ù†ÙŠØ©`, 2000);
                console.log(`âœ… OpenCV loaded successfully in ${loadTime.toFixed(1)}s`);
                resolve();
                return;
              }
            }
          } catch (error) {
            console.warn(`âš ï¸ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± OpenCVØŒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©: ${attempts}`, error);
          }
          
          if (attempts >= maxAttempts) {
            const error = new Error(`ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ OpenCV Ø¨Ø¹Ø¯ ${maxAttempts} Ù…Ø­Ø§ÙˆÙ„Ø©`);
            document.getElementById('cvState').innerHTML = 'âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ OpenCV';
            reject(error);
          } else {
            setTimeout(check, 100);
          }
        }
        
        check();
      });
    }

    function checkThreeJSLoaded() {
      if (typeof THREE === 'undefined') {
        throw new Error('THREE.js ØºÙŠØ± Ù…Ø­Ù…Ù„');
      }
      
      if (typeof THREE.OrbitControls === 'undefined') {
        console.warn('âš ï¸ OrbitControls ØºÙŠØ± Ù…Ø­Ù…Ù„ - Ø³ØªØ¹Ù…Ù„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø¯ÙˆÙ† ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
      }
      
      return true;
    }

    // ================= Helper UI funcs =================
    function showToast(msg, ms = 3000) {
      try {
        const t = document.getElementById('toast');
        if (t) {
          t.textContent = msg;
          t.style.display = 'block';
          clearTimeout(t._t);
          t._t = setTimeout(() => {
            t.style.display = 'none';
          }, ms);
        }
        console.log('ğŸ’¬ Toast:', msg);
      } catch (e) {
        console.error('âŒ Toast error:', e);
      }
    }

    function cmToMm(cm) { return cm * 10; }
    function mmToCm(mm) { return mm / 10; }

    function updateDimensionDisplay() {
      try {
        // ØªØ­Ø¯ÙŠØ« Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø±Ø§ÙˆØªØ±
        const widthCm = parseFloat(document.getElementById('workWidth').value) || 0;
        const heightCm = parseFloat(document.getElementById('workHeight').value) || 0;
        const widthMmElem = document.getElementById('widthMm');
        const heightMmElem = document.getElementById('heightMm');
        
        if (widthMmElem) widthMmElem.textContent = cmToMm(widthCm).toFixed(1) + ' Ù…Ù…';
        if (heightMmElem) heightMmElem.textContent = cmToMm(heightCm).toFixed(1) + ' Ù…Ù…';
        
        // ØªØ­Ø¯ÙŠØ« Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù„ÙŠØ²Ø±
        const laserWidthCm = parseFloat(document.getElementById('laserWorkWidth').value) || 0;
        const laserHeightCm = parseFloat(document.getElementById('laserWorkHeight').value) || 0;
        const laserWidthMmElem = document.getElementById('laserWidthMm');
        const laserHeightMmElem = document.getElementById('laserHeightMm');
        
        if (laserWidthMmElem) laserWidthMmElem.textContent = cmToMm(laserWidthCm).toFixed(1) + ' Ù…Ù…';
        if (laserHeightMmElem) laserHeightMmElem.textContent = cmToMm(laserHeightCm).toFixed(1) + ' Ù…Ù…';
      } catch (e) {
        console.error('âŒ updateDimensionDisplay error:', e);
      }
    }

    function showElement(elementId, hidePlaceholderId) {
      try {
        const element = document.getElementById(elementId);
        const placeholder = document.getElementById(hidePlaceholderId);
        if (element && placeholder) {
          element.style.display = 'block';
          placeholder.style.display = 'none';
        }
      } catch (e) {
        console.error('âŒ showElement error:', e);
      }
    }

    // ================= Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø© Ø§Ù„Ù…Ø­Ø³Ù† =================
    class InputValidator {
      static validateNumberInput(inputId, min, max, defaultValue = min) {
        try {
          const input = document.getElementById(inputId);
          if (!input) {
            console.warn(`âš ï¸ Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: ${inputId}`);
            return defaultValue;
          }
          
          let value = parseFloat(input.value);
          
          if (isNaN(value)) {
            showToast(`Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ ${inputId} ØºÙŠØ± ØµØ§Ù„Ø­Ø©`);
            input.value = defaultValue;
            return defaultValue;
          }
          
          if (value < min) {
            showToast(`Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ ${inputId} Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (${min})`);
            input.value = min;
            return min;
          }
          
          if (value > max) {
            showToast(`Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ ${inputId} Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (${max})`);
            input.value = max;
            return max;
          }
          
          return value;
        } catch (error) {
          console.error(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ${inputId}:`, error);
          return defaultValue;
        }
      }

      static validateImageSize(canvas) {
        if (!canvas) return false;
        
        const maxPixels = 800000;
        const currentPixels = canvas.width * canvas.height;
        
        if (currentPixels > maxPixels) {
          const ratio = Math.sqrt(maxPixels / currentPixels);
          const newWidth = Math.floor(canvas.width * ratio);
          const newHeight = Math.floor(canvas.height * ratio);
          
          const tempCanvas = document.createElement('canvas');
          const tempCtx = tempCanvas.getContext('2d');
          tempCanvas.width = newWidth;
          tempCanvas.height = newHeight;
          tempCtx.drawImage(canvas, 0, 0, newWidth, newHeight);
          
          const ctx = canvas.getContext('2d');
          canvas.width = newWidth;
          canvas.height = newHeight;
          ctx.drawImage(tempCanvas, 0, 0);
          
          showToast('ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£ÙØ¶Ù„');
          console.log(`ğŸ–¼ï¸ ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† ${currentPixels} Ø¥Ù„Ù‰ ${newWidth * newHeight} Ø¨ÙƒØ³Ù„`);
          return true;
        }
        return false;
      }

      static validateProcessingPerformance(canvas) {
        if (!canvas) return { needsReduction: false, currentPixels: 0 };
        
        const maxPixels = 600000;
        const currentPixels = canvas.width * canvas.height;
        
        if (currentPixels > maxPixels) {
          return {
            needsReduction: true,
            currentPixels,
            maxPixels,
            ratio: Math.sqrt(maxPixels / currentPixels)
          };
        }
        
        return { needsReduction: false, currentPixels };
      }

      static validateLaserSettings() {
        const power = this.validateNumberInput('laserPower', 0, 100, 80);
        const speed = this.validateNumberInput('laserSpeed', 100, 10000, 2000);
        const passes = this.validateNumberInput('laserPasses', 1, 10, 1);
        
        return { power, speed, passes };
      }

      static validateRouterSettings() {
        const feedRate = this.validateNumberInput('feedRate', 10, 5000, 800);
        const safeZ = this.validateNumberInput('safeZ', 0, 100, 5);
        const maxDepth = this.validateNumberInput('maxDepth', 0.1, 50, 3);
        const stepOver = this.validateNumberInput('stepOver', 0.1, 50, 5);
        
        return { feedRate, safeZ, maxDepth, stepOver };
      }

      static validateCanvas(canvas) {
        if (!canvas) {
          throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†ØµØ± Canvas');
        }
        if (canvas.width === 0 || canvas.height === 0) {
          throw new Error('Ø£Ø¨Ø¹Ø§Ø¯ Canvas ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
        }
        return true;
      }
    }

    // ================= Initialize Event Listeners =================
    function initializeEventListeners() {
      console.log('ğŸ”§ ØªÙ‡ÙŠØ¦Ø© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«...');

      // Tabs behavior
      document.querySelectorAll('.tab-buttons button').forEach(btn => {
        btn.addEventListener('click', function() {
          const allButtons = document.querySelectorAll('.tab-buttons button');
          const allContents = document.querySelectorAll('.tab-content');
          
          allButtons.forEach(b => b.classList.remove('active'));
          allContents.forEach(tc => tc.classList.remove('active'));
          
          this.classList.add('active');
          const tabId = this.getAttribute('data-tab');
          const tabContent = document.getElementById(tabId);
          if (tabContent) {
            tabContent.classList.add('active');
          }

          if (tabId === 'simulation' && document.getElementById('gcodeOut').value) {
            initSimulation();
          }
        });
      });

      // Machine Category Control
      const machineCategory = document.getElementById('machineCategory');
      if (machineCategory) {
        machineCategory.addEventListener('change', function(e) {
          const isLaser = e.target.value === 'laser';
          const routerSettings = document.getElementById('routerSettings');
          const laserSettings = document.getElementById('laserSettings');
          
          if (routerSettings) routerSettings.style.display = isLaser ? 'none' : 'block';
          if (laserSettings) laserSettings.style.display = isLaser ? 'block' : 'none';
          
          updateButtonVisibility(isLaser);
          
          if (previewCanvas && cvReady && !isProcessing) {
            taskManager.addTask(async () => {
              if (isLaser) {
                await detectLaserContours();
              } else {
                await detectContours();
              }
            }, 'ØªØ¨Ø¯ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§ÙƒÙŠÙ†Ø©');
          }
          
          showToast(isLaser ? 'ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠØ²Ø±' : 'ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ø±ÙˆØ§ØªØ±');
        });
      }

      // Laser event listeners
      const laserPower = document.getElementById('laserPower');
      if (laserPower) {
        laserPower.addEventListener('input', function(e) {
          const value = e.target.value;
          const laserPowerValue = document.getElementById('laserPowerValue');
          if (laserPowerValue) {
            laserPowerValue.textContent = value + '%';
            laserPowerValue.style.color = `hsl(${value * 1.2}, 100%, 60%)`;
          }
        });
      }

      const laserDetail = document.getElementById('laserDetail');
      if (laserDetail) {
        laserDetail.addEventListener('input', function(e) {
          const laserDetailValue = document.getElementById('laserDetailValue');
          if (laserDetailValue) {
            laserDetailValue.textContent = e.target.value;
          }
        });
      }

      // Edge sensitivity
      const edgeSensitivity = document.getElementById('edgeSensitivity');
      if (edgeSensitivity) {
        edgeSensitivity.addEventListener('input', function(e) {
          const edgeValue = document.getElementById('edgeValue');
          if (edgeValue) {
            edgeValue.textContent = parseFloat(e.target.value).toFixed(2);
          }
          if (!previewCanvas || isProcessing) return;
          const isLaser = document.getElementById('machineCategory').value === 'laser';
          if (!isLaser && cvReady && previewCanvas && previewCanvas.width > 0) {
            taskManager.addTask(detectContours, 'ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ù');
          }
        });
      }

      // Colormap buttons
      document.querySelectorAll('#colormapButtons button').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('#colormapButtons button').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentColormap = this.getAttribute('data-map');
          
          if (document.getElementById('heatmap').classList.contains('active')) {
            renderHeatmap();
          }
          
          if (lastGeneratedGcode) {
            renderTopViewFromGcode(lastGeneratedGcode);
          }
          
          if (document.getElementById('contour').classList.contains('active') && grayMat && contour) {
            renderContour(grayMat, contour);
          }
          
          showToast('ØªÙ… ØªØºÙŠÙŠØ± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¥Ù„Ù‰ ' + currentColormap);
        });
      });

      // Initialize dimension displays
      updateDimensionDisplay();
      
      // Add input listeners for dimension updates
      const dimensionInputs = ['workWidth', 'workHeight', 'laserWorkWidth', 'laserWorkHeight'];
      dimensionInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('input', updateDimensionDisplay);
        }
      });

      console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø¬Ù…ÙŠØ¹ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«');
    }

    // ... (ÙŠØªØ¨Ø¹ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø­Ø³Ù†)

  </script>
</body>
</html>
