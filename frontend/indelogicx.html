<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNC AI - النسخة النهائية المصححة</title>

  <!-- مكتبات خارجية -->
  <script src="https://cdn.jsdelivr.net/npm/clipper-lib@6.4.2/clipper_unminified.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.156.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.156.0/examples/js/controls/OrbitControls.js"></script>

  <style>
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f4f6fa;color:#222}
    header{background:#1f78d1;color:#fff;padding:10px;text-align:center;font-weight:bold}
    .container{display:grid;grid-template-columns:1fr 350px;gap:15px;padding:15px}
    canvas{background:#fff;border:1px solid #ccc;border-radius:6px;max-width:100%}
    .panel{background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
    .btn{padding:8px 12px;border:0;border-radius:6px;cursor:pointer;margin:3px}
    .btn-primary{background:#1f78d1;color:#fff}
    .gcode-output{background:#0b1220;color:#cfe8ff;font-family:monospace;font-size:12px;height:200px;overflow:auto;padding:6px;border-radius:6px}
    label{font-weight:bold;margin-top:6px;display:block}
    input[type=number]{width:70px}
    @media(max-width:900px){.container{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>🛠 CNC AI - النسخة النهائية المصححة</header>

<div class="container">
  <!-- يسار -->
  <div class="panel">
    <label>رفع صورة التصميم</label>
    <input id="fileInput" type="file" accept="image/*">

    <div>
      <button id="btnAnalyze" class="btn btn-primary">كشف الحواف</button>
      <button id="btnGeneratePaths" class="btn">توليد المحيطات</button>
      <button id="btnGenGcode" class="btn">توليد G-code</button>
      <button id="btnDownload" class="btn">تحميل G-code</button>
    </div>

    <label>معاينة 2D</label>
    <canvas id="preview2d" width="600" height="400"></canvas>

    <label>Heatmap (للـ Z)</label>
    <canvas id="heatmap" width="300" height="200"></canvas>

    <label>معاينة 3D</label>
    <div id="preview3d" style="width:100%;height:300px;background:#eee;border-radius:6px"></div>
  </div>

  <!-- يمين -->
  <div class="panel">
    <h3>إعدادات</h3>
    <label>عرض العمل (mm)</label>
    <input id="workWidth" type="number" value="300">

    <label>ارتفاع العمل (mm)</label>
    <input id="workHeight" type="number" value="200">

    <label>قطر الأداة (mm)</label>
    <input id="toolDia" type="number" value="3" step="0.1">

    <label>Stepover (%)</label>
    <input id="stepover" type="number" value="40">

    <label>أقصى عمق (mm)</label>
    <input id="maxDepth" type="number" value="3" step="0.1">

    <label>عمق كل مرور (mm)</label>
    <input id="passDepth" type="number" value="0.5" step="0.1">

    <label>Feed Rate</label>
    <input id="feedRate" type="number" value="800">

    <hr>
    <div>
      <label><input type="checkbox" id="startFromEdges" checked> بدء من الحواف</label><br>
      <label><input type="checkbox" id="useInfill" checked> تعبئة داخلية</label>
    </div>

    <hr>
    <label>G-code Output</label>
    <div id="gcodeOutput" class="gcode-output"></div>
  </div>
</div>

<script>
/* عناصر DOM */
const fileInput = document.getElementById('fileInput');
const preview2d = document.getElementById('preview2d');
const ctx2d = preview2d.getContext('2d');
const heatmap = document.getElementById('heatmap');
const ctxHeat = heatmap.getContext('2d');
const gcodeOutput = document.getElementById('gcodeOutput');

let loadedImage = null;
let contours = [];
let perimeters = [];
let heatmapData = null;

/* تحميل الصورة */
fileInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  const img = new Image();
  img.onload = ()=>{
    loadedImage = img;
    // ضبط أبعاد المعاينة
    preview2d.width = img.width > 800 ? 800 : img.width;
    preview2d.height = img.height * (preview2d.width / img.width);
    ctx2d.drawImage(img,0,0,preview2d.width,preview2d.height);

    // توليد Heatmap مصغرة
    heatmap.width = 300;
    heatmap.height = Math.round(300 * (img.height / img.width));
    ctxHeat.drawImage(img,0,0,heatmap.width,heatmap.height);
    heatmapData = ctxHeat.getImageData(0,0,heatmap.width,heatmap.height);
  };
  img.src = URL.createObjectURL(file);
});

/* كشف الحواف */
document.getElementById('btnAnalyze').addEventListener('click',()=>{
  if(!heatmapData) return alert('حمّل صورة أولاً');
  contours = detectEdges(heatmapData);
  drawContours();
  alert('تم كشف الحواف بنجاح');
});

/* رسم الحواف */
function drawContours(){
  ctx2d.drawImage(loadedImage,0,0,preview2d.width,preview2d.height);
  ctx2d.strokeStyle = 'red';
  ctx2d.lineWidth = 1.2;
  contours.forEach(cont=>{
    ctx2d.beginPath();
    cont.forEach((p,i)=>{
      const x = (p.x/heatmap.width)*preview2d.width;
      const y = (p.y/heatmap.height)*preview2d.height;
      if(i===0) ctx2d.moveTo(x,y); else ctx2d.lineTo(x,y);
    });
    ctx2d.closePath();
    ctx2d.stroke();
  });
}

/* Sobel + Threshold ديناميكي */
function detectEdges(imgData){
  const w = imgData.width, h = imgData.height;
  const gray = new Float32Array(w*h);
  const d = imgData.data;
  for(let i=0;i<w*h;i++){
    const j = i*4;
    gray[i] = 0.34*d[j] + 0.5*d[j+1] + 0.16*d[j+2];
  }
  const sobel = new Float32Array(w*h);
  const kx = [-1,0,1,-2,0,2,-1,0,1];
  const ky = [-1,-2,-1,0,0,0,1,2,1];
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      let gx=0, gy=0, idx=0;
      for(let yy=-1;yy<=1;yy++){
        for(let xx=-1;xx<=1;xx++){
          const v = gray[(y+yy)*w+(x+xx)];
          gx += v*kx[idx];
          gy += v*ky[idx];
          idx++;
        }
      }
      sobel[y*w+x] = Math.hypot(gx,gy);
    }
  }
  const max = Math.max(...sobel);
  const threshold = max * 0.35;
  const binary = new Uint8Array(w*h);
  for(let i=0;i<w*h;i++) binary[i] = sobel[i]>threshold?1:0;

  // تتبع الحواف
  const visited = new Uint8Array(w*h);
  const contours=[];
  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      const idx=y*w+x;
      if(binary[idx] && !visited[idx]){
        const stack=[[x,y]];
        const points=[];
        while(stack.length){
          const [cx,cy]=stack.pop();
          const id=cy*w+cx;
          if(cx<0||cx>=w||cy<0||cy>=h||visited[id]||!binary[id]) continue;
          visited[id]=1;
          points.push({x:cx,y:cy});
          stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
        }
        if(points.length>20) contours.push(simplifyPath(points,1));
      }
    }
  }
  return contours;
}

/* تبسيط المسارات (RDP) */
function simplifyPath(points,eps){
  if(points.length<3) return points;
  let dmax=0,index=0;
  const start=points[0],end=points[points.length-1];
  for(let i=1;i<points.length-1;i++){
    const d=perpendicularDist(points[i],start,end);
    if(d>dmax){index=i;dmax=d;}
  }
  if(dmax>eps){
    const res1=simplifyPath(points.slice(0,index+1),eps);
    const res2=simplifyPath(points.slice(index),eps);
    return res1.slice(0,res1.length-1).concat(res2);
  }else{
    return [start,end];
  }
}
function perpendicularDist(p,a,b){
  const dx=b.x-a.x,dy=b.y-a.y;
  if(dx===0&&dy===0) return Math.hypot(p.x-a.x,p.y-a.y);
  const t=((p.x-a.x)*dx+(p.y-a.y)*dy)/(dx*dx+dy*dy);
  const px=a.x+t*dx,py=a.y+t*dy;
  return Math.hypot(p.x-px,p.y-py);
}

/* توليد المحيطات باستخدام Clipper */
document.getElementById('btnGeneratePaths').addEventListener('click',()=>{
  if(contours.length===0) return alert('لا توجد حواف');
  perimeters = [];
  const scale = 100;
  const toolDia = parseFloat(document.getElementById('toolDia').value);
  const offset = (toolDia/2)*scale;
  contours.forEach(cont=>{
    const path = cont.map(p=>({X:Math.round(p.x*scale),Y:Math.round(p.y*scale)}));
    const co = new ClipperLib.ClipperOffset();
    co.AddPath(path,ClipperLib.JoinType.jtRound,ClipperLib.EndType.etClosedPolygon);
    const solution = new ClipperLib.Paths();
    co.Execute(solution,-offset);
    solution.forEach(sol=>{
      const poly = sol.map(pt=>({x:pt.X/scale,y:pt.Y/scale}));
      perimeters.push(poly);
    });
  });
  drawPerimeters();
  alert('تم توليد المحيطات بدقة');
});

/* رسم المحيطات */
function drawPerimeters(){
  drawContours();
  ctx2d.strokeStyle = 'blue';
  perimeters.forEach(poly=>{
    ctx2d.beginPath();
    poly.forEach((p,i)=>{
      const x = (p.x/heatmap.width)*preview2d.width;
      const y = (p.y/heatmap.height)*preview2d.height;
      if(i===0) ctx2d.moveTo(x,y); else ctx2d.lineTo(x,y);
    });
    ctx2d.closePath();
    ctx2d.stroke();
  });
}

/* أخذ Z من Heatmap */
function getZ(x,y){
  const w = heatmap.width, h = heatmap.height;
  const ix = Math.max(0,Math.min(w-1,Math.floor(x)));
  const iy = Math.max(0,Math.min(h-1,Math.floor(y)));
  const idx = (iy*w+ix)*4;
  const r = heatmapData.data[idx];
  const g = heatmapData.data[idx+1];
  const b = heatmapData.data[idx+2];
  const bright = 0.34*r + 0.5*g + 0.16*b;
  const maxDepth = parseFloat(document.getElementById('maxDepth').value);
  return (1 - bright/255) * maxDepth;
}

/* تحويل Canvas → mm */
function canvasToMM(pt){
  const workW = parseFloat(document.getElementById('workWidth').value);
  const workH = parseFloat(document.getElementById('workHeight').value);
  return {
    x:(pt.x/heatmap.width)*workW,
    y:(pt.y/heatmap.height)*workH
  };
}

/* توليد G-code */
document.getElementById('btnGenGcode').addEventListener('click',()=>{
  if(perimeters.length===0) return alert('لا توجد محيطات');
  const feed = parseFloat(document.getElementById('feedRate').value);
  const safeZ = 5;
  const passDepth = parseFloat(document.getElementById('passDepth').value);

  const lines = [
    '; G-code Generated by CNC AI',
    'G21',
    'G90',
    `G0 Z${safeZ}`
  ];

  perimeters.forEach(poly=>{
    const first = canvasToMM(poly[0]);
    lines.push(`G0 X${first.x.toFixed(2)} Y${first.y.toFixed(2)} Z${safeZ}`);
    const maxZ = Math.max(...poly.map(p=>getZ(p.x,p.y)));
    const passes = Math.ceil(maxZ/passDepth);

    for(let pass=1;pass<=passes;pass++){
      const targetDepth = Math.min(pass*passDepth,maxZ);
      lines.push(`G1 Z-${targetDepth.toFixed(2)} F${feed/2}`);
      poly.forEach(p=>{
        const mm = canvasToMM(p);
        const localZ = Math.min(getZ(p.x,p.y),targetDepth);
        lines.push(`G1 X${mm.x.toFixed(2)} Y${mm.y.toFixed(2)} Z-${localZ.toFixed(2)} F${feed}`);
      });
      lines.push(`G0 Z${safeZ}`);
    }
  });

  lines.push('M30');
  gcodeOutput.textContent = lines.join('\n');
  alert('تم توليد G-code بنجاح');
});

/* تحميل G-code */
document.getElementById('btnDownload').addEventListener('click',()=>{
  const blob = new Blob([gcodeOutput.textContent],{type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'cnc_output.nc';
  a.click();
});
</script>
</body>
</html>
